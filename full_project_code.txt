PROJECT CONTEXT FOR AI
======================

--- FILE: server/config/db.js ---
const mongoose = require("mongoose");

const connectDB = async () => {
  try {
    const conn = await mongoose.connect(process.env.MONGO_URI);
    console.log(`MongoDB Connected: ${conn.connection.host}`);
  } catch (error) {
    console.error(`Error: ${error.message}`);
    process.exit(1);
  }
};

module.exports = connectDB;


--- FILE: server/controllers/auditController.js ---
const Inventory = require("../models/Inventory");
const InventoryAudit = require("../models/InventoryAudit");
const AuditLog = require("../models/AuditLog"); // <--- MAKE SURE THIS IS HERE

// ==========================================
// 1. INVENTORY RECONCILIATION FUNCTIONS
// ==========================================

// @desc    Create Stock Audit & Adjust Inventory
// @route   POST /api/inventory/audit
const createAudit = async (req, res) => {
  try {
    const { items, branch } = req.body;

    const audit = await InventoryAudit.create({
      items: items.map((i) => ({
        inventoryItem: i.itemId,
        itemName: i.itemName,
        systemQty: i.systemQty,
        physicalQty: i.physicalQty,
        difference: i.physicalQty - i.systemQty,
        remark: i.remark,
      })),
      branch: branch || "Headquarters",
      auditedBy: req.user._id,
    });

    for (const item of items) {
      if (item.systemQty !== item.physicalQty) {
        await Inventory.findByIdAndUpdate(item.itemId, {
          quantity: item.physicalQty,
          lastUpdatedBy: req.user._id,
        });
      }
    }

    res.status(201).json({ message: "Audit saved", audit });
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

// @desc    Get Past Inventory Audits
// @route   GET /api/inventory/audit
const getAudits = async (req, res) => {
  try {
    const audits = await InventoryAudit.find({})
      .populate("auditedBy", "name")
      .sort({ createdAt: -1 });
    res.json(audits);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

// @desc    Delete Inventory Audit
// @route   DELETE /api/inventory/audit/:id
const deleteAudit = async (req, res) => {
  try {
    const audit = await InventoryAudit.findById(req.params.id);
    if (!audit)
      return res.status(404).json({ message: "Audit record not found" });
    await InventoryAudit.findByIdAndDelete(req.params.id);
    res.json({ message: "Audit record removed" });
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

// ==========================================
// 2. SYSTEM AUDIT TRAIL FUNCTIONS (KSS_GEN_7)
// ==========================================

// @desc    Get System-wide Audit Logs
// @route   GET /api/audit/system
const getSystemLogs = async (req, res) => {
  try {
    // Ensure AuditLog model is imported correctly at the top
    const logs = await AuditLog.find({}).sort({ createdAt: -1 }).limit(100);
    res.json(logs);
  } catch (error) {
    console.error("Error fetching system logs:", error); // Log error to terminal
    res.status(500).json({ message: "Server Error: " + error.message });
  }
};

// Export ALL functions
module.exports = { createAudit, getAudits, deleteAudit, getSystemLogs };


--- FILE: server/controllers/contactController.js ---
// const Contact = require("../models/Contact");

// // @desc    Submit a new contact message
// // @route   POST /api/contact
// // @access  Public
// const submitContact = async (req, res) => {
//   try {
//     const { name, phone, email, subject, message } = req.body;

//     // Validation: Check if fields are empty
//     if (!name || !phone || !email || !message) {
//       return res
//         .status(400)
//         .json({ message: "Please fill in all required fields" });
//     }

//     // Create new contact in Database
//     const newContact = await Contact.create({
//       name,
//       phone,
//       email,
//       subject,
//       message,
//     });

//     if (newContact) {
//       res.status(201).json({
//         success: true,
//         message: "Message sent successfully! We will contact you soon.",
//         data: newContact,
//       });
//     } else {
//       res.status(400).json({ message: "Invalid contact data" });
//     }
//   } catch (error) {
//     res.status(500).json({ message: "Server Error: " + error.message });
//   }
// };

// module.exports = { submitContact };
const Contact = require("../models/Contact");
const nodemailer = require("nodemailer");

// @desc    Submit a new contact message & Send Email
// @route   POST /api/contact
const submitContact = async (req, res) => {
  try {
    const { name, phone, email, subject, message } = req.body;

    // 1. Validation
    if (!name || !phone || !email || !message) {
      return res
        .status(400)
        .json({ message: "Please fill in all required fields" });
    }

    // 2. Save to Database
    const newContact = await Contact.create({
      name,
      phone,
      email,
      subject,
      message,
    });

    // 3. Send Email Notification
    if (newContact) {
      // Create Transporter
      const transporter = nodemailer.createTransport({
        service: "gmail",
        auth: {
          user: process.env.EMAIL_USER,
          pass: process.env.EMAIL_PASS, // Your App Password
        },
      });

      // Email Content
      const mailOptions = {
        from: process.env.EMAIL_USER,
        to: process.env.EMAIL_USER, // Send to the Ashram's own email
        subject: `New Website Inquiry: ${subject}`,
        html: `
          <h3>New Contact Message</h3>
          <p><strong>Name:</strong> ${name}</p>
          <p><strong>Phone:</strong> ${phone}</p>
          <p><strong>Email:</strong> ${email}</p>
          <p><strong>Subject:</strong> ${subject}</p>
          <br/>
          <p><strong>Message:</strong></p>
          <p>${message}</p>
        `,
      };

      // Send Mail
      await transporter.sendMail(mailOptions);

      res.status(201).json({
        success: true,
        message: "Message sent successfully! We will contact you soon.",
        data: newContact,
      });
    } else {
      res.status(400).json({ message: "Invalid contact data" });
    }
  } catch (error) {
    console.error("Error:", error);
    res.status(500).json({ message: "Server Error: " + error.message });
  }
};

module.exports = { submitContact };


--- FILE: server/controllers/donationController.js ---
// const Donation = require("../models/Donation");
// const { buildReceipt } = require("../utils/generatePDF"); // Import the utility
// const nodemailer = require("nodemailer");

// // @desc    Create new donation (Manual Entry by Admin/Employee)
// // @route   POST /api/donations
// const createDonation = async (req, res) => {
//   try {
//     const {
//       donorName,
//       donorPhone,
//       donorEmail,
//       donorPan,
//       amount,
//       scheme,
//       paymentMode,
//       paymentReference,
//       branch,
//     } = req.body;

//     const donation = await Donation.create({
//       donorName,
//       donorPhone,
//       donorEmail,
//       donorPan,
//       amount,
//       scheme,
//       paymentMode,
//       paymentReference,
//       branch: branch || "Headquarters",
//       collectedBy: req.user._id, // The logged-in employee ID
//     });

//     res.status(201).json(donation);
//   } catch (error) {
//     res.status(400).json({ message: error.message });
//   }
// };

// // @desc    Get all donations
// // @route   GET /api/donations
// const getDonations = async (req, res) => {
//   try {
//     // Sort by newest first
//     const donations = await Donation.find({}).sort({ createdAt: -1 });
//     res.json(donations);
//   } catch (error) {
//     res.status(500).json({ message: error.message });
//   }
// };
// // @desc    Download Receipt PDF
// // @route   GET /api/donations/:id/receipt
// const downloadReceipt = async (req, res) => {
//   try {
//     const donation = await Donation.findById(req.params.id);
//     if (!donation)
//       return res.status(404).json({ message: "Donation not found" });

//     // Set headers to tell browser this is a PDF
//     const filename = `Receipt_${donation.donorName}_${Date.now()}.pdf`;
//     res.setHeader("Content-disposition", `attachment; filename="${filename}"`);
//     res.setHeader("Content-type", "application/pdf");

//     // Stream the PDF to the response
//     buildReceipt(
//       donation,
//       (chunk) => res.write(chunk),
//       () => res.end()
//     );
//   } catch (error) {
//     res.status(500).json({ message: error.message });
//   }
// };

// // @desc    Email Receipt PDF
// // @route   POST /api/donations/:id/email
// const emailReceipt = async (req, res) => {
//   try {
//     const donation = await Donation.findById(req.params.id);
//     if (!donation)
//       return res.status(404).json({ message: "Donation not found" });
//     if (!donation.donorEmail)
//       return res.status(400).json({ message: "Donor has no email address" });

//     // 1. Generate PDF in memory
//     let buffers = [];
//     const pdfPromise = new Promise((resolve) => {
//       buildReceipt(
//         donation,
//         (chunk) => buffers.push(chunk),
//         () => resolve(Buffer.concat(buffers))
//       );
//     });

//     const pdfBuffer = await pdfPromise;

//     // 2. Setup Nodemailer
//     const transporter = nodemailer.createTransport({
//       service: "gmail",
//       auth: {
//         user: process.env.EMAIL_USER,
//         pass: process.env.EMAIL_PASS,
//       },
//     });

//     // 3. Send Email with Attachment
//     await transporter.sendMail({
//       from: process.env.EMAIL_USER,
//       to: donation.donorEmail,
//       subject: `Donation Receipt - Karunasri Seva Samithi`,
//       html: `
//         <h3>Namaste ${donation.donorName},</h3>
//         <p>Thank you for your generous donation of <strong>Rs. ${donation.amount}</strong>.</p>
//         <p>Please find your official 80G tax-exempt receipt attached to this email.</p>
//         <br/>
//         <p>Regards,<br/>Karunasri Team</p>
//       `,
//       attachments: [
//         {
//           filename: `Receipt_${donation._id}.pdf`,
//           content: pdfBuffer,
//           contentType: "application/pdf",
//         },
//       ],
//     });

//     // 4. Update Status
//     donation.receiptStatus = "Sent";
//     await donation.save();

//     res.json({ message: "Receipt sent successfully" });
//   } catch (error) {
//     console.error(error);
//     res.status(500).json({ message: error.message });
//   }
// };

// // Don't forget to export them!
// module.exports = {
//   createDonation,
//   getDonations,
//   downloadReceipt,
//   emailReceipt,
// };

// module.exports = { createDonation, getDonations };

const fs = require("fs"); // <--- Add this at the very top
const path = require("path"); // <--- Ensure this is imported too
const Donation = require("../models/Donation");
const { buildReceipt } = require("../utils/generatePDF"); // Ensure this path is correct
const Scheme = require("../models/Scheme"); // <--- Import Scheme
const nodemailer = require("nodemailer");
const { logAudit } = require("../utils/auditLogger"); // <--- Import

// Helper to find Account Head ID based on Scheme Name
const getAccountHeadForScheme = async (schemeName) => {
  const schemeObj = await Scheme.findOne({ name: schemeName });
  return schemeObj ? schemeObj.accountHead : null;
};

// @desc    Create new donation
// @route   POST /api/donations
const createDonation = async (req, res) => {
  try {
    const {
      donorName,
      donorPhone,
      donorEmail,
      donorPan,
      amount,
      scheme,
      paymentMode,
      paymentReference,
      branch,
    } = req.body;

    const accountHeadId = await getAccountHeadForScheme(scheme);

    const donation = await Donation.create({
      donorName,
      donorPhone,
      donorEmail,
      donorPan,
      amount,
      scheme,
      accountHead: accountHeadId,
      paymentMode,
      paymentReference,
      branch: branch || "Headquarters",
      collectedBy: req.user._id,
    });
    await logAudit(
      req,
      "CREATE",
      "Donation",
      donation._id,
      `Created donation of Rs.${amount} for ${donorName}`
    );

    res.status(201).json(donation);
  } catch (error) {
    res.status(400).json({ message: error.message });
  }
};

// @desc    Get all donations
// @route   GET /api/donations
// const getDonations = async (req, res) => {
//   try {
//     const donations = await Donation.find({}).sort({ createdAt: -1 });
//     res.json(donations);
//   } catch (error) {
//     res.status(500).json({ message: error.message });
//   }
// };

// @desc    Get all donations (Populated with Account Code)
// @route   GET /api/donations
const getDonations = async (req, res) => {
  try {
    const { from, to } = req.query;
    let query = {};

    if (from && to) {
      query.createdAt = {
        $gte: new Date(from),
        $lte: new Date(new Date(to).setHours(23, 59, 59)),
      };
    }

    const donations = await Donation.find(query)
      .populate("accountHead", "code name") // <--- THIS IS CRITICAL
      .sort({ createdAt: -1 });

    res.json(donations);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

// @desc    Download Receipt PDF
// @route   GET /api/donations/:id/receipt
const downloadReceipt = async (req, res) => {
  try {
    const donation = await Donation.findById(req.params.id);
    if (!donation)
      return res.status(404).json({ message: "Donation not found" });

    const filename = `Receipt_${donation.donorName}_${Date.now()}.pdf`;
    res.setHeader("Content-disposition", `attachment; filename="${filename}"`);
    res.setHeader("Content-type", "application/pdf");

    buildReceipt(
      donation,
      (chunk) => res.write(chunk),
      () => res.end()
    );
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

// @desc    Email Receipt PDF
// @route   POST /api/donations/:id/email
const emailReceipt = async (req, res) => {
  try {
    const donation = await Donation.findById(req.params.id);
    if (!donation)
      return res.status(404).json({ message: "Donation not found" });
    if (!donation.donorEmail)
      return res.status(400).json({ message: "Donor has no email address" });

    let buffers = [];
    const pdfPromise = new Promise((resolve) => {
      buildReceipt(
        donation,
        (chunk) => buffers.push(chunk),
        () => resolve(Buffer.concat(buffers))
      );
    });

    const pdfBuffer = await pdfPromise;

    const transporter = nodemailer.createTransport({
      service: "gmail",
      auth: {
        user: process.env.EMAIL_USER,
        pass: process.env.EMAIL_PASS,
      },
    });

    await transporter.sendMail({
      from: process.env.EMAIL_USER,
      to: donation.donorEmail,
      subject: `Donation Receipt - Karunasri Seva Samithi`,
      html: `
        <h3>Namaste ${donation.donorName},</h3>
        <p>Thank you for your generous donation of <strong>Rs. ${donation.amount}</strong>.</p>
        <p>Please find your official 80G tax-exempt receipt attached to this email.</p>
        <br/>
        <p>Regards,<br/>Karunasri Team</p>
      `,
      attachments: [
        {
          filename: `Receipt_${donation._id}.pdf`,
          content: pdfBuffer,
          contentType: "application/pdf",
        },
      ],
    });

    donation.receiptStatus = "Sent";
    await donation.save();

    res.json({ message: "Receipt sent successfully" });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: error.message });
  }
};

// @desc    Create Public Donation (Guest User - No Token)
// @route   POST /api/donations/public
const createPublicDonation = async (req, res) => {
  try {
    const {
      donorName,
      donorPhone,
      donorEmail,
      donorPan,
      amount,
      scheme,
      paymentMode,
      paymentReference,
      address,
    } = req.body;

    // Basic Validation
    if (!donorName || !amount || !scheme || !paymentMode) {
      return res.status(400).json({ message: "Missing required fields" });
    }
    const accountHeadId = await getAccountHeadForScheme(scheme);

    const donation = await Donation.create({
      donorName,
      donorPhone,
      donorEmail,
      donorPan,
      amount,
      scheme,
      accountHead: accountHeadId, // <--- SAVE IT HERE
      paymentMode, // 'Online' or 'Bank Transfer'
      paymentReference,
      branch: "Headquarters", // Default for online
      receiptStatus: "Generated", // Auto-generate status
      // collectedBy is left undefined for online donations
    });

    // Optional: You could trigger the emailReceipt function here automatically
    // But for now, let's just save it.

    res.status(201).json(donation);
  } catch (error) {
    res.status(400).json({ message: error.message });
  }
};

// @desc    Upload Media for Donation (KSS_DON_11)
// @route   POST /api/donations/:id/upload
const uploadMedia = async (req, res) => {
  try {
    const donation = await Donation.findById(req.params.id);
    if (!donation)
      return res.status(404).json({ message: "Donation not found" });

    if (!req.files || req.files.length === 0) {
      return res.status(400).json({ message: "No files uploaded" });
    }

    // Get paths of uploaded files
    const filePaths = req.files.map(
      (file) => `/${file.path.replace(/\\/g, "/")}`
    ); // Fix windows slashes

    // Add to existing media array
    donation.media.push(...filePaths);
    await donation.save();

    res.json({ message: "Files uploaded successfully", media: donation.media });
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

// @desc    Delete Media from Donation
// @route   DELETE /api/donations/:id/media
const deleteMedia = async (req, res) => {
  try {
    const { filePath } = req.body; // Expecting "/uploads/filename.jpg"
    const donation = await Donation.findById(req.params.id);

    if (!donation)
      return res.status(404).json({ message: "Donation not found" });

    // 1. Remove from Database Array
    donation.media = donation.media.filter((file) => file !== filePath);
    await donation.save();

    // 2. Delete File from Server Disk
    // filePath looks like "/uploads/image.jpg". We need to remove the leading "/"
    const absolutePath = path.join(__dirname, "..", filePath);

    if (fs.existsSync(absolutePath)) {
      fs.unlinkSync(absolutePath); // Delete file
    }

    res.json({ message: "File deleted successfully", media: donation.media });
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

// // Add to exports
// module.exports = {
//   createDonation,
//   createPublicDonation,
//   getDonations,
//   downloadReceipt,
//   emailReceipt,
//   uploadMedia,
//   deleteMedia, // <--- Add this
// };
// @desc    Get My Donations (Logged in User)
// @route   GET /api/donations/my
const getMyDonations = async (req, res) => {
  try {
    // Find donations where 'donorEmail' matches the user's email
    // OR where 'donor' ID matches the user ID (if we linked them)
    const donations = await Donation.find({
      $or: [
        { donor: req.user._id },
        { donorEmail: req.user.email }, // Fallback if they donated as guest with same email
      ],
    }).sort({ createdAt: -1 });

    res.json(donations);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

// Export it
module.exports = {
  createDonation,
  createPublicDonation,
  getDonations,
  downloadReceipt,
  emailReceipt,
  uploadMedia,
  deleteMedia,
  getMyDonations, // <--- Add this
};


--- FILE: server/controllers/eventController.js ---
const Event = require("../models/Event");

// @desc    Get all events (Public)
// @route   GET /api/events
const getEvents = async (req, res) => {
  try {
    // Sort by date (Nearest first)
    const events = await Event.find({}).sort({ date: 1 });
    res.json(events);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

// @desc    Create new event (Manager/Admin)
// @route   POST /api/events
const createEvent = async (req, res) => {
  try {
    const { title, description, date, time, location, eventType, branch } =
      req.body;

    const event = await Event.create({
      title,
      description,
      date,
      time,
      location,
      eventType,
      branch: branch || "Headquarters",
      createdBy: req.user._id, // Will be the Manager's ID
    });

    res.status(201).json(event);
  } catch (error) {
    res.status(400).json({ message: error.message });
  }
};

// @desc    Register for event (Public Guest)
// @route   POST /api/events/:id/register
const registerForEvent = async (req, res) => {
  try {
    const event = await Event.findById(req.params.id);
    if (!event) return res.status(404).json({ message: "Event not found" });

    const { name, phone } = req.body;

    // Prevent duplicate registration by phone number
    const alreadyRegistered = event.registrations.find(
      (r) => r.phone === phone
    );
    if (alreadyRegistered) {
      return res
        .status(400)
        .json({ message: "This phone number is already registered." });
    }

    // Add to registrations
    event.registrations.push({
      user: req.user ? req.user._id : null,
      name,
      phone,
    });

    await event.save();
    res.json({ message: "Registration Successful" });
  } catch (error) {
    res.status(400).json({ message: error.message });
  }
};
// @desc    Mark Attendance (Staff Only)
// @route   PUT /api/events/:id/attendance
const markAttendance = async (req, res) => {
  try {
    const { registrationId, status } = req.body; // status = true/false

    const event = await Event.findById(req.params.id);
    if (!event) return res.status(404).json({ message: "Event not found" });

    // Find the specific registration inside the array
    const registration = event.registrations.id(registrationId);
    if (!registration)
      return res.status(404).json({ message: "Registration not found" });

    registration.attended = status;
    await event.save();

    res.json({
      message: "Attendance updated",
      registrations: event.registrations,
    });
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

module.exports = { getEvents, createEvent, registerForEvent, markAttendance };


--- FILE: server/controllers/financeController.js ---
const Voucher = require("../models/Voucher");
const Donation = require("../models/Donation"); // Import Donation model
const { buildVoucherPDF } = require("../utils/generateVoucherPDF"); // Import utility

// @desc    Create a new Voucher (Employee/Admin)
// @route   POST /api/finance/vouchers
const createVoucher = async (req, res) => {
  try {
    const {
      voucherType,
      accountHead,
      amount,
      description,
      paymentMode,
      branch,
    } = req.body;

    // Auto-generate Voucher Number (VCH + Timestamp)
    const voucherNo = "VCH-" + Date.now().toString().slice(-6);

    const voucher = await Voucher.create({
      voucherType,
      voucherNo,
      accountHead,
      amount,
      description,
      paymentMode,
      branch: branch || "Headquarters",
      preparedBy: req.user._id, // The Warden/Employee logging in
      status: "Pending", // Always starts as Pending
    });

    res.status(201).json(voucher);
  } catch (error) {
    res.status(400).json({ message: error.message });
  }
};

// @desc    Get all vouchers
// @route   GET /api/finance/vouchers
const getVouchers = async (req, res) => {
  try {
    const vouchers = await Voucher.find({})
      .populate("accountHead", "code name") // Get Code & Name
      .populate("preparedBy", "name") // Get Warden Name
      .populate("approvedBy", "name") // Get Approver Name
      .sort({ createdAt: -1 });
    res.json(vouchers);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

// @desc    Approve Voucher (Admin Only)
// @route   PUT /api/finance/vouchers/:id/approve
// @desc    Approve Voucher (Multi-Signature)
// @route   PUT /api/finance/vouchers/:id/approve
const approveVoucher = async (req, res) => {
  try {
    const voucher = await Voucher.findById(req.params.id);

    if (!voucher) {
      return res.status(404).json({ message: "Voucher not found" });
    }

    // Check if this user already approved it
    if (voucher.approvedBy.includes(req.user._id)) {
      return res
        .status(400)
        .json({ message: "You have already approved this voucher" });
    }

    // Add current user to approval list
    voucher.approvedBy.push(req.user._id);

    // LOGIC: If 2 or more approvals, mark as Approved. Else, Partially Approved.
    if (voucher.approvedBy.length >= 2) {
      voucher.status = "Approved";
    } else {
      voucher.status = "Partially Approved";
    }

    await voucher.save();

    // Return populated data so frontend updates immediately
    const updatedVoucher = await Voucher.findById(req.params.id)
      .populate("accountHead", "code name")
      .populate("preparedBy", "name")
      .populate("approvedBy", "name");

    res.json(updatedVoucher);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};
// @desc    Download Voucher PDF
// @route   GET /api/finance/vouchers/:id/pdf
// @desc    Download Voucher PDF
// @route   GET /api/finance/vouchers/:id/pdf
const downloadVoucherPDF = async (req, res) => {
  try {
    // FIX: Added .populate() calls to get the actual names/codes
    const voucher = await Voucher.findById(req.params.id)
      .populate("accountHead", "code name") // <--- CRITICAL FIX
      .populate("preparedBy", "name")
      .populate("approvedBy", "name");

    if (!voucher) return res.status(404).json({ message: "Voucher not found" });

    const filename = `${voucher.voucherNo}.pdf`;
    res.setHeader("Content-disposition", `attachment; filename="${filename}"`);
    res.setHeader("Content-type", "application/pdf");

    buildVoucherPDF(
      voucher,
      (chunk) => res.write(chunk),
      () => res.end()
    );
  } catch (error) {
    console.error("PDF Error:", error);
    res.status(500).json({ message: error.message });
  }
};

// @desc    Get Current Cash Balance (System Calculated)
// @route   GET /api/finance/cash-balance
const getCashBalance = async (req, res) => {
  try {
    // 1. Total Cash Donations
    const donations = await Donation.find({ paymentMode: "Cash" });
    const totalDonationCash = donations.reduce(
      (acc, item) => acc + item.amount,
      0
    );

    // 2. Finance Vouchers (Cash Only)
    // Credit = Income, Debit = Expense
    const vouchers = await Voucher.find({
      paymentMode: "Cash",
      status: "Approved",
    });

    const voucherIncome = vouchers
      .filter((v) => v.voucherType === "Credit")
      .reduce((acc, v) => acc + v.amount, 0);

    const voucherExpense = vouchers
      .filter((v) => v.voucherType === "Debit")
      .reduce((acc, v) => acc + v.amount, 0);

    // 3. Calculate Net System Balance
    const systemBalance = totalDonationCash + voucherIncome - voucherExpense;

    res.json({ systemBalance });
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

// @desc    Reconcile Cash (Create Adjustment Voucher) - KSS_FIN_7
// @route   POST /api/finance/reconcile
const reconcileCash = async (req, res) => {
  try {
    const { systemBalance, physicalBalance, remark } = req.body;
    const difference = physicalBalance - systemBalance;

    if (difference === 0) {
      return res
        .status(400)
        .json({ message: "Balances match. No adjustment needed." });
    }

    // Determine Voucher Type based on difference
    // If Physical < System (Negative Diff) -> We lost money -> Treat as Expense (Debit) to lower system balance
    // If Physical > System (Positive Diff) -> We found money -> Treat as Income (Credit) to raise system balance

    // Actually, for Reconciliation, we usually use "Journal" type,
    // but to adjust the math in our simple logic:
    // Loss = Debit Voucher
    // Gain = Credit Voucher

    const type = difference < 0 ? "Debit" : "Credit";
    const amount = Math.abs(difference);

    const voucherNo = "ADJ-" + Date.now().toString().slice(-6);

    const adjustmentVoucher = await Voucher.create({
      voucherType: type, // or 'Journal' if you prefer strict accounting
      voucherNo,
      accountHead: "Cash Reconciliation Adjustment",
      amount,
      description: `System: ${systemBalance} | Physical: ${physicalBalance} | Reason: ${remark}`,
      paymentMode: "Cash",
      branch: "Headquarters",
      status: "Approved", // Auto-approve adjustments made by authorized staff
      createdBy: req.user._id,
      approvedBy: req.user._id,
    });

    res.status(201).json(adjustmentVoucher);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

// Export new functions
module.exports = {
  createVoucher,
  getVouchers,
  approveVoucher,
  downloadVoucherPDF,
  getCashBalance,
  reconcileCash, // <--- Add these
};


--- FILE: server/controllers/inventoryController1.js ---
const Inventory = require("../models/Inventory");
const { logAudit } = require("../utils/auditLogger"); // <--- Import

// @desc    Get all inventory items
// @route   GET /api/inventory
const getInventory = async (req, res) => {
  try {
    const items = await Inventory.find({}).sort({ itemName: 1 });
    res.json(items);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

// @desc    Add new item or Update stock
// @route   POST /api/inventory
const addInventoryItem = async (req, res) => {
  try {
    const {
      itemName,
      category,
      isPerishable,
      expiryDate,
      quantity,
      unit,
      branch,
    } = req.body;

    // Check if item exists in that branch
    const existingItem = await Inventory.findOne({
      itemName,
      branch: branch || "Headquarters",
    });

    if (existingItem) {
      // If item exists, just update the quantity (KSS_INV_4)
      existingItem.quantity += Number(quantity);
      existingItem.lastUpdatedBy = req.user._id;
      await existingItem.save();
      // --- LOG UPDATE ---
      await logAudit(
        req,
        "UPDATE",
        "Inventory",
        existingItem._id,
        `Updated ${itemName}: Changed Qty from ${oldQty} to ${existingItem.quantity}`
      );
      return res.status(200).json(existingItem);
    }

    // Create new item
    const newItem = await Inventory.create({
      itemName,
      category,
      isPerishable,
      expiryDate,
      quantity,
      unit,
      branch: branch || "Headquarters",
      lastUpdatedBy: req.user._id,
    });
    await logAudit(
      req,
      "CREATE",
      "Inventory",
      newItem._id,
      `Added new item: ${itemName} (${quantity} ${unit})`
    );

    res.status(201).json(newItem);
  } catch (error) {
    res.status(400).json({ message: error.message });
  }
};

module.exports = { getInventory, addInventoryItem };


--- FILE: server/controllers/memberController.js ---
const Member = require("../models/Member");

// @desc    Get all members
// @route   GET /api/members
const getMembers = async (req, res) => {
  try {
    const members = await Member.find({}).sort({ createdAt: -1 });
    res.json(members);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

// @desc    Register new member
// @route   POST /api/members
const createMember = async (req, res) => {
  try {
    const {
      firstName,
      lastName,
      phone,
      email,
      address,
      membershipType,
      feeAmount,
      feeStatus,
    } = req.body;

    // Calculate Validity (e.g., 1 year for Annual)
    let validUntil = null;
    if (membershipType === "Annual") {
      const d = new Date();
      d.setFullYear(d.getFullYear() + 1);
      validUntil = d;
    }

    const member = await Member.create({
      firstName,
      lastName,
      phone,
      email,
      address,
      membershipType,
      feeAmount,
      feeStatus,
      validUntil,
      createdBy: req.user._id,
    });

    res.status(201).json(member);
  } catch (error) {
    res.status(400).json({ message: error.message });
  }
};
// @desc    Add Activity to Member
// @route   POST /api/members/:id/activity
const addMemberActivity = async (req, res) => {
  try {
    const member = await Member.findById(req.params.id);
    if (!member) return res.status(404).json({ message: "Member not found" });

    const { eventName, role, date } = req.body;

    member.activities.push({
      eventName,
      role,
      date: date || Date.now(),
    });

    await member.save();
    res.json(member);
  } catch (error) {
    res.status(400).json({ message: error.message });
  }
};

// Export
module.exports = { getMembers, createMember, addMemberActivity };


--- FILE: server/controllers/reportController.js ---
// const Donation = require("../models/Donation");
// const Voucher = require("../models/Voucher");
// const Student = require("../models/Student");
// const Inventory = require("../models/Inventory");

// // @desc    Get Dashboard Stats (Admin/Manager)
// // @route   GET /api/reports/stats
// const getDashboardStats = async (req, res) => {
//   try {
//     // 1. Calculate Total Donations (Income)
//     const donations = await Donation.find({});
//     const totalIncome = donations.reduce((acc, item) => acc + item.amount, 0);

//     // 2. Calculate Total Expenses (Debit Vouchers)
//     // We only count 'Approved' vouchers for accurate accounting
//     const expenses = await Voucher.find({
//       voucherType: "Debit",
//       status: "Approved",
//     });
//     const totalExpense = expenses.reduce((acc, item) => acc + item.amount, 0);

//     // 3. Counts
//     const studentCount = await Student.countDocuments({
//       admissionStatus: "Active",
//     });
//     const lowStockCount = await Inventory.countDocuments({
//       quantity: { $lt: 10 },
//     });

//     // 4. Recent Transactions (Last 5 Donations)
//     const recentDonations = await Donation.find({})
//       .sort({ createdAt: -1 })
//       .limit(5)
//       .select("donorName amount scheme createdAt");

//     res.json({
//       financials: {
//         income: totalIncome,
//         expense: totalExpense,
//         balance: totalIncome - totalExpense,
//       },
//       counts: {
//         students: studentCount,
//         lowStock: lowStockCount,
//       },
//       recentDonations,
//     });
//   } catch (error) {
//     res.status(500).json({ message: error.message });
//   }
// };

// module.exports = { getDashboardStats };
const Donation = require("../models/Donation");
const Voucher = require("../models/Voucher");
const Student = require("../models/Student");
const Inventory = require("../models/Inventory");

// @desc    Get Real-Time Dashboard Stats
// @route   GET /api/reports/stats
const getDashboardStats = async (req, res) => {
  try {
    // 1. Calculate Total Donations (Income)
    const donations = await Donation.find({});
    const totalIncome = donations.reduce((acc, item) => acc + item.amount, 0);

    // 2. Calculate Total Expenses (Only Approved Debit Vouchers)
    const expenses = await Voucher.find({
      voucherType: "Debit",
      status: "Approved",
    });
    const totalExpense = expenses.reduce((acc, item) => acc + item.amount, 0);

    // 3. Count Active Students (Only those with 'Active' status)
    const studentCount = await Student.countDocuments({
      admissionStatus: "Active",
    });

    // 4. Count Low Stock Items (Quantity < 10)
    const lowStockCount = await Inventory.countDocuments({
      quantity: { $lt: 10 },
    });

    // 5. Get Recent 5 Donations for the table
    const recentDonations = await Donation.find({})
      .sort({ createdAt: -1 })
      .limit(5)
      .select("donorName amount scheme createdAt");

    res.json({
      financials: {
        income: totalIncome,
        expense: totalExpense,
        balance: totalIncome - totalExpense,
      },
      counts: {
        students: studentCount,
        lowStock: lowStockCount,
      },
      recentDonations,
    });
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

module.exports = { getDashboardStats };


--- FILE: server/controllers/schemeController.js ---
const Scheme = require("../models/Scheme");

// @desc    Get all schemes
// @route   GET /api/schemes
const getSchemes = async (req, res) => {
  try {
    const schemes = await Scheme.find({ isActive: true }).populate(
      "accountHead",
      "code name"
    );
    res.json(schemes);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

// @desc    Add new scheme (Admin Only)
// @route   POST /api/schemes
const createScheme = async (req, res) => {
  try {
    const { name, description, accountHead } = req.body;
    const scheme = await Scheme.create({ name, description, accountHead });
    res.status(201).json(scheme);
  } catch (error) {
    res.status(400).json({ message: error.message });
  }
};

// @desc    Delete scheme
// @route   DELETE /api/schemes/:id
const deleteScheme = async (req, res) => {
  try {
    await Scheme.findByIdAndDelete(req.params.id);
    res.json({ message: "Scheme removed" });
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

module.exports = { getSchemes, createScheme, deleteScheme };


--- FILE: server/controllers/studentController.js ---
const fs = require("fs"); // <--- Add at top
const path = require("path"); // <--- Add at top
const Student = require("../models/Student");
const { buildProgressPDF } = require("../utils/generateProgressPDF");
const nodemailer = require("nodemailer");

// @desc    Register a new Student (Employee)
// @route   POST /api/students
const createStudent = async (req, res) => {
  try {
    const {
      firstName,
      lastName,
      dob,
      gender,
      guardianName,
      contactNumber,
      address,
      branch,
      formsStatus,
      schoolName,
    } = req.body;

    const student = await Student.create({
      firstName,
      lastName,
      dob,
      gender,
      guardianName,
      contactNumber,
      address,
      branch: branch || "Headquarters",
      formsStatus, // Expecting an object { form20: true, ... }
      schoolName,
      createdBy: req.user._id,
    });

    res.status(201).json(student);
  } catch (error) {
    res.status(400).json({ message: error.message });
  }
};

// @desc    Get all students
// @route   GET /api/students
const getStudents = async (req, res) => {
  try {
    const students = await Student.find({}).sort({ createdAt: -1 });
    res.json(students);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

// @desc    Approve Student (President/Secretary/Treasurer)
// @route   PUT /api/students/:id/approve
// const approveStudent = async (req, res) => {
//   try {
//     const student = await Student.findById(req.params.id);
//     const { role } = req.user; // 'admin' usually plays President role in this demo
//     const { status, remark } = req.body; // 'Approved' or 'Rejected'

//     if (!student) {
//       return res.status(404).json({ message: "Student not found" });
//     }

//     // Logic: Which approval slot to update?
//     // In a real app, you might have specific roles like 'president', 'secretary'.
//     // For this demo, we will simulate it:
//     // If Admin -> President Approval
//     // If Employee -> Secretary Approval (Just for demo purposes)

//     // Ideally, you would add specific roles to your User model enum.
//     // Let's assume the frontend sends which "roleType" is approving.
//     const { approvalType } = req.body; // 'president', 'secretary', or 'treasurer'

//     if (approvalType === "president") {
//       student.approvals.president = { status, date: Date.now(), remark };
//     } else if (approvalType === "secretary") {
//       student.approvals.secretary = { status, date: Date.now(), remark };
//     } else if (approvalType === "treasurer") {
//       student.approvals.treasurer = { status, date: Date.now(), remark };
//     } else {
//       return res.status(400).json({ message: "Invalid approval type" });
//     }

//     // Check if ALL 3 are Approved -> Set Admission to Active
//     const p = student.approvals.president.status === "Approved";
//     const s = student.approvals.secretary.status === "Approved";
//     const t = student.approvals.treasurer.status === "Approved";

//     if (p && s && t) {
//       student.admissionStatus = "Active";
//     } else if (status === "Rejected") {
//       student.admissionStatus = "Rejected";
//     }

//     await student.save();
//     res.json(student);
//   } catch (error) {
//     res.status(500).json({ message: error.message });
//   }
// };

// @desc    Approve Student (President/Secretary/Treasurer)
// @route   PUT /api/students/:id/approve
const approveStudent = async (req, res) => {
  try {
    const student = await Student.findById(req.params.id);
    const { role } = req.user; // Get role from logged-in user
    const { status, remark } = req.body; // 'Approved' or 'Rejected'

    if (!student) {
      return res.status(404).json({ message: "Student not found" });
    }

    // AUTOMATICALLY detect which approval slot to update based on Role
    if (role === "president") {
      student.approvals.president = { status, date: Date.now(), remark };
    } else if (role === "secretary") {
      student.approvals.secretary = { status, date: Date.now(), remark };
    } else if (role === "treasurer") {
      student.approvals.treasurer = { status, date: Date.now(), remark };
    } else if (role === "admin") {
      // Admin backdoor: Can approve for anyone (optional, good for testing)
      // For now, let's say Admin acts as President
      student.approvals.president = { status, date: Date.now(), remark };
    } else {
      return res
        .status(403)
        .json({ message: "You are not authorized to approve students." });
    }

    // Check if ALL 3 are Approved -> Set Admission to Active
    const p = student.approvals.president.status === "Approved";
    const s = student.approvals.secretary.status === "Approved";
    const t = student.approvals.treasurer.status === "Approved";

    if (p && s && t) {
      student.admissionStatus = "Active";
    } else if (status === "Rejected") {
      student.admissionStatus = "Rejected";
    }

    await student.save();
    res.json(student);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

// @desc    Get Single Student by ID
// @route   GET /api/students/:id
// const getStudentById = async (req, res) => {
//   try {
//     const student = await Student.findById(req.params.id);
//     if (student) {
//       res.json(student);
//     } else {
//       res.status(404).json({ message: "Student not found" });
//     }
//   } catch (error) {
//     res.status(500).json({ message: error.message });
//   }
// };

///////////
const getStudentById = async (req, res) => {
  try {
    // Populate sponsor to see donor details in frontend
    const student = await Student.findById(req.params.id).populate(
      "sponsor",
      "donorName donorEmail"
    );
    if (student) {
      res.json(student);
    } else {
      res.status(404).json({ message: "Student not found" });
    }
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

// @desc    Update Student Details (Profile, Alumni, etc.)
// @route   PUT /api/students/:id
const updateStudent = async (req, res) => {
  try {
    const student = await Student.findById(req.params.id);

    if (student) {
      // 1. Update Arrays (if provided)
      student.educationHistory =
        req.body.educationHistory || student.educationHistory;
      student.healthRecords = req.body.healthRecords || student.healthRecords;

      // 2. Update Sponsor (if provided)
      // We check undefined because sending 'null' is a valid update (to remove sponsor)
      if (req.body.sponsor !== undefined) {
        student.sponsor = req.body.sponsor;
      }

      // 3. Update Basic Info (if provided - for Edit Profile)
      student.firstName = req.body.firstName || student.firstName;
      student.lastName = req.body.lastName || student.lastName;
      student.guardianName = req.body.guardianName || student.guardianName;
      student.contactNumber = req.body.contactNumber || student.contactNumber;
      student.address = req.body.address || student.address;
      student.dob = req.body.dob || student.dob;

      // 4. Update Expenses (Push to array)
      if (req.body.newExpense) {
        student.expenses.push(req.body.newExpense);
      }

      // --- FIX: ALLOW ALUMNI CONVERSION ---
      if (req.body.admissionStatus) {
        student.admissionStatus = req.body.admissionStatus;
      }
      if (req.body.alumniDetails) {
        student.alumniDetails = req.body.alumniDetails;
      }
      // ------------------------------------

      const updatedStudent = await student.save();
      res.json(updatedStudent);
    } else {
      res.status(404).json({ message: "Student not found" });
    }
  } catch (error) {
    res.status(400).json({ message: error.message });
  }
};

// @desc    Delete Student (Admin Only)
// @route   DELETE /api/students/:id
const deleteStudent = async (req, res) => {
  try {
    const student = await Student.findById(req.params.id);
    if (!student) return res.status(404).json({ message: "Student not found" });

    await Student.findByIdAndDelete(req.params.id);
    res.json({ message: "Student record removed" });
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

// @desc    Upload Documents for Student
// @route   POST /api/students/:id/upload
const uploadDocuments = async (req, res) => {
  try {
    const student = await Student.findById(req.params.id);
    if (!student) return res.status(404).json({ message: "Student not found" });

    if (!req.files || req.files.length === 0) {
      return res.status(400).json({ message: "No files uploaded" });
    }

    // Get paths
    const filePaths = req.files.map(
      (file) => `/${file.path.replace(/\\/g, "/")}`
    );

    // Add to array
    student.documents.push(...filePaths);
    await student.save();

    res.json({ message: "Documents uploaded", documents: student.documents });
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

// @desc    Delete Document
// @route   DELETE /api/students/:id/documents
const deleteDocument = async (req, res) => {
  try {
    const { filePath } = req.body;
    const student = await Student.findById(req.params.id);

    if (!student) return res.status(404).json({ message: "Student not found" });

    // Remove from DB
    student.documents = student.documents.filter((doc) => doc !== filePath);
    await student.save();

    // Remove from Disk
    const absolutePath = path.join(__dirname, "..", filePath);
    if (fs.existsSync(absolutePath)) {
      fs.unlinkSync(absolutePath);
    }

    res.json({ message: "File deleted", documents: student.documents });
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

// @desc    Record Student Leave
// @route   POST /api/students/:id/leave
const addStudentLeave = async (req, res) => {
  try {
    const student = await Student.findById(req.params.id);
    if (!student) return res.status(404).json({ message: "Student not found" });

    const { startDate, endDate, reason } = req.body;

    // Add to leaves array
    student.leaves.push({
      startDate,
      endDate,
      reason,
      status: "On Leave",
    });

    await student.save();
    res.json(student);
  } catch (error) {
    res.status(400).json({ message: error.message });
  }
};

// @desc    Mark Student as Returned
// @route   PUT /api/students/:id/leave/:leaveId
const updateLeaveStatus = async (req, res) => {
  try {
    const student = await Student.findById(req.params.id);
    if (!student) return res.status(404).json({ message: "Student not found" });

    // Find the specific leave record
    const leave = student.leaves.id(req.params.leaveId);
    if (!leave)
      return res.status(404).json({ message: "Leave record not found" });

    leave.status = "Returned";
    leave.actualReturnDate = Date.now();

    await student.save();
    res.json(student);
  } catch (error) {
    res.status(400).json({ message: error.message });
  }
};
// @desc    Email Progress Report to Sponsor (KSS_STU_20)
// @route   POST /api/students/:id/email-sponsor
const emailProgressReport = async (req, res) => {
  try {
    // Populate sponsor to get donorEmail
    const student = await Student.findById(req.params.id).populate("sponsor");

    if (!student) return res.status(404).json({ message: "Student not found" });

    if (!student.sponsor || !student.sponsor.donorEmail) {
      return res
        .status(400)
        .json({ message: "No sponsor mapped or sponsor has no email." });
    }

    // 1. Generate PDF
    let buffers = [];
    const pdfPromise = new Promise((resolve) => {
      buildProgressPDF(
        student,
        (chunk) => buffers.push(chunk),
        () => resolve(Buffer.concat(buffers))
      );
    });
    const pdfBuffer = await pdfPromise;

    // 2. Send Email
    const transporter = nodemailer.createTransport({
      service: "gmail",
      auth: {
        user: process.env.EMAIL_USER,
        pass: process.env.EMAIL_PASS,
      },
    });

    await transporter.sendMail({
      from: process.env.EMAIL_USER,
      to: student.sponsor.donorEmail,
      subject: `Progress Report: ${student.firstName} ${student.lastName}`,
      html: `
        <h3>Namaste ${student.sponsor.donorName},</h3>
        <p>We are happy to share the periodic progress report of the student you are supporting: <strong>${student.firstName} ${student.lastName}</strong>.</p>
        <p>Please find the detailed report attached.</p>
        <p>Your support is making a real difference in their life.</p>
        <br/>
        <p>Regards,<br/>Karunasri Seva Samithi</p>
      `,
      attachments: [
        {
          filename: `Progress_Report_${student.firstName}.pdf`,
          content: pdfBuffer,
          contentType: "application/pdf",
        },
      ],
    });

    res.json({ message: "Progress report sent successfully" });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: error.message });
  }
};

// Export ALL functions
module.exports = {
  createStudent,
  getStudents,
  approveStudent,
  getStudentById,
  updateStudent,
  deleteStudent,
  uploadDocuments,
  deleteDocument, // <--- Add these
  addStudentLeave,
  updateLeaveStatus, // <--- Add these
  emailProgressReport, // <--- Add this
};


--- FILE: server/controllers/userController.js ---
// const jwt = require("jsonwebtoken");
// const bcrypt = require("bcryptjs");
// const User = require("../models/User");

// // Helper Function: Generate JWT Token
// const generateToken = (id) => {
//   return jwt.sign({ id }, process.env.JWT_SECRET, {
//     expiresIn: "30d", // User stays logged in for 30 days
//   });
// };

// // @desc    Register new user
// // @route   POST /api/users/register
// const registerUser = async (req, res) => {
//   try {
//     const { name, email, password, phone } = req.body;

//     if (!name || !email || !password || !phone) {
//       return res.status(400).json({ message: "Please fill all fields" });
//     }

//     // Check if user exists
//     const userExists = await User.findOne({ email });
//     if (userExists) {
//       return res.status(400).json({ message: "User already exists" });
//     }

//     // Hash password
//     const salt = await bcrypt.genSalt(10);
//     const hashedPassword = await bcrypt.hash(password, salt);

//     // Create User
//     const user = await User.create({
//       name,
//       email,
//       phone,
//       password: hashedPassword,
//       role: "user", // Default role
//     });

//     if (user) {
//       res.status(201).json({
//         _id: user.id,
//         name: user.name,
//         email: user.email,
//         role: user.role,
//         token: generateToken(user.id), // Send token back
//       });
//     } else {
//       res.status(400).json({ message: "Invalid user data" });
//     }
//   } catch (error) {
//     res.status(500).json({ message: error.message });
//   }
// };

// // @desc    Authenticate a user (Login)
// // @route   POST /api/users/login
// const loginUser = async (req, res) => {
//   try {
//     const { email, password } = req.body;

//     // Check for user email
//     const user = await User.findOne({ email });

//     // Check password matches
//     if (user && (await bcrypt.compare(password, user.password))) {
//       res.json({
//         _id: user.id,
//         name: user.name,
//         email: user.email,
//         role: user.role,
//         token: generateToken(user.id),
//       });
//     } else {
//       res.status(401).json({ message: "Invalid email or password" });
//     }
//   } catch (error) {
//     res.status(500).json({ message: error.message });
//   }
// };

// module.exports = { registerUser, loginUser };
const jwt = require("jsonwebtoken");
const bcrypt = require("bcryptjs");
const nodemailer = require("nodemailer"); // <--- Import Nodemailer
const User = require("../models/User");

// Helper: Generate Token
const generateToken = (id) => {
  return jwt.sign({ id }, process.env.JWT_SECRET, { expiresIn: "30d" });
};

// @desc    Register new user & Send Welcome Email
// @route   POST /api/users/register
const registerUser = async (req, res) => {
  try {
    const { name, email, password, phone } = req.body;

    if (!name || !email || !password || !phone) {
      return res.status(400).json({ message: "Please fill all fields" });
    }

    const userExists = await User.findOne({ email });
    if (userExists) {
      return res.status(400).json({ message: "User already exists" });
    }

    // Hash password
    const salt = await bcrypt.genSalt(10);
    const hashedPassword = await bcrypt.hash(password, salt);

    // Create User
    const user = await User.create({
      name,
      email,
      phone,
      password: hashedPassword,
      role: "user",
    });

    if (user) {
      // --- SEND WELCOME EMAIL LOGIC START ---
      try {
        const transporter = nodemailer.createTransport({
          service: "gmail",
          auth: {
            user: process.env.EMAIL_USER,
            pass: process.env.EMAIL_PASS,
          },
        });

        const mailOptions = {
          from: process.env.EMAIL_USER,
          to: user.email, // Send to the NEW USER
          subject: "Welcome to Karunasri Seva Samithi Family",
          html: `
            <div style="font-family: Arial, sans-serif; color: #333;">
              <h2 style="color: #D35400;">Namaste ${user.name},</h2>
              <p>Thank you for joining <strong>Karunasri Seva Samithi</strong>.</p>
              <p>We are delighted to have you as part of our community. Your account has been successfully created.</p>
              <p>You can now log in to:</p>
              <ul>
                <li>View your donation history</li>
                <li>Download receipts</li>
                <li>Stay updated with Ashram events</li>
              </ul>
              <br/>
              <p>In Service of the Lord,</p>
              <p><strong>The Karunasri Team</strong></p>
            </div>
          `,
        };

        await transporter.sendMail(mailOptions);
      } catch (emailError) {
        console.log("Email sending failed:", emailError);
        // We don't stop the registration if email fails, just log it
      }
      // --- SEND WELCOME EMAIL LOGIC END ---

      res.status(201).json({
        _id: user.id,
        name: user.name,
        email: user.email,
        role: user.role,
        token: generateToken(user.id),
      });
    } else {
      res.status(400).json({ message: "Invalid user data" });
    }
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

// @desc    Login User (Kept same as before)
const loginUser = async (req, res) => {
  try {
    const { email, password } = req.body;
    const user = await User.findOne({ email });

    if (user && (await bcrypt.compare(password, user.password))) {
      res.json({
        _id: user.id,
        name: user.name,
        email: user.email,
        role: user.role,
        token: generateToken(user.id),
      });
    } else {
      res.status(401).json({ message: "Invalid email or password" });
    }
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

// @desc    Get User Profile
// @route   GET /api/users/profile
const getUserProfile = async (req, res) => {
  try {
    const user = await User.findById(req.user._id);
    if (user) {
      res.json({
        _id: user._id,
        name: user.name,
        email: user.email,
        phone: user.phone,
        role: user.role,
        branch: user.branch,
      });
    } else {
      res.status(404).json({ message: "User not found" });
    }
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

// @desc    Update User Profile
// @route   PUT /api/users/profile
const updateUserProfile = async (req, res) => {
  try {
    const user = await User.findById(req.user._id);

    if (user) {
      user.name = req.body.name || user.name;
      user.phone = req.body.phone || user.phone;
      // We usually don't allow changing email easily as it's the ID
      if (req.body.password) {
        const salt = await bcrypt.genSalt(10);
        user.password = await bcrypt.hash(req.body.password, salt);
      }

      const updatedUser = await user.save();

      res.json({
        _id: updatedUser._id,
        name: updatedUser.name,
        email: updatedUser.email,
        phone: updatedUser.phone,
        role: updatedUser.role,
        token: generateToken(updatedUser._id), // Return new token just in case
      });
    } else {
      res.status(404).json({ message: "User not found" });
    }
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

// Export new functions
module.exports = { registerUser, loginUser, getUserProfile, updateUserProfile };


--- FILE: server/middleware/authMiddleware.js ---
// const jwt = require("jsonwebtoken");
// const User = require("../models/User");

// const protect = async (req, res, next) => {
//   let token;

//   if (
//     req.headers.authorization &&
//     req.headers.authorization.startsWith("Bearer")
//   ) {
//     try {
//       // Get token from header (Bearer <token>)
//       token = req.headers.authorization.split(" ")[1];

//       // Verify token
//       const decoded = jwt.verify(token, process.env.JWT_SECRET);

//       // Get user from the token
//       req.user = await User.findById(decoded.id).select("-password");

//       next();
//     } catch (error) {
//       res.status(401).json({ message: "Not authorized, token failed" });
//     }
//   }

//   if (!token) {
//     res.status(401).json({ message: "Not authorized, no token" });
//   }
// };

// module.exports = { protect };

// const jwt = require("jsonwebtoken");
// const User = require("../models/User");

// // 1. Protect (Checks if user is logged in)
// const protect = async (req, res, next) => {
//   let token;
//   if (
//     req.headers.authorization &&
//     req.headers.authorization.startsWith("Bearer")
//   ) {
//     try {
//       token = req.headers.authorization.split(" ")[1];
//       const decoded = jwt.verify(token, process.env.JWT_SECRET);
//       req.user = await User.findById(decoded.id).select("-password");
//       next();
//     } catch (error) {
//       res.status(401).json({ message: "Not authorized, token failed" });
//     }
//   }
//   if (!token) {
//     res.status(401).json({ message: "Not authorized, no token" });
//   }
// };

// // 2. Admin Only (Checks if user is Admin) <--- NEW FUNCTION
// const admin = (req, res, next) => {
//   if (req.user && req.user.role === "admin") {
//     next(); // Allow access
//   } else {
//     res.status(401).json({ message: "Not authorized as an admin" });
//   }
// };

// module.exports = { protect, admin };
const jwt = require("jsonwebtoken");
const User = require("../models/User");

// 1. Protect (Checks if user is logged in)
const protect = async (req, res, next) => {
  let token;
  if (
    req.headers.authorization &&
    req.headers.authorization.startsWith("Bearer")
  ) {
    try {
      token = req.headers.authorization.split(" ")[1];
      const decoded = jwt.verify(token, process.env.JWT_SECRET);
      req.user = await User.findById(decoded.id).select("-password");
      next();
    } catch (error) {
      res.status(401).json({ message: "Not authorized, token failed" });
    }
  }
  if (!token) {
    res.status(401).json({ message: "Not authorized, no token" });
  }
};

// 2. Admin Only (Strict)
const admin = (req, res, next) => {
  if (req.user && req.user.role === "admin") {
    next();
  } else {
    res.status(401).json({ message: "Not authorized as an admin" });
  }
};

// 3. Staff Only (Manager OR Admin) <--- THIS ENABLE MANAGER ACCESS
// const staff = (req, res, next) => {
//   if (req.user && (req.user.role === "admin" || req.user.role === "employee")) {
//     next(); // Allow access
//   } else {
//     res.status(401).json({ message: "Not authorized. Staff access required." });
//   }
// };
// 3. Staff Only (Employees + Committee Members)
const staff = (req, res, next) => {
  const allowedRoles = [
    "admin",
    "employee",
    "president",
    "secretary",
    "treasurer",
  ];

  if (req.user && allowedRoles.includes(req.user.role)) {
    next();
  } else {
    res
      .status(401)
      .json({ message: "Not authorized. Staff/Committee access required." });
  }
};
// 4. NEW: Committee Only (For Approvals)
const committee = (req, res, next) => {
  const allowedRoles = ["admin", "president", "secretary", "treasurer"];

  if (req.user && allowedRoles.includes(req.user.role)) {
    next();
  } else {
    res
      .status(401)
      .json({ message: "Not authorized. Committee access required." });
  }
};

module.exports = { protect, admin, staff, committee };


--- FILE: server/models/AccountHead.js ---
const mongoose = require("mongoose");

const accountHeadSchema = mongoose.Schema(
  {
    code: { type: String, required: true, unique: true }, // e.g., "201", "10"
    name: { type: String, required: true }, // e.g., "Nitya Annadhana"
    type: { type: String, enum: ["Credit", "Debit"], required: true }, // Credit = Income, Debit = Expense
    description: { type: String },
  },
  { timestamps: true }
);

module.exports = mongoose.model("AccountHead", accountHeadSchema);


--- FILE: server/models/AuditLog.js ---
// const mongoose = require("mongoose");

// const auditLogSchema = mongoose.Schema(
//   {
//     user: {
//       type: mongoose.Schema.Types.ObjectId,
//       ref: "User",
//       required: true,
//     },
//     userName: { type: String }, // Store name snapshot in case user is deleted later

//     action: {
//       type: String,
//       required: true,
//       enum: ["CREATE", "UPDATE", "DELETE", "LOGIN", "APPROVE", "REJECT"],
//     },

//     module: {
//       type: String,
//       required: true,
//     }, // e.g., "Donation", "Inventory", "Student"

//     recordId: { type: String }, // The ID of the item changed

//     details: { type: String }, // Description of change (e.g., "Changed Stock from 50 to 45")

//     ipAddress: { type: String }, // Optional security feature
//   },
//   {
//     timestamps: true, // Automatically captures Date & Time
//   }
// );

// module.exports = mongoose.model("AuditLog", auditLogSchema);
const mongoose = require("mongoose");

const auditLogSchema = mongoose.Schema(
  {
    user: { type: mongoose.Schema.Types.ObjectId, ref: "User" },
    userName: { type: String },
    action: { type: String, required: true },
    module: { type: String, required: true },
    recordId: { type: String },
    details: { type: String },
    ipAddress: { type: String },
  },
  {
    timestamps: true,
  }
);

module.exports = mongoose.model("AuditLog", auditLogSchema);


--- FILE: server/models/Contact.js ---
const mongoose = require("mongoose");

const contactSchema = mongoose.Schema(
  {
    name: {
      type: String,
      required: true,
    },
    phone: {
      type: String,
      required: true,
    },
    email: {
      type: String,
      required: true,
    },
    subject: {
      type: String,
      required: true,
    },
    message: {
      type: String,
      required: true,
    },
  },
  {
    timestamps: true, // Automatically adds 'createdAt' and 'updatedAt'
  }
);

module.exports = mongoose.model("Contact", contactSchema);


--- FILE: server/models/Donation.js ---
const mongoose = require("mongoose");

const donationSchema = mongoose.Schema(
  {
    // Link to a registered user (optional, can be Guest)
    donor: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "User",
      required: false,
    },
    // Basic Details
    donorName: { type: String, required: true },
    donorPhone: { type: String, required: true },
    donorEmail: { type: String },
    donorPan: { type: String }, // For Tax Benefit (KSS_DON_8)
    donorAadhaar: { type: String },

    // Donation Details
    amount: { type: Number, required: true },
    scheme: { type: String, required: true }, // e.g. Nitya Annadhana
    // --- NEW FIELD: Account Head Link ---
    accountHead: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "AccountHead",
      // Not required yet, to support legacy data, but highly recommended
    },
    // ------------------------------------

    // Payment Details (KSS_DON_1)
    paymentMode: {
      type: String,
      enum: ["Cash", "Online", "Cheque", "DD", "Foreign Currency"],
      required: true,
    },
    paymentReference: { type: String }, // Cheque No or Transaction ID

    // System Details
    branch: { type: String, required: true, default: "Headquarters" }, // KSS_GEN_2
    receiptStatus: {
      type: String,
      enum: ["Generated", "Sent", "Pending"],
      default: "Pending",
    },
    media: [
      {
        type: String, // Stores the URL/Path of the file
      },
    ],

    // Who entered this record? (Audit Trail)
    collectedBy: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "User",
    },
  },
  {
    timestamps: true,
  }
);

module.exports = mongoose.model("Donation", donationSchema);


--- FILE: server/models/Event.js ---
const mongoose = require("mongoose");

const eventSchema = mongoose.Schema(
  {
    title: { type: String, required: true },
    description: { type: String, required: true },
    date: { type: Date, required: true },
    time: { type: String, required: true },
    location: { type: String, required: true },

    // Requirement KSS_EVE_2: Event Types
    eventType: {
      type: String,
      enum: ["Celebration", "Training", "Workshop", "Puja", "Other"],
      default: "Celebration",
    },

    // Requirement KSS_EVE_3: Track Registrations
    registrations: [
      {
        user: { type: mongoose.Schema.Types.ObjectId, ref: "User" }, // Optional link
        name: { type: String, required: true },
        phone: { type: String, required: true },
        registeredAt: { type: Date, default: Date.now },
        // --- NEW FIELD ---
        attended: { type: Boolean, default: false },
        // ----------------
      },
    ],

    branch: { type: String, default: "Headquarters" },

    // Track who created it (Manager or Admin)
    createdBy: { type: mongoose.Schema.Types.ObjectId, ref: "User" },
  },
  {
    timestamps: true,
  }
);

module.exports = mongoose.model("Event", eventSchema);


--- FILE: server/models/Inventory.js ---
const mongoose = require("mongoose");

const inventorySchema = mongoose.Schema(
  {
    itemName: { type: String, required: true },

    category: {
      type: String,
      enum: ["Food", "Non-Food", "Medical", "General"],
      required: true,
    }, // KSS_INV_1, KSS_INV_2

    isPerishable: { type: Boolean, default: false }, // KSS_INV_3 (Track perishables)
    expiryDate: { type: Date }, // Only for perishable items

    quantity: { type: Number, required: true, default: 0 },
    unit: { type: String, required: true }, // e.g., kg, liters, pieces, bags

    minStockLevel: { type: Number, default: 10 }, // Alert when stock is low

    branch: { type: String, required: true, default: "Headquarters" },

    lastUpdatedBy: { type: mongoose.Schema.Types.ObjectId, ref: "User" },
  },
  {
    timestamps: true,
  }
);

module.exports = mongoose.model("Inventory", inventorySchema);


--- FILE: server/models/InventoryAudit.js ---
const mongoose = require("mongoose");

const auditSchema = mongoose.Schema(
  {
    auditDate: { type: Date, default: Date.now },

    items: [
      {
        inventoryItem: {
          type: mongoose.Schema.Types.ObjectId,
          ref: "Inventory",
        },
        itemName: String,
        systemQty: Number, // What the software thought we had
        physicalQty: Number, // What we actually counted
        difference: Number, // Physical - System
        remark: String, // Reason (e.g., "Spoiled", "Theft", "Data Entry Error")
      },
    ],

    branch: { type: String, default: "Headquarters" },
    auditedBy: { type: mongoose.Schema.Types.ObjectId, ref: "User" },
  },
  {
    timestamps: true,
  }
);

module.exports = mongoose.model("InventoryAudit", auditSchema);


--- FILE: server/models/Member.js ---
const mongoose = require("mongoose");

const memberSchema = mongoose.Schema(
  {
    // Personal Details
    firstName: { type: String, required: true },
    lastName: { type: String, required: true },
    phone: { type: String, required: true, unique: true },
    email: { type: String },
    address: { type: String, required: true },

    // Membership Details
    membershipType: {
      type: String,
      enum: ["Annual", "Life", "Patron", "Volunteer"],
      default: "Annual",
    },

    joinDate: { type: Date, default: Date.now },
    validUntil: { type: Date }, // For Annual members

    // Fee Details (KSS_MEM_3)
    feeAmount: { type: Number, default: 0 },
    feeStatus: {
      type: String,
      enum: ["Paid", "Pending", "Waived"],
      default: "Pending",
    },

    // Activity Tracking (KSS_MEM_4)
    activities: [
      {
        eventName: String,
        date: Date,
        role: String, // e.g., "Food Server", "Crowd Control"
      },
    ],

    branch: { type: String, default: "Headquarters" },
    createdBy: { type: mongoose.Schema.Types.ObjectId, ref: "User" },
  },
  {
    timestamps: true,
  }
);

module.exports = mongoose.model("Member", memberSchema);


--- FILE: server/models/Scheme.js ---
const mongoose = require("mongoose");

const schemeSchema = mongoose.Schema(
  {
    name: { type: String, required: true, unique: true },
    description: { type: String },
    accountHead: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "AccountHead",
      required: true, // Every scheme MUST have an accounting code now
    },
    isActive: { type: Boolean, default: true },
  },
  { timestamps: true }
);

module.exports = mongoose.model("Scheme", schemeSchema);


--- FILE: server/models/Student.js ---
const mongoose = require("mongoose");

const studentSchema = mongoose.Schema(
  {
    // --- Personal Details ---
    firstName: { type: String, required: true },
    lastName: { type: String, required: true },
    dob: { type: Date, required: true },
    gender: { type: String, enum: ["Male", "Female"], required: true },
    guardianName: { type: String, required: true }, // KSS_STU_8
    contactNumber: { type: String, required: true },
    address: { type: String, required: true },
    branch: { type: String, required: true },

    // --- Statutory Forms (Checklist KSS_STU_8 to KSS_STU_13) ---
    // We store 'true' if the form is submitted/verified
    formsStatus: {
      form20: { type: Boolean, default: false }, // Undertaking by guardian
      form44: { type: Boolean, default: false }, // Release order
      form37: { type: Boolean, default: false }, // After care placement
      form17: { type: Boolean, default: false }, // Report at production
      form18: { type: Boolean, default: false }, // Order of placement
      form7: { type: Boolean, default: false }, // Individual care plan
    },

    // --- Education & Health (KSS_STU_14) ---
    schoolName: { type: String },
    currentClass: { type: String },
    healthIssues: { type: String },

    // --- The 3-Tier Approval System (KSS_STU_3, 4, 5) ---
    approvals: {
      president: {
        status: {
          type: String,
          enum: ["Pending", "Approved", "Rejected"],
          default: "Pending",
        },
        date: Date,
        remark: String,
      },
      secretary: {
        status: {
          type: String,
          enum: ["Pending", "Approved", "Rejected"],
          default: "Pending",
        },
        date: Date,
        remark: String,
      },
      treasurer: {
        status: {
          type: String,
          enum: ["Pending", "Approved", "Rejected"],
          default: "Pending",
        },
        date: Date,
        remark: String,
      },
    },

    // Overall Status (Only 'Active' if all 3 approve)
    admissionStatus: {
      type: String,
      enum: ["Draft", "In Review", "Active", "Rejected", "Alumni"],
      default: "In Review",
    },

    createdBy: { type: mongoose.Schema.Types.ObjectId, ref: "User" },
    sponsor: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "Donation", // Link to a specific Donor/Donation record
      default: null,
    },

    // --- KSS_STU_14: Education & Health Details ---
    educationHistory: [
      {
        year: String,
        class: String,
        school: String,
        percentage: String,
        remarks: String,
      },
    ],

    healthRecords: [
      {
        date: { type: Date, default: Date.now },
        checkupType: String, // e.g., "General", "Dental"
        doctorName: String,
        observation: String,
      },
    ],

    // --- KSS_STU_7: Expenses ---
    // We can track specific expenses for this student
    expenses: [
      {
        amount: Number,
        description: String, // e.g., "School Fees", "Uniform"
        date: { type: Date, default: Date.now },
      },
    ],
    // --- NEW FIELD: ALUMNI TRACKING (KSS_FUT_1) ---
    alumniDetails: {
      jobTitle: String,
      company: String,
      currentLocation: String,
      email: String,
      phone: String, // Current phone (might differ from guardian contact)
      linkedIn: String,
    },
    // --- NEW FIELD: DOCUMENTS (KSS_STU_11, 12, 16) ---
    documents: [
      {
        type: String, // Stores file path e.g., "/uploads/student-123-aadhar.jpg"
      },
    ],
    // ----------------------------------------------
    leaves: [
      {
        startDate: { type: Date, required: true },
        endDate: { type: Date }, // Estimated return date
        actualReturnDate: { type: Date }, // When they actually came back
        reason: { type: String, required: true },
        status: {
          type: String,
          enum: ["On Leave", "Returned"],
          default: "On Leave",
        },
      },
    ],

    createdBy: { type: mongoose.Schema.Types.ObjectId, ref: "User" },
  },

  {
    timestamps: true,
  }
);

module.exports = mongoose.model("Student", studentSchema);


--- FILE: server/models/User.js ---
const mongoose = require("mongoose");

const userSchema = mongoose.Schema(
  {
    name: {
      type: String,
      required: true,
    },
    email: {
      type: String,
      required: true,
      unique: true, // No duplicate emails
    },
    password: {
      type: String,
      required: true,
    },
    phone: {
      type: String,
      required: true,
    },
    // This is the magic field for your 3 profiles
    role: {
      type: String,
      // enum: ["user", "employee", "admin"],
      enum: [
        "user",
        "employee",
        "admin",
        "president",
        "secretary",
        "treasurer",
      ],
      default: "user", // Everyone starts as a guest user
    },
    // Optional: For employees belonging to a specific branch
    branch: {
      type: String,
      default: "Headquarters",
    },
  },
  {
    timestamps: true,
  }
);

module.exports = mongoose.model("User", userSchema);


--- FILE: server/models/Voucher.js ---
const mongoose = require("mongoose");

const voucherSchema = mongoose.Schema(
  {
    voucherType: {
      type: String,
      enum: ["Debit", "Credit", "Journal"],
      required: true,
    },
    voucherNo: { type: String, required: true, unique: true },
    date: { type: Date, default: Date.now },

    accountHead: { type: String, ref: "AccountHead", required: true }, // e.g., "Vegetables", "Salary"
    amount: { type: Number, required: true },
    description: { type: String },

    paymentMode: {
      type: String,
      enum: ["Cash", "Bank Transfer", "Cheque", "UPI"],
      default: "Cash",
    },

    // Approval Workflow
    status: {
      type: String,
      enum: ["Pending", "Partially Approved", "Approved", "Rejected"],
      default: "Pending",
    },

    preparedBy: { type: mongoose.Schema.Types.ObjectId, ref: "User" },
    // Committee members who approved it (Array allows multiple signatures)
    approvedBy: [{ type: mongoose.Schema.Types.ObjectId, ref: "User" }],
    branch: { type: String, default: "Headquarters" },
  },
  {
    timestamps: true,
  }
);

module.exports = mongoose.model("Voucher", voucherSchema);


--- FILE: server/package.json ---
{
  "name": "server",
  "version": "1.0.0",
  "main": "index.js",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "description": "",
  "dependencies": {
    "bcryptjs": "^3.0.3",
    "cors": "^2.8.5",
    "dotenv": "^17.2.3",
    "express": "^5.2.1",
    "jsonwebtoken": "^9.0.3",
    "mongoose": "^9.0.2",
    "multer": "^2.0.2",
    "nodemailer": "^7.0.11",
    "pdfkit": "^0.17.2"
  },
  "devDependencies": {
    "nodemon": "^3.1.11"
  }
}


--- FILE: server/routes/accountRoutes.js ---
const express = require("express");
const router = express.Router();
const AccountHead = require("../models/AccountHead");
const { protect } = require("../middleware/authMiddleware");

// @desc    Get All Account Heads
// @route   GET /api/accounts
router.get("/", protect, async (req, res) => {
  try {
    const accounts = await AccountHead.find({}).sort({ code: 1 });
    res.json(accounts);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
});

module.exports = router;


--- FILE: server/routes/auditRoutes.js ---
// const express = require("express");
// const router = express.Router();
// const { getSystemLogs } = require("../controllers/auditController");
// const { protect, admin } = require("../middleware/authMiddleware");

// // Only Admin can see the full system trail
// router.get("/system", protect, admin, getSystemLogs);

// module.exports = router;
const express = require("express");
const router = express.Router();
// Import getSystemLogs from the controller
const { getSystemLogs } = require("../controllers/auditController");
const { protect, admin } = require("../middleware/authMiddleware");

// Check if getSystemLogs is undefined (Common error)
if (!getSystemLogs) {
  console.error(
    "Error: getSystemLogs function is missing in auditController export!"
  );
}

router.get("/system", protect, admin, getSystemLogs);

module.exports = router;


--- FILE: server/routes/contactRoutes.js ---
const express = require("express");
const router = express.Router();
const { submitContact } = require("../controllers/contactController");

// When someone sends a POST request to '/', run the submitContact function
router.post("/", submitContact);

module.exports = router;


--- FILE: server/routes/donationRoutes.js ---
// const express = require("express");
// const router = express.Router();
// const {
//   createDonation,
//   getDonations,
// } = require("../controllers/donationController");
// const { protect } = require("../middleware/authMiddleware");

// // Protect these routes so only logged-in users can access
// router.route("/").post(protect, createDonation).get(protect, getDonations);

// module.exports = router;
// const express = require("express");
// const router = express.Router();

// // IMPORTANT: Ensure you are destructuring all 4 functions from the controller
// const {
//   createDonation,
//   getDonations,
//   downloadReceipt,
//   emailReceipt,
// } = require("../controllers/donationController");

// const { protect } = require("../middleware/authMiddleware");

// // Standard Routes
// router.route("/").post(protect, createDonation).get(protect, getDonations);

// // Receipt Routes
// // If downloadReceipt is undefined, the app will crash here
// router.get("/:id/receipt", protect, downloadReceipt);
// router.post("/:id/email", protect, emailReceipt);

// module.exports = router;

const express = require("express");
const router = express.Router();
const multer = require("multer");
const path = require("path");
const {
  createDonation,
  getDonations,
  downloadReceipt,
  emailReceipt,
  createPublicDonation, // <--- Import
  uploadMedia,
  deleteMedia,
  getMyDonations,
} = require("../controllers/donationController");

const { protect } = require("../middleware/authMiddleware");
// --- MULTER CONFIGURATION ---
const storage = multer.diskStorage({
  destination(req, file, cb) {
    cb(null, "uploads/"); // Save to 'uploads' folder
  },
  filename(req, file, cb) {
    // Rename file to: donationID-timestamp.ext
    cb(
      null,
      `${file.fieldname}-${Date.now()}${path.extname(file.originalname)}`
    );
  },
});
// Allow only Images and Videos
const checkFileType = (file, cb) => {
  const filetypes = /jpg|jpeg|png|mp4|mov|pdf/;
  const extname = filetypes.test(path.extname(file.originalname).toLowerCase());
  const mimetype = filetypes.test(file.mimetype);

  if (extname && mimetype) {
    return cb(null, true);
  } else {
    cb("Images, Videos, or PDFs only!");
  }
};

const upload = multer({
  storage,
  fileFilter: function (req, file, cb) {
    checkFileType(file, cb);
  },
});

// 1. Protected Routes (For Admin/Employee Dashboard)
router.route("/").post(protect, createDonation).get(protect, getDonations);

router.get("/:id/receipt", protect, downloadReceipt);
router.post("/:id/email", protect, emailReceipt);

// 2. Public Route (For Guest Website) - NO PROTECT MIDDLEWARE
router.post("/public", createPublicDonation);
// --- NEW UPLOAD ROUTE ---
// Allows uploading up to 5 files at once
router.post("/:id/upload", protect, upload.array("files", 5), uploadMedia);
router.delete("/:id/media", protect, deleteMedia); // <--- Add this
router.get("/my", protect, getMyDonations); // <--- Add this

module.exports = router;


--- FILE: server/routes/eventRoutes.js ---
const express = require("express");
const router = express.Router();
const {
  getEvents,
  createEvent,
  registerForEvent,
  markAttendance,
} = require("../controllers/eventController");
const { protect, staff } = require("../middleware/authMiddleware");

router
  .route("/")
  .get(getEvents) // Public can view
  .post(protect, staff, createEvent); // <--- 'staff' allows Manager AND Admin

router.route("/:id/register").post(registerForEvent); // Public can register
router.put("/:id/attendance", protect, staff, markAttendance);

module.exports = router;


--- FILE: server/routes/financeRoutes.js ---
const express = require("express");
const router = express.Router();
const {
  createVoucher,
  getVouchers,
  approveVoucher,
  downloadVoucherPDF, // Import
  getCashBalance,
  reconcileCash,
} = require("../controllers/financeController");
const { protect, committee } = require("../middleware/authMiddleware");

router
  .route("/vouchers")
  .post(protect, createVoucher)
  .get(protect, getVouchers);

router.route("/vouchers/:id/approve").put(protect, committee, approveVoucher);

// New Route for PDF
router.get("/vouchers/:id/pdf", protect, downloadVoucherPDF);
// Reconciliation Routes
router.get("/cash-balance", protect, getCashBalance);
router.post("/reconcile", protect, reconcileCash);
module.exports = router;


--- FILE: server/routes/inventoryRoutes.js ---
// const express = require("express");
// const router = express.Router();
// const {
//   getInventory,
//   addInventoryItem,
// } = require("../controllers/inventoryController");
// const { protect } = require("../middleware/authMiddleware");

// router.route("/").get(protect, getInventory).post(protect, addInventoryItem);

// module.exports = router;
const express = require("express");
const router = express.Router();
const {
  getInventory,
  addInventoryItem,
} = require("../controllers/inventoryController");
// Import the new controller functions
const {
  createAudit,
  getAudits,
  deleteAudit,
} = require("../controllers/auditController"); // Import deleteAudit
const { protect, admin } = require("../middleware/authMiddleware"); // Import admin middleware
// Existing Routes
router.route("/").get(protect, getInventory).post(protect, addInventoryItem);

// --- NEW AUDIT ROUTES ---
router
  .route("/audit")
  .post(protect, createAudit) // Submit Audit
  .get(protect, getAudits); // View History

router.delete("/audit/:id", protect, admin, deleteAudit);

module.exports = router;


--- FILE: server/routes/memberRoutes.js ---
const express = require("express");
const router = express.Router();
const {
  getMembers,
  createMember,
  addMemberActivity,
} = require("../controllers/memberController");
const { protect, staff } = require("../middleware/authMiddleware");

router
  .route("/")
  .get(protect, staff, getMembers)
  .post(protect, staff, createMember);
router.post("/:id/activity", protect, staff, addMemberActivity);

module.exports = router;


--- FILE: server/routes/reportRoutes.js ---
const express = require("express");
const router = express.Router();
const { getDashboardStats } = require("../controllers/reportController");
const { protect, staff } = require("../middleware/authMiddleware");

// Only Staff (Admin/Manager) can see reports
router.get("/stats", protect, staff, getDashboardStats);

module.exports = router;


--- FILE: server/routes/schemeRoutes.js ---
const express = require("express");
const router = express.Router();
const {
  getSchemes,
  createScheme,
  deleteScheme,
} = require("../controllers/schemeController");
const { protect, admin, staff } = require("../middleware/authMiddleware");

router
  .route("/")
  .get(getSchemes) // Public/Employees can view
  .post(protect, staff, createScheme); // Only Admin can add

router.route("/:id").delete(protect, staff, deleteScheme); // Only Admin can delete

module.exports = router;


--- FILE: server/routes/studentRoutes.js ---
const express = require("express");
const router = express.Router();
const multer = require("multer");
const path = require("path");
const {
  createStudent,
  getStudents,
  approveStudent,
  updateStudent,
  getStudentById,
  deleteStudent,
  uploadDocuments,
  deleteDocument,
  addStudentLeave,
  updateLeaveStatus,
  emailProgressReport,
} = require("../controllers/studentController");
const { protect, admin } = require("../middleware/authMiddleware");
// --- MULTER CONFIG (Same as Donation) ---
const storage = multer.diskStorage({
  destination(req, file, cb) {
    cb(null, "uploads/");
  },
  filename(req, file, cb) {
    cb(null, `STU-${Date.now()}${path.extname(file.originalname)}`);
  },
});

const checkFileType = (file, cb) => {
  const filetypes = /jpg|jpeg|png|pdf|doc|docx/; // Added doc/docx support
  const extname = filetypes.test(path.extname(file.originalname).toLowerCase());
  if (extname) return cb(null, true);
  cb("Images or Documents only!");
};

const upload = multer({
  storage,
  fileFilter: function (req, file, cb) {
    checkFileType(file, cb);
  },
});
// ----------------------------------------

router.route("/").post(protect, createStudent).get(protect, getStudents);

router
  .route("/:id")
  .get(protect, getStudentById)
  .put(protect, updateStudent)
  .delete(protect, admin, deleteStudent); // For updating profile
router.route("/:id/approve").put(protect, approveStudent);
// --- NEW DOCUMENT ROUTES ---
router.post("/:id/upload", protect, upload.array("files", 5), uploadDocuments);
router.delete("/:id/documents", protect, deleteDocument);

// Leave Management Routes
router.post("/:id/leave", protect, addStudentLeave);
router.put("/:id/leave/:leaveId", protect, updateLeaveStatus);
// Email Sponsor Route
router.post("/:id/email-sponsor", protect, emailProgressReport);

module.exports = router;


--- FILE: server/routes/userRoutes.js ---
const express = require("express");
const router = express.Router();
const {
  registerUser,
  loginUser,
  getUserProfile,
  updateUserProfile,
} = require("../controllers/userController");
const { protect } = require("../middleware/authMiddleware");

router.post("/register", registerUser);
router.post("/login", loginUser);
router
  .route("/profile")
  .get(protect, getUserProfile)
  .put(protect, updateUserProfile);

module.exports = router;


--- FILE: server/seeder.js ---
const mongoose = require("mongoose");
const dotenv = require("dotenv");
const bcrypt = require("bcryptjs");
const User = require("./models/User");
const AccountHead = require("./models/AccountHead");
const Scheme = require("./models/Scheme"); // <--- Import Scheme Model
const connectDB = require("./config/db");

dotenv.config();

const importData = async () => {
  try {
    await connectDB();

    const salt = await bcrypt.genSalt(10);
    const hashedPassword = await bcrypt.hash("123456", salt);

    const staffUsers = [
      {
        name: "System Admin",
        email: "admin@karunasri.org",
        password: hashedPassword,
        phone: "9999999999",
        role: "admin",
        branch: "Headquarters",
      },
      {
        name: "Ashram Manager",
        email: "manager@karunasri.org",
        password: hashedPassword,
        phone: "8888888888",
        role: "employee",
        branch: "Saroornagar",
      },
      {
        name: "Trust President",
        email: "president@karunasri.org",
        password: hashedPassword,
        phone: "1111111111",
        role: "president",
        branch: "Headquarters",
      },
      {
        name: "Trust Secretary",
        email: "secretary@karunasri.org",
        password: hashedPassword,
        phone: "2222222222",
        role: "secretary",
        branch: "Headquarters",
      },
      {
        name: "Trust Treasurer",
        email: "treasurer@karunasri.org",
        password: hashedPassword,
        phone: "3333333333",
        role: "treasurer",
        branch: "Headquarters",
      },
    ];

    console.log("Checking for staff accounts...");

    for (const user of staffUsers) {
      const userExists = await User.findOne({ email: user.email });
      if (userExists) {
        console.log(`Skipping: ${user.name} (${user.email}) already exists.`);
      } else {
        await User.create(user);
        console.log(`Created: ${user.name} (${user.email})`);
      }
    }

    console.log("Seeding Account Codes...");
    await AccountHead.deleteMany();
    const accountCodes = [
      { code: "201", name: "NITYA ANNADHANAMU NIDHI", type: "Credit" },
      { code: "202", name: "SHASWITHA ANNADHANAMU NIDHI", type: "Credit" },
      { code: "203", name: "VIDYARTHI PATASHALA RUSUMU NIDHI", type: "Credit" },
      { code: "204", name: "VIDYARTHI POSHAKA NIDHI", type: "Credit" },
      { code: "205", name: "INTEREST RECEIVED", type: "Credit" },
      { code: "206", name: "DONATIONS", type: "Credit" },
      { code: "207", name: "KARUNYA BHARATHI BUILDING FUND", type: "Credit" },
      { code: "208", name: "VIDYARTHI KAUSHALYA NIDHI", type: "Credit" },
      { code: "209", name: "SAMAJA SEVA KARYAKRAMALA NIDHI", type: "Credit" },
      { code: "210", name: "INCOME TAX REFUND", type: "Credit" },
      { code: "220", name: "CORPUS FUND", type: "Credit" },
      { code: "230", name: "RESERVES & SURPLUS", type: "Credit" },
      { code: "10", name: "SALARIES WARDEN & CLERK", type: "Debit" },
      { code: "11", name: "SALARIES COOK", type: "Debit" },
      { code: "12", name: "SALARIES TUTORS", type: "Debit" },
      { code: "20", name: "MESS EXPENSES - VEGETABLES", type: "Debit" },
      { code: "21", name: "MESS EXPENSES - LPG", type: "Debit" },
      { code: "22", name: "MESS EXPENSES - MILK", type: "Debit" },
      { code: "23", name: "MESS EXPENSES - KIRANA ITEMS", type: "Debit" },
      { code: "30", name: "ADMIN EXPENSES - ELECTRICITY BILLS", type: "Debit" },
      {
        code: "31",
        name: "ADMIN EXPENSES - REPAIRS & MAINTENANCE",
        type: "Debit",
      },
      { code: "32", name: "ADMIN EXPENSES - PETROL", type: "Debit" },
      { code: "33", name: "ADMIN EXPENSES - CONVEYANCE", type: "Debit" },
      {
        code: "34",
        name: "ADMIN EXPENSES - POSTAGE/MOBILE/INTERNET",
        type: "Debit",
      },
      {
        code: "35",
        name: "ADMIN EXPENSES - PRINTING BULLETINS",
        type: "Debit",
      },
      { code: "36", name: "ADMIN EXPENSES - PRINTING GENERAL", type: "Debit" },
      { code: "37", name: "ADMIN EXPENSES - STATIONERY", type: "Debit" },
      { code: "38", name: "ADMIN EXPENSES - BANK CHARGES", type: "Debit" },
      { code: "39", name: "ADMIN EXPENSES - MEETINGS", type: "Debit" },
      {
        code: "40",
        name: "EDUCATIONAL - SCHOOL & COLLEGE FEES",
        type: "Debit",
      },
      { code: "41", name: "EDUCATIONAL - BUS PASSES", type: "Debit" },
      { code: "42", name: "EDUCATIONAL - EXAM FEES", type: "Debit" },
      { code: "43", name: "EDUCATIONAL - BOOKS & STATIONERY", type: "Debit" },
      { code: "44", name: "EDUCATIONAL - TRAINING PROGRAMMES", type: "Debit" },
      { code: "50", name: "MEDICAL EXPENSES", type: "Debit" },
      { code: "51", name: "MAJOR BUILDING RENOVATION", type: "Debit" },
      { code: "60", name: "DEPRECIATION", type: "Debit" },
      { code: "61", name: "PUJAS/FESTIVALS/HOLY FUNCTIONS", type: "Debit" },
      { code: "100", name: "CASH", type: "Debit" },
      { code: "101", name: "BANK BALANCE TSCOB", type: "Debit" },
      { code: "102", name: "BANK BALANCE SBI", type: "Debit" },
      { code: "103", name: "BANK BALANCE BOB", type: "Debit" },
    ];

    await AccountHead.insertMany(accountCodes);
    console.log("Account Codes Imported!");

    console.log("--- Seeding Schemes ---");
    await Scheme.deleteMany(); // Reset Schemes

    // Helper to find ID by Code
    const getCodeId = async (code) => {
      const acc = await AccountHead.findOne({ code });
      return acc ? acc._id : null;
    };

    // List of Schemes to Create (Based on PDF Credit Side)
    // We exclude things like "Interest Received" or "Tax Refund" as they are not user-selectable schemes
    const schemesToSeed = [
      { name: "Nitya Annadhana Nidhi", code: "201" },
      { name: "Shasvitha Annadhana Nidhi", code: "202" },
      { name: "Vidyarthi Pathashala Rusumu Nidhi", code: "203" },
      { name: "Vidyarthi Poshaka Nidhi", code: "204" },
      { name: "General Donations", code: "206" },
      { name: "Karunya Bharathi Building Fund", code: "207" },
      { name: "Vidyarthi Kaushalya Nidhi", code: "208" },
      { name: "Samaja Seva Karyakramala Nidhi", code: "209" },
      { name: "Corpus Fund", code: "220" },
    ];

    for (const s of schemesToSeed) {
      const accId = await getCodeId(s.code);
      if (accId) {
        await Scheme.create({
          name: s.name,
          description: `Donation towards ${s.name}`,
          accountHead: accId,
          isActive: true,
        });
        console.log(`Created Scheme: ${s.name} -> Code ${s.code}`);
      } else {
        console.log(`Skipped Scheme ${s.name} (Code ${s.code} not found)`);
      }
    }

    console.log("Seeding Process Complete!");
    process.exit(0);
  } catch (error) {
    console.error(`Error: ${error.message}`);
    process.exit(1);
  }
};

importData();


--- FILE: server/server.js ---
// const express = require("express");
// const dotenv = require("dotenv");
// const cors = require("cors");
// const connectDB = require("./config/db");

// // Load config
// dotenv.config();

// // Connect to Database
// connectDB();

// const app = express();

// // Middleware
// app.use(cors()); // Allows frontend to connect
// app.use(express.json()); // Allows us to parse JSON data sent from frontend

// // Basic Route (Test if server is running)
// app.get("/", (req, res) => {
//   res.send("Karunasri Backend is Running...");
// });

// // Define Port
// const PORT = process.env.PORT || 5000;

// app.listen(PORT, () => {
//   console.log(`Server running in ${process.env.NODE_ENV} mode on port ${PORT}`);
// });
const express = require("express");
const dotenv = require("dotenv");
const cors = require("cors");
const connectDB = require("./config/db");
const path = require("path"); // <--- Import path

// Import Routes
const contactRoutes = require("./routes/contactRoutes"); // <--- ADD THIS
const userRoutes = require("./routes/userRoutes");
const donationRoutes = require("./routes/donationRoutes"); // <--- Import this
const studentRoutes = require("./routes/studentRoutes"); // <--- Import
const inventoryRoutes = require("./routes/inventoryRoutes"); // <--- Import
const financeRoutes = require("./routes/financeRoutes"); // Import
const eventRoutes = require("./routes/eventRoutes"); // Import
const reportRoutes = require("./routes/reportRoutes"); // Import
const memberRoutes = require("./routes/memberRoutes"); // Import
const schemeRoutes = require("./routes/schemeRoutes"); // Import
const auditRoutes = require("./routes/auditRoutes"); // Import
const accountRoutes = require("./routes/accountRoutes"); // Import

dotenv.config();
connectDB();

const app = express();

app.use(cors());
app.use(express.json());
app.use("/uploads", express.static(path.join(__dirname, "uploads")));

// Routes
app.use("/api/contact", contactRoutes); // <--- ADD THIS
app.use("/api/users", userRoutes);
app.use("/api/donations", donationRoutes); // <--- Add this line
app.use("/api/schemes", schemeRoutes); // <--- Add this
app.use("/api/students", studentRoutes); // <--- Add this
app.use("/api/inventory", inventoryRoutes); // <--- Add this
app.use("/api/finance", financeRoutes); // <--- Add this line
app.use("/api/events", eventRoutes); // Add this
app.use("/api/reports", reportRoutes); // <--- Add this
app.use("/api/members", memberRoutes); // <--- Add this
app.use("/api/audit", auditRoutes); // Add this
app.use("/api/accounts", accountRoutes); // Add this
app.get("/", (req, res) => {
  res.send("Karunasri Backend is Running...");
});

const PORT = process.env.PORT || 5000;
app.listen(PORT, () => console.log(`Server running on port ${PORT}`));


--- FILE: server/utils/auditLogger.js ---
const AuditLog = require("../models/AuditLog");

const logAudit = async (req, action, module, recordId, details) => {
  try {
    // If no user is logged in (e.g. public donation), we log as 'System' or 'Guest'
    const userId = req.user ? req.user._id : null;
    const userName = req.user ? req.user.name : "Guest/System";
    const ip = req.headers["x-forwarded-for"] || req.connection.remoteAddress;

    await AuditLog.create({
      user: userId, // Might be null for public actions
      userName: userName,
      action,
      module,
      recordId: recordId ? recordId.toString() : null,
      details,
      ipAddress: ip,
    });

    console.log(`[AUDIT] ${action} on ${module} by ${userName}`);
  } catch (error) {
    console.error("Audit Log Failed:", error.message);
    // We don't stop the main process if logging fails
  }
};

module.exports = { logAudit };


--- FILE: server/utils/generatePDF.js ---
// const PDFDocument = require("pdfkit");
// const fs = require("fs");

// const buildReceipt = (donation, dataCallback, endCallback) => {
//   const doc = new PDFDocument({ size: "A4", margin: 50 });

//   doc.on("data", dataCallback);
//   doc.on("end", endCallback);

//   // --- 1. Header ---
//   doc
//     .fillColor("#581818") // Maroon
//     .fontSize(20)
//     .text("KARUNASRI SEVA SAMITHI", { align: "center" })
//     .fontSize(10)
//     .text("Plot No. 123, Temple Road, Saroornagar, Hyderabad - 500035", {
//       align: "center",
//     })
//     .text(
//       "Reg No: 123/2024 | Email: info@karunasri.org | Phone: +91 99220 03000",
//       { align: "center" }
//     )
//     .moveDown();

//   // Draw a line
//   doc
//     .moveTo(50, 130)
//     .lineTo(550, 130)
//     .strokeColor("#DAA520")
//     .lineWidth(2)
//     .stroke();

//   // --- 2. Receipt Title ---
//   doc
//     .moveDown()
//     .fillColor("#000000")
//     .fontSize(16)
//     .text("DONATION RECEIPT", { align: "center", underline: true })
//     .moveDown();

//   // --- 3. Receipt Details (Grid Layout) ---
//   const startY = 200;

//   doc
//     .fontSize(12)
//     .text(
//       `Receipt No: ${donation._id.toString().slice(-6).toUpperCase()}`,
//       50,
//       startY
//     );
//   doc.text(
//     `Date: ${new Date(donation.createdAt).toLocaleDateString()}`,
//     400,
//     startY
//   );

//   doc.moveDown();
//   doc.text(`Received with thanks from:`, 50, startY + 30);
//   doc.font("Helvetica-Bold").text(donation.donorName, 200, startY + 30);

//   doc.font("Helvetica").text(`Phone Number:`, 50, startY + 50);
//   doc.text(donation.donorPhone, 200, startY + 50);

//   if (donation.donorPan) {
//     doc.text(`PAN Number:`, 50, startY + 70);
//     doc.text(donation.donorPan, 200, startY + 70);
//   }

//   doc.text(`Sum of Rupees:`, 50, startY + 100);
//   doc
//     .font("Helvetica-Bold")
//     .fontSize(14)
//     .text(`Rs. ${donation.amount.toLocaleString()}/-`, 200, startY + 100);

//   doc
//     .font("Helvetica")
//     .fontSize(12)
//     .text(`Towards Scheme:`, 50, startY + 130);
//   doc.text(donation.scheme, 200, startY + 130);

//   doc.text(`Payment Mode:`, 50, startY + 150);
//   doc.text(donation.paymentMode, 200, startY + 150);

//   // --- 4. 80G Statement ---
//   doc.moveDown(4);
//   doc
//     .rect(50, 450, 500, 60) // Box
//     .fillAndStroke("#f0f0f0", "#000000"); // Light grey background

//   doc
//     .fillColor("#000000")
//     .text(
//       "Donations to Karunasri Seva Samithi are exempt from Income Tax under Section 80G of the Income Tax Act, 1961. URN: AAATE1234EF20214",
//       60,
//       465,
//       { width: 480, align: "center" }
//     );

//   // --- 5. Footer / Signature ---
//   doc.moveDown(4);
//   doc.text("Authorized Signatory", 400, 600);
//   doc.text("(Karunasri Seva Samithi)", 380, 615);

//   doc.end();
// };

// module.exports = { buildReceipt };
const PDFDocument = require("pdfkit");
const fs = require("fs");
const path = require("path");

const buildReceipt = (donation, dataCallback, endCallback) => {
  const doc = new PDFDocument({ size: "A4", margin: 50 });

  doc.on("data", dataCallback);
  doc.on("end", endCallback);

  // --- 1. ADD LOGO ---
  const logoPath = path.join(__dirname, "..", "logo.jpg"); // Look for logo.png in server folder

  if (fs.existsSync(logoPath)) {
    // Image(path, x, y, options)
    doc.image(logoPath, 50, 45, { width: 70 });
  }

  // --- 2. Header Text (Shifted Right to make room for logo) ---
  doc
    .fillColor("#581818") // Maroon
    .fontSize(20)
    .text("KARUNASRI SEVA SAMITHI", 130, 50, { align: "left" }) // Adjusted X position
    .fontSize(10)
    .text(
      "Plot No. 123, Temple Road, Saroornagar, Hyderabad - 500035",
      130,
      75,
      { align: "left" }
    )
    .text("Reg No: 123/2024 | Email: info@karunasri.org", 130, 90, {
      align: "left",
    });

  // Draw a line
  doc
    .moveTo(50, 130)
    .lineTo(550, 130)
    .strokeColor("#DAA520")
    .lineWidth(2)
    .stroke();

  // --- 3. Receipt Title ---
  doc
    .moveDown(3) // Move cursor down
    .fillColor("#000000")
    .fontSize(16)
    .text("DONATION RECEIPT", 50, 150, { align: "center", underline: true });

  // --- 4. Receipt Details ---
  const startY = 200;

  doc
    .fontSize(12)
    .text(
      `Receipt No: ${donation._id.toString().slice(-6).toUpperCase()}`,
      50,
      startY
    );
  doc.text(
    `Date: ${new Date(donation.createdAt).toLocaleDateString()}`,
    400,
    startY
  );

  doc.text(`Received with thanks from:`, 50, startY + 30);
  doc.font("Helvetica-Bold").text(donation.donorName, 200, startY + 30);

  doc.font("Helvetica").text(`Phone Number:`, 50, startY + 50);
  doc.text(donation.donorPhone, 200, startY + 50);

  if (donation.donorPan) {
    doc.text(`PAN Number:`, 50, startY + 70);
    doc.text(donation.donorPan, 200, startY + 70);
  }

  // Handle Aadhaar (KSS_DON_8)
  if (donation.donorAadhaar) {
    doc.text(`Aadhaar Number:`, 50, startY + 90);
    doc.text(donation.donorAadhaar, 200, startY + 90);
  }

  const amountY = donation.donorAadhaar ? startY + 120 : startY + 100;

  doc.text(`Sum of Rupees:`, 50, amountY);
  doc
    .font("Helvetica-Bold")
    .fontSize(14)
    .text(`Rs. ${donation.amount.toLocaleString()}/-`, 200, amountY);

  doc
    .font("Helvetica")
    .fontSize(12)
    .text(`Towards Scheme:`, 50, amountY + 30);
  doc.text(donation.scheme, 200, amountY + 30);

  doc.text(`Payment Mode:`, 50, amountY + 50);
  doc.text(donation.paymentMode, 200, amountY + 50);

  // --- 5. 80G Statement ---
  doc
    .rect(50, 480, 500, 60) // Box
    .fillAndStroke("#f0f0f0", "#000000");

  doc
    .fillColor("#000000")
    .text(
      "Donations to Karunasri Seva Samithi are exempt from Income Tax under Section 80G of the Income Tax Act, 1961.",
      60,
      495,
      { width: 480, align: "center" }
    );

  // --- 6. Footer ---
  doc.text("Authorized Signatory", 400, 650);
  doc.text("(Karunasri Seva Samithi)", 380, 665);

  doc.end();
};

module.exports = { buildReceipt };


--- FILE: server/utils/generateProgressPDF.js ---
const PDFDocument = require("pdfkit");
const fs = require("fs");
const path = require("path");

const buildProgressPDF = (student, dataCallback, endCallback) => {
  const doc = new PDFDocument({ size: "A4", margin: 50 });

  doc.on("data", dataCallback);
  doc.on("end", endCallback);

  // --- 1. HEADER & LOGO ---
  const logoPath = path.join(__dirname, "..", "logo.jpg");
  if (fs.existsSync(logoPath)) {
    doc.image(logoPath, 50, 45, { width: 60 });
  }

  doc
    .fillColor("#581818")
    .fontSize(20)
    .text("KARUNASRI SEVA SAMITHI", 120, 50, { align: "left" })
    .fontSize(10)
    .text("Student Progress Report", 120, 75, { align: "left" });

  doc
    .moveTo(50, 100)
    .lineTo(550, 100)
    .strokeColor("#DAA520")
    .lineWidth(2)
    .stroke();

  // --- 2. STUDENT DETAILS ---
  doc.moveDown(3);
  doc.fillColor("black").fontSize(12);

  doc
    .font("Helvetica-Bold")
    .text(`Name: ${student.firstName} ${student.lastName}`);
  doc
    .font("Helvetica")
    .text(`Date of Birth: ${new Date(student.dob).toLocaleDateString()}`);
  doc.text(`Branch: ${student.branch}`);

  if (student.sponsor) {
    doc.text(`Sponsored By: ${student.sponsor.donorName}`);
  }

  doc.moveDown(2);

  // --- 3. ACADEMIC PROGRESS ---
  doc
    .font("Helvetica-Bold")
    .fontSize(14)
    .text("Academic Performance", { underline: true });
  doc.moveDown(0.5);

  // Simple Table Header
  let y = doc.y;
  doc.fontSize(10).font("Helvetica-Bold");
  doc.text("Year", 50, y);
  doc.text("Class", 150, y);
  doc.text("School", 250, y);
  doc.text("Percentage", 450, y);

  doc
    .moveTo(50, y + 15)
    .lineTo(550, y + 15)
    .stroke();
  y += 25;

  // Table Rows
  doc.font("Helvetica");
  if (student.educationHistory && student.educationHistory.length > 0) {
    student.educationHistory.forEach((edu) => {
      doc.text(edu.year, 50, y);
      doc.text(edu.class, 150, y);
      doc.text(edu.school, 250, y);
      doc.text(edu.percentage + "%", 450, y);
      y += 20;
    });
  } else {
    doc.text("No academic records available yet.", 50, y);
    y += 20;
  }

  doc.moveDown(2);
  y = doc.y;

  // --- 4. HEALTH UPDATE ---
  doc
    .font("Helvetica-Bold")
    .fontSize(14)
    .text("Health & Well-being", 50, y, { underline: true });
  doc.moveDown(0.5);

  y = doc.y;
  doc.fontSize(10).font("Helvetica-Bold");
  doc.text("Date", 50, y);
  doc.text("Checkup Type", 150, y);
  doc.text("Observation", 300, y);

  doc
    .moveTo(50, y + 15)
    .lineTo(550, y + 15)
    .stroke();
  y += 25;

  doc.font("Helvetica");
  if (student.healthRecords && student.healthRecords.length > 0) {
    student.healthRecords.forEach((h) => {
      doc.text(new Date(h.date).toLocaleDateString(), 50, y);
      doc.text(h.checkupType, 150, y);
      doc.text(h.observation, 300, y);
      y += 20;
    });
  } else {
    doc.text("No health issues recorded. Student is healthy.", 50, y);
  }

  // --- 5. FOOTER ---
  doc.moveDown(4);
  doc.fontSize(10).font("Helvetica-Oblique");
  doc.text(
    "Thank you for your continued support in shaping this child's future.",
    { align: "center" }
  );

  doc.end();
};

module.exports = { buildProgressPDF };


--- FILE: server/utils/generateVoucherPDF.js ---
const PDFDocument = require("pdfkit");
const fs = require("fs");
const path = require("path");

const buildVoucherPDF = (voucher, dataCallback, endCallback) => {
  const doc = new PDFDocument({ size: "A5", layout: "landscape", margin: 30 });

  doc.on("data", dataCallback);
  doc.on("end", endCallback);

  // --- 1. LOGO & HEADER ---
  const logoPath = path.join(__dirname, "..", "logo.jpg");
  if (fs.existsSync(logoPath)) {
    doc.image(logoPath, 30, 20, { width: 50 });
  }

  doc
    .fontSize(18)
    .fillColor("#581818")
    .text("KARUNASRI SEVA SAMITHI", 0, 30, { align: "center" });
  doc
    .fontSize(10)
    .text("Saroornagar, Hyderabad - 500035", 0, 55, { align: "center" });
  doc.moveDown();

  // --- 2. TITLE ---
  const title =
    voucher.voucherType === "Debit" ? "PAYMENT VOUCHER" : "RECEIPT VOUCHER";
  doc
    .fontSize(14)
    .fillColor("black")
    .text(title, 0, 80, { align: "center", underline: true });

  // --- 3. DETAILS ---
  const startY = 120;
  doc.fontSize(11).text(`Voucher No: ${voucher.voucherNo}`, 30, startY);
  doc.text(
    `Date: ${new Date(voucher.createdAt).toLocaleDateString()}`,
    450,
    startY
  );

  // Account Code Display
  const accCode = voucher.accountHead ? voucher.accountHead.code : "---";
  const accName = voucher.accountHead
    ? voucher.accountHead.name
    : "Unknown Ledger";

  doc.text(`Account Head:`, 30, startY + 30);
  doc.font("Helvetica-Bold").text(`${accCode} - ${accName}`, 150, startY + 30);

  doc.font("Helvetica").text(`Amount:`, 30, startY + 55);
  doc
    .font("Helvetica-Bold")
    .text(`Rs. ${voucher.amount.toLocaleString()}/-`, 150, startY + 55);

  doc.font("Helvetica").text(`Narration:`, 30, startY + 80);
  doc.text(voucher.description || "-", 150, startY + 80);

  doc.text(`Payment Mode:`, 30, startY + 105);
  doc.text(voucher.paymentMode, 150, startY + 105);

  // --- 4. SIGNATURES (Requirement: Warden + 2 Committee) ---
  const sigY = 320;
  doc.fontSize(9);

  // Warden (Prepared By)
  doc.text("Prepared By:", 30, sigY - 15);
  doc
    .font("Helvetica-Bold")
    .text(voucher.preparedBy ? voucher.preparedBy.name : "Warden", 30, sigY);
  doc.font("Helvetica").text("(Warden/Accountant)", 30, sigY + 12);

  // Receiver
  doc.text("Receiver's Signature", 200, sigY);

  // Approvers
  doc.text("Authorized Signatories:", 400, sigY - 15);

  // List names of people who clicked approve
  if (voucher.approvedBy && voucher.approvedBy.length > 0) {
    const names = voucher.approvedBy.map((u) => u.name).join(" & ");
    doc.font("Helvetica-Bold").text(names, 400, sigY, { width: 180 });
  } else {
    doc.text("(Pending Approval)", 400, sigY);
  }

  doc.end();
};

module.exports = { buildVoucherPDF };


--- FILE: server/utils/generateVoucherPDF1.js ---
// const PDFDocument = require("pdfkit");

// const buildVoucherPDF = (voucher, dataCallback, endCallback) => {
//   const doc = new PDFDocument({ size: "A5", layout: "landscape", margin: 30 }); // A5 Landscape is standard for vouchers

//   doc.on("data", dataCallback);
//   doc.on("end", endCallback);

//   // --- Header ---
//   doc
//     .fontSize(18)
//     .fillColor("#581818")
//     .text("KARUNASRI SEVA SAMITHI", { align: "center" });
//   doc.fontSize(10).text("Saroornagar, Hyderabad - 500035", { align: "center" });
//   doc.moveDown();

//   // --- Title ---
//   const title =
//     voucher.voucherType === "Debit" ? "PAYMENT VOUCHER" : "RECEIPT VOUCHER";
//   doc
//     .fontSize(14)
//     .fillColor("black")
//     .text(title, { align: "center", underline: true });
//   doc.moveDown();

//   // --- Details Box ---
//   const startY = 100;

//   // Left Side
//   doc.fontSize(11).text(`Voucher No: ${voucher.voucherNo}`, 30, startY);
//   doc.text(
//     `Date: ${new Date(voucher.createdAt).toLocaleDateString()}`,
//     400,
//     startY
//   );

//   doc.moveDown();
//   doc.text(`Paid To / Received From:`, 30, startY + 30);
//   doc.font("Helvetica-Bold").text(voucher.ledgerName, 180, startY + 30);

//   doc.font("Helvetica").text(`Sum of Rupees:`, 30, startY + 55);
//   doc
//     .font("Helvetica-Bold")
//     .text(`Rs. ${voucher.amount.toLocaleString()}/-`, 180, startY + 55);

//   doc.font("Helvetica").text(`Towards:`, 30, startY + 80);
//   doc.text(voucher.description || "General Expense", 180, startY + 80);

//   doc.text(`Payment Mode:`, 30, startY + 105);
//   doc.text(voucher.paymentMode, 180, startY + 105);

//   // --- Footer Signatures ---
//   doc.moveDown(5);
//   const sigY = 300;

//   doc.fontSize(10);
//   doc.text("Prepared By", 50, sigY);
//   doc.text("Receiver's Signature", 250, sigY);
//   doc.text("Authorized Signatory", 450, sigY);

//   doc.end();
// };

// module.exports = { buildVoucherPDF };
const PDFDocument = require("pdfkit");
const fs = require("fs");
const path = require("path");

const buildVoucherPDF = (voucher, dataCallback, endCallback) => {
  const doc = new PDFDocument({ size: "A5", layout: "landscape", margin: 30 });

  doc.on("data", dataCallback);
  doc.on("end", endCallback);

  // --- 1. ADD LOGO ---
  const logoPath = path.join(__dirname, "..", "logo.png");
  if (fs.existsSync(logoPath)) {
    doc.image(logoPath, 30, 20, { width: 50 });
  }

  // --- 2. Header ---
  doc
    .fontSize(18)
    .fillColor("#581818")
    .text("KARUNASRI SEVA SAMITHI", 0, 30, { align: "center" });
  doc
    .fontSize(10)
    .text("Saroornagar, Hyderabad - 500035", 0, 55, { align: "center" });
  doc.moveDown();

  // --- 3. Title ---
  const title =
    voucher.voucherType === "Debit" ? "PAYMENT VOUCHER" : "RECEIPT VOUCHER";
  doc
    .fontSize(14)
    .fillColor("black")
    .text(title, 0, 80, { align: "center", underline: true });

  // --- 4. Details ---
  const startY = 120;

  doc.fontSize(11).text(`Voucher No: ${voucher.voucherNo}`, 30, startY);
  doc.text(
    `Date: ${new Date(voucher.createdAt).toLocaleDateString()}`,
    450,
    startY
  );

  doc.text(`Account Head:`, 30, startY + 30);
  // Need to handle if accountHead is populated or not
  const accName = voucher.accountHead ? voucher.accountHead.name : "General";
  const accCode = voucher.accountHead ? voucher.accountHead.code : "";
  doc.font("Helvetica-Bold").text(`${accCode} - ${accName}`, 150, startY + 30);

  doc.font("Helvetica").text(`Amount:`, 30, startY + 55);
  doc
    .font("Helvetica-Bold")
    .text(`Rs. ${voucher.amount.toLocaleString()}/-`, 150, startY + 55);

  doc.font("Helvetica").text(`Narration:`, 30, startY + 80);
  doc.text(voucher.description || "-", 150, startY + 80);

  doc.text(`Payment Mode:`, 30, startY + 105);
  doc.text(voucher.paymentMode, 150, startY + 105);

  // --- 5. Signatures ---
  const sigY = 320;
  doc.fontSize(10);

  // Prepared By (Warden)
  doc.text("Prepared By:", 50, sigY - 15);
  doc.text(voucher.preparedBy ? voucher.preparedBy.name : "Warden", 50, sigY);

  doc.text("Receiver's Signature", 250, sigY);

  // Approved By (Committee)
  doc.text("Approved By:", 450, sigY - 15);
  if (voucher.approvedBy && voucher.approvedBy.length > 0) {
    doc.text("Committee Member", 450, sigY);
  } else {
    doc.text("(Pending)", 450, sigY);
  }

  doc.end();
};

module.exports = { buildVoucherPDF };


--- FILE: client/src/App.css ---
#root {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}
.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}
.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

.card {
  padding: 2em;
}

.read-the-docs {
  color: #888;
}


--- FILE: client/src/App.jsx ---
// import React from "react";
// import { Routes, Route } from "react-router-dom";
// import Header from "./components/Header";
// import Home from "./pages/Home";
// import Footer from "./components/Footer";
// import About from "./pages/About";
// import Activities from "./pages/Activities"; // Import
// import Events from "./pages/Events";
// import Contact from "./pages/Contact"; // <--- Import
// import Donate from "./pages/Donate"; // <--- Import
// import Login from "./pages/Login";
// import Register from "./pages/Register";

// // We will create these placeholders later

// function App() {
//   return (
//     <div className="d-flex flex-column min-vh-100">
//       {/* Header stays at top */}
//       <Header />

//       {/* Main Content Area */}
//       <main className="flex-grow-1">
//         <Routes>
//           <Route path="/" element={<Home />} />
//           <Route path="/about-us" element={<About />} />
//           <Route path="/login" element={<Login />} />
//           <Route path="/donate" element={<Donate />} />
//           <Route path="/activities" element={<Activities />} />
//           <Route path="/events" element={<Events />} />
//           <Route path="/contact" element={<Contact />} />
//           <Route path="/donate" element={<Donate />} />
//           <Route path="/login" element={<Login />} />
//           <Route path="/register" element={<Register />} />

//           {/* Add more routes here later */}
//         </Routes>
//       </main>
//       <Footer />
//     </div>
//   );
// }

// export default App;
import React from "react";
import { Routes, Route, Outlet } from "react-router-dom";

// --- Components ---
import Header from "./components/Header";
import Footer from "./components/Footer";
import DashboardLayout from "./components/DashboardLayout"; // The Sidebar Layout
import DonationList from "./pages/admin/DonationList"; // <--- Import this

// --- Public Pages ---
import Home from "./pages/Home";
import About from "./pages/About";
import Activities from "./pages/Activities";
import Events from "./pages/Events";
import Contact from "./pages/Contact";
import Donate from "./pages/Donate";
import Login from "./pages/Login";
import Register from "./pages/Register";

// --- Admin/Dashboard Pages ---
import DashboardHome from "./pages/admin/DashboardHome";
import StudentList from "./pages/admin/StudentList";
import InventoryList from "./pages/admin/InventoryList";
import FinanceList from "./pages/admin/FinanceList";
import EventList from "./pages/admin/EventList";
import Reports from "./pages/admin/Reports";
import MemberList from "./pages/admin/MemberList";
import StockAudit from "./pages/admin/StockAudit";
import AuditHistory from "./pages/admin/AuditHistory";
import StudentProfile from "./pages/admin/StudentProfile";
import SchemeManager from "./pages/admin/SchemeManager";
import SystemAudit from "./pages/admin/SystemAudit";
import CashReconciliation from "./pages/admin/CashReconciliation";
import UserProfile from "./pages/UserProfile";
import DonationHistory from "./pages/DonationHistory";

// --- Layout Wrapper for Public Pages ---
// This ensures Header and Footer only appear on public pages, not the dashboard
const PublicLayout = () => {
  return (
    <div className="d-flex flex-column min-vh-100">
      <Header />
      <main className="flex-grow-1">
        <Outlet /> {/* This renders the child page (Home, About, etc.) */}
      </main>
      <Footer />
    </div>
  );
};

function App() {
  return (
    <Routes>
      {/* 1. PUBLIC ROUTES GROUP */}
      <Route element={<PublicLayout />}>
        <Route path="/" element={<Home />} />
        <Route path="/about-us" element={<About />} />
        <Route path="/activities" element={<Activities />} />
        <Route path="/events" element={<Events />} />
        <Route path="/contact" element={<Contact />} />
        <Route path="/donate" element={<Donate />} />
        <Route path="/login" element={<Login />} />
        <Route path="/register" element={<Register />} />
        <Route path="/profile" element={<UserProfile />} />
        <Route path="/history" element={<DonationHistory />} />
      </Route>

      {/* 2. DASHBOARD ROUTES GROUP */}
      {/* All paths starting with /dashboard will use the Sidebar Layout */}
      <Route path="/dashboard" element={<DashboardLayout />}>
        {/* Default page when you go to /dashboard */}
        <Route index element={<DashboardHome />} />
        <Route path="donations" element={<DonationList />} />
        <Route path="students" element={<StudentList />} />
        <Route path="students/:id" element={<StudentProfile />} />{" "}
        <Route path="inventory" element={<InventoryList />} />
        <Route path="finance" element={<FinanceList />} />
        <Route path="events" element={<EventList />} />
        <Route path="reports" element={<Reports />} />
        <Route path="members" element={<MemberList />} />
        <Route path="inventory/audit" element={<StockAudit />} />{" "}
        <Route path="inventory/history" element={<AuditHistory />} />{" "}
        <Route path="settings" element={<SchemeManager />} />{" "}
        <Route path="audit" element={<SystemAudit />} />
        <Route path="finance/reconcile" element={<CashReconciliation />} />{" "}
        {/* New Route */}
        {/* Admin Settings */}
        {/* New Route */}
        {/* New Route */}
        {/* FUTURE SCREENS WILL GO HERE: */}
        {/* <Route path="donations" element={<DonationList />} /> */}
        {/* <Route path="students" element={<StudentList />} /> */}
      </Route>
    </Routes>
  );
}

export default App;


--- FILE: client/src/components/DashboardLayout.css ---
/* --- Main Container --- */
.dashboard-container {
  display: flex;
  min-height: 100vh;
  background-color: #f4f6f9; /* Light Grey Background for content */
  font-family: "Lato", sans-serif;
}

/* --- Sidebar Styling --- */
.sidebar {
  width: 260px;
  background-color: #2c0b0b; /* Deep Maroon */
  color: white;
  display: flex;
  flex-direction: column;
  position: fixed; /* Fixed on the left */
  height: 100vh;
  overflow-y: auto;
  z-index: 1000;
  box-shadow: 4px 0 10px rgba(0, 0, 0, 0.1);
}

.sidebar-header {
  padding: 25px 20px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  background-color: #1a0505; /* Slightly darker for logo area */
}

.sidebar-brand {
  font-family: "Playfair Display", serif;
  color: #daa520; /* Gold */
  font-size: 1.5rem;
  font-weight: 700;
  text-decoration: none;
  letter-spacing: 1px;
  display: block;
}

/* --- Menu Items --- */
.sidebar-menu {
  list-style: none;
  padding: 0;
  margin: 20px 0 0 0;
  flex-grow: 1;
  display: flex;
  flex-direction: column;
}

.sidebar-menu li {
  width: 100%;
}

.menu-item {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 15px 25px;
  color: #ccc; /* Light grey text */
  text-decoration: none;
  font-size: 1rem;
  transition: all 0.3s ease;
  border-left: 4px solid transparent;
}

.menu-item:hover {
  background-color: rgba(255, 255, 255, 0.05);
  color: white;
}

.menu-item.active {
  background-color: #3e1212; /* Lighter Maroon */
  color: #daa520; /* Gold Text */
  border-left: 4px solid #daa520; /* Gold Indicator */
  font-weight: 600;
}

/* --- Main Content Area --- */
.main-content {
  margin-left: 260px; /* Push content to right of sidebar */
  flex: 1;
  display: flex;
  flex-direction: column;
  width: calc(100% - 260px);
}

/* --- Top Header inside Dashboard --- */
.top-header {
  height: 70px;
  background-color: white;
  border-bottom: 1px solid #e0e0e0;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 30px;
  position: sticky;
  top: 0;
  z-index: 900;
}

.text-maroon {
  color: #581818;
}

/* --- Page Content Wrapper --- */
.page-content {
  padding: 30px;
  flex: 1;
  overflow-y: auto;
}


--- FILE: client/src/components/DashboardLayout.jsx ---
import React, { useEffect, useState } from "react";
import { Outlet, Link, useNavigate, useLocation } from "react-router-dom";
import {
  FaTachometerAlt,
  FaHandHoldingHeart,
  FaUserGraduate,
  FaBoxOpen,
  FaRupeeSign,
  FaCalendarAlt,
  FaUsers,
  FaChartBar,
  FaSignOutAlt,
  FaCogs,
  FaShieldAlt,
} from "react-icons/fa";
import "./DashboardLayout.css";

const DashboardLayout = () => {
  const navigate = useNavigate();
  const location = useLocation();
  const [user, setUser] = useState(null);

  // useEffect(() => {
  //   const userInfo = JSON.parse(localStorage.getItem("userInfo"));
  //   if (
  //     !userInfo ||
  //     (userInfo.role !== "admin" && userInfo.role !== "employee")
  //   ) {
  //     navigate("/login");
  //   } else {
  //     // eslint-disable-next-line react-hooks/set-state-in-effect
  //     setUser(userInfo);
  //   }
  // }, [navigate]);
  useEffect(() => {
    const userInfo = JSON.parse(localStorage.getItem("userInfo"));

    // Define allowed roles
    const allowedRoles = [
      "admin",
      "employee",
      "president",
      "secretary",
      "treasurer",
    ];

    if (!userInfo || !allowedRoles.includes(userInfo.role)) {
      navigate("/login"); // Redirect if not authorized
    } else {
      // eslint-disable-next-line react-hooks/set-state-in-effect
      setUser(userInfo);
    }
  }, [navigate]);

  const handleLogout = () => {
    localStorage.removeItem("userInfo");
    navigate("/login");
  };

  if (!user) return null;

  // Helper to check active link
  const isActive = (path) => (location.pathname.includes(path) ? "active" : "");

  return (
    <div className="dashboard-container">
      {/* SIDEBAR */}
      <aside className="sidebar">
        <div className="sidebar-header">
          <Link to="/" className="sidebar-brand">
            Karunasri ERP
          </Link>
          <div className="text-muted small mt-1">
            Branch: {user.branch || "Headquarters"}
          </div>
        </div>

        <ul className="sidebar-menu">
          <li>
            <Link
              to="/dashboard"
              className={`menu-item ${
                location.pathname === "/dashboard" ? "active" : ""
              }`}
            >
              <FaTachometerAlt /> Overview
            </Link>
          </li>

          {/* Module: Donations (KSS_DON) */}
          <li>
            <Link
              to="/dashboard/donations"
              className={`menu-item ${isActive("donations")}`}
            >
              <FaHandHoldingHeart /> Donations
            </Link>
          </li>

          {/* Module: Students (KSS_STU) */}
          <li>
            <Link
              to="/dashboard/students"
              className={`menu-item ${isActive("students")}`}
            >
              <FaUserGraduate /> Students
            </Link>
          </li>

          {/* Module: Inventory (KSS_INV) */}
          <li>
            <Link
              to="/dashboard/inventory"
              className={`menu-item ${isActive("inventory")}`}
            >
              <FaBoxOpen /> Inventory
            </Link>
          </li>

          {/* Module: Finance (KSS_FIN) */}
          <li>
            <Link
              to="/dashboard/finance"
              className={`menu-item ${isActive("finance")}`}
            >
              <FaRupeeSign /> Finance
            </Link>
          </li>

          {/* Module: Events (KSS_EVE) */}
          <li>
            <Link
              to="/dashboard/events"
              className={`menu-item ${isActive("events")}`}
            >
              <FaCalendarAlt /> Events
            </Link>
          </li>

          {/* Module: Memberships (KSS_MEM) */}
          <li>
            <Link
              to="/dashboard/members"
              className={`menu-item ${isActive("members")}`}
            >
              <FaUsers /> Members
            </Link>
          </li>

          {/* Module: Reports (KSS_GEN_6) */}
          <li>
            <Link
              to="/dashboard/reports"
              className={`menu-item ${isActive("reports")}`}
            >
              <FaChartBar /> Reports
            </Link>
          </li>

          {/* Admin Only: Settings (KSS_GEN_4 - Metadata) */}
          {/* {user.role === "admin" && (
            <li>
              <Link
                to="/dashboard/settings"
                className={`menu-item ${isActive("settings")}`}
              >
                <FaCogs /> Settings
              </Link>
            </li>
          )} */}
          {/* Module: Settings (KSS_GEN_4 & KSS_DON_3) */}
          {/* CHANGED: Allow both Admin AND Employee */}
          {(user.role === "admin" || user.role === "employee") && (
            <li>
              <Link
                to="/dashboard/settings"
                className={`menu-item ${isActive("settings")}`}
              >
                <FaCogs /> Settings
              </Link>
            </li>
          )}
          {/* Module: Audit Trail (Admin Only) */}
          {user.role === "admin" && (
            <li>
              <Link
                to="/dashboard/audit"
                className={`menu-item ${isActive("audit")}`}
              >
                <FaShieldAlt /> Audit Trail
              </Link>
            </li>
          )}

          <li style={{ marginTop: "auto" }}>
            <button
              onClick={handleLogout}
              className="menu-item"
              style={{
                background: "transparent",
                border: "none",
                width: "100%",
              }}
            >
              <FaSignOutAlt /> Logout
            </button>
          </li>
        </ul>
      </aside>

      {/* MAIN CONTENT */}
      <div className="main-content">
        <header className="top-header">
          <h5 className="m-0 text-secondary">
            {/* Dynamic Header Title based on path */}
            {location.pathname.split("/")[2]?.toUpperCase() || "DASHBOARD"}
          </h5>
          <div className="d-flex align-items-center gap-3">
            <div className="text-end">
              <div className="fw-bold text-maroon">{user.name}</div>
              <div
                style={{ fontSize: "0.8rem" }}
                className="text-muted text-uppercase"
              >
                {user.role}
              </div>
            </div>
            <div
              style={{
                width: "40px",
                height: "40px",
                background: "#581818",
                color: "white",
                borderRadius: "50%",
                display: "flex",
                alignItems: "center",
                justifyContent: "center",
                fontWeight: "bold",
              }}
            >
              {user.name.charAt(0)}
            </div>
          </div>
        </header>

        <main className="page-content">
          <Outlet />
        </main>
      </div>
    </div>
  );
};

export default DashboardLayout;


--- FILE: client/src/components/DonationSchemes.css ---
.donation-section {
  background-color: var(--bg-cream);
  padding: 80px 0;
  position: relative;
}

/* Header: Title Left, Link Right */
.scheme-header {
  border-bottom: 2px solid #e0e0e0; /* lighter border */
  padding-bottom: 15px;
  margin-bottom: 40px;
  display: flex;
  justify-content: space-between;
  align-items: flex-end; /* Align bottom so text sits on line */
}

.scheme-title {
  font-family: var(--font-heading);
  color: var(--secondary-color);
  font-size: 2.2rem;
  margin: 0;
  text-transform: uppercase;
  letter-spacing: 1px;
  border-left: 5px solid var(--primary-color);
  padding-left: 15px;
  line-height: 1;
}

/* The Toggle Link (View All / View Less) */
.view-toggle-link {
  color: var(--primary-color);
  font-weight: bold;
  font-size: 1rem;
  cursor: pointer;
  text-decoration: none;
  transition: color 0.3s;
  display: flex;
  align-items: center;
  gap: 5px;
}

.view-toggle-link:hover {
  color: var(--secondary-color);
  text-decoration: underline;
}

/* Divine Card Styling - Clean & Traditional */
.scheme-card {
  border: none;
  border-radius: 0; /* Square corners look more traditional sometimes */
  overflow: hidden;
  background: white;
  transition: transform 0.3s, box-shadow 0.3s;
  height: 100%;
  border-bottom: 3px solid transparent;
}

.scheme-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
  border-bottom: 3px solid var(--primary-color);
}

.scheme-img-wrapper {
  height: 220px;
  overflow: hidden;
  position: relative;
}

.scheme-img-wrapper img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.5s;
}

.scheme-card:hover .scheme-img-wrapper img {
  transform: scale(1.05);
}

.scheme-body {
  padding: 20px;
  text-align: center;
}

.scheme-name {
  color: var(--secondary-color);
  font-size: 1.3rem;
  margin-bottom: 10px;
  font-weight: 700;
  font-family: var(--font-heading);
}

.scheme-desc {
  font-size: 0.95rem;
  color: #666;
  margin-bottom: 20px;
  line-height: 1.5;
}

.btn-donate-card {
  background-color: transparent;
  color: var(--primary-color);
  border: 1px solid var(--primary-color);
  padding: 6px 20px;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: bold;
  transition: all 0.3s;
  text-decoration: none;
  display: inline-block;
}

.btn-donate-card:hover {
  background-color: var(--primary-color);
  color: white;
}


--- FILE: client/src/components/DonationSchemes.jsx ---
import React, { useState } from "react";
import { Container, Row, Col, Card } from "react-bootstrap";
import { Link } from "react-router-dom";
import { FaChevronRight, FaChevronUp } from "react-icons/fa";
import "./DonationSchemes.css";

const DonationSchemes = () => {
  // State to track if we are showing all items or just the first few
  const [showAll, setShowAll] = useState(false);

  // Full List of Schemes (Mock Data)
  const allSchemes = [
    {
      id: 1,
      title: "Nitya Annadhana",
      desc: "Sponsor daily meals for the Ashram residents. Food is Brahman.",
      img: "https://images.unsplash.com/photo-1606216794074-735e91aa9c29?w=600&auto=format&fit=crop",
    },
    {
      id: 2,
      title: "Vidyarthi Poshan",
      desc: "Support the education, books, and uniform of a Ved pathshala student.",
      img: "https://images.unsplash.com/photo-1509062522246-3755977927d7?w=600&auto=format&fit=crop",
    },
    {
      id: 3,
      title: "Go-Seva (Cow Care)",
      desc: "Protect and feed our cows. Gauseva is the highest form of service.",
      img: "https://images.unsplash.com/photo-1593113598332-cd288d649433?w=600&auto=format&fit=crop",
    },
    {
      id: 4,
      title: "Ashram Construction",
      desc: "Donate bricks or cement for the new prayer hall construction.",
      img: "https://images.unsplash.com/photo-1548625361-ec8595edc29b?w=600&auto=format&fit=crop",
    },
    {
      id: 5,
      title: "Medical Camp",
      desc: "Sponsor medicines for the free rural health checkup camps.",
      img: "https://images.unsplash.com/photo-1576091160550-2187d80a1b44?w=600&auto=format&fit=crop",
    },
    {
      id: 6,
      title: "Festival Seva",
      desc: "Contribute towards flowers and decorations for major festivals.",
      img: "https://images.unsplash.com/photo-1561343754-0518747449a5?w=600&auto=format&fit=crop",
    },
  ];

  // Logic: If showAll is true, take the whole list. If false, take only first 3.
  const displayedSchemes = showAll ? allSchemes : allSchemes.slice(0, 3);

  return (
    <section className="donation-section">
      <Container>
        {/* Header: Title LEFT, Toggle Link RIGHT */}
        <div className="scheme-header">
          <h2 className="scheme-title">Our Sacred Sevas</h2>

          <div
            className="view-toggle-link"
            onClick={() => setShowAll(!showAll)}
          >
            {showAll ? (
              <>
                View Less <FaChevronUp size={12} />
              </>
            ) : (
              <>
                View All <FaChevronRight size={12} />
              </>
            )}
          </div>
        </div>

        <Row>
          {displayedSchemes.map((item) => (
            <Col lg={4} md={6} className="mb-4 fade-in" key={item.id}>
              <Card className="scheme-card h-100">
                <div className="scheme-img-wrapper">
                  <img src={item.img} alt={item.title} />
                </div>
                <Card.Body className="scheme-body">
                  <Card.Title className="scheme-name">{item.title}</Card.Title>
                  <Card.Text className="scheme-desc">{item.desc}</Card.Text>
                  <Link to="/donate" className="btn-donate-card">
                    Donate Now
                  </Link>
                </Card.Body>
              </Card>
            </Col>
          ))}
        </Row>
      </Container>
    </section>
  );
};

export default DonationSchemes;


--- FILE: client/src/components/Footer.css ---
.footer-section {
  background-color: #421c1c; /* Solid Deep Maroon - High Contrast */
  color: #ffffff; /* Force all text to white by default */
  padding-top: 70px;
  padding-bottom: 20px;
  font-family: "Lato", sans-serif;
  border-top: 6px solid #daa520; /* Gold Top Border */
  position: relative;
}

/* Optional: Background Pattern Overlay for texture */
.footer-section::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-image: url("https://www.transparenttextures.com/patterns/black-scales.png");
  opacity: 0.2;
  pointer-events: none;
}

/* Ensure content is above the background pattern */
.footer-section .container {
  position: relative;
  z-index: 2;
}

/* --- Typography --- */
.footer-brand {
  font-family: "Playfair Display", serif;
  color: #ffd700; /* Bright Gold */
  font-weight: 700;
  font-size: 1.8rem; /* Larger */
  margin-bottom: 20px;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.footer-address {
  color: #f0f0f0; /* Near White */
  font-size: 1rem;
  line-height: 1.8;
  opacity: 0.9;
}

/* Headings - Making them VERY Visible */
.footer-heading {
  color: #ffd700; /* Bright Gold */
  font-family: "Playfair Display", serif;
  font-weight: 700;
  font-size: 1.4rem;
  margin-bottom: 25px;
  padding-bottom: 10px;
  border-bottom: 2px solid rgba(218, 165, 32, 0.3); /* Subtle gold line */
  display: inline-block;
}

/* --- QR Code Box --- */
.footer-qr-box {
  background-color: white;
  padding: 10px;
  border-radius: 8px;
  display: inline-block;
  margin-top: 15px;
  text-align: center;
}

.footer-qr-img {
  width: 90px;
  height: 90px;
}

.qr-label {
  display: block;
  color: #333;
  font-size: 0.75rem;
  font-weight: bold;
  margin-top: 5px;
  text-transform: uppercase;
}

/* --- Links --- */
.footer-links {
  list-style: none;
  padding: 0;
  margin: 0;
}

.footer-links li {
  margin-bottom: 15px;
}

.footer-links a {
  color: #ffffff;
  text-decoration: none;
  font-size: 1.05rem;
  transition: all 0.3s;
  display: flex;
  align-items: center;
}

/* Hover effect: text turns Gold and moves right */
.footer-links a:hover {
  color: #ffd700;
  padding-left: 8px;
}

/* --- Contact Items --- */
.contact-item {
  display: flex;
  align-items: flex-start; /* Align to top of icon */
  margin-bottom: 20px;
  color: #ffffff;
  font-size: 1rem;
}

.contact-icon {
  color: #ffd700; /* Gold Icon */
  font-size: 1.2rem;
  margin-right: 15px;
  margin-top: 3px;
}

/* --- Social Row --- */
.social-row {
  border-top: 1px solid rgba(255, 255, 255, 0.15);
  margin-top: 50px;
  padding-top: 30px;
  text-align: center;
  margin-bottom: 30px;
}

.social-icon-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 45px;
  height: 45px;
  border-radius: 50%;
  background-color: rgba(255, 255, 255, 0.1);
  color: white;
  margin: 0 10px;
  font-size: 1.2rem;
  transition: background 0.3s, transform 0.3s;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.social-icon-btn:hover {
  background-color: #ffd700;
  color: #421c1c; /* Dark text on gold background */
  transform: translateY(-5px);
}

/* --- Payment Row --- */
.payment-row {
  text-align: center;
  margin-bottom: 30px;
}

.payment-label {
  display: block;
  font-size: 0.9rem;
  color: #ccc;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 15px;
}

.payment-icons {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 20px;
  flex-wrap: wrap;
}

/* Icons are white by default, fully visible */
.pay-icon {
  font-size: 2.2rem;
  color: white;
}

.pay-img {
  height: 25px;
  background-color: white; /* Add white background so colored logos pop */
  padding: 2px 5px;
  border-radius: 4px;
}

/* --- Copyright --- */
.copyright-text {
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  padding-top: 20px;
  text-align: center;
  font-size: 0.85rem;
  color: #bbb;
}

.copyright-text a {
  color: #ffd700;
  text-decoration: none;
}


--- FILE: client/src/components/Footer.jsx ---
import React from "react";
import { Container, Row, Col } from "react-bootstrap";
import { Link } from "react-router-dom";
import {
  FaPhoneAlt,
  FaEnvelope,
  FaMapMarkerAlt,
  FaFacebookF,
  FaTwitter,
  FaYoutube,
  FaInstagram,
  FaCcVisa,
  FaCcMastercard,
  FaUniversity,
  FaChevronRight,
} from "react-icons/fa";
import "./Footer.css";

const Footer = () => {
  return (
    <footer className="footer-section">
      <Container>
        <Row className="gy-5">
          {/* Column 1: Brand, Address, QR */}
          <Col lg={4} md={6}>
            <div className="footer-brand">Karunasri Seva Samithi</div>
            <div className="footer-address">
              <p className="mb-2">Plot No. 123, Temple Road,</p>
              <p className="mb-2">Near Vedic Patashala, Saroornagar,</p>
              <p className="mb-0">Hyderabad, Telangana - 500035</p>
            </div>

            <div className="footer-qr-box">
              <img
                src="https://upload.wikimedia.org/wikipedia/commons/d/d0/QR_code_for_mobile_English_Wikipedia.svg"
                alt="Scan to Donate"
                className="footer-qr-img"
              />
              <span className="qr-label">Scan to Donate</span>
            </div>
          </Col>

          {/* Column 2: Quick Links */}
          <Col lg={4} md={6}>
            <h5 className="footer-heading">Quick Links</h5>
            <ul className="footer-links">
              <li>
                <Link to="/">
                  <FaChevronRight size={12} className="me-2 text-warning" />{" "}
                  Home
                </Link>
              </li>
              <li>
                <Link to="/about">
                  <FaChevronRight size={12} className="me-2 text-warning" />{" "}
                  About Us
                </Link>
              </li>
              <li>
                <Link to="/activities">
                  <FaChevronRight size={12} className="me-2 text-warning" /> Our
                  Activities
                </Link>
              </li>
              <li>
                <Link to="/donate">
                  <FaChevronRight size={12} className="me-2 text-warning" />{" "}
                  Donate Now
                </Link>
              </li>
              <li>
                <Link to="/gallery">
                  <FaChevronRight size={12} className="me-2 text-warning" />{" "}
                  Gallery
                </Link>
              </li>
              <li>
                <Link to="/contact">
                  <FaChevronRight size={12} className="me-2 text-warning" />{" "}
                  Contact Us
                </Link>
              </li>
            </ul>
          </Col>

          {/* Column 3: Contact Info */}
          <Col lg={4} md={12}>
            <h5 className="footer-heading">Get In Touch</h5>

            <div className="contact-item">
              <FaMapMarkerAlt className="contact-icon" />
              <div>
                <strong>Head Office:</strong>
                <br />
                Karunasri Ashram, Champapet
              </div>
            </div>

            <div className="contact-item">
              <FaPhoneAlt className="contact-icon" />
              <div>
                <strong>Phone:</strong>
                <br />
                +91 99220 03000
              </div>
            </div>

            <div className="contact-item">
              <FaEnvelope className="contact-icon" />
              <div>
                <strong>Email:</strong>
                <br />
                info@karunasri.org
              </div>
            </div>
          </Col>
        </Row>

        {/* Social Media Row */}
        <div className="social-row">
          <a href="#" className="social-icon-btn">
            <FaFacebookF />
          </a>
          <a href="#" className="social-icon-btn">
            <FaTwitter />
          </a>
          <a href="#" className="social-icon-btn">
            <FaYoutube />
          </a>
          <a href="#" className="social-icon-btn">
            <FaInstagram />
          </a>
        </div>

        {/* Payment Row */}
        <div className="payment-row">
          <span className="payment-label">Secure Donation Partners</span>
          <div className="payment-icons">
            <FaCcVisa className="pay-icon" title="Visa" />
            <FaCcMastercard className="pay-icon" title="Mastercard" />
            <FaUniversity className="pay-icon" title="Net Banking" />

            {/* Payment Images with white background for visibility */}
            <img
              src="https://upload.wikimedia.org/wikipedia/commons/e/e1/UPI-Logo-vector.svg"
              alt="UPI"
              className="pay-img"
            />
            <img
              src="https://upload.wikimedia.org/wikipedia/commons/c/cb/Rupay-Logo.png"
              alt="RuPay"
              className="pay-img"
            />
          </div>
        </div>

        {/* Copyright */}
        <div className="copyright-text">
          <p className="mb-0">
            &copy; {new Date().getFullYear()} Karunasri Seva Samithi. All Rights
            Reserved.
            <span className="mx-2">|</span>
            <Link to="/privacy">Privacy Policy</Link>
          </p>
        </div>
      </Container>
    </footer>
  );
};

export default Footer;


--- FILE: client/src/components/Header.css ---
/* Top Strip (Maroon) */
.top-bar {
  background-color: var(--secondary-color);
  font-size: 0.9rem;
  color: white;
}

.top-bar a {
  color: rgba(255, 255, 255, 0.8);
  transition: color 0.3s;
}

.top-bar a:hover {
  color: var(--gold-accent);
}

/* Main Navbar */
.navbar-custom {
  background-color: white;
  border-bottom: 3px solid var(--gold-accent);
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

/* Logo Circle */
.logo-circle {
  width: 50px;
  height: 50px;
  background-color: var(--primary-color);
  border-radius: 50%;
  color: white;
  font-weight: bold;
  font-size: 24px;
  margin-right: 12px;
  display: flex;
  justify-content: center;
  align-items: center;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

/* Navigation Links */
.nav-link-custom {
  font-weight: 500 !important;
  color: var(--text-dark) !important;
  font-family: var(--font-heading);
  font-size: 1.1rem;
  padding: 0.5rem 1rem !important;
  transition: color 0.3s ease;
}

.nav-link-custom:hover,
.nav-link-custom.active {
  color: var(--primary-color) !important;
}

/* Login Link */
.login-link {
  color: var(--primary-color) !important;
  font-weight: bold !important;
}

/* Common Button Style (Scoped to Header if needed, or global) */
.btn-donate-nav {
  background: linear-gradient(
    45deg,
    var(--primary-color),
    var(--primary-hover)
  );
  color: white !important;
  border: none;
  font-weight: 700;
  padding: 10px 25px;
  border-radius: 30px;
  text-transform: uppercase;
  letter-spacing: 1px;
  transition: transform 0.2s, box-shadow 0.2s;
}

.btn-donate-nav:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(211, 84, 0, 0.4);
}


--- FILE: client/src/components/Header.jsx ---
import React, { useState } from "react";
import { Navbar, Container, Nav, Button, Dropdown } from "react-bootstrap";
import { Link, NavLink, useNavigate } from "react-router-dom";
import {
  FaPhoneAlt,
  FaEnvelope,
  FaFacebook,
  FaYoutube,
  FaUserCircle,
} from "react-icons/fa";
import "./Header.css";
import logo from "../assets/logo.jpg";

const Header = () => {
  const navigate = useNavigate();

  // Lazy initialization to prevent hydration errors
  const [userInfo, setUserInfo] = useState(() => {
    const savedUser = localStorage.getItem("userInfo");
    return savedUser ? JSON.parse(savedUser) : null;
  });

  const handleLogout = () => {
    localStorage.removeItem("userInfo");
    setUserInfo(null);
    navigate("/login");
  };

  // Define who can see the Dashboard
  const allowedRoles = [
    "admin",
    "employee",
    "president",
    "secretary",
    "treasurer",
  ];

  return (
    <>
      {/* Top Bar */}
      <div className="py-2 top-bar">
        <Container className="d-flex justify-content-between align-items-center">
          <div className="d-flex gap-3">
            <span>
              <FaPhoneAlt className="me-2" /> +91 99220 03000
            </span>
            <span className="d-none d-md-block">
              <FaEnvelope className="me-2" /> info@karunasri.org
            </span>
          </div>
          <div className="d-flex gap-3">
            <span className="d-none d-md-block">Reg No: 123/2024</span>
            <a href="#">
              <FaFacebook />
            </a>
            <a href="#">
              <FaYoutube />
            </a>
          </div>
        </Container>
      </div>

      {/* Main Navbar */}
      <Navbar expand="lg" className="sticky-top navbar-custom">
        <Container>
          <Navbar.Brand as={Link} to="/" className="d-flex align-items-center">
            {/* <div className="logo-circle">K</div> */}
            <img
              src={logo}
              alt="Karunasri Logo"
              width="50" // Adjust size as needed
              height="50" // Adjust size as needed
              className="d-inline-block align-top me-2"
              style={{ objectFit: "contain" }} // Ensures logo doesn't stretch
            />

            <div style={{ lineHeight: "1.2" }}>
              <h4
                className="m-0"
                style={{
                  color: "var(--secondary-color)",
                  fontWeight: "bold",
                  letterSpacing: "1px",
                }}
              >
                KARUNASRI
              </h4>
              <small
                className="text-uppercase"
                style={{
                  fontSize: "0.7rem",
                  color: "#666",
                  letterSpacing: "2px",
                }}
              >
                Seva Samithi
              </small>
            </div>
          </Navbar.Brand>

          <Navbar.Toggle aria-controls="basic-navbar-nav" />

          <Navbar.Collapse id="basic-navbar-nav">
            <Nav className="ms-auto align-items-center gap-2">
              {["Home", "About Us", "Activities", "Events", "Contact"].map(
                (item) => (
                  <Nav.Link
                    key={item}
                    as={NavLink}
                    to={
                      item === "Home"
                        ? "/"
                        : `/${item.toLowerCase().replace(" ", "-")}`
                    }
                    className="nav-link-custom"
                  >
                    {item}
                  </Nav.Link>
                )
              )}

              {/* AUTH CHECK */}
              {userInfo ? (
                <Dropdown align="end">
                  <Dropdown.Toggle
                    variant="light"
                    id="dropdown-basic"
                    className="d-flex align-items-center gap-2 border-0 fw-bold"
                    style={{ color: "var(--secondary-color)" }}
                  >
                    <FaUserCircle size={24} /> {userInfo.name.split(" ")[0]}
                  </Dropdown.Toggle>

                  <Dropdown.Menu>
                    <Dropdown.Item as={Link} to="/profile">
                      My Profile
                    </Dropdown.Item>
                    <Dropdown.Item as={Link} to="/history">
                      Donation History
                    </Dropdown.Item>

                    {/* UPDATED LOGIC: Check if role is in the allowed list */}
                    {allowedRoles.includes(userInfo.role) && (
                      <>
                        <Dropdown.Divider />
                        <Dropdown.Item
                          as={Link}
                          to="/dashboard"
                          className="text-primary fw-bold"
                        >
                          {userInfo.role === "admin"
                            ? "Admin Dashboard"
                            : userInfo.role === "employee"
                            ? "Employee Portal"
                            : "Committee Dashboard"}
                        </Dropdown.Item>
                      </>
                    )}

                    <Dropdown.Divider />
                    <Dropdown.Item
                      onClick={handleLogout}
                      className="text-danger"
                    >
                      Logout
                    </Dropdown.Item>
                  </Dropdown.Menu>
                </Dropdown>
              ) : (
                <Nav.Link
                  as={NavLink}
                  to="/login"
                  className="nav-link-custom login-link"
                >
                  Login
                </Nav.Link>
              )}

              <Button as={Link} to="/donate" className="btn-donate-nav ms-2">
                Donate Now
              </Button>
            </Nav>
          </Navbar.Collapse>
        </Container>
      </Navbar>
    </>
  );
};

export default Header;


--- FILE: client/src/components/Header1.jsx ---
// import React from "react";
// import { Navbar, Container, Nav, Button } from "react-bootstrap";
// import { Link, NavLink } from "react-router-dom";
// import { FaPhoneAlt, FaEnvelope, FaFacebook, FaYoutube } from "react-icons/fa";

// const Header = () => {
//   return (
//     <>
//       {/* Top Bar */}
//       <div className="py-2 top-bar">
//         <Container className="d-flex justify-content-between align-items-center">
//           <div className="d-flex gap-3">
//             <span>
//               <FaPhoneAlt className="me-2" /> +91 99220 03000
//             </span>
//             <span className="d-none d-md-block">
//               <FaEnvelope className="me-2" /> info@karunasri.org
//             </span>
//           </div>
//           <div className="d-flex gap-3">
//             <span className="d-none d-md-block">Reg No: 123/2024</span>
//             <a href="#">
//               <FaFacebook />
//             </a>
//             <a href="#">
//               <FaYoutube />
//             </a>
//           </div>
//         </Container>
//       </div>

//       {/* Main Navbar */}
//       <Navbar expand="lg" className="sticky-top navbar-custom">
//         <Container>
//           <Navbar.Brand as={Link} to="/" className="d-flex align-items-center">
//             <div className="logo-circle">K</div>
//             <div style={{ lineHeight: "1.2" }}>
//               <h4
//                 className="m-0"
//                 style={{
//                   color: "var(--secondary-color)",
//                   fontWeight: "bold",
//                   letterSpacing: "1px",
//                 }}
//               >
//                 KARUNASRI
//               </h4>
//               <small
//                 className="text-uppercase"
//                 style={{
//                   fontSize: "0.7rem",
//                   color: "#666",
//                   letterSpacing: "2px",
//                 }}
//               >
//                 Seva Samithi
//               </small>
//             </div>
//           </Navbar.Brand>

//           <Navbar.Toggle aria-controls="basic-navbar-nav" />

//           <Navbar.Collapse id="basic-navbar-nav">
//             <Nav className="ms-auto align-items-center gap-2">
//               {["Home", "About Us", "Activities", "Events", "Contact"].map(
//                 (item) => (
//                   <Nav.Link
//                     key={item}
//                     as={NavLink}
//                     to={
//                       item === "Home"
//                         ? "/"
//                         : `/${item.toLowerCase().replace(" ", "-")}`
//                     }
//                     className="nav-link-custom"
//                   >
//                     {item}
//                   </Nav.Link>
//                 )
//               )}

//               <Nav.Link
//                 as={NavLink}
//                 to="/login"
//                 className="nav-link-custom login-link"
//               >
//                 Login
//               </Nav.Link>

//               <Button as={Link} to="/donate" className="btn-donate-nav ms-2">
//                 Donate Now
//               </Button>
//             </Nav>
//           </Navbar.Collapse>
//         </Container>
//       </Navbar>
//       <style>
//         {`
//         /* Top Strip (Maroon) */
// .top-bar {
//   background-color: var(--secondary-color);
//   font-size: 0.9rem;
//   color: white;
// }

// .top-bar a {
//   color: rgba(255, 255, 255, 0.8);
//   transition: color 0.3s;
// }

// .top-bar a:hover {
//   color: var(--gold-accent);
// }

// /* Main Navbar */
// .navbar-custom {
//   background-color: white;
//   border-bottom: 3px solid var(--gold-accent);
//   box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
// }

// /* Logo Circle */
// .logo-circle {
//   width: 50px;
//   height: 50px;
//   background-color: var(--primary-color);
//   border-radius: 50%;
//   color: white;
//   font-weight: bold;
//   font-size: 24px;
//   margin-right: 12px;
//   display: flex;
//   justify-content: center;
//   align-items: center;
//   box-shadow: 0 2px 5px rgba(0,0,0,0.2);
// }

// /* Navigation Links */
// .nav-link-custom {
//   font-weight: 500 !important;
//   color: var(--text-dark) !important;
//   font-family: var(--font-heading);
//   font-size: 1.1rem;
//   padding: 0.5rem 1rem !important;
//   transition: color 0.3s ease;
// }

// .nav-link-custom:hover,
// .nav-link-custom.active {
//   color: var(--primary-color) !important;
// }

// /* Login Link */
// .login-link {
//   color: var(--primary-color) !important;
//   font-weight: bold !important;
// }

// /* Common Button Style (Scoped to Header if needed, or global) */
// .btn-donate-nav {
//   background: linear-gradient(45deg, var(--primary-color), var(--primary-hover));
//   color: white !important;
//   border: none;
//   font-weight: 700;
//   padding: 10px 25px;
//   border-radius: 30px;
//   text-transform: uppercase;
//   letter-spacing: 1px;
//   transition: transform 0.2s, box-shadow 0.2s;
// }

// .btn-donate-nav:hover {
//   transform: translateY(-2px);
//   box-shadow: 0 4px 15px rgba(211, 84, 0, 0.4);
// }

//         `}
//       </style>
//     </>
//   );
// };

// export default Header;
import React, { useState } from "react";
import { Navbar, Container, Nav, Button, Dropdown } from "react-bootstrap";
import { Link, NavLink, useNavigate } from "react-router-dom";
import {
  FaPhoneAlt,
  FaEnvelope,
  FaFacebook,
  FaYoutube,
  FaUserCircle,
} from "react-icons/fa";
import "./Header.css";

const Header = () => {
  const navigate = useNavigate();

  // FIX: Initialize state directly from LocalStorage (Lazy Initialization)
  // This avoids the "useEffect" render error completely.
  const [userInfo, setUserInfo] = useState(() => {
    const savedUser = localStorage.getItem("userInfo");
    return savedUser ? JSON.parse(savedUser) : null;
  });

  const handleLogout = () => {
    localStorage.removeItem("userInfo");
    setUserInfo(null); // Clear state immediately
    navigate("/login");
  };

  return (
    <>
      {/* Top Bar */}
      <div className="py-2 top-bar">
        <Container className="d-flex justify-content-between align-items-center">
          <div className="d-flex gap-3">
            <span>
              <FaPhoneAlt className="me-2" /> +91 99220 03000
            </span>
            <span className="d-none d-md-block">
              <FaEnvelope className="me-2" /> info@karunasri.org
            </span>
          </div>
          <div className="d-flex gap-3">
            <span className="d-none d-md-block">Reg No: 123/2024</span>
            <a href="#">
              <FaFacebook />
            </a>
            <a href="#">
              <FaYoutube />
            </a>
          </div>
        </Container>
      </div>

      {/* Main Navbar */}
      <Navbar expand="lg" className="sticky-top navbar-custom">
        <Container>
          <Navbar.Brand as={Link} to="/" className="d-flex align-items-center">
            <div className="logo-circle">K</div>
            <div style={{ lineHeight: "1.2" }}>
              <h4
                className="m-0"
                style={{
                  color: "var(--secondary-color)",
                  fontWeight: "bold",
                  letterSpacing: "1px",
                }}
              >
                KARUNASRI
              </h4>
              <small
                className="text-uppercase"
                style={{
                  fontSize: "0.7rem",
                  color: "#666",
                  letterSpacing: "2px",
                }}
              >
                Seva Samithi
              </small>
            </div>
          </Navbar.Brand>

          <Navbar.Toggle aria-controls="basic-navbar-nav" />

          <Navbar.Collapse id="basic-navbar-nav">
            <Nav className="ms-auto align-items-center gap-2">
              {["Home", "About Us", "Activities", "Events", "Contact"].map(
                (item) => (
                  <Nav.Link
                    key={item}
                    as={NavLink}
                    to={
                      item === "Home"
                        ? "/"
                        : `/${item.toLowerCase().replace(" ", "-")}`
                    }
                    className="nav-link-custom"
                  >
                    {item}
                  </Nav.Link>
                )
              )}

              {/* AUTH CHECK */}
              {userInfo ? (
                <Dropdown align="end">
                  <Dropdown.Toggle
                    variant="light"
                    id="dropdown-basic"
                    className="d-flex align-items-center gap-2 border-0 fw-bold"
                    style={{ color: "var(--secondary-color)" }}
                  >
                    <FaUserCircle size={24} /> {userInfo.name.split(" ")[0]}
                  </Dropdown.Toggle>

                  <Dropdown.Menu>
                    <Dropdown.Item as={Link} to="/profile">
                      My Profile
                    </Dropdown.Item>
                    <Dropdown.Item as={Link} to="/history">
                      Donation History
                    </Dropdown.Item>

                    {/* Admin/Employee Link */}
                    {(userInfo.role === "admin" ||
                      userInfo.role === "employee") && (
                      <>
                        <Dropdown.Divider />
                        <Dropdown.Item
                          as={Link}
                          to="/dashboard"
                          className="text-primary fw-bold"
                        >
                          {userInfo.role === "admin"
                            ? "Admin Dashboard"
                            : "Employee Portal"}
                        </Dropdown.Item>
                      </>
                    )}

                    <Dropdown.Divider />
                    <Dropdown.Item
                      onClick={handleLogout}
                      className="text-danger"
                    >
                      Logout
                    </Dropdown.Item>
                  </Dropdown.Menu>
                </Dropdown>
              ) : (
                <Nav.Link
                  as={NavLink}
                  to="/login"
                  className="nav-link-custom login-link"
                >
                  Login
                </Nav.Link>
              )}

              <Button as={Link} to="/donate" className="btn-donate-nav ms-2">
                Donate Now
              </Button>
            </Nav>
          </Navbar.Collapse>
        </Container>
      </Navbar>
    </>
  );
};

export default Header;


--- FILE: client/src/components/HeroSlider.jsx ---
import React from "react";
import { Carousel, Button } from "react-bootstrap";
import { Link } from "react-router-dom";
import firstImage from "../assets/karunasri.jpg";
import secondImage from "../assets/image2.jpg";

const HeroSlider = () => {
  const slides = [
    {
      id: 1,
      image: firstImage,
      title: "Service to Mankind is Service to God",
      subtitle:
        "Join Karunasri Seva Samithi in uplifting the lives of the needy.",
      btnText: "Our Mission",
      link: "/about",
    },
    {
      id: 2,
      image:
        "https://images.unsplash.com/photo-1593113598332-cd288d649433?q=80&w=1920&auto=format&fit=crop",
      title: "Nitya Annadhana",
      subtitle: "Feeding the hungry is the highest form of charity.",
      btnText: "Donate a Meal",
      link: "/donate",
    },
    {
      id: 3,
      image: secondImage,
      title: "Vidyarthi Nidhi",
      subtitle: "Empowering the future through education and values.",
      btnText: "Sponsor a Child",
      link: "/donate",
    },
  ];

  return (
    <>
      <Carousel
        fade
        interval={4000}
        pause={false}
        controls={true}
        indicators={true}
        className="custom-carousel"
      >
        {slides.map((slide) => (
          <Carousel.Item key={slide.id} className="hero-slide-item">
            <img
              className="d-block  hero-image"
              src={slide.image}
              alt={slide.title}
            />
            {/* <div className="hero-overlay"></div> */}

            {/* <Carousel.Caption
              className="d-flex flex-column justify-content-center align-items-center h-100"
              style={{ bottom: 0 }}
            >
              <div>
                <h1 className="display-3 hero-title mb-3">{slide.title}</h1>
                <p className="lead mb-4 text-light hero-subtitle">
                  {slide.subtitle}
                </p>
                <Button as={Link} to={slide.link} className="btn-hero">
                  {slide.btnText}
                </Button>
              </div>
            </Carousel.Caption> */}
          </Carousel.Item>
        ))}
      </Carousel>
      <style>
        {`
      /* Make the slider take up significant height */
.hero-slide-item {
  height: 85vh;
  position: relative;
}

.hero-image {
  object-fit: cover;
  width: 100%;
  height: 100%;
}

/* Dark Gradient Overlay for text readability */
.hero-overlay {
  background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.3) 50%, rgba(0,0,0,0.2) 100%);
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
}

/* Customizing Bootstrap Carousel Indicators to be Round */
.custom-carousel .carousel-indicators {
  bottom: 30px;
}

.custom-carousel .carousel-indicators [data-bs-target] {
  width: 12px !important;
  height: 12px !important;
  border-radius: 50% !important;
  background-color: var(--gold-accent) !important;
  border: 2px solid rgba(255,255,255,0.5) !important;
  margin: 0 8px !important;
  opacity: 0.6;
  transition: all 0.3s ease;
}

.custom-carousel .carousel-indicators .active {
  opacity: 1;
  transform: scale(1.3);
  background-color: var(--primary-color) !important;
  border-color: white !important;
}

/* Caption Text Styling */
.hero-title {
  text-shadow: 2px 2px 4px rgba(0,0,0,0.6);
  font-weight: bold;
  letter-spacing: 1px;
}

.hero-subtitle {
  font-size: 1.5rem;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
  font-weight: 300;
}

/* Hero Button */
.btn-hero {
  background-color: var(--primary-color);
  color: white;
  border: 2px solid var(--primary-color);
  padding: 12px 35px;
  font-size: 1.1rem;
  font-weight: bold;
  border-radius: 50px;
  text-transform: uppercase;
  margin-top: 20px;
  transition: all 0.3s;
}

.btn-hero:hover {
  background-color: transparent;
  color: white;
  border-color: white;
}

      `}
      </style>
    </>
  );
};

export default HeroSlider;


--- FILE: client/src/components/JoinCtaSection.css ---
/* 1. Section Container - Traditional Light Cream Background */
.join-cta-section {
  position: relative;
  background-color: #fffbf5;
  padding: 80px 0;
  border-top: 1px solid #e6ccb2; /* Subtle Gold/Tan border top */
  border-bottom: 1px solid #e6ccb2; /* Subtle Gold/Tan border bottom */
  overflow: hidden; /* Ensures animations don't spill over */
}

/* 2. Flex Layout: Flower - Content - Flower */
.cta-wrapper {
  display: flex;
  align-items: center;
  justify-content: center; /* Center everything */
  gap: 40px; /* Space between flowers and text */
  position: relative;
}

/* 3. The Mandala/Flower Images Styling */
.flower-decor {
  width: 140px;
  height: 140px;
  opacity: 0.2; /* Make it subtle like a watermark */
  filter: sepia(1) saturate(1.5) hue-rotate(-10deg); /* Gives it a golden/brown tint */
}

/* 4. Rotation Animation for Flowers */
@keyframes spin-slow {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

.flower-rotate {
  animation: spin-slow 40s linear infinite; /* Very slow, dignified rotation */
}

/* 5. Center Content Text Styling */
.cta-content {
  text-align: center;
  z-index: 2;
  max-width: 600px;
}

.trust-name-cta {
  font-family: "Playfair Display", serif; /* Premium Heading Font */
  font-size: 2.2rem;
  font-weight: 700;
  color: #581818; /* Royal Maroon */
  margin-bottom: 10px;
  text-transform: uppercase;
  letter-spacing: 2px;
}

.sub-text-cta {
  font-family: "Lato", sans-serif;
  color: #666; /* Soft grey text */
  font-size: 1.1rem;
  margin-bottom: 35px;
  font-weight: 400;
}

/* 6. WhatsApp & Button Container */
.whatsapp-box {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 20px;
}

/* 7. The Green Icon Circle */
.wa-icon-circle {
  width: 65px;
  height: 65px;
  background-color: #25d366; /* WhatsApp Green */
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 32px;
  box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4);
  position: relative;
  transition: transform 0.3s ease;
}

.whatsapp-box:hover .wa-icon-circle {
  transform: scale(1.1); /* Grow slightly on hover */
}

/* Pulse/Ripple Effect behind the icon */
.wa-icon-circle::after {
  content: "";
  position: absolute;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  border: 2px solid #25d366;
  opacity: 0;
  animation: ripple 2s infinite;
}

@keyframes ripple {
  0% {
    transform: scale(1);
    opacity: 0.8;
  }
  100% {
    transform: scale(1.6);
    opacity: 0;
  }
}

/* 8. The "Join Us" Button */
.btn-join-us {
  background: linear-gradient(45deg, #581818, #800000); /* Maroon Gradient */
  color: white !important; /* Force white text */
  padding: 12px 40px;
  border-radius: 50px;
  text-decoration: none;
  font-weight: bold;
  letter-spacing: 1px;
  text-transform: uppercase;
  font-size: 0.95rem;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
  transition: all 0.3s ease;
  display: inline-block;
}

.btn-join-us:hover {
  background: linear-gradient(45deg, #d35400, #e67e22); /* Saffron on Hover */
  transform: translateY(-3px);
  box-shadow: 0 6px 15px rgba(211, 84, 0, 0.4);
}

/* Mobile Adjustments */
@media (max-width: 768px) {
  .trust-name-cta {
    font-size: 1.6rem;
  }

  .cta-wrapper {
    gap: 0;
  }

  /* Flowers are hidden via Bootstrap d-none class in JSX, 
     but we ensure safety here just in case */
  .flower-decor {
    display: none;
  }
}


--- FILE: client/src/components/JoinCtaSection.jsx ---
import React from "react";
import { Container } from "react-bootstrap";
import { FaWhatsapp } from "react-icons/fa";
import "./JoinCtaSection.css";

const JoinCtaSection = () => {
  // Reliable Link from Wikimedia (Transparent Mandala)
  const flowerImg =
    "https://upload.wikimedia.org/wikipedia/commons/thumb/2/29/Mandala_6.svg/640px-Mandala_6.svg.png";

  return (
    <section className="join-cta-section">
      <Container>
        <div className="cta-wrapper">
          {/* Left Flower */}
          <img
            src={flowerImg}
            alt="mandala decoration"
            className="flower-decor flower-rotate d-none d-md-block"
          />

          {/* Center Content */}
          <div className="cta-content">
            <h2 className="trust-name-cta">Karunasri Seva Samithi</h2>
            <p className="sub-text-cta">
              Join our spiritual community for daily updates & events
            </p>

            <div className="whatsapp-box">
              <div className="wa-icon-circle">
                <FaWhatsapp />
              </div>
              <a
                href="https://wa.me/919922003000"
                target="_blank"
                rel="noreferrer"
                className="btn-join-us"
              >
                Join Us
              </a>
            </div>
          </div>

          {/* Right Flower */}
          <img
            src={flowerImg}
            alt="mandala decoration"
            className="flower-decor flower-rotate d-none d-md-block"
          />
        </div>
      </Container>
    </section>
  );
};

export default JoinCtaSection;


--- FILE: client/src/components/QuoteSection.css ---
.quote-section {
  /* High Quality Spiritual Texture */
  background-image: url("https://images.unsplash.com/photo-1542273917363-3b1817f69a2d?q=80&w=1920&auto=format&fit=crop");

  /* THIS creates the Parallax Effect */
  background-attachment: fixed;
  background-position: center;
  background-repeat: no-repeat;
  background-size: cover;

  position: relative;
  padding: 120px 0; /* More padding to see the effect better */
  text-align: center;
  color: white;
  width: 100%;
}

.quote-overlay {
  /* Dark Maroon tint so text pops */
  background-color: rgba(88, 24, 24, 0.7);
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 1;
}

/* Ensure content sits ON TOP of the overlay */
.quote-content-wrapper {
  position: relative;
  z-index: 2;
}

.quote-text {
  font-family: "Playfair Display", serif;
  font-size: 2.5rem; /* Larger for impact */
  font-style: italic;
  line-height: 1.6;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
  margin-bottom: 20px;
}

.quote-author {
  font-family: "Lato", sans-serif;
  font-size: 1.1rem;
  color: #daa520; /* Gold */
  text-transform: uppercase;
  letter-spacing: 3px;
  font-weight: 700;
}


--- FILE: client/src/components/QuoteSection.jsx ---
import React from "react";
import { Container } from "react-bootstrap";
import { FaQuoteLeft } from "react-icons/fa";
import "./QuoteSection.css";

const QuoteSection = () => {
  return (
    <div className="quote-section">
      <div className="quote-overlay"></div>
      <Container className="quote-content-wrapper">
        <FaQuoteLeft
          size={40}
          style={{ color: "#DAA520", opacity: 0.8, marginBottom: "25px" }}
        />
        <h3 className="quote-text">
          "The best way to find yourself is to lose yourself in the service of
          others."
        </h3>
        <p className="quote-author">- Mahatma Gandhi</p>
      </Container>
    </div>
  );
};

export default QuoteSection;


--- FILE: client/src/components/UpcomingEvents.css ---
.events-section {
  padding: 80px 0;
  background-color: white;
}

.event-row {
  border-bottom: 1px solid #eee;
  padding: 20px 0;
  transition: background 0.3s;
}

.event-row:hover {
  background-color: #fffbf0; /* Light cream on hover */
}

/* The Date Box (Square with Month/Day) */
.event-date-box {
  background-color: var(--secondary-color);
  color: white;
  width: 80px;
  height: 80px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

.event-month {
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.event-day {
  font-size: 2rem;
  font-weight: bold;
  line-height: 1;
}

.event-title {
  font-family: var(--font-heading);
  color: var(--text-dark);
  font-size: 1.5rem;
  margin-bottom: 5px;
}

.event-meta {
  font-size: 0.9rem;
  color: var(--primary-color);
  font-weight: 600;
}


--- FILE: client/src/components/UpcomingEvents.jsx ---
import React from "react";
import { Container, Row, Col, Button } from "react-bootstrap";
import { FaClock, FaMapMarkerAlt } from "react-icons/fa";
import "./UpcomingEvents.css";

const UpcomingEvents = () => {
  const events = [
    {
      id: 1,
      day: "15",
      month: "AUG",
      title: "Sri Krishna Janmashtami",
      time: "6:00 PM - 12:00 AM",
      location: "Main Temple Hall",
    },
    {
      id: 2,
      day: "22",
      month: "SEP",
      title: "Radhastami Celebrations",
      time: "10:00 AM - 2:00 PM",
      location: "Ashram Gardens",
    },
    {
      id: 3,
      day: "05",
      month: "OCT",
      title: "Govardhan Puja & Annakut",
      time: "5:00 PM Onwards",
      location: "Goshala Grounds",
    },
  ];

  return (
    <section className="events-section">
      <Container>
        <div className="text-center mb-5">
          <h6
            className="text-uppercase"
            style={{ color: "var(--primary-color)", letterSpacing: "2px" }}
          >
            Join our Sacred Gatherings
          </h6>
          <h2
            className="section-title"
            style={{ fontFamily: "var(--font-heading)", fontSize: "2.5rem" }}
          >
            Upcoming Events
          </h2>
        </div>

        {events.map((event) => (
          <Row key={event.id} className="event-row align-items-center">
            {/* Date Box */}
            <Col xs={3} md={2} className="d-flex justify-content-center">
              <div className="event-date-box">
                <span className="event-month">{event.month}</span>
                <span className="event-day">{event.day}</span>
              </div>
            </Col>

            {/* Event Details */}
            <Col xs={9} md={7}>
              <h3 className="event-title">{event.title}</h3>
              <div className="d-flex gap-3 text-muted small">
                <span>
                  <FaClock className="me-1 text-warning" /> {event.time}
                </span>
                <span>
                  <FaMapMarkerAlt className="me-1 text-danger" />{" "}
                  {event.location}
                </span>
              </div>
            </Col>

            {/* Action Button */}
            <Col xs={12} md={3} className="text-md-end mt-3 mt-md-0">
              <Button variant="outline-dark" className="rounded-pill px-4">
                Register Free
              </Button>
            </Col>
          </Row>
        ))}

        <div className="text-center mt-5">
          <Button className="btn-ashram">View Full Calendar</Button>
        </div>
      </Container>
    </section>
  );
};

export default UpcomingEvents;


--- FILE: client/src/index.css ---
@import url("https://fonts.googleapis.com/css2?family=Lato:wght@200;400&family=Playfair+Display:wght@700&display=swap");

:root {
  /* --- Premium Color Palette --- */
  --primary-color: #d35400; /* Deep Saffron (Om/Fire color) */
  --primary-hover: #e67e22; /* Lighter Orange */
  --secondary-color: #581818; /* Royal Maroon */
  --gold-accent: #daa520; /* Goldenrod */
  --text-dark: #2c3e50;
  --text-light: #ffffff;
  --bg-cream: #fffbf0; /* Light Cream for section backgrounds */

  /* --- Fonts --- */
  --font-heading: "Playfair Display", serif; /* Divine Look */
  --font-body: "Lato", sans-serif; /* Clean Readability */
}

body {
  font-family: var(--font-body);
  color: var(--text-dark);
  background-color: #f8f9fa;
  margin: 0;
  padding: 0;
}

/* Global Typography Overrides */
h1,
h2,
h3,
h4,
h5,
h6 {
  font-family: var(--font-heading);
}

a {
  text-decoration: none;
}


--- FILE: client/src/main.jsx ---
import React from "react";
import ReactDOM from "react-dom/client";
import App from "./App.jsx";
import "./index.css";

// Import Bootstrap CSS
import "bootstrap/dist/css/bootstrap.min.css";
// Import Bootstrap JS (optional, for dropdowns/modals later)
import "bootstrap/dist/js/bootstrap.bundle.min";

import { BrowserRouter } from "react-router-dom";

ReactDOM.createRoot(document.getElementById("root")).render(
  <React.StrictMode>
    <BrowserRouter>
      <App />
    </BrowserRouter>
  </React.StrictMode>
);


--- FILE: client/src/pages/About.css ---
/* --- Page Hero (Breadcrumb style) --- */
.page-hero {
  background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)),
    url("https://images.unsplash.com/photo-1469044552483-057d60517869?q=80&w=1920&auto=format&fit=crop");
  background-size: cover;
  background-position: center;
  height: 300px;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  color: white;
}

.page-title {
  font-family: "Playfair Display", serif;
  font-size: 3rem;
  font-weight: 700;
  letter-spacing: 2px;
  text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.5);
}

/* --- Section Styling --- */
.about-section {
  padding: 80px 0;
  background-color: white;
}

.about-bg-cream {
  background-color: #fffbf5; /* Light cream for alternating sections */
}

/* Headings */
.section-heading {
  font-family: "Playfair Display", serif;
  color: #581818;
  font-size: 2.2rem;
  margin-bottom: 20px;
  position: relative;
  display: inline-block;
}

.section-heading::after {
  content: "";
  display: block;
  width: 60%;
  height: 3px;
  background-color: #d35400; /* Saffron underline */
  margin-top: 10px;
}

.text-content {
  font-family: "Lato", sans-serif;
  color: #555;
  font-size: 1.1rem;
  line-height: 1.8;
  margin-bottom: 20px;
}

/* --- Mission Cards --- */
.mission-card {
  background: white;
  padding: 40px 30px;
  text-align: center;
  border-top: 5px solid #d35400;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
  transition: transform 0.3s;
  height: 100%;
}

.mission-card:hover {
  transform: translateY(-10px);
}

.mission-icon {
  font-size: 3rem;
  color: #daa520; /* Gold */
  margin-bottom: 20px;
}

.mission-title {
  font-family: "Playfair Display", serif;
  font-size: 1.5rem;
  color: #581818;
  margin-bottom: 15px;
}

/* --- Founder Section --- */
.founder-img-box {
  position: relative;
  padding: 10px;
  border: 2px solid #daa520; /* Gold Border */
  border-radius: 8px;
  display: inline-block;
}

.founder-img {
  width: 100%;
  max-width: 400px;
  border-radius: 4px;
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
}

/* --- Stats Strip --- */
.stats-strip {
  background-color: #581818;
  padding: 50px 0;
  color: white;
  text-align: center;
}

.stat-number {
  font-size: 2.5rem;
  font-weight: 700;
  color: #ffd700;
  font-family: "Playfair Display", serif;
}

.stat-label {
  text-transform: uppercase;
  letter-spacing: 1px;
  font-size: 0.9rem;
  opacity: 0.8;
}


--- FILE: client/src/pages/About.jsx ---
import React from "react";
import { Container, Row, Col } from "react-bootstrap";
import { FaHandHoldingHeart, FaDove, FaUniversity } from "react-icons/fa";
import "./About.css";

const About = () => {
  return (
    <>
      {/* 1. Page Hero */}
      <div className="page-hero">
        <div>
          <h1 className="page-title">About Us</h1>
          <p className="lead text-white-50">Serving Humanity since 2010</p>
        </div>
      </div>

      {/* 2. Our Story (Image Left, Text Right) */}
      <section className="about-section">
        <Container>
          <Row className="align-items-center">
            <Col lg={6} className="mb-4 mb-lg-0">
              <div className="position-relative">
                <img
                  src="https://images.unsplash.com/photo-1516216628259-22b512b91873?w=800&auto=format&fit=crop"
                  alt="Ashram Activities"
                  className="img-fluid rounded shadow-lg"
                  style={{ border: "10px solid white" }}
                />
                {/* Decorative Box behind image */}
                <div
                  style={{
                    position: "absolute",
                    top: "-20px",
                    left: "-20px",
                    width: "100%",
                    height: "100%",
                    border: "2px solid #D35400",
                    zIndex: -1,
                    borderRadius: "4px",
                  }}
                ></div>
              </div>
            </Col>
            <Col lg={6} className="ps-lg-5">
              <h2 className="section-heading">Our Sacred Journey</h2>
              <p className="text-content">
                Karunasri Seva Samithi was established with a singular vision:
                to see God in every living being. What started as a small
                initiative to feed 10 people a day has now grown into a massive
                movement of compassion.
              </p>
              <p className="text-content">
                Guided by the principles of Sanatana Dharma, our Ashram provides
                shelter to the homeless, education to underprivileged children
                (Vidyarthi Nidhi), and protects our sacred cows (Go-Seva). We
                believe that <em>"Manava Sevaye Madhava Seva"</em> (Service to
                Man is Service to God).
              </p>
            </Col>
          </Row>
        </Container>
      </section>

      {/* 3. Mission, Vision, Values (Cards) */}
      <section className="about-section about-bg-cream">
        <Container>
          <Row>
            <Col md={4} className="mb-4">
              <div className="mission-card">
                <FaHandHoldingHeart className="mission-icon" />
                <h3 className="mission-title">Our Mission</h3>
                <p className="text-muted">
                  To eradicate hunger and illiteracy by providing free food,
                  education, and shelter to the most vulnerable sections of
                  society.
                </p>
              </div>
            </Col>
            <Col md={4} className="mb-4">
              <div className="mission-card">
                <FaDove className="mission-icon" />
                <h3 className="mission-title">Our Vision</h3>
                <p className="text-muted">
                  A society where compassion rules, where no child goes to sleep
                  hungry, and where every individual lives with dignity.
                </p>
              </div>
            </Col>
            <Col md={4} className="mb-4">
              <div className="mission-card">
                <FaUniversity className="mission-icon" />
                <h3 className="mission-title">Our Values</h3>
                <p className="text-muted">
                  Integrity, Compassion, Transparency, and Selfless Service are
                  the four pillars that uphold our organization.
                </p>
              </div>
            </Col>
          </Row>
        </Container>
      </section>

      {/* 4. Impact Statistics */}
      <div className="stats-strip">
        <Container>
          <Row>
            <Col md={3} xs={6} className="mb-4 mb-md-0">
              <div className="stat-number">15+</div>
              <div className="stat-label">Years of Service</div>
            </Col>
            <Col md={3} xs={6} className="mb-4 mb-md-0">
              <div className="stat-number">2M+</div>
              <div className="stat-label">Meals Served</div>
            </Col>
            <Col md={3} xs={6}>
              <div className="stat-number">500+</div>
              <div className="stat-label">Students Educated</div>
            </Col>
            <Col md={3} xs={6}>
              <div className="stat-number">3</div>
              <div className="stat-label">Active Branches</div>
            </Col>
          </Row>
        </Container>
      </div>

      {/* 5. Founder / Inspiration */}
      <section className="about-section">
        <Container>
          <Row className="align-items-center flex-row-reverse">
            <Col lg={5} className="mb-4 mb-lg-0 text-center">
              <div className="founder-img-box">
                {/* Placeholder for Swamiji/Founder Image */}
                <img
                  src="https://upload.wikimedia.org/wikipedia/commons/9/9b/Swami_Vivekananda_1893_Scanned_Image.jpg"
                  alt="Founder"
                  className="founder-img"
                />
              </div>
            </Col>
            <Col lg={7}>
              <h2 className="section-heading">Words of Inspiration</h2>
              <blockquote className="blockquote mt-3">
                <p
                  className="fst-italic text-muted"
                  style={{ fontSize: "1.3rem" }}
                >
                  "We want that education by which character is formed, strength
                  of mind is increased, the intellect is expanded, and by which
                  one can stand on one's own feet."
                </p>
                <footer className="blockquote-footer mt-2 text-warning">
                  Swami Vivekananda{" "}
                  <cite title="Source Title">(Inspiration)</cite>
                </footer>
              </blockquote>
              <p className="text-content mt-4">
                Our founders were deeply moved by these words. Following the
                path of the great Acharyas, Karunasri Seva Samithi strives to
                build a character-rich society through its various service
                wings.
              </p>
            </Col>
          </Row>
        </Container>
      </section>

      {/* 6. Branches / Legal Info */}
      <section className="py-5 bg-light text-center border-top">
        <Container>
          <h4 style={{ fontFamily: "Playfair Display", color: "#581818" }}>
            Registered Trust Branches
          </h4>
          <p className="text-muted mb-4">
            We currently operate across multiple locations to serve more people.
          </p>
          <Row className="justify-content-center">
            <Col md={3} className="mb-3">
              <div className="p-3 bg-white border rounded">
                <h6 className="fw-bold text-dark">Hyderabad (HQ)</h6>
                <small>Saroornagar</small>
              </div>
            </Col>
            <Col md={3} className="mb-3">
              <div className="p-3 bg-white border rounded">
                <h6 className="fw-bold text-dark">Warangal</h6>
                <small>Hanamkonda</small>
              </div>
            </Col>
            <Col md={3} className="mb-3">
              <div className="p-3 bg-white border rounded">
                <h6 className="fw-bold text-dark">Vijayawada</h6>
                <small>Benz Circle</small>
              </div>
            </Col>
          </Row>
          <div className="mt-4">
            <small className="text-muted">
              Registered under Trust Act. 80G & 12A Exempted.
            </small>
          </div>
        </Container>
      </section>
    </>
  );
};

export default About;


--- FILE: client/src/pages/Activities.css ---
/* --- Page Hero --- */
.activities-hero {
  background: linear-gradient(rgba(44, 11, 11, 0.7), rgba(44, 11, 11, 0.7)),
    url("https://images.unsplash.com/photo-1459183885421-5cc683b8dbba?q=80&w=1920&auto=format&fit=crop");
  background-size: cover;
  background-position: center;
  height: 350px; /* Slightly taller for grandeur */
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  color: white;
  margin-bottom: 60px;
}

/* --- Service Row (Zig Zag Layout) --- */
.seva-row {
  margin-bottom: 80px;
  align-items: center;
}

/* The Image Container with Divine Border */
.seva-img-wrapper {
  position: relative;
  padding: 15px;
  border: 1px solid #e6ccb2; /* Light Tan */
}

/* The decorative corner borders */
.seva-img-wrapper::before,
.seva-img-wrapper::after {
  content: "";
  position: absolute;
  width: 50px;
  height: 50px;
  border-color: #d35400; /* Saffron */
  border-style: solid;
  transition: all 0.3s;
}

/* Top-Left Corner */
.seva-img-wrapper::before {
  top: 0;
  left: 0;
  border-width: 3px 0 0 3px;
}

/* Bottom-Right Corner */
.seva-img-wrapper::after {
  bottom: 0;
  right: 0;
  border-width: 0 3px 3px 0;
}

.seva-img {
  width: 100%;
  border-radius: 4px;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s;
}

.seva-img:hover {
  transform: scale(1.02);
}

/* Text Content */
.seva-title {
  font-family: "Playfair Display", serif;
  color: #581818;
  font-size: 2rem;
  margin-bottom: 15px;
  font-weight: 700;
}

.seva-subtitle {
  color: #d35400; /* Saffron */
  font-weight: bold;
  text-transform: uppercase;
  letter-spacing: 1px;
  font-size: 0.9rem;
  margin-bottom: 15px;
  display: block;
}

.seva-desc {
  font-family: "Lato", sans-serif;
  color: #555;
  line-height: 1.8;
  font-size: 1.05rem;
  margin-bottom: 25px;
}

/* List of features within the text */
.seva-features {
  list-style: none;
  padding: 0;
  margin-bottom: 25px;
}

.seva-features li {
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  color: #444;
}

.feature-check {
  color: #25d366; /* Green check */
  margin-right: 10px;
}

/* Specific button for the activity */
.btn-seva-donate {
  background-color: #581818;
  color: white;
  padding: 10px 30px;
  border-radius: 30px;
  text-decoration: none;
  font-weight: bold;
  display: inline-block;
  transition: background 0.3s;
}

.btn-seva-donate:hover {
  background-color: #d35400;
  color: white;
}


--- FILE: client/src/pages/Activities.jsx ---
import React from "react";
import { Container, Row, Col } from "react-bootstrap";
import { Link } from "react-router-dom";
import { FaCheckCircle } from "react-icons/fa";
import "./Activities.css";

const Activities = () => {
  // Data for your services
  const sevas = [
    {
      id: 1,
      title: "Nitya Annadhana",
      subtitle: "Food Distribution Service",
      desc: "Hunger is the greatest enemy of human dignity. At Karunasri, we ensure that no one who comes to our Ashram goes back hungry. We serve wholesome, sattvic meals to sadhus, students, and the destitute every single day.",
      features: [
        "Daily feeding of 500+ people.",
        "Special feasts on festivals.",
        "Hygienic and nutritious preparation.",
      ],
      img: "https://images.unsplash.com/photo-1606216794074-735e91aa9c29?q=80&w=800&auto=format&fit=crop",
    },
    {
      id: 2,
      title: "Vidyarthi Nidhi",
      subtitle: "Education Support",
      desc: "Vidya (Knowledge) is the greatest wealth. We support underprivileged children by providing school fees, uniforms, and books. We also run a Vedic Patashala to preserve our ancient culture and traditions.",
      features: [
        "Scholarships for merit students.",
        "Free books and stationary distribution.",
        "Vedic chanting classes.",
      ],
      img: "https://images.unsplash.com/photo-1497633762265-9d179a990aa6?q=80&w=800&auto=format&fit=crop",
    },
    {
      id: 3,
      title: "Go-Seva (Cow Protection)",
      subtitle: "Animal Welfare",
      desc: "The cow is considered a mother in our culture. Our Goshala houses over 50 cows that have been rescued or are too old to produce milk. We provide them with fodder, medical care, and a loving home.",
      features: [
        "Shelter for abandoned cows.",
        "Daily Green Fodder & Medical checks.",
        "Go-Puja performed daily.",
      ],
      img: "https://images.unsplash.com/photo-1593113598332-cd288d649433?q=80&w=800&auto=format&fit=crop",
    },
    {
      id: 4,
      title: "Ashram Maintenance",
      subtitle: "Divine Infrastructure",
      desc: "To facilitate all these activities, we maintain a clean and spiritual environment. This includes the prayer hall, the kitchen, and the guest house for pilgrims.",
      features: [
        "Temple cleanliness and rituals.",
        "Accommodation for pilgrims.",
        "Greenery and garden maintenance.",
      ],
      img: "https://images.unsplash.com/photo-1564424918239-01150824b260?q=80&w=800&auto=format&fit=crop", // Temple/Building image
    },
  ];

  return (
    <>
      {/* 1. Hero Section */}
      <div className="activities-hero">
        <Container>
          <h1
            className="display-3 fw-bold"
            style={{ fontFamily: "Playfair Display, serif" }}
          >
            Our Sevas
          </h1>
          <p className="lead" style={{ opacity: 0.9 }}>
            Devotion through Action
          </p>
        </Container>
      </div>

      {/* 2. Activities List (Zig-Zag) */}
      <Container>
        {sevas.map((seva, index) => (
          // Logic: If index is even (0, 2), Image Left. If odd (1, 3), Image Right.
          <Row
            key={seva.id}
            className={`seva-row ${index % 2 !== 0 ? "flex-row-reverse" : ""}`}
          >
            {/* Image Column */}
            <Col lg={6} className="mb-4 mb-lg-0">
              <div className="seva-img-wrapper">
                <img src={seva.img} alt={seva.title} className="seva-img" />
              </div>
            </Col>

            {/* Text Column */}
            <Col lg={6} className="px-lg-5">
              <span className="seva-subtitle">{seva.subtitle}</span>
              <h2 className="seva-title">{seva.title}</h2>
              <p className="seva-desc">{seva.desc}</p>

              <ul className="seva-features">
                {seva.features.map((feature, idx) => (
                  <li key={idx}>
                    <FaCheckCircle className="feature-check" /> {feature}
                  </li>
                ))}
              </ul>

              <Link to="/donate" className="btn-seva-donate">
                Donate for {seva.title.split(" ")[0]}{" "}
                {/* Takes first word e.g. Donate for Nitya */}
              </Link>
            </Col>
          </Row>
        ))}
      </Container>

      {/* 3. Bottom Call to Action */}
      <div className="bg-light py-5 text-center mt-5">
        <Container>
          <h3 style={{ color: "#581818", fontFamily: "Playfair Display" }}>
            Ready to make a difference?
          </h3>
          <p className="text-muted mb-4">
            Your small contribution can save a life today.
          </p>
          <Link to="/donate" className="btn btn-ashram btn-lg">
            General Donation
          </Link>
        </Container>
      </div>
    </>
  );
};

export default Activities;


--- FILE: client/src/pages/admin/AuditHistory.jsx ---
// import React, { useEffect, useState } from "react";
// import {
//   Card,
//   Table,
//   Badge,
//   Row,
//   Col,
//   Button,
//   Accordion,
//   Spinner,
// } from "react-bootstrap";
// import { FaHistory, FaArrowLeft, FaUser, FaCalendarAlt } from "react-icons/fa";
// import { Link } from "react-router-dom";
// import axios from "axios";

// const AuditHistory = () => {
//   const [audits, setAudits] = useState([]);
//   const [loading, setLoading] = useState(true);

//   useEffect(() => {
//     // eslint-disable-next-line react-hooks/immutability
//     fetchAudits();
//   }, []);

//   const fetchAudits = async () => {
//     try {
//       const userInfo = JSON.parse(localStorage.getItem("userInfo"));
//       const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };
//       const { data } = await axios.get(
//         "http://localhost:5000/api/inventory/audit",
//         config
//       );
//       setAudits(data);
//       setLoading(false);
//     } catch (error) {
//       console.error(error);
//       setLoading(false);
//     }
//   };

//   if (loading)
//     return (
//       <div className="text-center py-5">
//         <Spinner animation="border" />
//       </div>
//     );

//   return (
//     <div>
//       <Row className="mb-4 align-items-center">
//         <Col>
//           <div className="d-flex align-items-center gap-3">
//             <Link
//               to="/dashboard/inventory"
//               className="btn btn-outline-secondary btn-sm"
//             >
//               <FaArrowLeft />
//             </Link>
//             <div>
//               <h2
//                 className="text-maroon m-0"
//                 style={{ fontFamily: "Playfair Display" }}
//               >
//                 Reconciliation History
//               </h2>
//               <p className="text-muted m-0">
//                 Log of all physical stock verifications
//               </p>
//             </div>
//           </div>
//         </Col>
//       </Row>

//       {audits.length === 0 ? (
//         <div className="text-center py-5 text-muted">
//           No audit history found.
//         </div>
//       ) : (
//         <Accordion defaultActiveKey="0">
//           {audits.map((audit, index) => (
//             <Accordion.Item
//               eventKey={index.toString()}
//               key={audit._id}
//               className="mb-3 shadow-sm border-0"
//             >
//               <Accordion.Header>
//                 <div className="d-flex w-100 justify-content-between align-items-center me-3">
//                   <div>
//                     <strong className="text-maroon">
//                       <FaCalendarAlt className="me-2" />{" "}
//                       {new Date(audit.createdAt).toLocaleDateString()}
//                     </strong>
//                     <span className="text-muted ms-2 small">
//                       at {new Date(audit.createdAt).toLocaleTimeString()}
//                     </span>
//                   </div>
//                   <div className="text-muted small">
//                     <FaUser className="me-1" /> Audited by:{" "}
//                     <strong>{audit.auditedBy?.name || "Unknown"}</strong>
//                   </div>
//                 </div>
//               </Accordion.Header>
//               <Accordion.Body>
//                 <Table bordered hover size="sm" className="mb-0">
//                   <thead className="bg-light">
//                     <tr>
//                       <th>Item Name</th>
//                       <th className="text-center">System Qty</th>
//                       <th className="text-center">Physical Qty</th>
//                       <th className="text-center">Difference</th>
//                       <th>Remark / Reason</th>
//                     </tr>
//                   </thead>
//                   <tbody>
//                     {audit.items.map((item, idx) => (
//                       <tr
//                         key={idx}
//                         className={item.difference !== 0 ? "table-warning" : ""}
//                       >
//                         <td className="fw-bold">{item.itemName}</td>
//                         <td className="text-center text-muted">
//                           {item.systemQty}
//                         </td>
//                         <td className="text-center fw-bold">
//                           {item.physicalQty}
//                         </td>
//                         <td className="text-center">
//                           {item.difference === 0 ? (
//                             <Badge bg="success">Match</Badge>
//                           ) : (
//                             <span
//                               className={
//                                 item.difference < 0
//                                   ? "text-danger fw-bold"
//                                   : "text-primary fw-bold"
//                               }
//                             >
//                               {item.difference > 0
//                                 ? `+${item.difference}`
//                                 : item.difference}
//                             </span>
//                           )}
//                         </td>
//                         <td>
//                           {item.difference !== 0 ? (
//                             <span className="text-danger fw-bold">
//                               {item.remark || "No Remark Provided"}
//                             </span>
//                           ) : (
//                             <span className="text-muted small">-</span>
//                           )}
//                         </td>
//                       </tr>
//                     ))}
//                   </tbody>
//                 </Table>
//               </Accordion.Body>
//             </Accordion.Item>
//           ))}
//         </Accordion>
//       )}
//     </div>
//   );
// };

// export default AuditHistory;
import React, { useEffect, useState } from "react";
import {
  Card,
  Table,
  Badge,
  Row,
  Col,
  Button,
  Accordion,
  Spinner,
} from "react-bootstrap";
// Add FaTrash to imports
import {
  FaHistory,
  FaArrowLeft,
  FaUser,
  FaCalendarAlt,
  FaTrash,
} from "react-icons/fa";
import { Link } from "react-router-dom";
import axios from "axios";

const AuditHistory = () => {
  const [audits, setAudits] = useState([]);
  const [loading, setLoading] = useState(true);
  const [currentUser, setCurrentUser] = useState(null); // To check role

  useEffect(() => {
    const user = JSON.parse(localStorage.getItem("userInfo"));
    setCurrentUser(user);
    // eslint-disable-next-line react-hooks/immutability
    if (user) fetchAudits(user);
  }, []);

  const fetchAudits = async (user) => {
    try {
      const config = { headers: { Authorization: `Bearer ${user.token}` } };
      const { data } = await axios.get(
        "http://localhost:5000/api/inventory/audit",
        config
      );
      setAudits(data);
      setLoading(false);
    } catch (error) {
      console.error(error);
      setLoading(false);
    }
  };

  // --- DELETE HANDLER ---
  const handleDelete = async (id, e) => {
    e.stopPropagation(); // Prevent Accordion from opening when clicking delete
    if (
      !window.confirm(
        "Are you sure you want to delete this audit log? This cannot be undone."
      )
    )
      return;

    try {
      const config = {
        headers: { Authorization: `Bearer ${currentUser.token}` },
      };
      await axios.delete(
        `http://localhost:5000/api/inventory/audit/${id}`,
        config
      );

      alert("Audit Log Deleted");
      fetchAudits(currentUser); // Refresh list
    } catch (error) {
      alert(error.response?.data?.message || "Error deleting record");
    }
  };

  if (loading)
    return (
      <div className="text-center py-5">
        <Spinner animation="border" />
      </div>
    );

  return (
    <div>
      <Row className="mb-4 align-items-center">
        <Col>
          <div className="d-flex align-items-center gap-3">
            <Link
              to="/dashboard/inventory"
              className="btn btn-outline-secondary btn-sm"
            >
              <FaArrowLeft />
            </Link>
            <div>
              <h2
                className="text-maroon m-0"
                style={{ fontFamily: "Playfair Display" }}
              >
                Reconciliation History
              </h2>
              <p className="text-muted m-0">
                Log of all physical stock verifications
              </p>
            </div>
          </div>
        </Col>
      </Row>

      {audits.length === 0 ? (
        <div className="text-center py-5 text-muted">
          No audit history found.
        </div>
      ) : (
        <Accordion defaultActiveKey="0">
          {audits.map((audit, index) => (
            <Accordion.Item
              eventKey={index.toString()}
              key={audit._id}
              className="mb-3 shadow-sm border-0"
            >
              <Accordion.Header>
                <div className="d-flex w-100 justify-content-between align-items-center me-3">
                  <div>
                    <strong className="text-maroon">
                      <FaCalendarAlt className="me-2" />{" "}
                      {new Date(audit.createdAt).toLocaleDateString()}
                    </strong>
                    <span className="text-muted ms-2 small">
                      at {new Date(audit.createdAt).toLocaleTimeString()}
                    </span>
                  </div>

                  <div className="d-flex align-items-center gap-3">
                    <div className="text-muted small">
                      <FaUser className="me-1" /> Audited by:{" "}
                      <strong>{audit.auditedBy?.name || "Unknown"}</strong>
                    </div>

                    {/* DELETE BUTTON - Only for Admins */}
                    {currentUser?.role === "admin" && (
                      <Button
                        variant="outline-danger"
                        size="sm"
                        onClick={(e) => handleDelete(audit._id, e)}
                        title="Delete Log"
                      >
                        <FaTrash />
                      </Button>
                    )}
                  </div>
                </div>
              </Accordion.Header>
              <Accordion.Body>
                <Table bordered hover size="sm" className="mb-0">
                  <thead className="bg-light">
                    <tr>
                      <th>Item Name</th>
                      <th className="text-center">System Qty</th>
                      <th className="text-center">Physical Qty</th>
                      <th className="text-center">Difference</th>
                      <th>Remark / Reason</th>
                    </tr>
                  </thead>
                  <tbody>
                    {audit.items.map((item, idx) => (
                      <tr
                        key={idx}
                        className={item.difference !== 0 ? "table-warning" : ""}
                      >
                        <td className="fw-bold">{item.itemName}</td>
                        <td className="text-center text-muted">
                          {item.systemQty}
                        </td>
                        <td className="text-center fw-bold">
                          {item.physicalQty}
                        </td>
                        <td className="text-center">
                          {item.difference === 0 ? (
                            <Badge bg="success">Match</Badge>
                          ) : (
                            <span
                              className={
                                item.difference < 0
                                  ? "text-danger fw-bold"
                                  : "text-primary fw-bold"
                              }
                            >
                              {item.difference > 0
                                ? `+${item.difference}`
                                : item.difference}
                            </span>
                          )}
                        </td>
                        <td>
                          {item.difference !== 0 ? (
                            <span className="text-danger fw-bold">
                              {item.remark || "No Remark Provided"}
                            </span>
                          ) : (
                            <span className="text-muted small">-</span>
                          )}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </Table>
              </Accordion.Body>
            </Accordion.Item>
          ))}
        </Accordion>
      )}
    </div>
  );
};

export default AuditHistory;


--- FILE: client/src/pages/admin/CashReconciliation.jsx ---
/* eslint-disable react-hooks/immutability */
/* eslint-disable no-unused-vars */
import React, { useEffect, useState } from "react";
import { Card, Row, Col, Form, Button, Alert, Spinner } from "react-bootstrap";
import { FaBalanceScale, FaArrowLeft, FaSave } from "react-icons/fa";
import { Link, useNavigate } from "react-router-dom";
import axios from "axios";

const CashReconciliation = () => {
  const navigate = useNavigate();
  const [systemBalance, setSystemBalance] = useState(0);
  const [physicalBalance, setPhysicalBalance] = useState("");
  const [remark, setRemark] = useState("");
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchBalance();
  }, []);

  const fetchBalance = async () => {
    try {
      const userInfo = JSON.parse(localStorage.getItem("userInfo"));
      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };
      const { data } = await axios.get(
        "http://localhost:5000/api/finance/cash-balance",
        config
      );
      setSystemBalance(data.systemBalance);
      setLoading(false);
    } catch (error) {
      alert("Error fetching balance");
      setLoading(false);
    }
  };

  const handleReconcile = async () => {
    if (physicalBalance === "") return alert("Enter physical balance");
    const diff = Number(physicalBalance) - systemBalance;

    if (diff === 0) return alert("Balances match! No adjustment needed.");
    if (!remark) return alert("Please provide a reason for the mismatch.");

    if (
      !window.confirm(
        `This will create an adjustment voucher for Rs. ${Math.abs(
          diff
        )}. Proceed?`
      )
    )
      return;

    try {
      const userInfo = JSON.parse(localStorage.getItem("userInfo"));
      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };

      await axios.post(
        "http://localhost:5000/api/finance/reconcile",
        {
          systemBalance,
          physicalBalance: Number(physicalBalance),
          remark,
        },
        config
      );

      alert("Reconciliation Successful! Adjustment Voucher Created.");
      navigate("/dashboard/finance"); // Go back to list
    } catch (error) {
      alert("Error posting adjustment");
    }
  };

  if (loading)
    return (
      <div className="text-center py-5">
        <Spinner animation="border" />
      </div>
    );

  const difference =
    physicalBalance !== "" ? Number(physicalBalance) - systemBalance : 0;

  return (
    <div>
      <div className="d-flex align-items-center gap-3 mb-4">
        <Link
          to="/dashboard/finance"
          className="btn btn-outline-secondary btn-sm"
        >
          <FaArrowLeft />
        </Link>
        <div>
          <h2
            className="text-maroon m-0"
            style={{ fontFamily: "Playfair Display" }}
          >
            Cash Reconciliation
          </h2>
          <p className="text-muted m-0">
            Compare System Books vs Physical Cash
          </p>
        </div>
      </div>

      <Row className="justify-content-center">
        <Col md={8}>
          <Card className="shadow-lg border-0">
            <Card.Body className="p-5">
              {/* System Balance Display */}
              <div className="text-center mb-4 p-3 bg-light rounded">
                <h5 className="text-muted">Expected System Cash Balance</h5>
                <h1 className="fw-bold text-maroon">
                   {systemBalance.toLocaleString()}
                </h1>
              </div>

              <Form>
                <Form.Group className="mb-4">
                  <Form.Label className="fw-bold">
                    Physical Cash Count (Actual)
                  </Form.Label>
                  <Form.Control
                    type="number"
                    size="lg"
                    placeholder="Enter amount counted in drawer"
                    value={physicalBalance}
                    onChange={(e) => setPhysicalBalance(e.target.value)}
                  />
                </Form.Group>

                {/* Difference Indicator */}
                {physicalBalance !== "" && (
                  <div
                    className={`alert ${
                      difference === 0 ? "alert-success" : "alert-warning"
                    } text-center`}
                  >
                    {difference === 0 ? (
                      <strong>
                        <FaBalanceScale /> Perfect Match!
                      </strong>
                    ) : (
                      <div>
                        <strong>Mismatch Detected: </strong>
                        <span
                          className={
                            difference < 0
                              ? "text-danger fw-bold"
                              : "text-success fw-bold"
                          }
                        >
                          {difference > 0
                            ? `+ ${difference}`
                            : `- ${Math.abs(difference)}`}
                        </span>
                        <p className="mb-0 small mt-1">
                          {difference < 0
                            ? "Cash Shortage (Will create Expense Voucher)"
                            : "Excess Cash (Will create Income Voucher)"}
                        </p>
                      </div>
                    )}
                  </div>
                )}

                {difference !== 0 && (
                  <Form.Group className="mb-4">
                    <Form.Label>Reason for Discrepancy</Form.Label>
                    <Form.Control
                      as="textarea"
                      rows={3}
                      placeholder="e.g. Rounding error, Lost receipt, Found loose change"
                      value={remark}
                      onChange={(e) => setRemark(e.target.value)}
                    />
                  </Form.Group>
                )}

                <div className="d-grid">
                  <Button
                    variant={difference === 0 ? "success" : "danger"}
                    size="lg"
                    disabled={difference === 0 || !physicalBalance}
                    onClick={handleReconcile}
                  >
                    {difference === 0
                      ? "Books are Balanced"
                      : "Post Adjustment Voucher"}
                  </Button>
                </div>
              </Form>
            </Card.Body>
          </Card>
        </Col>
      </Row>
    </div>
  );
};

export default CashReconciliation;


--- FILE: client/src/pages/admin/DashboardHome.jsx ---
/* eslint-disable react-hooks/immutability */
// import React from "react";
// import { Row, Col, Card } from "react-bootstrap";

// const DashboardHome = () => {
//   return (
//     <div>
//       <h2
//         className="mb-4 text-maroon"
//         style={{ fontFamily: "Playfair Display" }}
//       >
//         Dashboard Overview
//       </h2>

//       <Row>
//         {/* Card 1 */}
//         <Col md={3}>
//           <Card
//             className="p-3 mb-3 text-white shadow border-0"
//             style={{ backgroundColor: "#581818" }}
//           >
//             <div className="d-flex justify-content-between align-items-center">
//               <div>
//                 <h3 className="mb-0">150</h3>
//                 <small>Total Donors</small>
//               </div>
//               <div style={{ fontSize: "2rem", opacity: 0.5 }}></div>
//             </div>
//           </Card>
//         </Col>

//         {/* Card 2 */}
//         <Col md={3}>
//           <Card
//             className="p-3 mb-3 text-white shadow border-0"
//             style={{ backgroundColor: "#D35400" }}
//           >
//             <div className="d-flex justify-content-between align-items-center">
//               <div>
//                 <h3 className="mb-0"> 1.2L</h3>
//                 <small>Donations (Month)</small>
//               </div>
//               <div style={{ fontSize: "2rem", opacity: 0.5 }}></div>
//             </div>
//           </Card>
//         </Col>

//         {/* Card 3 */}
//         <Col md={3}>
//           <Card
//             className="p-3 mb-3 text-white shadow border-0"
//             style={{ backgroundColor: "#25D366" }}
//           >
//             <div className="d-flex justify-content-between align-items-center">
//               <div>
//                 <h3 className="mb-0">12</h3>
//                 <small>Pending Approvals</small>
//               </div>
//               <div style={{ fontSize: "2rem", opacity: 0.5 }}></div>
//             </div>
//           </Card>
//         </Col>
//       </Row>
//     </div>
//   );
// };

// export default DashboardHome;

import React, { useEffect, useState } from "react";
import { Row, Col, Card, Table, Spinner, Alert } from "react-bootstrap";
import {
  FaRupeeSign,
  FaUserGraduate,
  FaExclamationTriangle,
  FaHandHoldingHeart,
  FaArrowRight,
} from "react-icons/fa";
import { Link } from "react-router-dom";
import axios from "axios";

const DashboardHome = () => {
  const [stats, setStats] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");
  const [user, setUser] = useState(null);

  useEffect(() => {
    const userInfo = JSON.parse(localStorage.getItem("userInfo"));
    setUser(userInfo);
    if (userInfo) fetchStats(userInfo);
  }, []);

  const fetchStats = async (userInfo) => {
    try {
      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };
      // Call the API to get REAL numbers
      const { data } = await axios.get(
        "http://localhost:5000/api/reports/stats",
        config
      );
      setStats(data);
      setLoading(false);
    } catch (err) {
      console.error(err);
      setError("Failed to load dashboard data");
      setLoading(false);
    }
  };

  if (loading)
    return (
      <div className="text-center py-5">
        <Spinner animation="border" variant="primary" />
      </div>
    );
  if (error) return <Alert variant="danger">{error}</Alert>;

  return (
    <div>
      {/* --- Welcome Section --- */}
      <div className="mb-4">
        <h2 className="text-maroon" style={{ fontFamily: "Playfair Display" }}>
          Welcome back, {user?.name.split(" ")[0]}!
        </h2>
        <p className="text-muted">
          Here is the real-time status of the Ashram.
        </p>
      </div>

      {/* --- Key Metrics Cards (Dynamic Data) --- */}
      <Row className="mb-4">
        {/* 1. Total Donations */}
        <Col md={3}>
          <Card
            className="p-3 mb-3 text-white shadow border-0"
            style={{ background: "linear-gradient(45deg, #11998e, #38ef7d)" }}
          >
            <div className="d-flex justify-content-between align-items-center">
              <div>
                {/* Display Real Income */}
                <h3 className="mb-0 fw-bold">
                   {stats.financials.income.toLocaleString()}
                </h3>
                <small>Total Donations</small>
              </div>
              <div style={{ fontSize: "2rem", opacity: 0.5 }}>
                <FaHandHoldingHeart />
              </div>
            </div>
          </Card>
        </Col>

        {/* 2. Expenses */}
        <Col md={3}>
          <Card
            className="p-3 mb-3 text-white shadow border-0"
            style={{ background: "linear-gradient(45deg, #ff416c, #ff4b2b)" }}
          >
            <div className="d-flex justify-content-between align-items-center">
              <div>
                {/* Display Real Expenses */}
                <h3 className="mb-0 fw-bold">
                   {stats.financials.expense.toLocaleString()}
                </h3>
                <small>Total Expenses</small>
              </div>
              <div style={{ fontSize: "2rem", opacity: 0.5 }}>
                <FaRupeeSign />
              </div>
            </div>
          </Card>
        </Col>

        {/* 3. Active Students */}
        <Col md={3}>
          <Card
            className="p-3 mb-3 text-white shadow border-0"
            style={{ background: "linear-gradient(45deg, #2193b0, #6dd5ed)" }}
          >
            <div className="d-flex justify-content-between align-items-center">
              <div>
                {/* Display Real Student Count */}
                <h3 className="mb-0 fw-bold">{stats.counts.students}</h3>
                <small>Active Students</small>
              </div>
              <div style={{ fontSize: "2rem", opacity: 0.5 }}>
                <FaUserGraduate />
              </div>
            </div>
          </Card>
        </Col>

        {/* 4. Low Stock Alerts */}
        <Col md={3}>
          <Card
            className="p-3 mb-3 text-white shadow border-0"
            style={{ background: "linear-gradient(45deg, #f7971e, #ffd200)" }}
          >
            <div className="d-flex justify-content-between align-items-center">
              <div>
                {/* Display Real Low Stock Count */}
                <h3 className="mb-0 fw-bold">{stats.counts.lowStock}</h3>
                <small>Low Stock Items</small>
              </div>
              <div style={{ fontSize: "2rem", opacity: 0.5 }}>
                <FaExclamationTriangle />
              </div>
            </div>
          </Card>
        </Col>
      </Row>

      {/* --- Recent Activity Section --- */}
      <Row>
        <Col md={8}>
          <Card className="shadow-sm border-0">
            <Card.Header className="bg-white py-3 d-flex justify-content-between align-items-center">
              <h5 className="mb-0 text-maroon">Recent Donations</h5>
              <Link
                to="/dashboard/donations"
                className="btn btn-sm btn-outline-primary"
              >
                View All <FaArrowRight />
              </Link>
            </Card.Header>
            <Table responsive hover className="mb-0 align-middle">
              <thead className="bg-light">
                <tr>
                  <th className="ps-4">Date</th>
                  <th>Donor</th>
                  <th>Scheme</th>
                  <th className="text-end pe-4">Amount</th>
                </tr>
              </thead>
              <tbody>
                {/* Map through Real Recent Donations */}
                {stats.recentDonations.map((d) => (
                  <tr key={d._id}>
                    <td className="ps-4 text-muted">
                      {new Date(d.createdAt).toLocaleDateString()}
                    </td>
                    <td className="fw-bold">{d.donorName}</td>
                    <td>
                      <span className="badge bg-light text-dark border">
                        {d.scheme}
                      </span>
                    </td>
                    <td className="text-end pe-4 fw-bold text-success">
                      + {d.amount.toLocaleString()}
                    </td>
                  </tr>
                ))}
                {stats.recentDonations.length === 0 && (
                  <tr>
                    <td colSpan="4" className="text-center py-4 text-muted">
                      No recent donations found.
                    </td>
                  </tr>
                )}
              </tbody>
            </Table>
          </Card>
        </Col>

        <Col md={4}>
          {/* Quick Actions Card */}
          <Card className="shadow-sm border-0 mb-4">
            <Card.Header className="bg-white py-3">
              <h5 className="mb-0 text-maroon">Quick Actions</h5>
            </Card.Header>
            <Card.Body>
              <div className="d-grid gap-2">
                <Link
                  to="/dashboard/donations"
                  className="btn btn-outline-dark text-start"
                >
                  <FaHandHoldingHeart className="me-2" /> Add New Donation
                </Link>
                <Link
                  to="/dashboard/finance"
                  className="btn btn-outline-dark text-start"
                >
                  <FaRupeeSign className="me-2" /> Create Expense Voucher
                </Link>
                <Link
                  to="/dashboard/students"
                  className="btn btn-outline-dark text-start"
                >
                  <FaUserGraduate className="me-2" /> Admit Student
                </Link>
              </div>
            </Card.Body>
          </Card>

          {/* System Health / Alerts */}
          {stats.counts.lowStock > 0 && (
            <Alert variant="warning">
              <FaExclamationTriangle className="me-2" />
              <strong>Attention Needed:</strong> {stats.counts.lowStock}{" "}
              inventory items are running low.
              <Link to="/dashboard/inventory" className="alert-link ms-1">
                Check Inventory
              </Link>
            </Alert>
          )}
        </Col>
      </Row>
    </div>
  );
};

export default DashboardHome;


--- FILE: client/src/pages/admin/DonationList.jsx ---
/* eslint-disable react-hooks/exhaustive-deps */
/* eslint-disable no-unused-vars */
import React, { useEffect, useState, useCallback } from "react";
import {
  Table,
  Button,
  Badge,
  Card,
  Row,
  Col,
  Spinner,
  Alert,
  Modal,
  Form,
} from "react-bootstrap";
import { FaPlus, FaFilePdf, FaImages, FaTrash } from "react-icons/fa";
import axios from "axios";

const DonationList = () => {
  const [donations, setDonations] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");
  const [schemes, setSchemes] = useState([]); // New State for schemes

  // Modal State
  const [showModal, setShowModal] = useState(false);
  const [submitLoading, setSubmitLoading] = useState(false);

  // Form State
  const [formData, setFormData] = useState({
    donorName: "",
    donorPhone: "",
    donorEmail: "",
    donorPan: "",
    donorAadhaar: "",
    amount: "",
    scheme: "Nitya Annadhana",
    paymentMode: "Cash",
    paymentReference: "",
    branch: "Headquarters",
  });
  // --- MEDIA MODAL STATE ---
  const [showMediaModal, setShowMediaModal] = useState(false);
  const [selectedDonation, setSelectedDonation] = useState(null);
  const [files, setFiles] = useState([]);
  const [uploading, setUploading] = useState(false);

  // Fetch Schemes
  useEffect(() => {
    const getSchemes = async () => {
      const { data } = await axios.get("http://localhost:5000/api/schemes");
      setSchemes(data);
      // Set default scheme if available
      if (data.length > 0)
        setFormData((prev) => ({ ...prev, scheme: data[0].name }));
    };
    getSchemes();
    fetchDonations(); // Existing fetch
  }, []);

  // --- 1. Define Fetch Function with Safety Checks ---
  const fetchDonations = useCallback(async () => {
    try {
      const userInfo = JSON.parse(localStorage.getItem("userInfo"));

      // Safety Check: If no user logged in, stop here to avoid errors
      if (!userInfo || !userInfo.token) {
        setLoading(false);
        return;
      }

      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };
      const { data } = await axios.get(
        "http://localhost:5000/api/donations",
        config
      );

      setDonations(data);
      setLoading(false);
    } catch (err) {
      console.error(err);
      setError("Failed to fetch donations.");
      setLoading(false);
    }
  }, []);

  // --- 2. Call in useEffect ---
  useEffect(() => {
    fetchDonations();
  }, [fetchDonations]);

  // Handle Input Change
  function handleChange(e) {
    setFormData({ ...formData, [e.target.name]: e.target.value });
  }

  // Handle Form Submit
  const handleSubmit = async (e) => {
    e.preventDefault();
    setSubmitLoading(true);
    try {
      const userInfo = JSON.parse(localStorage.getItem("userInfo"));
      const config = {
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${userInfo.token}`,
        },
      };

      // Send Data to Backend
      await axios.post("http://localhost:5000/api/donations", formData, config);

      // Success: Close Modal, Refresh List, Reset Form
      setShowModal(false);
      fetchDonations();
      setFormData({
        donorName: "",
        donorPhone: "",
        donorEmail: "",
        donorPan: "",
        amount: "",
        scheme: "Nitya Annadhana",
        paymentMode: "Cash",
        paymentReference: "",
        branch: "Headquarters",
      });
      alert("Donation Added Successfully!");
    } catch (err) {
      alert(err.response?.data?.message || "Error adding donation");
    }
    setSubmitLoading(false);
  };
  // --- HANDLE FILE SELECT ---
  const handleFileChange = (e) => {
    setFiles(e.target.files);
  };

  // --- HANDLE UPLOAD SUBMIT ---
  const handleUpload = async (e) => {
    e.preventDefault();
    if (files.length === 0) return alert("Please select files");

    const formData = new FormData();
    for (let i = 0; i < files.length; i++) {
      formData.append("files", files[i]);
    }

    setUploading(true);
    try {
      const userInfo = JSON.parse(localStorage.getItem("userInfo"));
      const config = {
        headers: {
          "Content-Type": "multipart/form-data",
          Authorization: `Bearer ${userInfo.token}`,
        },
      };

      await axios.post(
        `http://localhost:5000/api/donations/${selectedDonation._id}/upload`,
        formData,
        config
      );

      alert("Uploaded Successfully!");
      setFiles([]);
      setShowMediaModal(false);
      fetchDonations(); // Refresh to update data
    } catch (err) {
      alert("Upload failed");
    }
    setUploading(false);
  };

  const openMediaModal = (donation) => {
    setSelectedDonation(donation);
    setShowMediaModal(true);
  };

  // --- NEW DELETE MEDIA FUNCTION ---
  const handleDeleteMedia = async (filePath) => {
    if (!window.confirm("Are you sure you want to delete this file?")) return;

    try {
      const userInfo = JSON.parse(localStorage.getItem("userInfo"));
      const config = {
        headers: { Authorization: `Bearer ${userInfo.token}` },
        data: { filePath }, // Send path in body for DELETE request
      };

      const { data } = await axios.delete(
        `http://localhost:5000/api/donations/${selectedDonation._id}/media`,
        config
      );

      // Update the selected donation in UI immediately
      setSelectedDonation({ ...selectedDonation, media: data.media });
      fetchDonations(); // Refresh main list
      alert("File Deleted");
    } catch (err) {
      alert("Error deleting file");
    }
  };
  const handleExport = () => {
    console.log("Export button clicked..."); // Debug Log 1

    if (!donations || donations.length === 0) {
      alert("No data to export");
      return;
    }

    try {
      // 1. Define Headers
      const headers = [
        "Date",
        "Account Code",
        "Donor Name",
        "Phone",
        "Email",
        "PAN",
        "Scheme",
        "Amount",
        "Mode",
        "Receipt Status",
      ];

      // 2. Map Data (With Safety Checks)
      const rows = donations.map((d) => {
        // Safe check for Account Code
        // If populated: d.accountHead.code
        // If not populated (just ID): 'N/A'
        // If null: 'N/A'
        let accCode = "N/A";
        if (d.accountHead && typeof d.accountHead === "object") {
          accCode = d.accountHead.code || "N/A";
        }

        return [
          new Date(d.createdAt).toLocaleDateString(),
          accCode,
          `"${d.donorName || ""}"`, // Quote strings to handle commas
          `"${d.donorPhone || ""}"`,
          d.donorEmail || "-",
          d.donorPan || "-",
          `"${d.scheme || ""}"`,
          d.amount || 0,
          d.paymentMode || "-",
          d.receiptStatus || "-",
        ];
      });

      // 3. Create CSV Content
      const csvContent =
        headers.join(",") + "\n" + rows.map((e) => e.join(",")).join("\n");

      // 4. Create Blob (Better than encodeURI)
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      // 5. Trigger Download
      const link = document.createElement("a");
      link.href = url;
      link.setAttribute(
        "download",
        `Donations_Export_${new Date().toISOString().split("T")[0]}.csv`
      );
      document.body.appendChild(link);
      link.click();

      // 6. Cleanup
      document.body.removeChild(link);
      console.log("Export successful!"); // Debug Log 2
    } catch (err) {
      console.error("Export Error:", err);
      alert("An error occurred while exporting. Check console for details.");
    }
  };
  return (
    <div>
      {/* --- Header --- */}
      <Row className="mb-4 align-items-center">
        <Col>
          <h2
            className="text-maroon"
            style={{ fontFamily: "Playfair Display" }}
          >
            Donations Management
          </h2>
          <p className="text-muted">Track all incoming donations</p>
        </Col>
        <Col className="text-end">
          <Button variant="success" className="me-2" onClick={handleExport}>
            <FaFilePdf /> Export
          </Button>
          <Button
            variant="primary"
            style={{ backgroundColor: "#581818", border: "none" }}
            onClick={() => setShowModal(true)}
          >
            <FaPlus /> Add New Donation
          </Button>
        </Col>
      </Row>

      {/* --- Error Alert --- */}
      {error && <Alert variant="danger">{error}</Alert>}

      {/* --- Data Table --- */}
      <Card className="shadow-sm border-0">
        <Card.Body className="p-0">
          {loading ? (
            <div className="text-center py-5">
              <Spinner animation="border" />
            </div>
          ) : (
            <Table hover responsive className="align-middle mb-0">
              <thead className="bg-light">
                <tr>
                  <th className="ps-4">Date</th>
                  <th>Donor Name</th>
                  <th>Scheme</th>
                  <th>Amount</th>
                  <th>Mode</th>
                  <th>Branch</th>
                  <th>Receipt</th>
                </tr>
              </thead>
              <tbody>
                {donations.map((d) => (
                  <tr key={d._id}>
                    <td className="ps-4">
                      {new Date(d.createdAt).toLocaleDateString()}
                    </td>
                    <td>
                      <div className="fw-bold">{d.donorName}</div>
                      <small className="text-muted">{d.donorPhone}</small>
                    </td>
                    <td>
                      <Badge bg="info" text="dark">
                        {d.scheme}
                      </Badge>
                    </td>
                    <td className="fw-bold">{d.amount.toLocaleString()}</td>
                    <td>{d.paymentMode}</td>
                    <td>{d.branch}</td>
                    {/* <td>
                      {d.receiptStatus === "Sent" ? (
                        <Badge bg="success">Sent</Badge>
                      ) : (
                        <Button
                          size="sm"
                          variant="outline-dark"
                          style={{ fontSize: "0.7rem" }}
                        >
                          Generate
                        </Button>
                      )}
                    </td> */}
                    <td>
                      <div className="d-flex justify-content-center gap-2">
                        {/* 1. Media Gallery Button */}
                        <Button
                          size="sm"
                          variant={
                            d.media && d.media.length > 0
                              ? "warning"
                              : "outline-secondary"
                          }
                          title="View/Upload Photos"
                          onClick={() => openMediaModal(d)}
                        >
                          <FaImages />
                        </Button>
                        {/* Download Button */}
                        <Button
                          size="sm"
                          variant="outline-dark"
                          title="Download PDF"
                          onClick={async () => {
                            try {
                              const userInfo = JSON.parse(
                                localStorage.getItem("userInfo")
                              );
                              const response = await axios.get(
                                `http://localhost:5000/api/donations/${d._id}/receipt`,
                                {
                                  headers: {
                                    Authorization: `Bearer ${userInfo.token}`,
                                  },
                                  responseType: "blob", // Important for file download
                                }
                              );
                              // Create a link to download the blob
                              const url = window.URL.createObjectURL(
                                new Blob([response.data])
                              );
                              const link = document.createElement("a");
                              link.href = url;
                              link.setAttribute(
                                "download",
                                `Receipt_${d.donorName}.pdf`
                              );
                              document.body.appendChild(link);
                              link.click();
                            } catch (err) {
                              alert("Error downloading receipt");
                            }
                          }}
                        >
                          <FaFilePdf />
                        </Button>

                        {/* Email Button */}
                        {d.donorEmail && (
                          <Button
                            size="sm"
                            variant={
                              d.receiptStatus === "Sent"
                                ? "success"
                                : "outline-primary"
                            }
                            title="Email Receipt"
                            onClick={async () => {
                              if (!confirm(`Send receipt to ${d.donorEmail}?`))
                                return;
                              try {
                                const userInfo = JSON.parse(
                                  localStorage.getItem("userInfo")
                                );
                                await axios.post(
                                  `http://localhost:5000/api/donations/${d._id}/email`,
                                  {},
                                  {
                                    headers: {
                                      Authorization: `Bearer ${userInfo.token}`,
                                    },
                                  }
                                );
                                alert("Email Sent Successfully!");
                                fetchDonations(); // Refresh to show green status
                              } catch (err) {
                                alert("Error sending email");
                              }
                            }}
                          >
                            {d.receiptStatus === "Sent" ? "Sent" : "Email"}
                          </Button>
                        )}
                      </div>
                    </td>
                  </tr>
                ))}
                {donations.length === 0 && (
                  <tr>
                    <td colSpan="7" className="text-center py-5 text-muted">
                      No donations found.
                    </td>
                  </tr>
                )}
              </tbody>
            </Table>
          )}
        </Card.Body>
      </Card>

      {/* --- ADD DONATION MODAL --- */}
      <Modal show={showModal} onHide={() => setShowModal(false)} size="lg">
        <Modal.Header closeButton>
          <Modal.Title>Add Manual Donation</Modal.Title>
        </Modal.Header>
        <Modal.Body>
          <Form onSubmit={handleSubmit}>
            <Row>
              <Col md={6} className="mb-3">
                <Form.Label>
                  Donor Name <span className="text-danger">*</span>
                </Form.Label>
                <Form.Control
                  type="text"
                  name="donorName"
                  value={formData.donorName}
                  onChange={handleChange}
                  required
                />
              </Col>
              <Col md={6} className="mb-3">
                <Form.Label>
                  Phone Number <span className="text-danger">*</span>
                </Form.Label>
                <Form.Control
                  type="text"
                  name="donorPhone"
                  value={formData.donorPhone}
                  onChange={handleChange}
                  required
                />
              </Col>
              <Col md={6} className="mb-3">
                <Form.Label>Email (Optional)</Form.Label>
                <Form.Control
                  type="email"
                  name="donorEmail"
                  value={formData.donorEmail}
                  onChange={handleChange}
                />
              </Col>
              <Col md={6} className="mb-3">
                <Form.Label>PAN Number (For 80G)</Form.Label>
                <Form.Control
                  type="text"
                  name="donorPan"
                  value={formData.donorPan}
                  onChange={handleChange}
                />
              </Col>
              <Col md={6} className="mb-3">
                <Form.Label>Aadhaar Number</Form.Label>
                <Form.Control
                  type="text"
                  name="donorAadhaar"
                  value={formData.donorAadhaar}
                  onChange={handleChange}
                  placeholder="Optional"
                />
              </Col>
            </Row>

            <hr />

            <Row>
              <Col md={6} className="mb-3">
                <Form.Label>
                  Amount () <span className="text-danger">*</span>
                </Form.Label>
                <Form.Control
                  type="number"
                  name="amount"
                  value={formData.amount}
                  onChange={handleChange}
                  required
                />
              </Col>
              {/* Update Scheme Select to use Dynamic Data */}
              <Col md={6} className="mb-3">
                <Form.Label>
                  Scheme <span className="text-danger">*</span>
                </Form.Label>
                <Form.Select
                  name="scheme"
                  value={formData.scheme}
                  onChange={handleChange}
                >
                  {schemes.map((s) => (
                    <option key={s._id} value={s.name}>
                      {s.name}
                    </option>
                  ))}
                </Form.Select>
              </Col>
              {/* Update Payment Mode to include Foreign Currency */}
              <Col md={6} className="mb-3">
                <Form.Label>Payment Mode</Form.Label>
                <Form.Select
                  name="paymentMode"
                  value={formData.paymentMode}
                  onChange={handleChange}
                >
                  <option>Cash</option>
                  <option>Online</option>
                  <option>Cheque</option>
                  <option>DD</option>
                  <option>Foreign Currency</option> {/* Added */}
                </Form.Select>
              </Col>
              <Col md={6} className="mb-3">
                <Form.Label>Reference / Cheque No</Form.Label>
                <Form.Control
                  type="text"
                  name="paymentReference"
                  value={formData.paymentReference}
                  onChange={handleChange}
                  placeholder="Optional"
                />
              </Col>
            </Row>

            <div className="text-end mt-3">
              <Button
                variant="secondary"
                className="me-2"
                onClick={() => setShowModal(false)}
              >
                Cancel
              </Button>
              <Button
                variant="primary"
                type="submit"
                disabled={submitLoading}
                style={{ backgroundColor: "#581818" }}
              >
                {submitLoading ? "Saving..." : "Save Donation"}
              </Button>
            </div>
          </Form>
        </Modal.Body>
      </Modal>
      <Modal
        show={showMediaModal}
        onHide={() => setShowMediaModal(false)}
        size="lg"
      >
        <Modal.Header closeButton>
          <Modal.Title>Celebration Media</Modal.Title>
        </Modal.Header>
        <Modal.Body>
          {selectedDonation && (
            <>
              <h5 className="text-maroon mb-3">
                Upload Photos/Videos for {selectedDonation.donorName}
              </h5>

              {/* Upload Form */}
              <Form
                onSubmit={handleUpload}
                className="mb-4 p-3 bg-light rounded"
              >
                <Form.Group controlId="formFileMultiple" className="mb-3">
                  <Form.Label>Select Files (Images/Video/PDF)</Form.Label>
                  <Form.Control
                    type="file"
                    multiple
                    onChange={handleFileChange}
                  />
                </Form.Group>
                <Button type="submit" variant="primary" disabled={uploading}>
                  {uploading ? "Uploading..." : "Upload Files"}
                </Button>
              </Form>

              <hr />

              {/* Gallery Grid */}
              <h6 className="mb-3">
                Attached Media ({selectedDonation.media?.length || 0})
              </h6>
              <Row>
                {selectedDonation.media &&
                  selectedDonation.media.map((path, index) => (
                    <Col md={4} key={index} className="mb-3">
                      <div className="border rounded p-1 position-relative">
                        {/* DELETE BUTTON OVERLAY */}
                        <Button
                          variant="danger"
                          size="sm"
                          className="position-absolute top-0 end-0 m-1"
                          style={{ zIndex: 10 }}
                          onClick={() => handleDeleteMedia(path)}
                          title="Delete File"
                        >
                          <FaTrash size={10} />
                        </Button>
                        {/* Check if it's an image or other file */}
                        {path.match(/\.(jpeg|jpg|png|gif)$/) ? (
                          <img
                            src={`http://localhost:5000${path}`}
                            alt="Donation Media"
                            style={{
                              width: "100%",
                              height: "150px",
                              objectFit: "cover",
                            }}
                          />
                        ) : (
                          <div className="text-center py-5 bg-white">
                            <a
                              href={`http://localhost:5000${path}`}
                              target="_blank"
                              rel="noreferrer"
                            >
                              View Document/Video
                            </a>
                          </div>
                        )}
                      </div>
                    </Col>
                  ))}
                {(!selectedDonation.media ||
                  selectedDonation.media.length === 0) && (
                  <p className="text-muted text-center">
                    No media uploaded yet.
                  </p>
                )}
              </Row>
            </>
          )}
        </Modal.Body>
      </Modal>
    </div>
  );
};

export default DonationList;


--- FILE: client/src/pages/admin/EventList.jsx ---
/* eslint-disable no-unused-vars */
import React, { useEffect, useState, useCallback } from "react";
import {
  Table,
  Button,
  Badge,
  Card,
  Row,
  Col,
  Modal,
  Form,
  Alert,
} from "react-bootstrap";
import {
  FaPlus,
  FaMapMarkerAlt,
  FaClipboardList,
  FaUsers,
  FaCheckSquare,
  FaSquare,
} from "react-icons/fa";
import axios from "axios";

const EventList = () => {
  const [events, setEvents] = useState([]);
  const [showModal, setShowModal] = useState(false);

  // Attendance Modal State
  const [showAttendanceModal, setShowAttendanceModal] = useState(false);
  const [selectedEvent, setSelectedEvent] = useState(null);
  const [error, setError] = useState("");

  // Form Data
  const [formData, setFormData] = useState({
    title: "",
    description: "",
    date: "",
    time: "",
    location: "",
    eventType: "Celebration",
  });

  // Fetch Events
  const fetchEvents = useCallback(async () => {
    try {
      const { data } = await axios.get("http://localhost:5000/api/events");
      setEvents(data);
    } catch (error) {
      console.error(error);
      setError("Failed to load events");
    }
  }, []);

  useEffect(() => {
    // eslint-disable-next-line react-hooks/set-state-in-effect
    fetchEvents();
  }, [fetchEvents]);

  // --- ATTENDANCE HANDLER ---
  const toggleAttendance = async (regId, currentStatus) => {
    try {
      const userInfo = JSON.parse(localStorage.getItem("userInfo"));
      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };

      const { data } = await axios.put(
        `http://localhost:5000/api/events/${selectedEvent._id}/attendance`,
        {
          registrationId: regId,
          status: !currentStatus,
        },
        config
      );

      // Update local state immediately to reflect change
      setSelectedEvent((prev) => ({
        ...prev,
        registrations: data.registrations,
      }));
      fetchEvents(); // Refresh main list
    } catch (err) {
      alert("Error updating attendance");
    }
  };

  const openAttendanceModal = (evt) => {
    setSelectedEvent(evt);
    setShowAttendanceModal(true);
  };

  // Handle Create Event
  const handleSubmit = async (e) => {
    e.preventDefault();
    try {
      const userInfo = JSON.parse(localStorage.getItem("userInfo"));
      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };

      // This API call works for both Admin AND Employee (Manager)
      await axios.post("http://localhost:5000/api/events", formData, config);

      setShowModal(false);
      fetchEvents();
      setFormData({
        title: "",
        description: "",
        date: "",
        time: "",
        location: "",
        eventType: "Celebration",
      });
      alert("Event Created Successfully!");
    } catch (error) {
      alert(error.response?.data?.message || "Error creating event");
    }
  };

  const handleChange = (e) => {
    setFormData({ ...formData, [e.target.name]: e.target.value });
  };

  return (
    <div>
      <Row className="mb-4 align-items-center">
        <Col>
          <h2
            className="text-maroon"
            style={{ fontFamily: "Playfair Display" }}
          >
            Events Management
          </h2>
          <p className="text-muted">
            Schedule Pujas, Workshops, and Celebrations
          </p>
        </Col>
        <Col className="text-end">
          {/* This button is visible to anyone who can access the Dashboard (Admin & Manager) */}
          <Button
            variant="primary"
            style={{ backgroundColor: "#581818", border: "none" }}
            onClick={() => setShowModal(true)}
          >
            <FaPlus /> Create Event
          </Button>
        </Col>
      </Row>

      {error && <Alert variant="danger">{error}</Alert>}

      <Card className="shadow-sm border-0">
        <Card.Body className="p-0">
          <Table hover responsive className="align-middle mb-0">
            <thead className="bg-light">
              <tr>
                <th className="ps-4">Date</th>
                <th>Event Name</th>
                <th>Type</th>
                <th>Location</th>
                <th>Registrations</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {events.map((e) => (
                <tr key={e._id}>
                  <td className="ps-4">
                    <div className="fw-bold">
                      {new Date(e.date).toLocaleDateString()}
                    </div>
                    <small className="text-muted">{e.time}</small>
                  </td>
                  <td className="fw-bold">{e.title}</td>
                  <td>
                    <Badge bg="info" text="dark">
                      {e.eventType}
                    </Badge>
                  </td>
                  <td>
                    <FaMapMarkerAlt className="text-danger me-1" /> {e.location}
                  </td>
                  <td>
                    <Badge bg="secondary">
                      <FaUsers className="me-1" /> {e.registrations.length}
                    </Badge>
                  </td>
                  <td>
                    <Button
                      size="sm"
                      variant="outline-dark"
                      onClick={() => openAttendanceModal(e)}
                      title="Manage Attendance"
                    >
                      <FaClipboardList /> Attendance
                    </Button>
                  </td>
                </tr>
              ))}
              {events.length === 0 && (
                <tr>
                  <td colSpan="5" className="text-center py-5">
                    No events scheduled
                  </td>
                </tr>
              )}
            </tbody>
          </Table>
        </Card.Body>
      </Card>
      {/* --- ATTENDANCE MODAL --- */}
      <Modal
        show={showAttendanceModal}
        onHide={() => setShowAttendanceModal(false)}
        size="lg"
      >
        <Modal.Header closeButton>
          <Modal.Title>Attendance: {selectedEvent?.title}</Modal.Title>
        </Modal.Header>
        <Modal.Body>
          {selectedEvent?.registrations.length === 0 ? (
            <p className="text-center text-muted">No registrations yet.</p>
          ) : (
            <Table striped bordered hover>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Phone</th>
                  <th className="text-center">Status</th>
                  <th className="text-center">Action</th>
                </tr>
              </thead>
              <tbody>
                {selectedEvent?.registrations.map((reg) => (
                  <tr key={reg._id}>
                    <td>{reg.name}</td>
                    <td>{reg.phone}</td>
                    <td className="text-center">
                      {reg.attended ? (
                        <Badge bg="success">Present</Badge>
                      ) : (
                        <Badge bg="danger">Absent</Badge>
                      )}
                    </td>
                    <td className="text-center">
                      <Button
                        size="sm"
                        variant={
                          reg.attended ? "outline-danger" : "outline-success"
                        }
                        onClick={() => toggleAttendance(reg._id, reg.attended)}
                      >
                        {reg.attended ? "Mark Absent" : "Mark Present"}
                      </Button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </Table>
          )}
        </Modal.Body>
      </Modal>
      {/* Create Event Modal */}
      <Modal show={showModal} onHide={() => setShowModal(false)} size="lg">
        <Modal.Header closeButton>
          <Modal.Title>Create New Event</Modal.Title>
        </Modal.Header>
        <Modal.Body>
          <Form onSubmit={handleSubmit}>
            <Row>
              <Col md={6} className="mb-3">
                <Form.Label>Event Title</Form.Label>
                <Form.Control
                  name="title"
                  value={formData.title}
                  onChange={handleChange}
                  required
                />
              </Col>
              <Col md={6} className="mb-3">
                <Form.Label>Type</Form.Label>
                <Form.Select
                  name="eventType"
                  value={formData.eventType}
                  onChange={handleChange}
                >
                  <option>Celebration</option>
                  <option>Training</option>
                  <option>Workshop</option>
                  <option>Puja</option>
                </Form.Select>
              </Col>
              <Col md={6} className="mb-3">
                <Form.Label>Date</Form.Label>
                <Form.Control
                  type="date"
                  name="date"
                  value={formData.date}
                  onChange={handleChange}
                  required
                />
              </Col>
              <Col md={6} className="mb-3">
                <Form.Label>Time</Form.Label>
                <Form.Control
                  type="text"
                  name="time"
                  value={formData.time}
                  placeholder="e.g. 10:00 AM"
                  onChange={handleChange}
                  required
                />
              </Col>
              <Col md={12} className="mb-3">
                <Form.Label>Location</Form.Label>
                <Form.Control
                  name="location"
                  value={formData.location}
                  onChange={handleChange}
                  required
                />
              </Col>
              <Col md={12} className="mb-3">
                <Form.Label>Description</Form.Label>
                <Form.Control
                  as="textarea"
                  rows={3}
                  name="description"
                  value={formData.description}
                  onChange={handleChange}
                  required
                />
              </Col>
            </Row>
            <Button type="submit" className="w-100 btn-ashram">
              Publish Event
            </Button>
          </Form>
        </Modal.Body>
      </Modal>
    </div>
  );
};

export default EventList;


--- FILE: client/src/pages/admin/FinanceList.jsx ---
import React, { useEffect, useState } from "react";
import {
  Table,
  Button,
  Badge,
  Card,
  Row,
  Col,
  Modal,
  Form,
} from "react-bootstrap";
import { FaPlus, FaCheck, FaFilePdf, FaFileDownload } from "react-icons/fa";
import axios from "axios";

const FinanceList = () => {
  const [vouchers, setVouchers] = useState([]);
  const [accountHeads, setAccountHeads] = useState([]);
  const [showModal, setShowModal] = useState(false);
  const [userInfo, setUserInfo] = useState(null);

  const [formData, setFormData] = useState({
    voucherType: "Debit",
    accountHead: "",
    amount: "",
    description: "",
    paymentMode: "Cash",
  });

  useEffect(() => {
    const user = JSON.parse(localStorage.getItem("userInfo"));
    setUserInfo(user);
    if (user) {
      fetchVouchers(user);
      fetchAccountHeads(user);
    }
  }, []);

  const fetchVouchers = async (user) => {
    try {
      const config = { headers: { Authorization: `Bearer ${user.token}` } };
      const { data } = await axios.get(
        "http://localhost:5000/api/finance/vouchers",
        config
      );
      setVouchers(data);
    } catch (error) {
      console.error(error);
    }
  };

  const fetchAccountHeads = async (user) => {
    try {
      const config = { headers: { Authorization: `Bearer ${user.token}` } };
      const { data } = await axios.get(
        "http://localhost:5000/api/accounts",
        config
      );
      setAccountHeads(data);
    } catch (error) {
      console.error(error);
    }
  };

  // --- TALLY EXPORT ---
  const handleExport = () => {
    if (vouchers.length === 0) return alert("No vouchers to export.");

    const headers = [
      "Date",
      "Voucher No",
      "Type",
      "Account Code",
      "Ledger Name",
      "Amount",
      "Mode",
      "Narration",
      "Prepared By",
      "Status",
    ];

    const rows = vouchers.map((v) => [
      new Date(v.createdAt).toLocaleDateString(),
      v.voucherNo,
      v.voucherType,
      v.accountHead?.code || "N/A",
      `"${v.accountHead?.name || "Unknown"}"`,
      v.amount,
      v.paymentMode,
      `"${v.description || ""}"`,
      v.preparedBy?.name || "System",
      v.status,
    ]);

    const csvContent =
      "data:text/csv;charset=utf-8," +
      headers.join(",") +
      "\n" +
      rows.map((e) => e.join(",")).join("\n");
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute(
      "download",
      `Tally_Export_${new Date().toISOString().split("T")[0]}.csv`
    );
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    try {
      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };
      await axios.post(
        "http://localhost:5000/api/finance/vouchers",
        formData,
        config
      );
      setShowModal(false);
      fetchVouchers(userInfo);
      alert("Voucher Created Successfully!");
      setFormData({
        voucherType: "Debit",
        accountHead: "",
        amount: "",
        description: "",
        paymentMode: "Cash",
      });
    } catch (error) {
      alert("Error creating voucher");
    }
  };

  const handleApprove = async (id) => {
    try {
      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };
      await axios.put(
        `http://localhost:5000/api/finance/vouchers/${id}/approve`,
        {},
        config
      );
      fetchVouchers(userInfo);
      alert("Approval Recorded!");
    } catch (error) {
      alert(error.response?.data?.message || "Error approving");
    }
  };

  const handleChange = (e) => {
    setFormData({ ...formData, [e.target.name]: e.target.value });
  };

  const filteredAccounts = accountHeads.filter(
    (acc) => acc.type === formData.voucherType
  );

  return (
    <div>
      <Row className="mb-4 align-items-center">
        <Col>
          <h2
            className="text-maroon"
            style={{ fontFamily: "Playfair Display" }}
          >
            Finance & Accounts
          </h2>
        </Col>
        <Col className="text-end">
          <Button variant="success" className="me-2" onClick={handleExport}>
            <FaFileDownload /> Tally CSV
          </Button>
          <Button
            variant="primary"
            style={{ backgroundColor: "#581818", border: "none" }}
            onClick={() => setShowModal(true)}
          >
            <FaPlus /> Create Voucher
          </Button>
        </Col>
      </Row>

      <Card className="shadow-sm border-0">
        <Card.Body className="p-0">
          <Table hover responsive className="align-middle mb-0">
            <thead className="bg-light">
              <tr>
                <th className="ps-4">Voucher No</th>
                <th>Code</th>
                <th>Ledger Name</th>
                <th>Amount</th>
                <th>Prepared By</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {vouchers.map((v) => {
                // --- LOGIC MOVED INSIDE THE MAP FUNCTION ---
                // Check if the current logged-in user has already approved this voucher
                const hasApproved =
                  v.approvedBy &&
                  v.approvedBy.some((u) => u._id === userInfo?._id);

                // Check if user is a committee member authorized to approve
                const isCommittee = [
                  "admin",
                  "president",
                  "secretary",
                  "treasurer",
                ].includes(userInfo?.role);
                // -------------------------------------------

                return (
                  <tr key={v._id}>
                    <td className="ps-4 text-muted small">{v.voucherNo}</td>
                    <td>
                      <Badge bg="secondary">{v.accountHead?.code}</Badge>
                    </td>
                    <td className="fw-bold">{v.accountHead?.name}</td>
                    <td>{v.amount.toLocaleString()}</td>
                    <td className="small text-muted">{v.preparedBy?.name}</td>

                    {/* Status Column */}
                    <td>
                      {v.status === "Approved" ? (
                        <Badge bg="success">Approved</Badge>
                      ) : (
                        <Badge bg="warning" text="dark">
                          {v.status === "Partially Approved"
                            ? "1/2 Approvals"
                            : "Pending (0/2)"}
                        </Badge>
                      )}
                    </td>

                    {/* Action Column */}
                    <td>
                      <div className="d-flex gap-2">
                        {/* Approve Button Logic:
                            Show ONLY if:
                            1. Voucher is NOT fully approved yet
                            2. User is a Committee Member
                            3. User has NOT already approved it
                        */}
                        {v.status !== "Approved" &&
                        isCommittee &&
                        !hasApproved ? (
                          <Button
                            size="sm"
                            variant="outline-success"
                            onClick={() => handleApprove(v._id)}
                            title="Click to Sign"
                          >
                            <FaCheck /> Sign
                          </Button>
                        ) : null}

                        {/* Download PDF Button */}
                        <Button
                          size="sm"
                          variant="outline-danger"
                          title="Download Voucher"
                          onClick={async () => {
                            try {
                              const config = {
                                headers: {
                                  Authorization: `Bearer ${userInfo.token}`,
                                },
                                responseType: "blob",
                              };
                              const response = await axios.get(
                                `http://localhost:5000/api/finance/vouchers/${v._id}/pdf`,
                                config
                              );

                              const url = window.URL.createObjectURL(
                                new Blob([response.data])
                              );
                              const link = document.createElement("a");
                              link.href = url;
                              link.setAttribute(
                                "download",
                                `${v.voucherNo}.pdf`
                              );
                              document.body.appendChild(link);
                              link.click();
                            } catch (err) {
                              alert("Error downloading voucher");
                            }
                          }}
                        >
                          <FaFilePdf />
                        </Button>
                      </div>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </Table>
        </Card.Body>
      </Card>

      {/* Create Voucher Modal */}
      <Modal show={showModal} onHide={() => setShowModal(false)}>
        <Modal.Header closeButton>
          <Modal.Title>Create Voucher</Modal.Title>
        </Modal.Header>
        <Modal.Body>
          <Form onSubmit={handleSubmit}>
            <Form.Group className="mb-3">
              <Form.Label>Voucher Type</Form.Label>
              <Form.Select
                name="voucherType"
                onChange={handleChange}
                value={formData.voucherType}
              >
                <option value="Debit">Debit (Expense)</option>
                <option value="Credit">Credit (Income)</option>
              </Form.Select>
            </Form.Group>

            <Form.Group className="mb-3">
              <Form.Label>Account Head (Ledger)</Form.Label>
              <Form.Select name="accountHead" onChange={handleChange} required>
                <option value="">-- Select Account Code --</option>
                {filteredAccounts.map((acc) => (
                  <option key={acc._id} value={acc._id}>
                    {acc.code} - {acc.name}
                  </option>
                ))}
              </Form.Select>
            </Form.Group>

            <Row>
              <Col md={6}>
                <Form.Group className="mb-3">
                  <Form.Label>Amount ()</Form.Label>
                  <Form.Control
                    type="number"
                    name="amount"
                    onChange={handleChange}
                    required
                  />
                </Form.Group>
              </Col>
              <Col md={6}>
                <Form.Group className="mb-3">
                  <Form.Label>Payment Mode</Form.Label>
                  <Form.Select name="paymentMode" onChange={handleChange}>
                    <option>Cash</option>
                    <option>Bank Transfer</option>
                    <option>Cheque</option>
                  </Form.Select>
                </Form.Group>
              </Col>
            </Row>

            <Form.Group className="mb-3">
              <Form.Label>Narration</Form.Label>
              <Form.Control
                as="textarea"
                name="description"
                onChange={handleChange}
              />
            </Form.Group>

            <Button type="submit" className="w-100 btn-ashram">
              Generate Voucher
            </Button>
          </Form>
        </Modal.Body>
      </Modal>
    </div>
  );
};

export default FinanceList;


--- FILE: client/src/pages/admin/FinanceList1.jsx ---
// eslint-disable-next-line no-unused-vars
import React, { useEffect, useState, useCallback } from "react";
import {
  Table,
  Button,
  Badge,
  Card,
  Row,
  Col,
  Modal,
  Form,
  Alert,
} from "react-bootstrap";
// import { FaPlus, FaCheck } from "react-icons/fa";
import axios from "axios";
import { FaPlus, FaCheck, FaFileDownload, FaFilePdf } from "react-icons/fa"; // Added FaFilePdf

const FinanceList = () => {
  const [vouchers, setVouchers] = useState([]);
  const [showModal, setShowModal] = useState(false);
  const [userInfo, setUserInfo] = useState(null); // To store logged-in user details

  // Form Data
  const [formData, setFormData] = useState({
    voucherType: "Debit",
    ledgerName: "",
    amount: "",
    description: "",
    paymentMode: "Cash",
  });

  // 1. Load User Info & Fetch Data
  useEffect(() => {
    const user = JSON.parse(localStorage.getItem("userInfo"));
    setUserInfo(user);
    // eslint-disable-next-line react-hooks/immutability
    fetchVouchers(user);
  }, []);

  const fetchVouchers = async (user) => {
    try {
      if (!user) return;
      const config = { headers: { Authorization: `Bearer ${user.token}` } };
      const { data } = await axios.get(
        "http://localhost:5000/api/finance/vouchers",
        config
      );
      setVouchers(data);
    } catch (error) {
      console.error(error);
    }
  };

  // 2. Handle Create Voucher
  const handleSubmit = async (e) => {
    e.preventDefault();
    try {
      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };
      await axios.post(
        "http://localhost:5000/api/finance/vouchers",
        formData,
        config
      );
      setShowModal(false);
      fetchVouchers(userInfo);
      alert("Voucher Created Successfully!");
      setFormData({
        voucherType: "Debit",
        ledgerName: "",
        amount: "",
        description: "",
        paymentMode: "Cash",
      });
      // eslint-disable-next-line no-unused-vars
    } catch (error) {
      alert("Error creating voucher");
    }
  };

  // 3. Handle Approve (Admin Only)
  const handleApprove = async (id) => {
    try {
      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };
      await axios.put(
        `http://localhost:5000/api/finance/vouchers/${id}/approve`,
        {},
        config
      );
      fetchVouchers(userInfo);
      alert("Voucher Approved!");
      // eslint-disable-next-line no-unused-vars
    } catch (error) {
      alert("Error approving: You might not be an Admin.");
    }
  };

  const handleChange = (e) => {
    setFormData({ ...formData, [e.target.name]: e.target.value });
  };

  return (
    <div>
      <Row className="mb-4 align-items-center">
        <Col>
          <h2
            className="text-maroon"
            style={{ fontFamily: "Playfair Display" }}
          >
            Finance & Accounts
          </h2>
          <p className="text-muted">
            Manage Vouchers (Debit/Credit) and Expenses
          </p>
        </Col>
        <Col className="text-end">
          <Button
            variant="primary"
            style={{ backgroundColor: "#581818", border: "none" }}
            onClick={() => setShowModal(true)}
          >
            <FaPlus /> Create Voucher
          </Button>
        </Col>
      </Row>

      <Card className="shadow-sm border-0">
        <Card.Body className="p-0">
          <Table hover responsive className="align-middle mb-0">
            <thead className="bg-light">
              <tr>
                <th className="ps-4">Voucher No</th>
                <th>Type</th>
                <th>Ledger / Head</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {vouchers.map((v) => (
                <tr key={v._id}>
                  <td className="ps-4 text-muted small">{v.voucherNo}</td>
                  <td>
                    {v.voucherType === "Credit" ? (
                      <Badge bg="success">Credit (Income)</Badge>
                    ) : (
                      <Badge bg="danger">Debit (Expense)</Badge>
                    )}
                  </td>
                  <td className="fw-bold">{v.ledgerName}</td>
                  <td>{v.amount.toLocaleString()}</td>
                  <td>
                    {v.status === "Approved" ? (
                      <Badge bg="success">Approved</Badge>
                    ) : (
                      <Badge bg="warning" text="dark">
                        Pending
                      </Badge>
                    )}
                  </td>
                  {/* <td>
                    
                    {v.status === "Pending" && userInfo?.role === "admin" ? (
                      <Button
                        size="sm"
                        variant="outline-success"
                        onClick={() => handleApprove(v._id)}
                      >
                        <FaCheck /> Approve
                      </Button>
                    ) : v.status === "Pending" ? (
                      <span className="text-muted small fst-italic">
                        Waiting Approval
                      </span>
                    ) : (
                      <span className="text-success small fw-bold">
                        Verified
                      </span>
                    )}
                  </td> */}
                  <td>
                    <div className="d-flex gap-2">
                      {/* 1. Approve Button (Admin Only) */}
                      {v.status === "Pending" && userInfo?.role === "admin" ? (
                        <Button
                          size="sm"
                          variant="outline-success"
                          onClick={() => handleApprove(v._id)}
                          title="Approve"
                        >
                          <FaCheck />
                        </Button>
                      ) : null}

                      {/* 2. Download Voucher PDF Button */}
                      <Button
                        size="sm"
                        variant="outline-danger"
                        title="Download Voucher"
                        onClick={async () => {
                          try {
                            const config = {
                              headers: {
                                Authorization: `Bearer ${userInfo.token}`,
                              },
                              responseType: "blob",
                            };
                            const response = await axios.get(
                              `http://localhost:5000/api/finance/vouchers/${v._id}/pdf`,
                              config
                            );

                            const url = window.URL.createObjectURL(
                              new Blob([response.data])
                            );
                            const link = document.createElement("a");
                            link.href = url;
                            link.setAttribute("download", `${v.voucherNo}.pdf`);
                            document.body.appendChild(link);
                            link.click();
                            // eslint-disable-next-line no-unused-vars
                          } catch (err) {
                            alert("Error downloading voucher");
                          }
                        }}
                      >
                        <FaFilePdf />
                      </Button>
                    </div>
                  </td>
                </tr>
              ))}
              {vouchers.length === 0 && (
                <tr>
                  <td colSpan="6" className="text-center py-5">
                    No vouchers found
                  </td>
                </tr>
              )}
            </tbody>
          </Table>
        </Card.Body>
      </Card>

      {/* Create Voucher Modal */}
      <Modal show={showModal} onHide={() => setShowModal(false)}>
        <Modal.Header closeButton>
          <Modal.Title>Create Expenditure Voucher</Modal.Title>
        </Modal.Header>
        <Modal.Body>
          <Form onSubmit={handleSubmit}>
            <Form.Group className="mb-3">
              <Form.Label>Voucher Type</Form.Label>
              <Form.Select name="voucherType" onChange={handleChange}>
                <option value="Debit">Debit (Expense)</option>
                <option value="Credit">Credit (Income)</option>
                <option value="Journal">Journal (Adjustment)</option>
              </Form.Select>
            </Form.Group>

            <Form.Group className="mb-3">
              <Form.Label>Ledger Name (Expense Head)</Form.Label>
              <Form.Control
                name="ledgerName"
                onChange={handleChange}
                required
                placeholder="e.g. Vegetables, Salary, Electricity"
              />
            </Form.Group>

            <Row>
              <Col md={6}>
                <Form.Group className="mb-3">
                  <Form.Label>Amount ()</Form.Label>
                  <Form.Control
                    type="number"
                    name="amount"
                    onChange={handleChange}
                    required
                  />
                </Form.Group>
              </Col>
              <Col md={6}>
                <Form.Group className="mb-3">
                  <Form.Label>Payment Mode</Form.Label>
                  <Form.Select name="paymentMode" onChange={handleChange}>
                    <option>Cash</option>
                    <option>Bank Transfer</option>
                    <option>Cheque</option>
                    <option>UPI</option>
                  </Form.Select>
                </Form.Group>
              </Col>
            </Row>

            <Form.Group className="mb-3">
              <Form.Label>Description</Form.Label>
              <Form.Control
                as="textarea"
                name="description"
                onChange={handleChange}
              />
            </Form.Group>

            <Button type="submit" className="w-100 btn-ashram">
              Generate Voucher
            </Button>
          </Form>
        </Modal.Body>
      </Modal>
    </div>
  );
};

export default FinanceList;


--- FILE: client/src/pages/admin/FinanceList2.jsx ---
/* eslint-disable no-unused-vars */
/* eslint-disable react-hooks/immutability */
import React, { useEffect, useState } from "react";
import {
  Table,
  Button,
  Badge,
  Card,
  Row,
  Col,
  Modal,
  Form,
} from "react-bootstrap";
// Added FaFileDownload for the export button
import {
  FaPlus,
  FaCheck,
  FaFilePdf,
  FaFileDownload,
  FaBalanceScale,
} from "react-icons/fa";
import axios from "axios";
import { Link } from "react-router-dom"; // Ensure Link is imported

const FinanceList = () => {
  const [vouchers, setVouchers] = useState([]);
  const [showModal, setShowModal] = useState(false);
  const [userInfo, setUserInfo] = useState(null);

  // Form Data
  const [formData, setFormData] = useState({
    voucherType: "Debit",
    ledgerName: "",
    amount: "",
    description: "",
    paymentMode: "Cash",
  });

  useEffect(() => {
    const user = JSON.parse(localStorage.getItem("userInfo"));
    setUserInfo(user);
    if (user) fetchVouchers(user);
  }, []);

  const fetchVouchers = async (user) => {
    try {
      const config = { headers: { Authorization: `Bearer ${user.token}` } };
      const { data } = await axios.get(
        "http://localhost:5000/api/finance/vouchers",
        config
      );
      setVouchers(data);
    } catch (error) {
      console.error(error);
    }
  };

  // --- NEW FUNCTION: EXPORT TO CSV (TALLY FORMAT) ---
  const handleExport = () => {
    if (vouchers.length === 0) {
      alert("No vouchers to export.");
      return;
    }

    // 1. Define Headers (Standard Accounting Format)
    const headers = [
      "Date",
      "Voucher No",
      "Voucher Type",
      "Ledger Name",
      "Amount",
      "Payment Mode",
      "Narration (Description)",
      "Status",
    ];

    // 2. Map Data to CSV Rows
    const rows = vouchers.map((v) => [
      new Date(v.createdAt).toLocaleDateString(), // Date
      v.voucherNo,
      v.voucherType,
      `"${v.ledgerName}"`, // Wrap in quotes to handle commas inside names
      v.amount,
      v.paymentMode,
      `"${v.description || ""}"`, // Wrap narration in quotes
      v.status,
    ]);

    // 3. Combine Headers and Rows
    const csvContent =
      "data:text/csv;charset=utf-8," +
      headers.join(",") +
      "\n" +
      rows.map((e) => e.join(",")).join("\n");

    // 4. Trigger Download
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute(
      "download",
      `Tally_Export_${new Date().toISOString().split("T")[0]}.csv`
    );
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };
  // --------------------------------------------------

  const handleSubmit = async (e) => {
    e.preventDefault();
    try {
      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };
      await axios.post(
        "http://localhost:5000/api/finance/vouchers",
        formData,
        config
      );
      setShowModal(false);
      fetchVouchers(userInfo);
      alert("Voucher Created Successfully!");
      setFormData({
        voucherType: "Debit",
        ledgerName: "",
        amount: "",
        description: "",
        paymentMode: "Cash",
      });
    } catch (error) {
      alert("Error creating voucher");
    }
  };

  const handleApprove = async (id) => {
    try {
      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };
      await axios.put(
        `http://localhost:5000/api/finance/vouchers/${id}/approve`,
        {},
        config
      );
      fetchVouchers(userInfo);
      alert("Voucher Approved!");
    } catch (error) {
      alert("Error approving");
    }
  };

  const handleChange = (e) => {
    setFormData({ ...formData, [e.target.name]: e.target.value });
  };

  return (
    <div>
      <Row className="mb-4 align-items-center">
        <Col>
          <h2
            className="text-maroon"
            style={{ fontFamily: "Playfair Display" }}
          >
            Finance & Accounts
          </h2>
          <p className="text-muted">
            Manage Vouchers (Debit/Credit) and Expenses
          </p>
        </Col>
        <Col className="text-end">
          <Link
            to="/dashboard/finance/reconcile"
            className="btn btn-outline-dark me-2"
          >
            <FaBalanceScale /> Reconcile Cash
          </Link>
          {/* --- EXPORT BUTTON --- */}
          <Button variant="success" className="me-2" onClick={handleExport}>
            <FaFileDownload /> Download Tally CSV
          </Button>

          <Button
            variant="primary"
            style={{ backgroundColor: "#581818", border: "none" }}
            onClick={() => setShowModal(true)}
          >
            <FaPlus /> Create Voucher
          </Button>
        </Col>
      </Row>

      <Card className="shadow-sm border-0">
        <Card.Body className="p-0">
          <Table hover responsive className="align-middle mb-0">
            <thead className="bg-light">
              <tr>
                <th className="ps-4">Voucher No</th>
                <th>Type</th>
                <th>Ledger / Head</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {vouchers.map((v) => (
                <tr key={v._id}>
                  <td className="ps-4 text-muted small">{v.voucherNo}</td>
                  <td>
                    {v.voucherType === "Credit" ? (
                      <Badge bg="success">Credit (Income)</Badge>
                    ) : (
                      <Badge bg="danger">Debit (Expense)</Badge>
                    )}
                  </td>
                  <td className="fw-bold">{v.ledgerName}</td>
                  <td>{v.amount.toLocaleString()}</td>
                  <td>
                    {v.status === "Approved" ? (
                      <Badge bg="success">Approved</Badge>
                    ) : (
                      <Badge bg="warning" text="dark">
                        Pending
                      </Badge>
                    )}
                  </td>
                  <td>
                    <div className="d-flex gap-2">
                      {/* Approve Button (Admin Only) */}
                      {v.status === "Pending" && userInfo?.role === "admin" ? (
                        <Button
                          size="sm"
                          variant="outline-success"
                          onClick={() => handleApprove(v._id)}
                          title="Approve"
                        >
                          <FaCheck />
                        </Button>
                      ) : null}

                      {/* Download Individual PDF Button */}
                      <Button
                        size="sm"
                        variant="outline-danger"
                        title="Download Voucher PDF"
                        onClick={async () => {
                          try {
                            const config = {
                              headers: {
                                Authorization: `Bearer ${userInfo.token}`,
                              },
                              responseType: "blob",
                            };
                            const response = await axios.get(
                              `http://localhost:5000/api/finance/vouchers/${v._id}/pdf`,
                              config
                            );

                            const url = window.URL.createObjectURL(
                              new Blob([response.data])
                            );
                            const link = document.createElement("a");
                            link.href = url;
                            link.setAttribute("download", `${v.voucherNo}.pdf`);
                            document.body.appendChild(link);
                            link.click();
                          } catch (err) {
                            alert("Error downloading voucher");
                          }
                        }}
                      >
                        <FaFilePdf />
                      </Button>
                    </div>
                  </td>
                </tr>
              ))}
              {vouchers.length === 0 && (
                <tr>
                  <td colSpan="6" className="text-center py-5">
                    No vouchers found
                  </td>
                </tr>
              )}
            </tbody>
          </Table>
        </Card.Body>
      </Card>

      {/* Create Voucher Modal */}
      <Modal show={showModal} onHide={() => setShowModal(false)}>
        <Modal.Header closeButton>
          <Modal.Title>Create Expenditure Voucher</Modal.Title>
        </Modal.Header>
        <Modal.Body>
          <Form onSubmit={handleSubmit}>
            <Form.Group className="mb-3">
              <Form.Label>Voucher Type</Form.Label>
              <Form.Select name="voucherType" onChange={handleChange}>
                <option value="Debit">Debit (Expense)</option>
                <option value="Credit">Credit (Income)</option>
                <option value="Journal">Journal (Adjustment)</option>
              </Form.Select>
            </Form.Group>

            <Form.Group className="mb-3">
              <Form.Label>Ledger Name (Expense Head)</Form.Label>
              <Form.Control
                name="ledgerName"
                onChange={handleChange}
                required
                placeholder="e.g. Vegetables, Salary, Electricity"
              />
            </Form.Group>

            <Row>
              <Col md={6}>
                <Form.Group className="mb-3">
                  <Form.Label>Amount ()</Form.Label>
                  <Form.Control
                    type="number"
                    name="amount"
                    onChange={handleChange}
                    required
                  />
                </Form.Group>
              </Col>
              <Col md={6}>
                <Form.Group className="mb-3">
                  <Form.Label>Payment Mode</Form.Label>
                  <Form.Select name="paymentMode" onChange={handleChange}>
                    <option>Cash</option>
                    <option>Bank Transfer</option>
                    <option>Cheque</option>
                    <option>UPI</option>
                  </Form.Select>
                </Form.Group>
              </Col>
            </Row>

            <Form.Group className="mb-3">
              <Form.Label>Description</Form.Label>
              <Form.Control
                as="textarea"
                name="description"
                onChange={handleChange}
              />
            </Form.Group>

            <Button type="submit" className="w-100 btn-ashram">
              Generate Voucher
            </Button>
          </Form>
        </Modal.Body>
      </Modal>
    </div>
  );
};

export default FinanceList;


--- FILE: client/src/pages/admin/InventoryList.jsx ---
import React, { useEffect, useState, useCallback } from "react";
import {
  Table,
  Button,
  Badge,
  Card,
  Row,
  Col,
  Modal,
  Form,
  ProgressBar,
} from "react-bootstrap";
import { FaPlus, FaBox, FaExclamationTriangle } from "react-icons/fa";
import { FaClipboardList, FaHistory } from "react-icons/fa"; // Add FaHistory
import axios from "axios";
import { Link } from "react-router-dom";

const InventoryList = () => {
  const [items, setItems] = useState([]);
  const [showModal, setShowModal] = useState(false);

  const [formData, setFormData] = useState({
    itemName: "",
    category: "Food",
    isPerishable: false,
    quantity: "",
    unit: "kg",
    expiryDate: "",
  });

  const fetchInventory = useCallback(async () => {
    try {
      const userInfo = JSON.parse(localStorage.getItem("userInfo"));
      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };
      const { data } = await axios.get(
        "http://localhost:5000/api/inventory",
        config
      );
      setItems(data);
    } catch (error) {
      console.error(error);
    }
  }, []);

  useEffect(() => {
    // eslint-disable-next-line react-hooks/set-state-in-effect
    fetchInventory();
  }, [fetchInventory]);

  // const handleSubmit = async (e) => {
  //   e.preventDefault();
  //   try {
  //     const userInfo = JSON.parse(localStorage.getItem("userInfo"));
  //     const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };
  //     await axios.post("http://localhost:5000/api/inventory", formData, config);
  //     setShowModal(false);
  //     fetchInventory();
  //     alert("Stock Updated Successfully!");
  //     // eslint-disable-next-line no-unused-vars
  //   } catch (error) {
  //     alert("Error updating stock");
  //   }
  // };

  const handleSubmit = async (e) => {
    e.preventDefault();

    // Basic Validation
    if (!formData.itemName || !formData.quantity) {
      alert("Please enter Item Name and Quantity");
      return;
    }

    try {
      const userInfo = JSON.parse(localStorage.getItem("userInfo"));
      const config = {
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${userInfo.token}`,
        },
      };

      // Prepare Payload (Ensure types are correct)
      const payload = {
        itemName: formData.itemName,
        category: formData.category,
        quantity: Number(formData.quantity), // <--- Force Number
        unit: formData.unit,
        isPerishable:
          formData.isPerishable === true || formData.isPerishable === "true", // Handle boolean
        expiryDate: formData.expiryDate || null,
        branch: "Headquarters", // Ensure branch is sent
      };

      console.log("Sending Payload:", payload); // Debugging: Check console to see what is sent

      await axios.post("http://localhost:5000/api/inventory", payload, config);

      setShowModal(false);
      fetchInventory();

      // Reset Form
      setFormData({
        itemName: "",
        category: "Food",
        isPerishable: false,
        quantity: "",
        unit: "kg",
        expiryDate: "",
      });

      alert("Stock Updated Successfully!");
    } catch (error) {
      console.error("Add Stock Error:", error.response?.data); // Check console for details
      // Show the specific error message from Backend
      alert(error.response?.data?.message || "Error updating stock");
    }
  };

  const handleChange = (e) => {
    const value =
      e.target.type === "checkbox" ? e.target.checked : e.target.value;
    setFormData({ ...formData, [e.target.name]: value });
  };

  return (
    <div>
      <Row className="mb-4 align-items-center">
        <Col>
          <h2
            className="text-maroon"
            style={{ fontFamily: "Playfair Display" }}
          >
            Inventory & Stock
          </h2>
          <p className="text-muted">
            Manage Food, Non-Food, and Ashram Supplies
          </p>
        </Col>
        <Col className="text-end">
          {/* History Button */}
          <Link
            to="/dashboard/inventory/history"
            className="btn btn-outline-secondary me-2"
          >
            <FaHistory /> History
          </Link>
          {/* Audit Button */}
          <Link
            to="/dashboard/inventory/audit"
            className="btn btn-outline-dark me-2"
          >
            <FaClipboardList /> Stock Audit
          </Link>{" "}
          <Button
            variant="primary"
            style={{ backgroundColor: "#581818", border: "none" }}
            onClick={() => setShowModal(true)}
          >
            <FaPlus /> Add / Update Stock
          </Button>
        </Col>
      </Row>

      <Row className="mb-4">
        <Col md={3}>
          <Card className="p-3 text-center border-0 shadow-sm">
            <h3 className="text-success">
              {items.filter((i) => i.category === "Food").length}
            </h3>
            <small>Food Items</small>
          </Card>
        </Col>
        <Col md={3}>
          <Card className="p-3 text-center border-0 shadow-sm">
            <h3 className="text-primary">
              {items.filter((i) => i.category === "Non-Food").length}
            </h3>
            <small>Non-Food Items</small>
          </Card>
        </Col>
      </Row>

      <Card className="shadow-sm border-0">
        <Card.Body className="p-0">
          <Table hover responsive className="align-middle mb-0">
            <thead className="bg-light">
              <tr>
                <th className="ps-4">Item Name</th>
                <th>Category</th>
                <th>Stock Level</th>
                <th>Status</th>
                <th>Expiry (If Perishable)</th>
              </tr>
            </thead>
            <tbody>
              {items.map((item) => (
                <tr key={item._id}>
                  <td className="ps-4 fw-bold">{item.itemName}</td>
                  <td>
                    <Badge bg="secondary">{item.category}</Badge>
                  </td>
                  <td>
                    <div className="d-flex align-items-center">
                      <span className="me-2 fw-bold">
                        {item.quantity} {item.unit}
                      </span>
                      {/* Visual Bar for stock */}
                      <ProgressBar
                        now={Math.min(item.quantity, 100)}
                        variant={item.quantity < 20 ? "danger" : "success"}
                        style={{ width: "80px", height: "5px" }}
                      />
                    </div>
                  </td>
                  <td>
                    {item.quantity < 10 ? (
                      <Badge bg="danger">
                        <FaExclamationTriangle /> Low Stock
                      </Badge>
                    ) : (
                      <Badge bg="success">In Stock</Badge>
                    )}
                  </td>
                  <td>
                    {item.isPerishable && item.expiryDate ? (
                      new Date(item.expiryDate).toLocaleDateString()
                    ) : (
                      <span className="text-muted">-</span>
                    )}
                  </td>
                </tr>
              ))}
              {items.length === 0 && (
                <tr>
                  <td colSpan="5" className="text-center py-5">
                    No inventory items found
                  </td>
                </tr>
              )}
            </tbody>
          </Table>
        </Card.Body>
      </Card>

      {/* Add Item Modal */}
      <Modal show={showModal} onHide={() => setShowModal(false)}>
        <Modal.Header closeButton>
          <Modal.Title>Add Inventory Item</Modal.Title>
        </Modal.Header>
        <Modal.Body>
          <Form onSubmit={handleSubmit}>
            <Form.Group className="mb-3">
              <Form.Label>Item Name</Form.Label>
              <Form.Control
                name="itemName"
                value={formData.itemName}
                onChange={handleChange}
                required
                placeholder="e.g. Rice, Oil, Chairs"
              />
            </Form.Group>

            <Row>
              <Col md={6}>
                <Form.Group className="mb-3">
                  <Form.Label>Category</Form.Label>
                  <Form.Select
                    name="category"
                    value={formData.category} // <--- Added value
                    onChange={handleChange}
                  >
                    <option>Food</option>
                    <option>Non-Food</option>
                    <option>Medical</option>
                    <option>General</option>
                  </Form.Select>
                </Form.Group>
              </Col>
              <Col md={6}>
                <Form.Group className="mb-3">
                  <Form.Label>Quantity</Form.Label>
                  <Form.Control
                    type="number"
                    name="quantity"
                    value={formData.quantity} // <--- Added value
                    onChange={handleChange}
                    required
                  />
                </Form.Group>
              </Col>
            </Row>

            <Row>
              <Col md={6}>
                <Form.Group className="mb-3">
                  <Form.Label>Unit</Form.Label>
                  <Form.Select
                    name="unit"
                    value={formData.unit}
                    onChange={handleChange}
                  >
                    <option>kg</option>
                    <option>liters</option>
                    <option>bags</option>
                    <option>pieces</option>
                    <option>boxes</option>
                  </Form.Select>
                </Form.Group>
              </Col>
              <Col md={6}>
                <Form.Group className="mb-3 pt-4">
                  <Form.Check
                    type="checkbox"
                    label="Is Perishable?"
                    name="isPerishable"
                    checked={formData.isPerishable}
                    onChange={handleChange}
                  />
                </Form.Group>
              </Col>
            </Row>

            {/* Show Expiry Date only if Perishable is checked */}
            {formData.isPerishable && (
              <Form.Group className="mb-3">
                <Form.Label>Expiry Date</Form.Label>
                <Form.Control
                  type="date"
                  name="expiryDate"
                  value={formData.expiryDate}
                  onChange={handleChange}
                />
              </Form.Group>
            )}

            <Button type="submit" className="w-100 btn-ashram">
              Update Stock
            </Button>
          </Form>
        </Modal.Body>
      </Modal>
    </div>
  );
};

export default InventoryList;


--- FILE: client/src/pages/admin/MemberList.jsx ---
import React, { useEffect, useState } from "react";
import {
  Table,
  Button,
  Badge,
  Card,
  Row,
  Col,
  Modal,
  Form,
  Alert,
} from "react-bootstrap";
import {
  FaPlus,
  FaUserTie,
  FaCheckCircle,
  FaTimesCircle,
  FaTasks,
} from "react-icons/fa";
import axios from "axios";

const MemberList = () => {
  const [members, setMembers] = useState([]);
  const [showModal, setShowModal] = useState(false);
  // Activity Modal State
  const [showActivityModal, setShowActivityModal] = useState(false);
  const [selectedMember, setSelectedMember] = useState(null);
  const [activityData, setActivityData] = useState({
    eventName: "",
    role: "",
    date: "",
  });
  const [error, setError] = useState("");

  const [formData, setFormData] = useState({
    firstName: "",
    lastName: "",
    phone: "",
    email: "",
    address: "",
    membershipType: "Annual",
    feeAmount: "1000",
    feeStatus: "Paid",
  });

  useEffect(() => {
    // eslint-disable-next-line react-hooks/immutability
    fetchMembers();
  }, []);

  const fetchMembers = async () => {
    try {
      const userInfo = JSON.parse(localStorage.getItem("userInfo"));
      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };
      const { data } = await axios.get(
        "http://localhost:5000/api/members",
        config
      );
      setMembers(data);
    } catch (err) {
      console.error(err);
      setError("Failed to fetch members");
    }
  };
  // --- ACTIVITY HANDLER ---
  const handleAddActivity = async (e) => {
    e.preventDefault();
    try {
      const userInfo = JSON.parse(localStorage.getItem("userInfo"));
      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };

      await axios.post(
        `http://localhost:5000/api/members/${selectedMember._id}/activity`,
        activityData,
        config
      );

      alert("Activity Logged Successfully!");
      setShowActivityModal(false);
      setActivityData({ eventName: "", role: "", date: "" });
      fetchMembers(); // Refresh to update list (if we showed count)
      // eslint-disable-next-line no-unused-vars
    } catch (err) {
      alert("Error logging activity");
    }
  };

  const openActivityModal = (member) => {
    setSelectedMember(member);
    setShowActivityModal(true);
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    try {
      const userInfo = JSON.parse(localStorage.getItem("userInfo"));
      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };
      await axios.post("http://localhost:5000/api/members", formData, config);
      setShowModal(false);
      fetchMembers();
      alert("Member Registered Successfully!");
      // eslint-disable-next-line no-unused-vars
    } catch (err) {
      alert("Error registering member");
    }
  };

  const handleChange = (e) => {
    setFormData({ ...formData, [e.target.name]: e.target.value });
  };

  return (
    <div>
      <Row className="mb-4 align-items-center">
        <Col>
          <h2
            className="text-maroon"
            style={{ fontFamily: "Playfair Display" }}
          >
            Membership Management
          </h2>
          <p className="text-muted">
            Manage Volunteers, Life Members, and Patrons
          </p>
        </Col>
        <Col className="text-end">
          <Button
            variant="primary"
            style={{ backgroundColor: "#581818", border: "none" }}
            onClick={() => setShowModal(true)}
          >
            <FaPlus /> Register Member
          </Button>
        </Col>
      </Row>

      {error && <Alert variant="danger">{error}</Alert>}

      <Card className="shadow-sm border-0">
        <Card.Body className="p-0">
          <Table hover responsive className="align-middle mb-0">
            <thead className="bg-light">
              <tr>
                <th className="ps-4">Name</th>
                <th>Contact</th>
                <th>Type</th>
                <th>Joined Date</th>
                <th>Fee Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {members.map((m) => (
                <tr key={m._id}>
                  <td className="ps-4 fw-bold">
                    <FaUserTie className="me-2 text-secondary" />
                    {m.firstName} {m.lastName}
                  </td>
                  <td>
                    <div>{m.phone}</div>
                    <small className="text-muted">{m.email}</small>
                  </td>
                  <td>
                    <Badge bg="info" text="dark">
                      {m.membershipType}
                    </Badge>
                  </td>
                  <td>{new Date(m.joinDate).toLocaleDateString()}</td>
                  <td>
                    {m.feeStatus === "Paid" ? (
                      <span className="text-success">
                        <FaCheckCircle /> Paid
                      </span>
                    ) : (
                      <span className="text-danger">
                        <FaTimesCircle /> Pending
                      </span>
                    )}
                  </td>
                  <td>
                    <Button
                      size="sm"
                      variant="outline-dark"
                      onClick={() => openActivityModal(m)}
                      title="Log Activity"
                    >
                      <FaTasks /> Log Work
                    </Button>
                  </td>
                </tr>
              ))}
              {members.length === 0 && (
                <tr>
                  <td colSpan="5" className="text-center py-5">
                    No members found
                  </td>
                </tr>
              )}
            </tbody>
          </Table>
        </Card.Body>
      </Card>
      {/* --- ACTIVITY MODAL --- */}
      <Modal
        show={showActivityModal}
        onHide={() => setShowActivityModal(false)}
      >
        <Modal.Header closeButton>
          <Modal.Title>Log Member Activity</Modal.Title>
        </Modal.Header>
        <Modal.Body>
          <p>
            Member:{" "}
            <strong>
              {selectedMember?.firstName} {selectedMember?.lastName}
            </strong>
          </p>
          <Form onSubmit={handleAddActivity}>
            <Form.Group className="mb-3">
              <Form.Label>Event / Program Name</Form.Label>
              <Form.Control
                placeholder="e.g. Janmashtami Setup"
                value={activityData.eventName}
                onChange={(e) =>
                  setActivityData({
                    ...activityData,
                    eventName: e.target.value,
                  })
                }
                required
              />
            </Form.Group>
            <Form.Group className="mb-3">
              <Form.Label>Role / Responsibility</Form.Label>
              <Form.Control
                placeholder="e.g. Food Serving Volunteer"
                value={activityData.role}
                onChange={(e) =>
                  setActivityData({ ...activityData, role: e.target.value })
                }
                required
              />
            </Form.Group>
            <Form.Group className="mb-3">
              <Form.Label>Date</Form.Label>
              <Form.Control
                type="date"
                value={activityData.date}
                onChange={(e) =>
                  setActivityData({ ...activityData, date: e.target.value })
                }
                required
              />
            </Form.Group>
            <Button type="submit" className="w-100 btn-ashram">
              Save Activity
            </Button>
          </Form>
        </Modal.Body>
      </Modal>

      {/* Add Member Modal */}
      <Modal show={showModal} onHide={() => setShowModal(false)} size="lg">
        <Modal.Header closeButton>
          <Modal.Title>New Member Registration</Modal.Title>
        </Modal.Header>
        <Modal.Body>
          <Form onSubmit={handleSubmit}>
            <Row>
              <Col md={6} className="mb-3">
                <Form.Label>First Name</Form.Label>
                <Form.Control
                  name="firstName"
                  onChange={handleChange}
                  required
                />
              </Col>
              <Col md={6} className="mb-3">
                <Form.Label>Last Name</Form.Label>
                <Form.Control
                  name="lastName"
                  onChange={handleChange}
                  required
                />
              </Col>
            </Row>
            <Row>
              <Col md={6} className="mb-3">
                <Form.Label>Phone</Form.Label>
                <Form.Control name="phone" onChange={handleChange} required />
              </Col>
              <Col md={6} className="mb-3">
                <Form.Label>Email</Form.Label>
                <Form.Control name="email" onChange={handleChange} />
              </Col>
            </Row>
            <Form.Group className="mb-3">
              <Form.Label>Address</Form.Label>
              <Form.Control
                as="textarea"
                name="address"
                onChange={handleChange}
                required
              />
            </Form.Group>

            <hr />

            <Row>
              <Col md={4} className="mb-3">
                <Form.Label>Membership Type</Form.Label>
                <Form.Select name="membershipType" onChange={handleChange}>
                  <option>Annual</option>
                  <option>Life</option>
                  <option>Patron</option>
                  <option>Volunteer</option>
                </Form.Select>
              </Col>
              <Col md={4} className="mb-3">
                <Form.Label>Fee Amount ()</Form.Label>
                <Form.Control
                  type="number"
                  name="feeAmount"
                  value={formData.feeAmount}
                  onChange={handleChange}
                />
              </Col>
              <Col md={4} className="mb-3">
                <Form.Label>Fee Status</Form.Label>
                <Form.Select name="feeStatus" onChange={handleChange}>
                  <option>Paid</option>
                  <option>Pending</option>
                  <option>Waived</option>
                </Form.Select>
              </Col>
            </Row>

            <Button type="submit" className="w-100 btn-ashram">
              Register Member
            </Button>
          </Form>
        </Modal.Body>
      </Modal>
    </div>
  );
};

export default MemberList;


--- FILE: client/src/pages/admin/Reports.jsx ---
import React, { useEffect, useState } from "react";
import { Row, Col, Card, Table, Button, Spinner, Alert } from "react-bootstrap";
import {
  FaRupeeSign,
  FaArrowDown,
  FaArrowUp,
  FaUserGraduate,
  FaExclamationTriangle,
  FaDownload,
} from "react-icons/fa";
import axios from "axios";

const Reports = () => {
  const [stats, setStats] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");

  useEffect(() => {
    // eslint-disable-next-line react-hooks/immutability
    fetchStats();
  }, []);

  const fetchStats = async () => {
    try {
      const userInfo = JSON.parse(localStorage.getItem("userInfo"));
      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };
      const { data } = await axios.get(
        "http://localhost:5000/api/reports/stats",
        config
      );
      setStats(data);
      setLoading(false);
    } catch (err) {
      console.error(err);
      setError("Failed to load reports");
      setLoading(false);
    }
  };

  if (loading)
    return (
      <div className="text-center py-5">
        <Spinner animation="border" />
      </div>
    );
  if (error) return <Alert variant="danger">{error}</Alert>;

  return (
    <div>
      <Row className="mb-4 align-items-center">
        <Col>
          <h2
            className="text-maroon"
            style={{ fontFamily: "Playfair Display" }}
          >
            Executive Reports
          </h2>
          <p className="text-muted">Financial Health & Operational Status</p>
        </Col>
        <Col className="text-end">
          <Button variant="outline-dark" onClick={() => window.print()}>
            <FaDownload /> Print / Save PDF
          </Button>
        </Col>
      </Row>

      {/* --- Financial Cards --- */}
      <Row className="mb-4">
        <Col md={4}>
          <Card
            className="shadow-sm border-0 text-white"
            style={{ background: "linear-gradient(45deg, #11998e, #38ef7d)" }}
          >
            <Card.Body>
              <div className="d-flex justify-content-between align-items-center">
                <div>
                  <h6 className="text-uppercase mb-2" style={{ opacity: 0.8 }}>
                    Total Income
                  </h6>
                  <h2 className="fw-bold">
                    <FaRupeeSign size={20} />{" "}
                    {stats.financials.income.toLocaleString()}
                  </h2>
                </div>
                <FaArrowUp size={30} style={{ opacity: 0.5 }} />
              </div>
            </Card.Body>
          </Card>
        </Col>

        <Col md={4}>
          <Card
            className="shadow-sm border-0 text-white"
            style={{ background: "linear-gradient(45deg, #ff416c, #ff4b2b)" }}
          >
            <Card.Body>
              <div className="d-flex justify-content-between align-items-center">
                <div>
                  <h6 className="text-uppercase mb-2" style={{ opacity: 0.8 }}>
                    Total Expenses
                  </h6>
                  <h2 className="fw-bold">
                    <FaRupeeSign size={20} />{" "}
                    {stats.financials.expense.toLocaleString()}
                  </h2>
                </div>
                <FaArrowDown size={30} style={{ opacity: 0.5 }} />
              </div>
            </Card.Body>
          </Card>
        </Col>

        <Col md={4}>
          <Card
            className="shadow-sm border-0 text-white"
            style={{ background: "linear-gradient(45deg, #2193b0, #6dd5ed)" }}
          >
            <Card.Body>
              <div className="d-flex justify-content-between align-items-center">
                <div>
                  <h6 className="text-uppercase mb-2" style={{ opacity: 0.8 }}>
                    Net Balance
                  </h6>
                  <h2 className="fw-bold">
                    <FaRupeeSign size={20} />{" "}
                    {stats.financials.balance.toLocaleString()}
                  </h2>
                </div>
                <div style={{ fontSize: "1.5rem", fontWeight: "bold" }}></div>
              </div>
            </Card.Body>
          </Card>
        </Col>
      </Row>

      {/* --- Operational Stats --- */}
      <Row className="mb-4">
        <Col md={6}>
          <Card className="shadow-sm border-0 h-100">
            <Card.Body className="d-flex align-items-center justify-content-between">
              <div>
                <h5 className="text-maroon">Active Students</h5>
                <h3 className="fw-bold">{stats.counts.students}</h3>
                <small className="text-muted">
                  Currently admitted in Ashram
                </small>
              </div>
              <div className="bg-light p-3 rounded-circle text-maroon">
                <FaUserGraduate size={30} />
              </div>
            </Card.Body>
          </Card>
        </Col>

        <Col md={6}>
          <Card className="shadow-sm border-0 h-100">
            <Card.Body className="d-flex align-items-center justify-content-between">
              <div>
                <h5 className="text-warning">Low Stock Alerts</h5>
                <h3 className="fw-bold">{stats.counts.lowStock}</h3>
                <small className="text-muted">
                  Items below minimum quantity
                </small>
              </div>
              <div className="bg-light p-3 rounded-circle text-warning">
                <FaExclamationTriangle size={30} />
              </div>
            </Card.Body>
          </Card>
        </Col>
      </Row>

      {/* --- Recent Donations Table --- */}
      <Card className="shadow-sm border-0">
        <Card.Header className="bg-white py-3">
          <h5 className="mb-0 text-maroon">Recent Donations</h5>
        </Card.Header>
        <Table responsive hover className="mb-0 align-middle">
          <thead className="bg-light">
            <tr>
              <th className="ps-4">Date</th>
              <th>Donor</th>
              <th>Scheme</th>
              <th className="text-end pe-4">Amount</th>
            </tr>
          </thead>
          <tbody>
            {stats.recentDonations.map((d) => (
              <tr key={d._id}>
                <td className="ps-4 text-muted">
                  {new Date(d.createdAt).toLocaleDateString()}
                </td>
                <td className="fw-bold">{d.donorName}</td>
                <td>
                  <span className="badge bg-info text-dark">{d.scheme}</span>
                </td>
                <td className="text-end pe-4 fw-bold text-success">
                  + {d.amount.toLocaleString()}
                </td>
              </tr>
            ))}
            {stats.recentDonations.length === 0 && (
              <tr>
                <td colSpan="4" className="text-center py-3">
                  No recent activity
                </td>
              </tr>
            )}
          </tbody>
        </Table>
      </Card>
    </div>
  );
};

export default Reports;


--- FILE: client/src/pages/admin/SchemeManager.jsx ---
/* eslint-disable react-hooks/immutability */
/* eslint-disable no-unused-vars */
import React, { useEffect, useState } from "react";
import {
  Table,
  Button,
  Form,
  Card,
  Row,
  Col,
  Alert,
  Badge,
} from "react-bootstrap";
import { FaTrash, FaPlus } from "react-icons/fa";
import axios from "axios";

const SchemeManager = () => {
  const [schemes, setSchemes] = useState([]);
  const [accountHeads, setAccountHeads] = useState([]); // Store Credit Codes

  // Form State
  const [newSchemeName, setNewSchemeName] = useState("");
  const [selectedAccount, setSelectedAccount] = useState("");

  const [userInfo, setUserInfo] = useState(null);

  useEffect(() => {
    const user = JSON.parse(localStorage.getItem("userInfo"));
    setUserInfo(user);
    if (user) {
      fetchSchemes(user);
      fetchAccountHeads(user);
    }
  }, []);

  const fetchSchemes = async (user) => {
    try {
      const config = { headers: { Authorization: `Bearer ${user.token}` } };
      const { data } = await axios.get(
        "http://localhost:5000/api/schemes",
        config
      );
      setSchemes(data);
    } catch (error) {
      console.error(error);
    }
  };

  // Fetch Account Codes (Credit Side Only)
  const fetchAccountHeads = async (user) => {
    try {
      const config = { headers: { Authorization: `Bearer ${user.token}` } };
      const { data } = await axios.get(
        "http://localhost:5000/api/accounts",
        config
      );
      // Filter only CREDIT (Income) codes
      const creditAccounts = data.filter((acc) => acc.type === "Credit");
      setAccountHeads(creditAccounts);
    } catch (error) {
      console.error(error);
    }
  };

  const handleAdd = async (e) => {
    e.preventDefault();
    if (!newSchemeName || !selectedAccount)
      return alert("Please enter name and select account code");

    try {
      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };
      await axios.post(
        "http://localhost:5000/api/schemes",
        {
          name: newSchemeName,
          accountHead: selectedAccount,
        },
        config
      );

      setNewSchemeName("");
      setSelectedAccount("");
      fetchSchemes(userInfo);
    } catch (error) {
      alert("Error adding scheme");
    }
  };

  const handleDelete = async (id) => {
    if (!window.confirm("Delete this scheme?")) return;
    try {
      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };
      await axios.delete(`http://localhost:5000/api/schemes/${id}`, config);
      fetchSchemes(userInfo);
    } catch (error) {
      alert("Error deleting scheme");
    }
  };

  return (
    <div>
      <h2
        className="text-maroon mb-4"
        style={{ fontFamily: "Playfair Display" }}
      >
        Manage Donation Schemes
      </h2>

      <Row>
        <Col md={5}>
          <Card className="shadow-sm border-0 p-3 mb-4">
            <h5 className="mb-3">Add New Scheme</h5>
            <Form onSubmit={handleAdd}>
              <Form.Group className="mb-2">
                <Form.Label>Scheme Name</Form.Label>
                <Form.Control
                  placeholder="e.g. Nitya Annadhana"
                  value={newSchemeName}
                  onChange={(e) => setNewSchemeName(e.target.value)}
                />
              </Form.Group>

              <Form.Group className="mb-3">
                <Form.Label>Link to Account Code (Credit)</Form.Label>
                <Form.Select
                  value={selectedAccount}
                  onChange={(e) => setSelectedAccount(e.target.value)}
                >
                  <option value="">-- Select Account --</option>
                  {accountHeads.map((acc) => (
                    <option key={acc._id} value={acc._id}>
                      {acc.code} - {acc.name}
                    </option>
                  ))}
                </Form.Select>
              </Form.Group>

              <Button type="submit" variant="success" className="w-100">
                <FaPlus /> Add Scheme
              </Button>
            </Form>
          </Card>
        </Col>

        <Col md={7}>
          <Card className="shadow-sm border-0">
            <Table hover className="mb-0 align-middle">
              <thead className="bg-light">
                <tr>
                  <th>Scheme Name</th>
                  <th>Account Code</th>
                  <th className="text-end">Action</th>
                </tr>
              </thead>
              <tbody>
                {schemes.map((s) => (
                  <tr key={s._id}>
                    <td className="fw-bold">{s.name}</td>
                    <td>
                      {s.accountHead ? (
                        <Badge bg="info" text="dark">
                          {s.accountHead.code} - {s.accountHead.name}
                        </Badge>
                      ) : (
                        <Badge bg="danger">Unmapped</Badge>
                      )}
                    </td>
                    <td className="text-end">
                      <Button
                        size="sm"
                        variant="outline-danger"
                        onClick={() => handleDelete(s._id)}
                      >
                        <FaTrash />
                      </Button>
                    </td>
                  </tr>
                ))}
                {schemes.length === 0 && (
                  <tr>
                    <td colSpan="3" className="text-center">
                      No schemes found.
                    </td>
                  </tr>
                )}
              </tbody>
            </Table>
          </Card>
        </Col>
      </Row>
    </div>
  );
};

export default SchemeManager;


--- FILE: client/src/pages/admin/SchemeManager1.jsx ---
/* eslint-disable react-hooks/immutability */
/* eslint-disable no-unused-vars */
import React, { useEffect, useState } from "react";
import { Table, Button, Form, Card, Row, Col, Alert } from "react-bootstrap";
import { FaTrash, FaPlus } from "react-icons/fa";
import axios from "axios";

const SchemeManager = () => {
  const [schemes, setSchemes] = useState([]);
  const [newScheme, setNewScheme] = useState("");
  const [userInfo, setUserInfo] = useState(null);

  useEffect(() => {
    const user = JSON.parse(localStorage.getItem("userInfo"));
    setUserInfo(user);
    fetchSchemes();
  }, []);

  const fetchSchemes = async () => {
    try {
      const { data } = await axios.get("http://localhost:5000/api/schemes");
      setSchemes(data);
    } catch (error) {
      console.error(error);
    }
  };

  const handleAdd = async (e) => {
    e.preventDefault();
    if (!newScheme) return;
    try {
      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };
      await axios.post(
        "http://localhost:5000/api/schemes",
        { name: newScheme },
        config
      );
      setNewScheme("");
      fetchSchemes();
    } catch (error) {
      alert("Error adding scheme");
    }
  };

  const handleDelete = async (id) => {
    if (!window.confirm("Delete this scheme?")) return;
    try {
      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };
      await axios.delete(`http://localhost:5000/api/schemes/${id}`, config);
      fetchSchemes();
    } catch (error) {
      alert("Error deleting scheme");
    }
  };

  return (
    <div>
      <h2
        className="text-maroon mb-4"
        style={{ fontFamily: "Playfair Display" }}
      >
        Manage Donation Schemes
      </h2>

      <Row>
        <Col md={6}>
          <Card className="shadow-sm border-0 p-3 mb-4">
            <h5 className="mb-3">Add New Scheme</h5>
            <Form onSubmit={handleAdd} className="d-flex gap-2">
              <Form.Control
                placeholder="Enter Scheme Name (e.g. Nitya Annadhana)"
                value={newScheme}
                onChange={(e) => setNewScheme(e.target.value)}
              />
              <Button type="submit" variant="success">
                <FaPlus /> Add
              </Button>
            </Form>
          </Card>

          <Card className="shadow-sm border-0">
            <Table hover className="mb-0">
              <thead className="bg-light">
                <tr>
                  <th>Scheme Name</th>
                  <th className="text-end">Action</th>
                </tr>
              </thead>
              <tbody>
                {schemes.map((s) => (
                  <tr key={s._id}>
                    <td className="fw-bold">{s.name}</td>
                    <td className="text-end">
                      <Button
                        size="sm"
                        variant="outline-danger"
                        onClick={() => handleDelete(s._id)}
                      >
                        <FaTrash />
                      </Button>
                    </td>
                  </tr>
                ))}
                {schemes.length === 0 && (
                  <tr>
                    <td colSpan="2" className="text-center">
                      No schemes found.
                    </td>
                  </tr>
                )}
              </tbody>
            </Table>
          </Card>
        </Col>
        <Col md={6}>
          <Alert variant="info">
            <strong>Note:</strong> These schemes will appear in the dropdown
            menu on the Donation Page and Admin Entry form.
          </Alert>
        </Col>
      </Row>
    </div>
  );
};

export default SchemeManager;


--- FILE: client/src/pages/admin/StockAudit.jsx ---
/* eslint-disable no-unused-vars */
import React, { useEffect, useState } from "react";
import {
  Table,
  Button,
  Card,
  Row,
  Col,
  Form,
  Badge,
  Alert,
} from "react-bootstrap";
import { FaClipboardCheck, FaHistory } from "react-icons/fa";
import axios from "axios";
import { useNavigate } from "react-router-dom"; // 1. Import this

const StockAudit = () => {
  const navigate = useNavigate(); // 2. Initialize hook
  const [items, setItems] = useState([]);
  const [auditData, setAuditData] = useState({}); // Stores physical qty inputs
  const [remarks, setRemarks] = useState({}); // Stores remarks
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    // eslint-disable-next-line react-hooks/immutability
    fetchInventory();
  }, []);

  const fetchInventory = async () => {
    try {
      const userInfo = JSON.parse(localStorage.getItem("userInfo"));
      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };
      const { data } = await axios.get(
        "http://localhost:5000/api/inventory",
        config
      );
      setItems(data);

      // Initialize audit data with current system values
      const initialData = {};
      data.forEach((item) => {
        initialData[item._id] = item.quantity;
      });
      setAuditData(initialData);
    } catch (error) {
      console.error(error);
    }
  };

  const handleQtyChange = (id, val) => {
    setAuditData({ ...auditData, [id]: Number(val) });
  };

  const handleRemarkChange = (id, val) => {
    setRemarks({ ...remarks, [id]: val });
  };

  // const handleSubmitAudit = async () => {
  //   if (
  //     !window.confirm(
  //       "This will update the live stock quantities. Are you sure?"
  //     )
  //   )
  //     return;

  //   setLoading(true);
  //   try {
  //     const userInfo = JSON.parse(localStorage.getItem("userInfo"));
  //     const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };

  //     // Prepare Payload
  //     const auditItems = items.map((item) => ({
  //       itemId: item._id,
  //       itemName: item.itemName,
  //       systemQty: item.quantity,
  //       physicalQty: auditData[item._id],
  //       remark: remarks[item._id] || "",
  //     }));

  //     await axios.post(
  //       "http://localhost:5000/api/inventory/audit",
  //       { items: auditItems },
  //       config
  //     );

  //     alert("Audit Completed! Stock Adjusted.");
  //     fetchInventory(); // Refresh data
  //     setRemarks({});
  //   } catch (error) {
  //     alert("Error submitting audit");
  //   }
  //   setLoading(false);
  // };
  const handleSubmitAudit = async () => {
    if (
      !window.confirm(
        "This will update the live stock quantities. Are you sure?"
      )
    )
      return;

    setLoading(true);
    try {
      const userInfo = JSON.parse(localStorage.getItem("userInfo"));
      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };

      const auditItems = items.map((item) => ({
        itemId: item._id,
        itemName: item.itemName,
        systemQty: item.quantity,
        physicalQty:
          auditData[item._id] !== undefined
            ? auditData[item._id]
            : item.quantity,
        remark: remarks[item._id] || "",
      }));

      await axios.post(
        "http://localhost:5000/api/inventory/audit",
        { items: auditItems },
        config
      );

      alert("Audit Completed Successfully!");

      // 3. REDIRECT to History Page immediately
      navigate("/dashboard/inventory/history");
    } catch (error) {
      alert("Error submitting audit");
      setLoading(false);
    }
  };

  return (
    <div>
      <Row className="mb-4 align-items-center">
        <Col>
          <h2
            className="text-maroon"
            style={{ fontFamily: "Playfair Display" }}
          >
            Stock Reconciliation
          </h2>
          <p className="text-muted">Compare System Stock vs Physical Stock</p>
        </Col>
        <Col className="text-end">
          <Button
            variant="success"
            onClick={handleSubmitAudit}
            disabled={loading}
          >
            <FaClipboardCheck /> {loading ? "Saving..." : "Finalize Audit"}
          </Button>
        </Col>
      </Row>

      <Card className="shadow-sm border-0">
        <Card.Body className="p-0">
          <Table hover responsive className="align-middle mb-0">
            <thead className="bg-light">
              <tr>
                <th className="ps-4">Item Name</th>
                <th>System Stock</th>
                <th style={{ width: "150px" }}>Physical Stock</th>
                <th>Difference</th>
                <th>Remark</th>
              </tr>
            </thead>
            <tbody>
              {items.map((item) => {
                const physical =
                  auditData[item._id] !== undefined
                    ? auditData[item._id]
                    : item.quantity;
                const diff = physical - item.quantity;

                return (
                  <tr
                    key={item._id}
                    className={diff !== 0 ? "bg-light-warning" : ""}
                  >
                    <td className="ps-4 fw-bold">
                      {item.itemName}{" "}
                      <Badge bg="secondary" className="ms-1">
                        {item.unit}
                      </Badge>
                    </td>
                    <td>{item.quantity}</td>
                    <td>
                      <Form.Control
                        type="number"
                        value={physical}
                        onChange={(e) =>
                          handleQtyChange(item._id, e.target.value)
                        }
                        style={{
                          borderColor: diff !== 0 ? "#ffc107" : "#ced4da",
                        }}
                      />
                    </td>
                    <td>
                      {diff === 0 ? (
                        <span className="text-success fw-bold">Match</span>
                      ) : (
                        <span
                          className={
                            diff < 0
                              ? "text-danger fw-bold"
                              : "text-primary fw-bold"
                          }
                        >
                          {diff > 0 ? `+${diff}` : diff}
                        </span>
                      )}
                    </td>
                    <td>
                      {diff !== 0 && (
                        <Form.Control
                          size="sm"
                          placeholder="Reason (e.g. Spoilage)"
                          value={remarks[item._id] || ""}
                          onChange={(e) =>
                            handleRemarkChange(item._id, e.target.value)
                          }
                        />
                      )}
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </Table>
        </Card.Body>
      </Card>
    </div>
  );
};

export default StockAudit;


--- FILE: client/src/pages/admin/StudentList.jsx ---
/* eslint-disable react-hooks/immutability */
/* eslint-disable no-unused-vars */
import React, { useEffect, useState } from "react";
import {
  Table,
  Button,
  Badge,
  Card,
  Row,
  Col,
  Modal,
  Form,
} from "react-bootstrap";
import {
  FaPlus,
  FaEye,
  FaCheckCircle,
  FaTimesCircle,
  FaClock,
  FaUserGraduate,
  FaFileDownload,
  FaTrash,
} from "react-icons/fa";
import { Link } from "react-router-dom";
import axios from "axios";

const StudentList = () => {
  const [students, setStudents] = useState([]);
  const [showAddModal, setShowAddModal] = useState(false);
  const [showViewModal, setShowViewModal] = useState(false);
  const [selectedStudent, setSelectedStudent] = useState(null);
  const [currentUser, setCurrentUser] = useState(null);

  const [formData, setFormData] = useState({
    firstName: "",
    lastName: "",
    dob: "",
    gender: "Male",
    guardianName: "",
    contactNumber: "",
    address: "",
    branch: "Headquarters",
  });

  useEffect(() => {
    const user = JSON.parse(localStorage.getItem("userInfo"));
    setCurrentUser(user);
    if (user) fetchStudents(user);
  }, []);

  const fetchStudents = async (user) => {
    try {
      const config = { headers: { Authorization: `Bearer ${user.token}` } };
      const { data } = await axios.get(
        "http://localhost:5000/api/students",
        config
      );
      setStudents(data);
    } catch (error) {
      console.error(error);
    }
  };

  // --- EXPORT FUNCTION (CSV) ---
  const handleExport = () => {
    if (students.length === 0) return alert("No data to export");

    const headers = [
      "First Name",
      "Last Name",
      "Guardian",
      "DOB",
      "Gender",
      "Contact",
      "Branch",
      "Status",
    ];
    const rows = students.map((s) => [
      s.firstName,
      s.lastName,
      s.guardianName,
      new Date(s.dob).toLocaleDateString(),
      s.gender,
      s.contactNumber,
      s.branch,
      s.admissionStatus,
    ]);

    const csvContent =
      "data:text/csv;charset=utf-8," +
      headers.join(",") +
      "\n" +
      rows.map((e) => e.join(",")).join("\n");
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "Students_List.csv");
    document.body.appendChild(link);
    link.click();
  };

  const handleDelete = async (id) => {
    if (!window.confirm("Are you sure you want to delete this student record?"))
      return;
    try {
      const config = {
        headers: { Authorization: `Bearer ${currentUser.token}` },
      };
      await axios.delete(`http://localhost:5000/api/students/${id}`, config);
      fetchStudents(currentUser);
      alert("Student Deleted");
    } catch (error) {
      alert("Error deleting student");
    }
  };

  // ... (Helper functions: handleApprove, handleChange, handleSubmit, openViewModal, StatusBadge) ...
  const handleApprove = async (status) => {
    try {
      const config = {
        headers: { Authorization: `Bearer ${currentUser.token}` },
      };
      await axios.put(
        `http://localhost:5000/api/students/${selectedStudent._id}/approve`,
        {
          status: status,
          remark: "Approved via Dashboard",
          approvalType: currentUser.role,
        },
        config
      );
      alert(`Successfully ${status}`);
      setShowViewModal(false);
      fetchStudents(currentUser);
    } catch (error) {
      alert(error.response?.data?.message || "Error updating status");
    }
  };

  const handleChange = (e) => {
    setFormData({ ...formData, [e.target.name]: e.target.value });
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    try {
      const config = {
        headers: { Authorization: `Bearer ${currentUser.token}` },
      };
      await axios.post("http://localhost:5000/api/students", formData, config);
      setShowAddModal(false);
      fetchStudents(currentUser);
      alert("Application Submitted!");
      setFormData({
        firstName: "",
        lastName: "",
        dob: "",
        gender: "Male",
        guardianName: "",
        contactNumber: "",
        address: "",
        branch: "Headquarters",
      });
    } catch (error) {
      alert("Error submitting application");
    }
  };

  const openViewModal = (student) => {
    setSelectedStudent(student);
    setShowViewModal(true);
  };

  const StatusBadge = ({ status }) => {
    if (status === "Approved")
      return (
        <Badge bg="success">
          <FaCheckCircle /> Approved
        </Badge>
      );
    if (status === "Rejected")
      return (
        <Badge bg="danger">
          <FaTimesCircle /> Rejected
        </Badge>
      );
    return (
      <Badge bg="warning" text="dark">
        <FaClock /> Pending
      </Badge>
    );
  };
  // --- NEW HELPER: Overall Admission Status ---
  const renderOverallStatus = (status) => {
    switch (status) {
      case "Active":
        return (
          <Badge bg="success" style={{ fontSize: "0.9rem" }}>
            ADMITTED
          </Badge>
        );
      case "Alumni":
        return (
          <Badge bg="info" style={{ fontSize: "0.9rem" }}>
            ALUMNI
          </Badge>
        );
      case "Rejected":
        return (
          <Badge bg="danger" style={{ fontSize: "0.9rem" }}>
            REJECTED
          </Badge>
        );
      default: // 'In Review' or 'Draft'
        return (
          <Badge bg="secondary" style={{ fontSize: "0.9rem" }}>
            IN REVIEW
          </Badge>
        );
    }
  };

  return (
    <div>
      <Row className="mb-4 align-items-center">
        <Col>
          <h2
            className="text-maroon"
            style={{ fontFamily: "Playfair Display" }}
          >
            Student Admissions
          </h2>
        </Col>
        <Col className="text-end">
          {/* --- EXPORT BUTTON (Beside New Admission) --- */}
          <Button variant="success" className="me-2" onClick={handleExport}>
            <FaFileDownload /> Export List
          </Button>

          <Button
            variant="primary"
            style={{ backgroundColor: "#581818", border: "none" }}
            onClick={() => setShowAddModal(true)}
          >
            <FaPlus /> New Admission
          </Button>
        </Col>
      </Row>

      <Card className="shadow-sm border-0">
        <Card.Body className="p-0">
          <Table hover responsive className="align-middle mb-0">
            <thead className="bg-light">
              <tr>
                <th className="ps-4">Name</th>
                <th>Guardian</th>
                <th>Branch</th>
                <th className="text-center">Approvals</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {students.map((s) => (
                <tr key={s._id}>
                  <td className="ps-4 fw-bold">
                    {s.firstName} {s.lastName}
                  </td>
                  <td>{s.guardianName}</td>
                  <td>{s.branch}</td>
                  <td className="text-center">
                    <small>
                      P:{" "}
                      {s.approvals.president.status === "Approved"
                        ? ""
                        : ""}{" "}
                      | S:{" "}
                      {s.approvals.secretary.status === "Approved"
                        ? ""
                        : ""}{" "}
                      | T:{" "}
                      {s.approvals.treasurer.status === "Approved"
                        ? ""
                        : ""}
                    </small>
                  </td>
                  {/* <td>
                    {s.admissionStatus === "Active" ? (
                      <Badge bg="success">Admitted</Badge>
                    ) : (
                      <Badge bg="secondary">In Review</Badge>
                    )}
                  </td> */}
                  {/* --- FIXED STATUS COLUMN --- */}
                  <td>{renderOverallStatus(s.admissionStatus)}</td>
                  {/* --------------------------- */}

                  <td></td>
                  <td>
                    <div className="d-flex gap-2">
                      <Button
                        size="sm"
                        variant="outline-primary"
                        onClick={() => openViewModal(s)}
                        title="View Status"
                      >
                        <FaEye />
                      </Button>

                      <Link
                        to={`/dashboard/students/${s._id}`}
                        className="btn btn-sm btn-dark"
                        title="Full Profile"
                      >
                        <FaUserGraduate />
                      </Link>

                      {/* Delete Button (Admin Only) */}
                      {currentUser?.role === "admin" && (
                        <Button
                          size="sm"
                          variant="outline-danger"
                          onClick={() => handleDelete(s._id)}
                          title="Delete"
                        >
                          <FaTrash />
                        </Button>
                      )}
                    </div>
                  </td>
                </tr>
              ))}
              {students.length === 0 && (
                <tr>
                  <td colSpan="6" className="text-center py-5">
                    No students found
                  </td>
                </tr>
              )}
            </tbody>
          </Table>
        </Card.Body>
      </Card>

      {/* --- MODALS (View & Add) --- */}
      <Modal
        show={showViewModal}
        onHide={() => setShowViewModal(false)}
        size="lg"
      >
        <Modal.Header closeButton>
          <Modal.Title>Application Details</Modal.Title>
        </Modal.Header>
        <Modal.Body>
          {selectedStudent && (
            <>
              <h4 className="text-maroon">
                {selectedStudent.firstName} {selectedStudent.lastName}
              </h4>
              <p className="text-muted">
                Guardian: {selectedStudent.guardianName}
              </p>
              <hr />
              <h5 className="mb-3">Approval Workflow</h5>

              {/* President */}
              <div className="d-flex justify-content-between align-items-center mb-3 p-2 border rounded">
                <div>
                  <strong>1. President Review</strong>
                </div>
                <div>
                  <StatusBadge
                    status={selectedStudent.approvals.president.status}
                  />
                </div>
                {currentUser?.role === "president" &&
                  selectedStudent.approvals.president.status === "Pending" && (
                    <div>
                      <Button
                        size="sm"
                        variant="success"
                        className="me-2"
                        onClick={() => handleApprove("Approved")}
                      >
                        Approve
                      </Button>
                      <Button
                        size="sm"
                        variant="danger"
                        onClick={() => handleApprove("Rejected")}
                      >
                        Reject
                      </Button>
                    </div>
                  )}
              </div>

              {/* Secretary */}
              <div className="d-flex justify-content-between align-items-center mb-3 p-2 border rounded">
                <div>
                  <strong>2. Secretary Review</strong>
                </div>
                <div>
                  <StatusBadge
                    status={selectedStudent.approvals.secretary.status}
                  />
                </div>
                {currentUser?.role === "secretary" &&
                  selectedStudent.approvals.secretary.status === "Pending" && (
                    <div>
                      <Button
                        size="sm"
                        variant="success"
                        className="me-2"
                        onClick={() => handleApprove("Approved")}
                      >
                        Approve
                      </Button>
                      <Button
                        size="sm"
                        variant="danger"
                        onClick={() => handleApprove("Rejected")}
                      >
                        Reject
                      </Button>
                    </div>
                  )}
              </div>

              {/* Treasurer */}
              <div className="d-flex justify-content-between align-items-center mb-3 p-2 border rounded">
                <div>
                  <strong>3. Treasurer Review</strong>
                </div>
                <div>
                  <StatusBadge
                    status={selectedStudent.approvals.treasurer.status}
                  />
                </div>
                {currentUser?.role === "treasurer" &&
                  selectedStudent.approvals.treasurer.status === "Pending" && (
                    <div>
                      <Button
                        size="sm"
                        variant="success"
                        className="me-2"
                        onClick={() => handleApprove("Approved")}
                      >
                        Approve
                      </Button>
                      <Button
                        size="sm"
                        variant="danger"
                        onClick={() => handleApprove("Rejected")}
                      >
                        Reject
                      </Button>
                    </div>
                  )}
              </div>
            </>
          )}
        </Modal.Body>
      </Modal>

      <Modal
        show={showAddModal}
        onHide={() => setShowAddModal(false)}
        size="lg"
      >
        <Modal.Header closeButton>
          <Modal.Title>New Student Application</Modal.Title>
        </Modal.Header>
        <Modal.Body>
          <Form onSubmit={handleSubmit}>
            <Row>
              <Col md={6} className="mb-3">
                <Form.Label>First Name</Form.Label>
                <Form.Control
                  name="firstName"
                  onChange={handleChange}
                  required
                />
              </Col>
              <Col md={6} className="mb-3">
                <Form.Label>Last Name</Form.Label>
                <Form.Control
                  name="lastName"
                  onChange={handleChange}
                  required
                />
              </Col>
              <Col md={6} className="mb-3">
                <Form.Label>Date of Birth</Form.Label>
                <Form.Control
                  type="date"
                  name="dob"
                  onChange={handleChange}
                  required
                />
              </Col>
              <Col md={6} className="mb-3">
                <Form.Label>Guardian Name</Form.Label>
                <Form.Control
                  name="guardianName"
                  onChange={handleChange}
                  required
                />
              </Col>
              <Col md={6} className="mb-3">
                <Form.Label>Contact Number</Form.Label>
                <Form.Control
                  name="contactNumber"
                  onChange={handleChange}
                  required
                />
              </Col>
              <Col md={12} className="mb-3">
                <Form.Label>Address</Form.Label>
                <Form.Control
                  as="textarea"
                  name="address"
                  onChange={handleChange}
                  required
                />
              </Col>
            </Row>
            <Button type="submit" className="w-100 btn-ashram">
              Submit Application
            </Button>
          </Form>
        </Modal.Body>
      </Modal>
    </div>
  );
};

export default StudentList;


--- FILE: client/src/pages/admin/StudentList1.jsx ---
// import React, { useEffect, useState } from "react";
// import {
//   Table,
//   Button,
//   Badge,
//   Card,
//   Row,
//   Col,
//   Modal,
//   Form,
// } from "react-bootstrap";
// import { FaPlus, FaUserCheck } from "react-icons/fa";
// import axios from "axios";

// const StudentList = () => {
//   const [students, setStudents] = useState([]);
//   const [showModal, setShowModal] = useState(false);

//   // Form State
//   const [formData, setFormData] = useState({
//     firstName: "",
//     lastName: "",
//     dob: "",
//     gender: "Male",
//     guardianName: "",
//     contactNumber: "",
//     address: "",
//     branch: "Headquarters",
//   });

//   useEffect(() => {
//     // eslint-disable-next-line react-hooks/immutability
//     fetchStudents();
//   }, []);

//   const fetchStudents = async () => {
//     try {
//       const userInfo = JSON.parse(localStorage.getItem("userInfo"));
//       const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };
//       const { data } = await axios.get(
//         "http://localhost:5000/api/students",
//         config
//       );
//       setStudents(data);
//     } catch (error) {
//       console.error(error);
//     }
//   };

//   const handleChange = (e) => {
//     setFormData({ ...formData, [e.target.name]: e.target.value });
//   };

//   const handleSubmit = async (e) => {
//     e.preventDefault();
//     try {
//       const userInfo = JSON.parse(localStorage.getItem("userInfo"));
//       const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };
//       await axios.post("http://localhost:5000/api/students", formData, config);
//       setShowModal(false);
//       fetchStudents();
//       alert("Application Submitted!");
//       // eslint-disable-next-line no-unused-vars
//     } catch (error) {
//       alert("Error submitting application");
//     }
//   };

//   // Helper to render approval badge
//   const renderStatus = (status) => {
//     if (status === "Approved") return <Badge bg="success">Approved</Badge>;
//     if (status === "Rejected") return <Badge bg="danger">Rejected</Badge>;
//     return (
//       <Badge bg="warning" text="dark">
//         Pending
//       </Badge>
//     );
//   };

//   return (
//     <div>
//       <Row className="mb-4 align-items-center">
//         <Col>
//           <h2
//             className="text-maroon"
//             style={{ fontFamily: "Playfair Display" }}
//           >
//             Student Admissions
//           </h2>
//           <p className="text-muted">Manage enrollments and approvals</p>
//         </Col>
//         <Col className="text-end">
//           <Button
//             variant="primary"
//             style={{ backgroundColor: "#581818", border: "none" }}
//             onClick={() => setShowModal(true)}
//           >
//             <FaPlus /> New Admission
//           </Button>
//         </Col>
//       </Row>

//       <Card className="shadow-sm border-0">
//         <Card.Body className="p-0">
//           <Table hover responsive className="align-middle mb-0">
//             <thead className="bg-light">
//               <tr>
//                 <th className="ps-4">Name</th>
//                 <th>Guardian</th>
//                 <th>Branch</th>
//                 <th className="text-center">President</th>
//                 <th className="text-center">Secretary</th>
//                 <th className="text-center">Treasurer</th>
//                 <th>Status</th>
//               </tr>
//             </thead>
//             <tbody>
//               {students.map((s) => (
//                 <tr key={s._id}>
//                   <td className="ps-4 fw-bold">
//                     {s.firstName} {s.lastName}
//                   </td>
//                   <td>{s.guardianName}</td>
//                   <td>{s.branch}</td>
//                   <td className="text-center">
//                     {renderStatus(s.approvals.president.status)}
//                   </td>
//                   <td className="text-center">
//                     {renderStatus(s.approvals.secretary.status)}
//                   </td>
//                   <td className="text-center">
//                     {renderStatus(s.approvals.treasurer.status)}
//                   </td>
//                   <td>
//                     {s.admissionStatus === "Active" ? (
//                       <Badge bg="success">ADMITTED</Badge>
//                     ) : (
//                       <Badge bg="secondary">IN REVIEW</Badge>
//                     )}
//                   </td>
//                 </tr>
//               ))}
//               {students.length === 0 && (
//                 <tr>
//                   <td colSpan="7" className="text-center py-5">
//                     No students found
//                   </td>
//                 </tr>
//               )}
//             </tbody>
//           </Table>
//         </Card.Body>
//       </Card>

//       {/* Add Student Modal */}
//       <Modal show={showModal} onHide={() => setShowModal(false)} size="lg">
//         <Modal.Header closeButton>
//           <Modal.Title>New Student Application</Modal.Title>
//         </Modal.Header>
//         <Modal.Body>
//           <Form onSubmit={handleSubmit}>
//             <Row>
//               <Col md={6} className="mb-3">
//                 <Form.Label>First Name</Form.Label>
//                 <Form.Control
//                   name="firstName"
//                   onChange={handleChange}
//                   required
//                 />
//               </Col>
//               <Col md={6} className="mb-3">
//                 <Form.Label>Last Name</Form.Label>
//                 <Form.Control
//                   name="lastName"
//                   onChange={handleChange}
//                   required
//                 />
//               </Col>
//               <Col md={6} className="mb-3">
//                 <Form.Label>Date of Birth</Form.Label>
//                 <Form.Control
//                   type="date"
//                   name="dob"
//                   onChange={handleChange}
//                   required
//                 />
//               </Col>
//               <Col md={6} className="mb-3">
//                 <Form.Label>Guardian Name</Form.Label>
//                 <Form.Control
//                   name="guardianName"
//                   onChange={handleChange}
//                   required
//                 />
//               </Col>
//               <Col md={6} className="mb-3">
//                 <Form.Label>Contact Number</Form.Label>
//                 <Form.Control
//                   name="contactNumber"
//                   onChange={handleChange}
//                   required
//                 />
//               </Col>
//               <Col md={12} className="mb-3">
//                 <Form.Label>Address</Form.Label>
//                 <Form.Control
//                   as="textarea"
//                   name="address"
//                   onChange={handleChange}
//                   required
//                 />
//               </Col>
//             </Row>
//             <Button type="submit" className="w-100 btn-ashram">
//               Submit Application
//             </Button>
//           </Form>
//         </Modal.Body>
//       </Modal>
//     </div>
//   );
// };

// export default StudentList;
import React, { useEffect, useState } from "react";
// 1. Correctly import UI components from react-bootstrap
import {
  Table,
  Button,
  Badge,
  Card,
  Row,
  Col,
  Modal,
  Form,
  Alert,
} from "react-bootstrap";
// 2. Correctly import Icons from react-icons/fa
import {
  FaPlus,
  FaEye,
  FaCheckCircle,
  FaTimesCircle,
  FaClock,
  FaUserGraduate,
  FaFileDownload,
  FaTrash,
} from "react-icons/fa";
import { Link } from "react-router-dom";
import axios from "axios";

const StudentList = () => {
  const [students, setStudents] = useState([]);
  const [showAddModal, setShowAddModal] = useState(false);
  const [showViewModal, setShowViewModal] = useState(false);
  const [selectedStudent, setSelectedStudent] = useState(null);
  const [currentUser, setCurrentUser] = useState(null);

  // Form State
  const [formData, setFormData] = useState({
    firstName: "",
    lastName: "",
    dob: "",
    gender: "Male",
    guardianName: "",
    contactNumber: "",
    address: "",
    branch: "Headquarters",
  });

  useEffect(() => {
    const user = JSON.parse(localStorage.getItem("userInfo"));
    setCurrentUser(user);
    // Safety check to ensure user exists before fetching
    if (user) {
      // eslint-disable-next-line react-hooks/immutability
      fetchStudents(user);
    }
  }, []);

  const fetchStudents = async (user) => {
    try {
      const config = { headers: { Authorization: `Bearer ${user.token}` } };
      const { data } = await axios.get(
        "http://localhost:5000/api/students",
        config
      );
      setStudents(data);
    } catch (error) {
      console.error(error);
    }
  };
  // --- EXPORT FUNCTION ---
  const handleExport = () => {
    if (students.length === 0) return alert("No data to export");

    const headers = [
      "First Name",
      "Last Name",
      "Guardian",
      "DOB",
      "Gender",
      "Contact",
      "Branch",
      "Status",
    ];
    const rows = students.map((s) => [
      s.firstName,
      s.lastName,
      s.guardianName,
      new Date(s.dob).toLocaleDateString(),
      s.gender,
      s.contactNumber,
      s.branch,
      s.admissionStatus,
    ]);

    const csvContent =
      "data:text/csv;charset=utf-8," +
      headers.join(",") +
      "\n" +
      rows.map((e) => e.join(",")).join("\n");
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "Students_List.csv");
    document.body.appendChild(link);
    link.click();
  };

  // --- DELETE FUNCTION ---
  const handleDelete = async (id) => {
    if (!window.confirm("Are you sure you want to delete this student record?"))
      return;
    try {
      const config = {
        headers: { Authorization: `Bearer ${currentUser.token}` },
      };
      await axios.delete(`http://localhost:5000/api/students/${id}`, config);
      fetchStudents(currentUser);
      alert("Student Deleted");
    } catch (error) {
      alert("Error deleting student");
    }
  };

  const handleApprove = async (status) => {
    try {
      const config = {
        headers: { Authorization: `Bearer ${currentUser.token}` },
      };
      await axios.put(
        `http://localhost:5000/api/students/${selectedStudent._id}/approve`,
        {
          status: status,
          remark: "Approved via Dashboard",
          approvalType: currentUser.role, // Send the role to backend to know which slot to update
        },
        config
      );

      alert(`Successfully ${status}`);
      setShowViewModal(false);
      fetchStudents(currentUser);
    } catch (error) {
      alert(error.response?.data?.message || "Error updating status");
    }
  };

  const handleChange = (e) => {
    setFormData({ ...formData, [e.target.name]: e.target.value });
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    try {
      const config = {
        headers: { Authorization: `Bearer ${currentUser.token}` },
      };
      await axios.post("http://localhost:5000/api/students", formData, config);
      setShowAddModal(false);
      fetchStudents(currentUser);
      alert("Application Submitted!");
      // Reset form
      setFormData({
        firstName: "",
        lastName: "",
        dob: "",
        gender: "Male",
        guardianName: "",
        contactNumber: "",
        address: "",
        branch: "Headquarters",
      });
      // eslint-disable-next-line no-unused-vars
    } catch (error) {
      alert("Error submitting application");
    }
  };

  const openViewModal = (student) => {
    setSelectedStudent(student);
    setShowViewModal(true);
  };

  // Helper to render status badge
  const StatusBadge = ({ status }) => {
    if (status === "Approved")
      return (
        <Badge bg="success">
          <FaCheckCircle /> Approved
        </Badge>
      );
    if (status === "Rejected")
      return (
        <Badge bg="danger">
          <FaTimesCircle /> Rejected
        </Badge>
      );
    return (
      <Badge bg="warning" text="dark">
        <FaClock /> Pending
      </Badge>
    );
  };

  return (
    <div>
      <Row className="mb-4 align-items-center">
        <Col>
          <h2
            className="text-maroon"
            style={{ fontFamily: "Playfair Display" }}
          >
            Student Admissions
          </h2>
        </Col>
        <Col className="text-end">
          <Button
            variant="primary"
            style={{ backgroundColor: "#581818", border: "none" }}
            onClick={() => setShowAddModal(true)}
          >
            <FaPlus /> New Admission
          </Button>
        </Col>
      </Row>

      <Card className="shadow-sm border-0">
        <Card.Body className="p-0">
          <Table hover responsive className="align-middle mb-0">
            <thead className="bg-light">
              <tr>
                <th className="ps-4">Name</th>
                <th>Branch</th>
                <th className="text-center">President</th>
                <th className="text-center">Secretary</th>
                <th className="text-center">Treasurer</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {students.map((s) => (
                <tr key={s._id}>
                  <td className="ps-4 fw-bold">
                    {s.firstName} {s.lastName}
                  </td>
                  <td>{s.branch}</td>
                  <td className="text-center">
                    <StatusBadge status={s.approvals.president.status} />
                  </td>
                  <td className="text-center">
                    <StatusBadge status={s.approvals.secretary.status} />
                  </td>
                  <td className="text-center">
                    <StatusBadge status={s.approvals.treasurer.status} />
                  </td>
                  {/* <td>
                    <Button
                      size="sm"
                      variant="outline-primary"
                      onClick={() => openViewModal(s)}
                    >
                      <FaEye /> View
                    </Button>
                    <Link
                      to={`/dashboard/students/${s._id}`}
                      className="btn btn-sm btn-dark"
                    >
                      <FaUserGraduate /> Profile
                    </Link>
                  </td> */}
                  <div className="d-flex gap-2">
                    <Button
                      size="sm"
                      variant="outline-primary"
                      onClick={() => openViewModal(s)}
                      title="View Status"
                    >
                      <FaEye />
                    </Button>

                    <Link
                      to={`/dashboard/students/${s._id}`}
                      className="btn btn-sm btn-dark"
                      title="Full Profile"
                    >
                      <FaUserGraduate />
                    </Link>

                    {/* Delete Button (Admin Only) */}
                    {currentUser?.role === "admin" && (
                      <Button
                        size="sm"
                        variant="outline-danger"
                        onClick={() => handleDelete(s._id)}
                        title="Delete"
                      >
                        <FaTrash />
                      </Button>
                    )}
                  </div>
                </tr>
              ))}
              {students.length === 0 && (
                <tr>
                  <td colSpan="6" className="text-center py-5">
                    No students found
                  </td>
                </tr>
              )}
            </tbody>
          </Table>
        </Card.Body>
      </Card>

      {/* --- VIEW / APPROVE MODAL --- */}
      <Modal
        show={showViewModal}
        onHide={() => setShowViewModal(false)}
        size="lg"
      >
        <Modal.Header closeButton>
          <Modal.Title>Application Details</Modal.Title>
        </Modal.Header>
        <Modal.Body>
          {selectedStudent && (
            <>
              <h4 className="text-maroon">
                {selectedStudent.firstName} {selectedStudent.lastName}
              </h4>
              <p className="text-muted">
                Guardian: {selectedStudent.guardianName} | DOB:{" "}
                {new Date(selectedStudent.dob).toLocaleDateString()}
              </p>
              <hr />

              <h5 className="mb-3">Approval Workflow</h5>

              {/* 1. President Row */}
              <div className="d-flex justify-content-between align-items-center mb-3 p-2 border rounded">
                <div>
                  <strong>1. President Review</strong>
                </div>
                <div>
                  <StatusBadge
                    status={selectedStudent.approvals.president.status}
                  />
                </div>

                {/* Logic: Show buttons if User is President AND Status is Pending */}
                {currentUser?.role === "president" &&
                  selectedStudent.approvals.president.status === "Pending" && (
                    <div>
                      <Button
                        size="sm"
                        variant="success"
                        className="me-2"
                        onClick={() => handleApprove("Approved")}
                      >
                        Approve
                      </Button>
                      <Button
                        size="sm"
                        variant="danger"
                        onClick={() => handleApprove("Rejected")}
                      >
                        Reject
                      </Button>
                    </div>
                  )}
              </div>

              {/* 2. Secretary Row */}
              <div className="d-flex justify-content-between align-items-center mb-3 p-2 border rounded">
                <div>
                  <strong>2. Secretary Review</strong>
                </div>
                <div>
                  <StatusBadge
                    status={selectedStudent.approvals.secretary.status}
                  />
                </div>

                {currentUser?.role === "secretary" &&
                  selectedStudent.approvals.secretary.status === "Pending" && (
                    <div>
                      <Button
                        size="sm"
                        variant="success"
                        className="me-2"
                        onClick={() => handleApprove("Approved")}
                      >
                        Approve
                      </Button>
                      <Button
                        size="sm"
                        variant="danger"
                        onClick={() => handleApprove("Rejected")}
                      >
                        Reject
                      </Button>
                    </div>
                  )}
              </div>

              {/* 3. Treasurer Row */}
              <div className="d-flex justify-content-between align-items-center mb-3 p-2 border rounded">
                <div>
                  <strong>3. Treasurer Review</strong>
                </div>
                <div>
                  <StatusBadge
                    status={selectedStudent.approvals.treasurer.status}
                  />
                </div>

                {currentUser?.role === "treasurer" &&
                  selectedStudent.approvals.treasurer.status === "Pending" && (
                    <div>
                      <Button
                        size="sm"
                        variant="success"
                        className="me-2"
                        onClick={() => handleApprove("Approved")}
                      >
                        Approve
                      </Button>
                      <Button
                        size="sm"
                        variant="danger"
                        onClick={() => handleApprove("Rejected")}
                      >
                        Reject
                      </Button>
                    </div>
                  )}
              </div>

              {/* Final Status */}
              <div className="mt-4 text-center">
                {selectedStudent.admissionStatus === "Active" ? (
                  <Alert variant="success">
                    <strong> Admission Confirmed!</strong> Student is now
                    active.
                  </Alert>
                ) : (
                  <Alert variant="warning">Admission In Progress</Alert>
                )}
              </div>
            </>
          )}
        </Modal.Body>
      </Modal>

      {/* --- ADD STUDENT MODAL --- */}
      <Modal
        show={showAddModal}
        onHide={() => setShowAddModal(false)}
        size="lg"
      >
        <Modal.Header closeButton>
          <Modal.Title>New Student Application</Modal.Title>
        </Modal.Header>
        <Modal.Body>
          <Form onSubmit={handleSubmit}>
            <Row>
              <Col md={6} className="mb-3">
                <Form.Label>First Name</Form.Label>
                <Form.Control
                  name="firstName"
                  onChange={handleChange}
                  required
                />
              </Col>
              <Col md={6} className="mb-3">
                <Form.Label>Last Name</Form.Label>
                <Form.Control
                  name="lastName"
                  onChange={handleChange}
                  required
                />
              </Col>
              <Col md={6} className="mb-3">
                <Form.Label>Date of Birth</Form.Label>
                <Form.Control
                  type="date"
                  name="dob"
                  onChange={handleChange}
                  required
                />
              </Col>
              <Col md={6} className="mb-3">
                <Form.Label>Guardian Name</Form.Label>
                <Form.Control
                  name="guardianName"
                  onChange={handleChange}
                  required
                />
              </Col>
              <Col md={6} className="mb-3">
                <Form.Label>Contact Number</Form.Label>
                <Form.Control
                  name="contactNumber"
                  onChange={handleChange}
                  required
                />
              </Col>
              <Col md={12} className="mb-3">
                <Form.Label>Address</Form.Label>
                <Form.Control
                  as="textarea"
                  name="address"
                  onChange={handleChange}
                  required
                />
              </Col>
            </Row>
            <Button type="submit" className="w-100 btn-ashram">
              Submit Application
            </Button>
          </Form>
        </Modal.Body>
      </Modal>
    </div>
  );
};

export default StudentList;


--- FILE: client/src/pages/admin/StudentProfile.jsx ---
/* eslint-disable no-unused-vars */
// /* eslint-disable no-unused-vars */
// import React, { useEffect, useState } from "react";
// import { useParams, Link } from "react-router-dom";
// import {
//   Row,
//   Col,
//   Card,
//   Tabs,
//   Tab,
//   Table,
//   Button,
//   Form,
//   Badge,
//   Spinner,
//   Modal,
//   Alert,
// } from "react-bootstrap";
// import {
//   FaArrowLeft,
//   FaUserGraduate,
//   FaHeartbeat,
//   FaBook,
//   FaRupeeSign,
//   FaPlus,
//   FaHandHoldingHeart,
//   FaEdit,
//   FaSave,
// } from "react-icons/fa";
// import axios from "axios";

// const StudentProfile = () => {
//   const { id } = useParams();
//   const [student, setStudent] = useState(null);
//   const [loading, setLoading] = useState(true);

//   // Edit Mode State
//   const [isEditing, setIsEditing] = useState(false);
//   const [editData, setEditData] = useState({});

//   // Sub-data States
//   const [newEdu, setNewEdu] = useState({
//     year: "",
//     class: "",
//     school: "",
//     percentage: "",
//   });
//   const [newHealth, setNewHealth] = useState({
//     checkupType: "",
//     doctorName: "",
//     observation: "",
//   });
//   const [newExpense, setNewExpense] = useState({ description: "", amount: "" });

//   // Sponsor States
//   const [showSponsorModal, setShowSponsorModal] = useState(false);
//   const [donors, setDonors] = useState([]);
//   const [selectedSponsorId, setSelectedSponsorId] = useState("");

//   useEffect(() => {
//     fetchStudent();
//     // eslint-disable-next-line react-hooks/exhaustive-deps
//   }, [id]);

//   const fetchStudent = async () => {
//     try {
//       const userInfo = JSON.parse(localStorage.getItem("userInfo"));
//       const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };
//       const { data } = await axios.get(
//         `http://localhost:5000/api/students/${id}`,
//         config
//       );
//       setStudent(data);
//       setEditData(data);
//       setLoading(false);
//     } catch (error) {
//       console.error(error);
//       setLoading(false);
//     }
//   };

//   const saveProfileChanges = async () => {
//     try {
//       const userInfo = JSON.parse(localStorage.getItem("userInfo"));
//       const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };

//       await axios.put(
//         `http://localhost:5000/api/students/${id}`,
//         {
//           firstName: editData.firstName,
//           lastName: editData.lastName,
//           guardianName: editData.guardianName,
//           contactNumber: editData.contactNumber,
//           address: editData.address,
//           dob: editData.dob,
//         },
//         config
//       );

//       setIsEditing(false);
//       fetchStudent();
//       alert("Profile Updated Successfully!");
//     } catch (error) {
//       alert("Error updating profile");
//     }
//   };

//   const handleUpdate = async (updateData) => {
//     try {
//       const userInfo = JSON.parse(localStorage.getItem("userInfo"));
//       const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };
//       await axios.put(
//         `http://localhost:5000/api/students/${id}`,
//         updateData,
//         config
//       );
//       fetchStudent();
//     } catch (error) {
//       alert("Error updating student");
//     }
//   };

//   // --- Helper Functions ---
//   const addEducation = () => {
//     if (!newEdu.year || !newEdu.school) return alert("Please fill details");
//     const updatedHistory = [...student.educationHistory, newEdu];
//     handleUpdate({ educationHistory: updatedHistory });
//     setNewEdu({ year: "", class: "", school: "", percentage: "" });
//   };

//   const addHealth = () => {
//     if (!newHealth.checkupType) return alert("Please fill details");
//     const updatedHealth = [...student.healthRecords, newHealth];
//     handleUpdate({ healthRecords: updatedHealth });
//     setNewHealth({ checkupType: "", doctorName: "", observation: "" });
//   };

//   const addExpense = () => {
//     if (!newExpense.description || !newExpense.amount)
//       return alert("Please enter description and amount");
//     handleUpdate({
//       newExpense: {
//         description: newExpense.description,
//         amount: Number(newExpense.amount),
//         date: new Date(),
//       },
//     });
//     setNewExpense({ description: "", amount: "" });
//   };

//   const openSponsorModal = async () => {
//     setShowSponsorModal(true);
//     try {
//       const userInfo = JSON.parse(localStorage.getItem("userInfo"));
//       const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };
//       const { data } = await axios.get(
//         "http://localhost:5000/api/donations",
//         config
//       );
//       setDonors(data);
//     } catch (err) {
//       alert("Failed to load donor list");
//     }
//   };

//   const mapSponsor = async () => {
//     if (!selectedSponsorId) return alert("Select a sponsor");
//     await handleUpdate({ sponsor: selectedSponsorId });
//     setShowSponsorModal(false);
//     alert("Sponsor Mapped Successfully!");
//   };

//   if (loading)
//     return (
//       <div className="text-center py-5">
//         <Spinner animation="border" />
//       </div>
//     );

//   return (
//     <div>
//       {/* Header */}
//       <div className="d-flex align-items-center gap-3 mb-4">
//         <Link
//           to="/dashboard/students"
//           className="btn btn-outline-secondary btn-sm"
//         >
//           <FaArrowLeft />
//         </Link>
//         <div>
//           <h2
//             className="text-maroon m-0"
//             style={{ fontFamily: "Playfair Display" }}
//           >
//             {student.firstName} {student.lastName}
//           </h2>
//           <span className="text-muted">
//             ID: {student._id.slice(-6).toUpperCase()}
//           </span>
//         </div>
//         <div className="ms-auto d-flex gap-2">
//           {/* Edit Toggle Button Only - Print Removed */}
//           {isEditing ? (
//             <Button variant="success" onClick={saveProfileChanges}>
//               <FaSave /> Save Changes
//             </Button>
//           ) : (
//             <Button
//               variant="primary"
//               style={{ backgroundColor: "#581818" }}
//               onClick={() => setIsEditing(true)}
//             >
//               <FaEdit /> Edit Details
//             </Button>
//           )}
//         </div>
//       </div>

//       <Row>
//         {/* Left Sidebar: Basic Info (Editable) */}
//         <Col md={4}>
//           <Card className="shadow-sm border-0 mb-4">
//             <Card.Body>
//               <div className="text-center mb-3">
//                 <div
//                   className="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3"
//                   style={{ width: "100px", height: "100px" }}
//                 >
//                   <FaUserGraduate size={50} className="text-secondary" />
//                 </div>
//               </div>

//               {isEditing ? (
//                 <Form>
//                   <Row className="mb-2">
//                     <Col>
//                       <Form.Control
//                         size="sm"
//                         value={editData.firstName}
//                         onChange={(e) =>
//                           setEditData({
//                             ...editData,
//                             firstName: e.target.value,
//                           })
//                         }
//                         placeholder="First Name"
//                       />
//                     </Col>
//                     <Col>
//                       <Form.Control
//                         size="sm"
//                         value={editData.lastName}
//                         onChange={(e) =>
//                           setEditData({ ...editData, lastName: e.target.value })
//                         }
//                         placeholder="Last Name"
//                       />
//                     </Col>
//                   </Row>
//                   <Form.Control
//                     size="sm"
//                     type="date"
//                     className="mb-2"
//                     value={editData.dob ? editData.dob.split("T")[0] : ""}
//                     onChange={(e) =>
//                       setEditData({ ...editData, dob: e.target.value })
//                     }
//                   />
//                   <Form.Control
//                     size="sm"
//                     className="mb-2"
//                     value={editData.guardianName}
//                     onChange={(e) =>
//                       setEditData({ ...editData, guardianName: e.target.value })
//                     }
//                     placeholder="Guardian"
//                   />
//                   <Form.Control
//                     size="sm"
//                     className="mb-2"
//                     value={editData.contactNumber}
//                     onChange={(e) =>
//                       setEditData({
//                         ...editData,
//                         contactNumber: e.target.value,
//                       })
//                     }
//                     placeholder="Contact"
//                   />
//                   <Form.Control
//                     size="sm"
//                     as="textarea"
//                     value={editData.address}
//                     onChange={(e) =>
//                       setEditData({ ...editData, address: e.target.value })
//                     }
//                     placeholder="Address"
//                   />
//                 </Form>
//               ) : (
//                 <div className="text-center">
//                   <h5>
//                     {student.firstName} {student.lastName}
//                   </h5>
//                   <p className="text-muted small">
//                     {student.gender} |{" "}
//                     {new Date(student.dob).toLocaleDateString()}
//                   </p>
//                   <hr />
//                   <div className="text-start">
//                     <p>
//                       <strong>Guardian:</strong> {student.guardianName}
//                     </p>
//                     <p>
//                       <strong>Contact:</strong> {student.contactNumber}
//                     </p>
//                     <p>
//                       <strong>Address:</strong> {student.address}
//                     </p>
//                   </div>
//                 </div>
//               )}
//             </Card.Body>
//           </Card>

//           {/* Sponsor Card */}
//           <Card className="shadow-sm border-0 bg-light">
//             <Card.Body>
//               <h6 className="text-maroon fw-bold">
//                 <FaHandHoldingHeart /> Sponsor Details
//               </h6>
//               {student.sponsor ? (
//                 <div className="mt-3">
//                   <p className="text-success fw-bold mb-1">Sponsored</p>
//                   <small className="text-muted">
//                     Sponsor ID: {student.sponsor.slice(-6)}
//                   </small>
//                   <div className="mt-2">
//                     <Button
//                       size="sm"
//                       variant="outline-danger"
//                       onClick={() => handleUpdate({ sponsor: null })}
//                     >
//                       Remove Mapping
//                     </Button>
//                   </div>
//                 </div>
//               ) : (
//                 <div className="text-center mt-3">
//                   <small className="text-muted d-block mb-2">
//                     No sponsor mapped yet.
//                   </small>
//                   <Button
//                     size="sm"
//                     variant="outline-primary"
//                     onClick={openSponsorModal}
//                   >
//                     Map Sponsor
//                   </Button>
//                 </div>
//               )}
//             </Card.Body>
//           </Card>
//         </Col>

//         {/* Right Content: Tabs */}
//         <Col md={8}>
//           <Card className="shadow-sm border-0">
//             <Card.Body>
//               <Tabs defaultActiveKey="education" className="mb-3">
//                 <Tab
//                   eventKey="education"
//                   title={
//                     <span>
//                       <FaBook /> Education
//                     </span>
//                   }
//                 >
//                   <Table striped bordered hover size="sm">
//                     <thead>
//                       <tr>
//                         <th>Year</th>
//                         <th>Class</th>
//                         <th>School</th>
//                         <th>%</th>
//                       </tr>
//                     </thead>
//                     <tbody>
//                       {student.educationHistory.map((edu, idx) => (
//                         <tr key={idx}>
//                           <td>{edu.year}</td>
//                           <td>{edu.class}</td>
//                           <td>{edu.school}</td>
//                           <td>{edu.percentage}</td>
//                         </tr>
//                       ))}
//                     </tbody>
//                   </Table>
//                   <div className="p-3 bg-light rounded">
//                     <h6>Add Academic Record</h6>
//                     <Row className="g-2">
//                       <Col md={3}>
//                         <Form.Control
//                           placeholder="Year"
//                           value={newEdu.year}
//                           onChange={(e) =>
//                             setNewEdu({ ...newEdu, year: e.target.value })
//                           }
//                         />
//                       </Col>
//                       <Col md={3}>
//                         <Form.Control
//                           placeholder="Class"
//                           value={newEdu.class}
//                           onChange={(e) =>
//                             setNewEdu({ ...newEdu, class: e.target.value })
//                           }
//                         />
//                       </Col>
//                       <Col md={4}>
//                         <Form.Control
//                           placeholder="School"
//                           value={newEdu.school}
//                           onChange={(e) =>
//                             setNewEdu({ ...newEdu, school: e.target.value })
//                           }
//                         />
//                       </Col>
//                       <Col md={2}>
//                         <Button size="sm" onClick={addEducation}>
//                           <FaPlus />
//                         </Button>
//                       </Col>
//                     </Row>
//                   </div>
//                 </Tab>
//                 <Tab
//                   eventKey="health"
//                   title={
//                     <span>
//                       <FaHeartbeat /> Health
//                     </span>
//                   }
//                 >
//                   <Table striped bordered hover size="sm">
//                     <thead>
//                       <tr>
//                         <th>Date</th>
//                         <th>Type</th>
//                         <th>Doctor</th>
//                         <th>Observation</th>
//                       </tr>
//                     </thead>
//                     <tbody>
//                       {student.healthRecords.map((h, idx) => (
//                         <tr key={idx}>
//                           <td>{new Date(h.date).toLocaleDateString()}</td>
//                           <td>{h.checkupType}</td>
//                           <td>{h.doctorName}</td>
//                           <td>{h.observation}</td>
//                         </tr>
//                       ))}
//                     </tbody>
//                   </Table>
//                   <div className="p-3 bg-light rounded">
//                     <h6>Add Health Checkup</h6>
//                     <Row className="g-2">
//                       <Col md={4}>
//                         <Form.Control
//                           placeholder="Type"
//                           value={newHealth.checkupType}
//                           onChange={(e) =>
//                             setNewHealth({
//                               ...newHealth,
//                               checkupType: e.target.value,
//                             })
//                           }
//                         />
//                       </Col>
//                       <Col md={4}>
//                         <Form.Control
//                           placeholder="Doctor"
//                           value={newHealth.doctorName}
//                           onChange={(e) =>
//                             setNewHealth({
//                               ...newHealth,
//                               doctorName: e.target.value,
//                             })
//                           }
//                         />
//                       </Col>
//                       <Col md={4}>
//                         <Form.Control
//                           placeholder="Observation"
//                           value={newHealth.observation}
//                           onChange={(e) =>
//                             setNewHealth({
//                               ...newHealth,
//                               observation: e.target.value,
//                             })
//                           }
//                         />
//                       </Col>
//                       <Col md={12} className="text-end mt-2">
//                         <Button size="sm" onClick={addHealth}>
//                           Add Record
//                         </Button>
//                       </Col>
//                     </Row>
//                   </div>
//                 </Tab>
//                 <Tab
//                   eventKey="expenses"
//                   title={
//                     <span>
//                       <FaRupeeSign /> Expenses
//                     </span>
//                   }
//                 >
//                   <Table striped bordered hover size="sm">
//                     <thead>
//                       <tr>
//                         <th>Date</th>
//                         <th>Description</th>
//                         <th className="text-end">Amount</th>
//                       </tr>
//                     </thead>
//                     <tbody>
//                       {student.expenses.map((exp, idx) => (
//                         <tr key={idx}>
//                           <td>{new Date(exp.date).toLocaleDateString()}</td>
//                           <td>{exp.description}</td>
//                           <td className="text-end fw-bold">{exp.amount}</td>
//                         </tr>
//                       ))}
//                       {student.expenses.length === 0 && (
//                         <tr>
//                           <td colSpan="3" className="text-center text-muted">
//                             No specific expenses recorded.
//                           </td>
//                         </tr>
//                       )}
//                     </tbody>
//                   </Table>
//                   <div className="p-3 bg-light rounded mt-3">
//                     <h6 className="text-maroon">Record New Expense</h6>
//                     <Row className="g-2">
//                       <Col md={7}>
//                         <Form.Control
//                           placeholder="Description"
//                           value={newExpense.description}
//                           onChange={(e) =>
//                             setNewExpense({
//                               ...newExpense,
//                               description: e.target.value,
//                             })
//                           }
//                         />
//                       </Col>
//                       <Col md={3}>
//                         <Form.Control
//                           type="number"
//                           placeholder="Amount ()"
//                           value={newExpense.amount}
//                           onChange={(e) =>
//                             setNewExpense({
//                               ...newExpense,
//                               amount: e.target.value,
//                             })
//                           }
//                         />
//                       </Col>
//                       <Col md={2}>
//                         <Button
//                           variant="danger"
//                           className="w-100"
//                           onClick={addExpense}
//                         >
//                           Add
//                         </Button>
//                       </Col>
//                     </Row>
//                   </div>
//                 </Tab>
//               </Tabs>
//             </Card.Body>
//           </Card>
//         </Col>
//       </Row>

//       {/* Sponsor Modal */}
//       <Modal show={showSponsorModal} onHide={() => setShowSponsorModal(false)}>
//         <Modal.Header closeButton>
//           <Modal.Title>Map a Sponsor</Modal.Title>
//         </Modal.Header>
//         <Modal.Body>
//           <p className="text-muted">
//             Select a donor from the list below to assign as a sponsor for{" "}
//             <strong>{student.firstName}</strong>.
//           </p>
//           <Form.Group className="mb-3">
//             <Form.Label>Select Donor</Form.Label>
//             <Form.Select onChange={(e) => setSelectedSponsorId(e.target.value)}>
//               <option value="">-- Choose Donor --</option>
//               {donors.map((d) => (
//                 <option key={d._id} value={d._id}>
//                   {d.donorName} - {d.amount} ({d.scheme})
//                 </option>
//               ))}
//             </Form.Select>
//           </Form.Group>
//           <Button variant="primary" className="w-100" onClick={mapSponsor}>
//             Confirm Mapping
//           </Button>
//         </Modal.Body>
//       </Modal>
//     </div>
//   );
// };

// export default StudentProfile;
import React, { useEffect, useState } from "react";
import { useParams, Link } from "react-router-dom";
import {
  Row,
  Col,
  Card,
  Tabs,
  Tab,
  Table,
  Button,
  Form,
  Badge,
  Spinner,
  Modal,
  Alert,
} from "react-bootstrap";
import {
  FaArrowLeft,
  FaUserGraduate,
  FaHeartbeat,
  FaBook,
  FaRupeeSign,
  FaPlus,
  FaHandHoldingHeart,
  FaEdit,
  FaSave,
  FaBriefcase,
  FaMapMarkerAlt,
  FaEnvelope,
  FaTrash,
  FaPhone,
  FaFileAlt,
  FaCloudUploadAlt,
  FaSuitcase,
} from "react-icons/fa";
import axios from "axios";

const StudentProfile = () => {
  const { id } = useParams();
  const [student, setStudent] = useState(null);
  const [loading, setLoading] = useState(true);

  // Edit Mode State (For Basic Info)
  const [isEditing, setIsEditing] = useState(false);
  const [editData, setEditData] = useState({});

  // Sub-data States
  const [newEdu, setNewEdu] = useState({
    year: "",
    class: "",
    school: "",
    percentage: "",
  });
  const [newHealth, setNewHealth] = useState({
    checkupType: "",
    doctorName: "",
    observation: "",
  });
  const [newExpense, setNewExpense] = useState({ description: "", amount: "" });

  // Sponsor States
  const [showSponsorModal, setShowSponsorModal] = useState(false);
  const [donors, setDonors] = useState([]);
  const [selectedSponsorId, setSelectedSponsorId] = useState("");

  // --- ALUMNI STATES ---
  const [showAlumniModal, setShowAlumniModal] = useState(false);
  const [alumniData, setAlumniData] = useState({
    jobTitle: "",
    company: "",
    currentLocation: "",
    email: "",
    phone: "",
  });

  // --- DOCUMENT STATES ---
  const [files, setFiles] = useState([]);
  const [uploading, setUploading] = useState(false);
  const [newLeave, setNewLeave] = useState({
    startDate: "",
    endDate: "",
    reason: "",
  });

  useEffect(() => {
    fetchStudent();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [id]);

  const fetchStudent = async () => {
    try {
      const userInfo = JSON.parse(localStorage.getItem("userInfo"));
      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };
      const { data } = await axios.get(
        `http://localhost:5000/api/students/${id}`,
        config
      );
      setStudent(data);
      setEditData(data);
      setLoading(false);
    } catch (error) {
      console.error(error);
      setLoading(false);
    }
  };

  // --- DOCUMENT HANDLERS ---
  const handleFileChange = (e) => {
    setFiles(e.target.files);
  };

  const handleUpload = async (e) => {
    e.preventDefault();
    if (files.length === 0) return alert("Select files first");

    const formData = new FormData();
    for (let i = 0; i < files.length; i++) {
      formData.append("files", files[i]);
    }

    setUploading(true);
    try {
      const userInfo = JSON.parse(localStorage.getItem("userInfo"));
      const config = {
        headers: {
          "Content-Type": "multipart/form-data",
          Authorization: `Bearer ${userInfo.token}`,
        },
      };
      await axios.post(
        `http://localhost:5000/api/students/${id}/upload`,
        formData,
        config
      );
      alert("Documents Uploaded!");
      setFiles([]);
      fetchStudent();
    } catch (err) {
      alert("Upload failed");
    }
    setUploading(false);
  };

  // --- LEAVE HANDLERS ---
  const addLeave = async () => {
    if (!newLeave.startDate || !newLeave.reason)
      return alert("Please fill Start Date and Reason");

    try {
      const userInfo = JSON.parse(localStorage.getItem("userInfo"));
      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };
      await axios.post(
        `http://localhost:5000/api/students/${id}/leave`,
        newLeave,
        config
      );

      alert("Leave Recorded");
      setNewLeave({ startDate: "", endDate: "", reason: "" });
      fetchStudent();
    } catch (err) {
      alert("Error recording leave");
    }
  };

  const markReturned = async (leaveId) => {
    if (!window.confirm("Confirm student has returned to Ashram?")) return;
    try {
      const userInfo = JSON.parse(localStorage.getItem("userInfo"));
      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };
      await axios.put(
        `http://localhost:5000/api/students/${id}/leave/${leaveId}`,
        {},
        config
      );

      alert("Student Marked as Returned");
      fetchStudent();
    } catch (err) {
      alert("Error updating status");
    }
  };

  const handleDeleteDoc = async (filePath) => {
    if (!window.confirm("Delete this document?")) return;
    try {
      const userInfo = JSON.parse(localStorage.getItem("userInfo"));
      const config = {
        headers: { Authorization: `Bearer ${userInfo.token}` },
        data: { filePath },
      };
      await axios.delete(
        `http://localhost:5000/api/students/${id}/documents`,
        config
      );
      fetchStudent();
    } catch (err) {
      alert("Delete failed");
    }
  };

  const saveProfileChanges = async () => {
    try {
      const userInfo = JSON.parse(localStorage.getItem("userInfo"));
      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };

      await axios.put(
        `http://localhost:5000/api/students/${id}`,
        {
          firstName: editData.firstName,
          lastName: editData.lastName,
          guardianName: editData.guardianName,
          contactNumber: editData.contactNumber,
          address: editData.address,
          dob: editData.dob,
        },
        config
      );

      setIsEditing(false);
      fetchStudent();
      alert("Profile Updated Successfully!");
    } catch (error) {
      alert("Error updating profile");
    }
  };

  const handleUpdate = async (updateData) => {
    try {
      const userInfo = JSON.parse(localStorage.getItem("userInfo"));
      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };
      await axios.put(
        `http://localhost:5000/api/students/${id}`,
        updateData,
        config
      );
      fetchStudent();
    } catch (error) {
      alert("Error updating student");
    }
  };

  // --- ALUMNI HANDLERS ---

  // 1. Convert / Save Alumni
  const handleConvertToAlumni = async () => {
    if (!alumniData.currentLocation || !alumniData.phone)
      return alert("Please fill current location and contact");

    await handleUpdate({
      admissionStatus: "Alumni",
      alumniDetails: alumniData,
    });

    setShowAlumniModal(false);
    alert("Student successfully converted to Alumni!");
  };

  // 2. Edit Alumni (Open Modal with Data)
  const handleEditAlumni = () => {
    setAlumniData(student.alumniDetails);
    setShowAlumniModal(true);
  };

  // 3. Delete Alumni (Revert to Active)
  const handleDeleteAlumni = async () => {
    if (
      !window.confirm(
        "Are you sure? This will revert the student status back to 'Active'."
      )
    )
      return;

    await handleUpdate({
      admissionStatus: "Active",
      alumniDetails: {
        jobTitle: "",
        company: "",
        currentLocation: "",
        email: "",
        phone: "",
      }, // Clear data
    });
    alert("Reverted to Active Student.");
  };

  // --- Helper Functions ---
  const addEducation = () => {
    if (!newEdu.year || !newEdu.school) return alert("Please fill details");
    const updatedHistory = [...student.educationHistory, newEdu];
    handleUpdate({ educationHistory: updatedHistory });
    setNewEdu({ year: "", class: "", school: "", percentage: "" });
  };

  const addHealth = () => {
    if (!newHealth.checkupType) return alert("Please fill details");
    const updatedHealth = [...student.healthRecords, newHealth];
    handleUpdate({ healthRecords: updatedHealth });
    setNewHealth({ checkupType: "", doctorName: "", observation: "" });
  };

  const addExpense = () => {
    if (!newExpense.description || !newExpense.amount)
      return alert("Please enter description and amount");
    handleUpdate({
      newExpense: {
        description: newExpense.description,
        amount: Number(newExpense.amount),
        date: new Date(),
      },
    });
    setNewExpense({ description: "", amount: "" });
  };

  const openSponsorModal = async () => {
    setShowSponsorModal(true);
    try {
      const userInfo = JSON.parse(localStorage.getItem("userInfo"));
      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };
      const { data } = await axios.get(
        "http://localhost:5000/api/donations",
        config
      );
      setDonors(data);
    } catch (err) {
      alert("Failed to load donor list");
    }
  };

  const mapSponsor = async () => {
    if (!selectedSponsorId) return alert("Select a sponsor");
    await handleUpdate({ sponsor: selectedSponsorId });
    setShowSponsorModal(false);
    alert("Sponsor Mapped Successfully!");
  };

  if (loading)
    return (
      <div className="text-center py-5">
        <Spinner animation="border" />
      </div>
    );
  const currentLeave = student.leaves?.find((l) => l.status === "On Leave");

  return (
    <div>
      {/* Header */}
      <div className="d-flex align-items-center gap-3 mb-4">
        <Link
          to="/dashboard/students"
          className="btn btn-outline-secondary btn-sm"
        >
          <FaArrowLeft />
        </Link>
        <div>
          <h2
            className="text-maroon m-0"
            style={{ fontFamily: "Playfair Display" }}
          >
            {student.firstName} {student.lastName}
          </h2>
          <span className="text-muted">
            ID: {student._id.slice(-6).toUpperCase()}
          </span>
        </div>
        <div className="ms-auto d-flex gap-2">
          {currentLeave && (
            <Badge bg="warning" text="dark" className="align-self-center me-2">
              ON LEAVE
            </Badge>
          )}
          {/* ALUMNI BUTTON: Only show if Active */}
          {student.admissionStatus === "Active" && (
            <Button
              variant="outline-primary"
              onClick={() => {
                setAlumniData({
                  jobTitle: "",
                  company: "",
                  currentLocation: "",
                  email: "",
                  phone: "",
                }); // Clear form
                setShowAlumniModal(true);
              }}
            >
              <FaUserGraduate /> Mark as Alumni
            </Button>
          )}

          {isEditing ? (
            <Button variant="success" onClick={saveProfileChanges}>
              <FaSave /> Save Changes
            </Button>
          ) : (
            <Button
              variant="primary"
              style={{ backgroundColor: "#581818" }}
              onClick={() => setIsEditing(true)}
            >
              <FaEdit /> Edit Details
            </Button>
          )}
        </div>
      </div>

      <Row>
        {/* Left Sidebar */}
        <Col md={4}>
          <Card className="shadow-sm border-0 mb-4">
            <Card.Body>
              <div className="text-center mb-3">
                <div
                  className="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3"
                  style={{ width: "100px", height: "100px" }}
                >
                  <FaUserGraduate size={50} className="text-secondary" />
                </div>
                <div className="mb-2">
                  <Badge
                    bg={
                      student.admissionStatus === "Alumni"
                        ? "info"
                        : student.admissionStatus === "Active"
                        ? "success"
                        : "warning"
                    }
                  >
                    {student.admissionStatus}
                  </Badge>
                </div>
              </div>

              {isEditing ? (
                <Form>
                  <Row className="mb-2">
                    <Col>
                      <Form.Control
                        size="sm"
                        value={editData.firstName}
                        onChange={(e) =>
                          setEditData({
                            ...editData,
                            firstName: e.target.value,
                          })
                        }
                        placeholder="First Name"
                      />
                    </Col>
                    <Col>
                      <Form.Control
                        size="sm"
                        value={editData.lastName}
                        onChange={(e) =>
                          setEditData({ ...editData, lastName: e.target.value })
                        }
                        placeholder="Last Name"
                      />
                    </Col>
                  </Row>
                  <Form.Control
                    size="sm"
                    type="date"
                    className="mb-2"
                    value={editData.dob ? editData.dob.split("T")[0] : ""}
                    onChange={(e) =>
                      setEditData({ ...editData, dob: e.target.value })
                    }
                  />
                  <Form.Control
                    size="sm"
                    className="mb-2"
                    value={editData.guardianName}
                    onChange={(e) =>
                      setEditData({ ...editData, guardianName: e.target.value })
                    }
                    placeholder="Guardian"
                  />
                  <Form.Control
                    size="sm"
                    className="mb-2"
                    value={editData.contactNumber}
                    onChange={(e) =>
                      setEditData({
                        ...editData,
                        contactNumber: e.target.value,
                      })
                    }
                    placeholder="Contact"
                  />
                  <Form.Control
                    size="sm"
                    as="textarea"
                    value={editData.address}
                    onChange={(e) =>
                      setEditData({ ...editData, address: e.target.value })
                    }
                    placeholder="Address"
                  />
                </Form>
              ) : (
                <div className="text-center">
                  <h5>
                    {student.firstName} {student.lastName}
                  </h5>
                  <p className="text-muted small">
                    {student.gender} |{" "}
                    {new Date(student.dob).toLocaleDateString()}
                  </p>
                  <hr />
                  <div className="text-start">
                    <p>
                      <strong>Guardian:</strong> {student.guardianName}
                    </p>
                    <p>
                      <strong>Contact:</strong> {student.contactNumber}
                    </p>
                    <p>
                      <strong>Address:</strong> {student.address}
                    </p>
                  </div>
                </div>
              )}
            </Card.Body>
          </Card>

          {/* --- ALUMNI DETAILS CARD (Visible only if Alumni) --- */}
          {student.admissionStatus === "Alumni" && student.alumniDetails && (
            <Card
              className="shadow-sm border-0 mb-4"
              style={{ borderLeft: "5px solid #0dcaf0" }}
            >
              <Card.Body>
                <div className="d-flex justify-content-between align-items-center mb-3">
                  <h6 className="text-info fw-bold m-0">Alumni Information</h6>
                  <div>
                    <Button
                      size="sm"
                      variant="link"
                      className="p-0 me-2"
                      onClick={handleEditAlumni}
                    >
                      <FaEdit />
                    </Button>
                    <Button
                      size="sm"
                      variant="link"
                      className="p-0 text-danger"
                      onClick={handleDeleteAlumni}
                    >
                      <FaTrash />
                    </Button>
                  </div>
                </div>

                <p className="mb-1">
                  <FaBriefcase className="me-2 text-muted" />{" "}
                  {student.alumniDetails.jobTitle || "Not working"}
                </p>
                <p className="mb-1">
                  <strong>@</strong> {student.alumniDetails.company || "N/A"}
                </p>
                <p className="mb-1">
                  <FaMapMarkerAlt className="me-2 text-muted" />{" "}
                  {student.alumniDetails.currentLocation}
                </p>
                <hr />
                <p className="mb-1">
                  <FaEnvelope className="me-2 text-muted" />{" "}
                  {student.alumniDetails.email || "No Email"}
                </p>
                <p className="mb-0">
                  <FaPhone className="me-2 text-muted" />{" "}
                  {student.alumniDetails.phone}
                </p>
              </Card.Body>
            </Card>
          )}

          {/* Sponsor Card */}
          {/* Sponsor Card */}
          <Card className="shadow-sm border-0 bg-light">
            <Card.Body>
              <h6 className="text-maroon fw-bold">
                <FaHandHoldingHeart /> Sponsor Details
              </h6>

              {student.sponsor ? (
                <div className="mt-3">
                  <p className="text-success fw-bold mb-1">Sponsored</p>

                  {/* --- FIX: Handle Object vs String --- */}
                  <div className="text-muted small mb-3">
                    {typeof student.sponsor === "object" ? (
                      <>
                        <strong>Name:</strong> {student.sponsor.donorName}
                        <br />
                        <strong>ID:</strong>{" "}
                        {student.sponsor._id.toString().slice(-6).toUpperCase()}
                      </>
                    ) : (
                      <>
                        <strong>ID:</strong>{" "}
                        {student.sponsor.toString().slice(-6).toUpperCase()}
                      </>
                    )}
                  </div>
                  {/* ----------------------------------- */}

                  {/* Email Report Button */}
                  <Button
                    size="sm"
                    variant="primary"
                    className="w-100 mb-2"
                    onClick={async () => {
                      if (
                        !confirm(
                          "Send Progress Report PDF to Sponsor via Email?"
                        )
                      )
                        return;
                      try {
                        const userInfo = JSON.parse(
                          localStorage.getItem("userInfo")
                        );
                        const config = {
                          headers: {
                            Authorization: `Bearer ${userInfo.token}`,
                          },
                        };
                        await axios.post(
                          `http://localhost:5000/api/students/${id}/email-sponsor`,
                          {},
                          config
                        );
                        alert("Report Sent Successfully!");
                      } catch (err) {
                        alert(
                          err.response?.data?.message || "Error sending report"
                        );
                      }
                    }}
                  >
                    <FaEnvelope className="me-2" /> Email Progress Report
                  </Button>

                  <div className="mt-2">
                    <Button
                      size="sm"
                      variant="outline-danger"
                      onClick={() => handleUpdate({ sponsor: null })}
                    >
                      Remove Mapping
                    </Button>
                  </div>
                </div>
              ) : (
                <div className="text-center mt-3">
                  <small className="text-muted d-block mb-2">
                    No sponsor mapped yet.
                  </small>
                  <Button
                    size="sm"
                    variant="outline-primary"
                    onClick={openSponsorModal}
                  >
                    Map Sponsor
                  </Button>
                </div>
              )}
            </Card.Body>
          </Card>
        </Col>

        {/* Right Content: Tabs */}
        <Col md={8}>
          <Card className="shadow-sm border-0">
            <Card.Body>
              <Tabs defaultActiveKey="education" className="mb-3">
                <Tab
                  eventKey="education"
                  title={
                    <span>
                      <FaBook /> Education
                    </span>
                  }
                >
                  <Table striped bordered hover size="sm">
                    <thead>
                      <tr>
                        <th>Year</th>
                        <th>Class</th>
                        <th>School</th>
                        <th>%</th>
                      </tr>
                    </thead>
                    <tbody>
                      {student.educationHistory.map((edu, idx) => (
                        <tr key={idx}>
                          <td>{edu.year}</td>
                          <td>{edu.class}</td>
                          <td>{edu.school}</td>
                          <td>{edu.percentage}</td>
                        </tr>
                      ))}
                    </tbody>
                  </Table>
                  <div className="p-3 bg-light rounded">
                    <h6>Add Academic Record</h6>
                    <Row className="g-2">
                      <Col md={3}>
                        <Form.Control
                          placeholder="Year"
                          value={newEdu.year}
                          onChange={(e) =>
                            setNewEdu({ ...newEdu, year: e.target.value })
                          }
                        />
                      </Col>
                      <Col md={3}>
                        <Form.Control
                          placeholder="Class"
                          value={newEdu.class}
                          onChange={(e) =>
                            setNewEdu({ ...newEdu, class: e.target.value })
                          }
                        />
                      </Col>
                      <Col md={4}>
                        <Form.Control
                          placeholder="School"
                          value={newEdu.school}
                          onChange={(e) =>
                            setNewEdu({ ...newEdu, school: e.target.value })
                          }
                        />
                      </Col>
                      <Col md={2}>
                        <Button size="sm" onClick={addEducation}>
                          <FaPlus />
                        </Button>
                      </Col>
                    </Row>
                  </div>
                </Tab>
                <Tab
                  eventKey="health"
                  title={
                    <span>
                      <FaHeartbeat /> Health
                    </span>
                  }
                >
                  <Table striped bordered hover size="sm">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Doctor</th>
                        <th>Observation</th>
                      </tr>
                    </thead>
                    <tbody>
                      {student.healthRecords.map((h, idx) => (
                        <tr key={idx}>
                          <td>{new Date(h.date).toLocaleDateString()}</td>
                          <td>{h.checkupType}</td>
                          <td>{h.doctorName}</td>
                          <td>{h.observation}</td>
                        </tr>
                      ))}
                    </tbody>
                  </Table>
                  <div className="p-3 bg-light rounded">
                    <h6>Add Health Checkup</h6>
                    <Row className="g-2">
                      <Col md={4}>
                        <Form.Control
                          placeholder="Type"
                          value={newHealth.checkupType}
                          onChange={(e) =>
                            setNewHealth({
                              ...newHealth,
                              checkupType: e.target.value,
                            })
                          }
                        />
                      </Col>
                      <Col md={4}>
                        <Form.Control
                          placeholder="Doctor"
                          value={newHealth.doctorName}
                          onChange={(e) =>
                            setNewHealth({
                              ...newHealth,
                              doctorName: e.target.value,
                            })
                          }
                        />
                      </Col>
                      <Col md={4}>
                        <Form.Control
                          placeholder="Observation"
                          value={newHealth.observation}
                          onChange={(e) =>
                            setNewHealth({
                              ...newHealth,
                              observation: e.target.value,
                            })
                          }
                        />
                      </Col>
                      <Col md={12} className="text-end mt-2">
                        <Button size="sm" onClick={addHealth}>
                          Add Record
                        </Button>
                      </Col>
                    </Row>
                  </div>
                </Tab>
                <Tab
                  eventKey="expenses"
                  title={
                    <span>
                      <FaRupeeSign /> Expenses
                    </span>
                  }
                >
                  <Table striped bordered hover size="sm">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th className="text-end">Amount</th>
                      </tr>
                    </thead>
                    <tbody>
                      {student.expenses.map((exp, idx) => (
                        <tr key={idx}>
                          <td>{new Date(exp.date).toLocaleDateString()}</td>
                          <td>{exp.description}</td>
                          <td className="text-end fw-bold">{exp.amount}</td>
                        </tr>
                      ))}
                      {student.expenses.length === 0 && (
                        <tr>
                          <td colSpan="3" className="text-center text-muted">
                            No specific expenses recorded.
                          </td>
                        </tr>
                      )}
                    </tbody>
                  </Table>
                  <div className="p-3 bg-light rounded mt-3">
                    <h6 className="text-maroon">Record New Expense</h6>
                    <Row className="g-2">
                      <Col md={7}>
                        <Form.Control
                          placeholder="Description"
                          value={newExpense.description}
                          onChange={(e) =>
                            setNewExpense({
                              ...newExpense,
                              description: e.target.value,
                            })
                          }
                        />
                      </Col>
                      <Col md={3}>
                        <Form.Control
                          type="number"
                          placeholder="Amount ()"
                          value={newExpense.amount}
                          onChange={(e) =>
                            setNewExpense({
                              ...newExpense,
                              amount: e.target.value,
                            })
                          }
                        />
                      </Col>
                      <Col md={2}>
                        <Button
                          variant="danger"
                          className="w-100"
                          onClick={addExpense}
                        >
                          Add
                        </Button>
                      </Col>
                    </Row>
                  </div>
                </Tab>
                {/* --- NEW DOCUMENTS TAB --- */}
                <Tab
                  eventKey="documents"
                  title={
                    <span>
                      <FaFileAlt /> Documents
                    </span>
                  }
                >
                  {/* Upload Section */}
                  <div className="p-3 bg-light rounded mb-4">
                    <h6 className="text-maroon">Upload Documents</h6>
                    <Form onSubmit={handleUpload} className="d-flex gap-2">
                      <Form.Control
                        type="file"
                        multiple
                        onChange={handleFileChange}
                      />
                      <Button
                        type="submit"
                        variant="primary"
                        disabled={uploading}
                      >
                        {uploading ? "Uploading..." : <FaCloudUploadAlt />}
                      </Button>
                    </Form>
                    <small className="text-muted">
                      Supported: Images, PDF, Word Docs
                    </small>
                  </div>

                  {/* Gallery Grid */}
                  <h6 className="mb-3">
                    Attached Files ({student.documents?.length || 0})
                  </h6>
                  <Row>
                    {student.documents &&
                      student.documents.map((path, index) => (
                        <Col md={4} key={index} className="mb-3">
                          <div className="border rounded p-2 position-relative bg-white text-center">
                            <Button
                              variant="danger"
                              size="sm"
                              className="position-absolute top-0 end-0 m-1"
                              style={{ zIndex: 10 }}
                              onClick={() => handleDeleteDoc(path)}
                            >
                              <FaTrash size={10} />
                            </Button>

                            {path.match(/\.(jpeg|jpg|png|gif)$/i) ? (
                              <img
                                src={`http://localhost:5000${path}`}
                                alt="Doc"
                                style={{
                                  width: "100%",
                                  height: "100px",
                                  objectFit: "cover",
                                  cursor: "pointer",
                                }}
                                onClick={() =>
                                  window.open(
                                    `http://localhost:5000${path}`,
                                    "_blank"
                                  )
                                }
                              />
                            ) : (
                              <div className="py-4">
                                <FaFileAlt
                                  size={30}
                                  className="text-secondary mb-2"
                                />
                                <br />
                                <a
                                  href={`http://localhost:5000${path}`}
                                  target="_blank"
                                  rel="noreferrer"
                                  className="small text-decoration-none"
                                >
                                  View Document
                                </a>
                              </div>
                            )}
                          </div>
                        </Col>
                      ))}
                    {(!student.documents || student.documents.length === 0) && (
                      <p className="text-muted text-center py-3">
                        No documents attached.
                      </p>
                    )}
                  </Row>
                </Tab>
                {/* --- NEW LEAVES TAB --- */}
                <Tab
                  eventKey="leaves"
                  title={
                    <span>
                      <FaSuitcase /> Leaves
                    </span>
                  }
                >
                  {/* Leave Form */}
                  <div className="p-3 bg-light rounded mb-4">
                    <h6 className="text-maroon">Record New Leave</h6>
                    {currentLeave ? (
                      <Alert variant="warning">
                        Student is currently on leave (Since{" "}
                        {new Date(currentLeave.startDate).toLocaleDateString()}
                        ).
                        <br />
                        <strong>Reason:</strong> {currentLeave.reason}
                        <div className="mt-2">
                          <Button
                            variant="success"
                            size="sm"
                            onClick={() => markReturned(currentLeave._id)}
                          >
                            Mark as Returned
                          </Button>
                        </div>
                      </Alert>
                    ) : (
                      <Row className="g-2">
                        <Col md={4}>
                          <Form.Label className="small">Start Date</Form.Label>
                          <Form.Control
                            type="date"
                            value={newLeave.startDate}
                            onChange={(e) =>
                              setNewLeave({
                                ...newLeave,
                                startDate: e.target.value,
                              })
                            }
                          />
                        </Col>
                        <Col md={4}>
                          <Form.Label className="small">
                            Expected Return
                          </Form.Label>
                          <Form.Control
                            type="date"
                            value={newLeave.endDate}
                            onChange={(e) =>
                              setNewLeave({
                                ...newLeave,
                                endDate: e.target.value,
                              })
                            }
                          />
                        </Col>
                        <Col md={4}>
                          <Form.Label className="small">Reason</Form.Label>
                          <Form.Control
                            placeholder="e.g. Going Home"
                            value={newLeave.reason}
                            onChange={(e) =>
                              setNewLeave({
                                ...newLeave,
                                reason: e.target.value,
                              })
                            }
                          />
                        </Col>
                        <Col md={12} className="text-end mt-2">
                          <Button size="sm" variant="danger" onClick={addLeave}>
                            Record Leave
                          </Button>
                        </Col>
                      </Row>
                    )}
                  </div>

                  {/* Leave History Table */}
                  <h6 className="mb-3">Leave History</h6>
                  <Table striped bordered hover size="sm">
                    <thead>
                      <tr>
                        <th>Start Date</th>
                        <th>Return Date</th>
                        <th>Reason</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      {student.leaves &&
                        student.leaves.map((l, idx) => (
                          <tr key={idx}>
                            <td>
                              {new Date(l.startDate).toLocaleDateString()}
                            </td>
                            <td>
                              {l.actualReturnDate
                                ? new Date(
                                    l.actualReturnDate
                                  ).toLocaleDateString()
                                : l.endDate
                                ? new Date(l.endDate).toLocaleDateString() +
                                  " (Exp)"
                                : "-"}
                            </td>
                            <td>{l.reason}</td>
                            <td>
                              {l.status === "On Leave" ? (
                                <Badge bg="warning" text="dark">
                                  On Leave
                                </Badge>
                              ) : (
                                <Badge bg="success">Returned</Badge>
                              )}
                            </td>
                          </tr>
                        ))}
                      {(!student.leaves || student.leaves.length === 0) && (
                        <tr>
                          <td colSpan="4" className="text-center text-muted">
                            No leave history.
                          </td>
                        </tr>
                      )}
                    </tbody>
                  </Table>
                </Tab>
              </Tabs>
            </Card.Body>
          </Card>
        </Col>
      </Row>

      {/* --- ALUMNI CONVERSION MODAL --- */}
      <Modal show={showAlumniModal} onHide={() => setShowAlumniModal(false)}>
        <Modal.Header closeButton>
          <Modal.Title>Alumni Details</Modal.Title>
        </Modal.Header>
        <Modal.Body>
          <p className="text-muted">
            Update current contact and work details for the alumni.
          </p>
          <Form>
            <Form.Group className="mb-3">
              <Form.Label>Current Location / City</Form.Label>
              <Form.Control
                value={alumniData.currentLocation}
                onChange={(e) =>
                  setAlumniData({
                    ...alumniData,
                    currentLocation: e.target.value,
                  })
                }
                placeholder="e.g. Bangalore"
              />
            </Form.Group>
            <Form.Group className="mb-3">
              <Form.Label>Current Phone Number</Form.Label>
              <Form.Control
                value={alumniData.phone}
                onChange={(e) =>
                  setAlumniData({ ...alumniData, phone: e.target.value })
                }
                placeholder="Personal Mobile"
              />
            </Form.Group>
            <Form.Group className="mb-3">
              <Form.Label>Email Address</Form.Label>
              <Form.Control
                value={alumniData.email}
                onChange={(e) =>
                  setAlumniData({ ...alumniData, email: e.target.value })
                }
              />
            </Form.Group>
            <Row>
              <Col>
                <Form.Group className="mb-3">
                  <Form.Label>Job Title</Form.Label>
                  <Form.Control
                    value={alumniData.jobTitle}
                    onChange={(e) =>
                      setAlumniData({ ...alumniData, jobTitle: e.target.value })
                    }
                    placeholder="e.g. Software Engineer"
                  />
                </Form.Group>
              </Col>
              <Col>
                <Form.Group className="mb-3">
                  <Form.Label>Company</Form.Label>
                  <Form.Control
                    value={alumniData.company}
                    onChange={(e) =>
                      setAlumniData({ ...alumniData, company: e.target.value })
                    }
                    placeholder="e.g. Infosys"
                  />
                </Form.Group>
              </Col>
            </Row>
          </Form>
        </Modal.Body>
        <Modal.Footer>
          <Button variant="secondary" onClick={() => setShowAlumniModal(false)}>
            Cancel
          </Button>
          <Button variant="primary" onClick={handleConvertToAlumni}>
            Save Details
          </Button>
        </Modal.Footer>
      </Modal>

      {/* Sponsor Modal */}
      <Modal show={showSponsorModal} onHide={() => setShowSponsorModal(false)}>
        <Modal.Header closeButton>
          <Modal.Title>Map a Sponsor</Modal.Title>
        </Modal.Header>
        <Modal.Body>
          <p className="text-muted">
            Select a donor from the list below to assign as a sponsor for{" "}
            <strong>{student.firstName}</strong>.
          </p>
          <Form.Group className="mb-3">
            <Form.Label>Select Donor</Form.Label>
            <Form.Select onChange={(e) => setSelectedSponsorId(e.target.value)}>
              <option value="">-- Choose Donor --</option>
              {donors.map((d) => (
                <option key={d._id} value={d._id}>
                  {d.donorName} - {d.amount} ({d.scheme})
                </option>
              ))}
            </Form.Select>
          </Form.Group>
          <Button variant="primary" className="w-100" onClick={mapSponsor}>
            Confirm Mapping
          </Button>
        </Modal.Body>
      </Modal>
    </div>
  );
};

export default StudentProfile;


--- FILE: client/src/pages/admin/StudentProfile1.jsx ---
/* eslint-disable no-unused-vars */
import React, { useEffect, useState } from "react";
import { useParams, Link } from "react-router-dom";
import {
  Row,
  Col,
  Card,
  Tabs,
  Tab,
  Table,
  Button,
  Form,
  Badge,
  Spinner,
  Modal,
  Alert,
} from "react-bootstrap";
import {
  FaArrowLeft,
  FaUserGraduate,
  FaHeartbeat,
  FaBook,
  FaRupeeSign,
  FaPlus,
  FaHandHoldingHeart,
  FaEdit,
  FaPrint,
} from "react-icons/fa";
import axios from "axios";

const StudentProfile = () => {
  const { id } = useParams();
  const [student, setStudent] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");
  // Edit Mode State
  const [isEditing, setIsEditing] = useState(false);
  const [editData, setEditData] = useState({}); // Stores changes while editing

  // --- State for New Entries ---
  const [newEdu, setNewEdu] = useState({
    year: "",
    class: "",
    school: "",
    percentage: "",
  });
  const [newHealth, setNewHealth] = useState({
    checkupType: "",
    doctorName: "",
    observation: "",
  });

  // --- FIX 1: State for New Expense ---
  const [newExpense, setNewExpense] = useState({ description: "", amount: "" });

  // --- FIX 2: State for Sponsor Mapping ---
  const [showSponsorModal, setShowSponsorModal] = useState(false);
  const [donors, setDonors] = useState([]); // List of available donors
  const [selectedSponsorId, setSelectedSponsorId] = useState("");

  useEffect(() => {
    fetchStudent();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [id]);

  const fetchStudent = async () => {
    try {
      const userInfo = JSON.parse(localStorage.getItem("userInfo"));
      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };
      const { data } = await axios.get(
        `http://localhost:5000/api/students/${id}`,
        config
      );
      setStudent(data);
      setLoading(false);
    } catch (error) {
      console.error(error);
      setError("Failed to load student data");
      setLoading(false);
    }
  };
  // --- SAVE EDITED PROFILE ---
  const saveProfileChanges = async () => {
    try {
      const userInfo = JSON.parse(localStorage.getItem("userInfo"));
      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };

      // Update basic fields
      await axios.put(
        `http://localhost:5000/api/students/${id}`,
        {
          firstName: editData.firstName,
          lastName: editData.lastName,
          guardianName: editData.guardianName,
          contactNumber: editData.contactNumber,
          address: editData.address,
          dob: editData.dob,
        },
        config
      );

      setIsEditing(false);
      fetchStudent();
      alert("Profile Updated Successfully!");
    } catch (error) {
      alert("Error updating profile");
    }
  };

  // --- Generic Update Handler ---
  const handleUpdate = async (updateData) => {
    try {
      const userInfo = JSON.parse(localStorage.getItem("userInfo"));
      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };
      await axios.put(
        `http://localhost:5000/api/students/${id}`,
        updateData,
        config
      );
      fetchStudent(); // Refresh UI
      // alert("Updated Successfully!"); // Optional: Commented out to reduce popup spam
    } catch (error) {
      alert("Error updating student");
    }
  };

  // --- Handlers for Adding Data ---
  const addEducation = () => {
    if (!newEdu.year || !newEdu.school) return alert("Please fill details");
    const updatedHistory = [...student.educationHistory, newEdu];
    handleUpdate({ educationHistory: updatedHistory });
    setNewEdu({ year: "", class: "", school: "", percentage: "" });
  };

  const addHealth = () => {
    if (!newHealth.checkupType) return alert("Please fill details");
    const updatedHealth = [...student.healthRecords, newHealth];
    handleUpdate({ healthRecords: updatedHealth });
    setNewHealth({ checkupType: "", doctorName: "", observation: "" });
  };

  // --- FIX 1: Add Expense Handler ---
  const addExpense = () => {
    if (!newExpense.description || !newExpense.amount)
      return alert("Please enter description and amount");

    // We send 'newExpense' object directly. The backend pushes it to the array.
    handleUpdate({
      newExpense: {
        description: newExpense.description,
        amount: Number(newExpense.amount),
        date: new Date(),
      },
    });
    setNewExpense({ description: "", amount: "" });
  };

  // --- FIX 2: Sponsor Handlers ---
  const openSponsorModal = async () => {
    setShowSponsorModal(true);
    try {
      // Fetch list of donations/donors to choose from
      const userInfo = JSON.parse(localStorage.getItem("userInfo"));
      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };
      const { data } = await axios.get(
        "http://localhost:5000/api/donations",
        config
      );
      setDonors(data);
    } catch (err) {
      alert("Failed to load donor list");
    }
  };

  const mapSponsor = async () => {
    if (!selectedSponsorId) return alert("Select a sponsor");
    await handleUpdate({ sponsor: selectedSponsorId });
    setShowSponsorModal(false);
    alert("Sponsor Mapped Successfully!");
  };

  if (loading)
    return (
      <div className="text-center py-5">
        <Spinner animation="border" />
      </div>
    );
  if (error) return <Alert variant="danger">{error}</Alert>;

  // Find sponsor name details if mapped
  const sponsorDetails = student.sponsor
    ? donors.find((d) => d._id === student.sponsor) // Try to find in loaded list (might need refresh if not loaded)
    : null;

  return (
    <div>
      {/* Header */}
      <div className="d-flex align-items-center gap-3 mb-4">
        <Link
          to="/dashboard/students"
          className="btn btn-outline-secondary btn-sm"
        >
          <FaArrowLeft />
        </Link>
        <div>
          <h2
            className="text-maroon m-0"
            style={{ fontFamily: "Playfair Display" }}
          >
            {student.firstName} {student.lastName}
          </h2>
          <span className="text-muted">
            ID: {student._id.slice(-6).toUpperCase()} | Branch: {student.branch}
          </span>
        </div>
        {/* <div className="ms-auto">
          <Badge
            bg={student.admissionStatus === "Active" ? "success" : "warning"}
          >
            {student.admissionStatus}
          </Badge>
        </div> */}
        <div className="ms-auto d-flex gap-2">
          {/* Print Button */}
          <Button variant="outline-dark" onClick={() => window.print()}>
            <FaPrint /> Print Profile
          </Button>

          {/* Edit Toggle Button */}
          {isEditing ? (
            <Button variant="success" onClick={saveProfileChanges}>
              <FaSave /> Save Changes
            </Button>
          ) : (
            <Button
              variant="primary"
              style={{ backgroundColor: "#581818" }}
              onClick={() => setIsEditing(true)}
            >
              <FaEdit /> Edit Details
            </Button>
          )}
        </div>
      </div>

      <Row>
        {/* Left Sidebar: Basic Info */}
        <Col md={4}>
          <Card className="shadow-sm border-0 mb-4">
            <Card.Body className="text-center">
              <div
                className="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3"
                style={{ width: "100px", height: "100px" }}
              >
                <FaUserGraduate size={50} className="text-secondary" />
              </div>
              <h5>
                {student.firstName} {student.lastName}
              </h5>
              <p className="text-muted small">
                {student.gender} | {new Date(student.dob).toLocaleDateString()}
              </p>
              <hr />
              <div className="text-start">
                <p>
                  <strong>Guardian:</strong> {student.guardianName}
                </p>
                <p>
                  <strong>Contact:</strong> {student.contactNumber}
                </p>
                <p>
                  <strong>Address:</strong> {student.address}
                </p>
              </div>
            </Card.Body>
          </Card>

          {/* Sponsor Card */}
          <Card className="shadow-sm border-0 bg-light">
            <Card.Body>
              <h6 className="text-maroon fw-bold">
                <FaHandHoldingHeart /> Sponsor Details
              </h6>

              {student.sponsor ? (
                <div className="mt-3">
                  <p className="text-success fw-bold mb-1">Sponsored</p>
                  <small className="text-muted">
                    Sponsor ID: {student.sponsor.slice(-6)}
                  </small>
                  {/* Note: To show Sponsor Name, backend populate is ideal, but for now we show ID or status */}
                  <div className="mt-2">
                    <Button
                      size="sm"
                      variant="outline-danger"
                      onClick={() => handleUpdate({ sponsor: null })}
                    >
                      Remove Mapping
                    </Button>
                  </div>
                </div>
              ) : (
                <div className="text-center mt-3">
                  <small className="text-muted d-block mb-2">
                    No sponsor mapped yet.
                  </small>
                  <Button
                    size="sm"
                    variant="outline-primary"
                    onClick={openSponsorModal}
                  >
                    Map Sponsor
                  </Button>
                </div>
              )}
            </Card.Body>
          </Card>
        </Col>

        {/* Right Content: Tabs */}
        <Col md={8}>
          <Card className="shadow-sm border-0">
            <Card.Body>
              <Tabs defaultActiveKey="education" className="mb-3">
                {/* Tab 1: Education */}
                <Tab
                  eventKey="education"
                  title={
                    <span>
                      <FaBook /> Education
                    </span>
                  }
                >
                  <Table striped bordered hover size="sm">
                    <thead>
                      <tr>
                        <th>Year</th>
                        <th>Class</th>
                        <th>School</th>
                        <th>%</th>
                      </tr>
                    </thead>
                    <tbody>
                      {student.educationHistory.map((edu, idx) => (
                        <tr key={idx}>
                          <td>{edu.year}</td>
                          <td>{edu.class}</td>
                          <td>{edu.school}</td>
                          <td>{edu.percentage}</td>
                        </tr>
                      ))}
                    </tbody>
                  </Table>
                  <div className="p-3 bg-light rounded">
                    <h6>Add Academic Record</h6>
                    <Row className="g-2">
                      <Col md={3}>
                        <Form.Control
                          placeholder="Year"
                          value={newEdu.year}
                          onChange={(e) =>
                            setNewEdu({ ...newEdu, year: e.target.value })
                          }
                        />
                      </Col>
                      <Col md={3}>
                        <Form.Control
                          placeholder="Class"
                          value={newEdu.class}
                          onChange={(e) =>
                            setNewEdu({ ...newEdu, class: e.target.value })
                          }
                        />
                      </Col>
                      <Col md={4}>
                        <Form.Control
                          placeholder="School"
                          value={newEdu.school}
                          onChange={(e) =>
                            setNewEdu({ ...newEdu, school: e.target.value })
                          }
                        />
                      </Col>
                      <Col md={2}>
                        <Button size="sm" onClick={addEducation}>
                          <FaPlus />
                        </Button>
                      </Col>
                    </Row>
                  </div>
                </Tab>

                {/* Tab 2: Health */}
                <Tab
                  eventKey="health"
                  title={
                    <span>
                      <FaHeartbeat /> Health
                    </span>
                  }
                >
                  <Table striped bordered hover size="sm">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Doctor</th>
                        <th>Observation</th>
                      </tr>
                    </thead>
                    <tbody>
                      {student.healthRecords.map((h, idx) => (
                        <tr key={idx}>
                          <td>{new Date(h.date).toLocaleDateString()}</td>
                          <td>{h.checkupType}</td>
                          <td>{h.doctorName}</td>
                          <td>{h.observation}</td>
                        </tr>
                      ))}
                    </tbody>
                  </Table>
                  <div className="p-3 bg-light rounded">
                    <h6>Add Health Checkup</h6>
                    <Row className="g-2">
                      <Col md={4}>
                        <Form.Control
                          placeholder="Type"
                          value={newHealth.checkupType}
                          onChange={(e) =>
                            setNewHealth({
                              ...newHealth,
                              checkupType: e.target.value,
                            })
                          }
                        />
                      </Col>
                      <Col md={4}>
                        <Form.Control
                          placeholder="Doctor"
                          value={newHealth.doctorName}
                          onChange={(e) =>
                            setNewHealth({
                              ...newHealth,
                              doctorName: e.target.value,
                            })
                          }
                        />
                      </Col>
                      <Col md={4}>
                        <Form.Control
                          placeholder="Observation"
                          value={newHealth.observation}
                          onChange={(e) =>
                            setNewHealth({
                              ...newHealth,
                              observation: e.target.value,
                            })
                          }
                        />
                      </Col>
                      <Col md={12} className="text-end mt-2">
                        <Button size="sm" onClick={addHealth}>
                          Add Record
                        </Button>
                      </Col>
                    </Row>
                  </div>
                </Tab>

                {/* Tab 3: Expenses (FIXED) */}
                <Tab
                  eventKey="expenses"
                  title={
                    <span>
                      <FaRupeeSign /> Expenses
                    </span>
                  }
                >
                  <Table striped bordered hover size="sm">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th className="text-end">Amount</th>
                      </tr>
                    </thead>
                    <tbody>
                      {student.expenses.map((exp, idx) => (
                        <tr key={idx}>
                          <td>{new Date(exp.date).toLocaleDateString()}</td>
                          <td>{exp.description}</td>
                          <td className="text-end fw-bold">{exp.amount}</td>
                        </tr>
                      ))}
                      {student.expenses.length === 0 && (
                        <tr>
                          <td colSpan="3" className="text-center text-muted">
                            No specific expenses recorded.
                          </td>
                        </tr>
                      )}
                    </tbody>
                  </Table>

                  {/* --- NEW EXPENSE INPUT SECTION --- */}
                  <div className="p-3 bg-light rounded mt-3">
                    <h6 className="text-maroon">Record New Expense</h6>
                    <Row className="g-2">
                      <Col md={7}>
                        <Form.Control
                          placeholder="Description (e.g. School Fees, Uniform)"
                          value={newExpense.description}
                          onChange={(e) =>
                            setNewExpense({
                              ...newExpense,
                              description: e.target.value,
                            })
                          }
                        />
                      </Col>
                      <Col md={3}>
                        <Form.Control
                          type="number"
                          placeholder="Amount ()"
                          value={newExpense.amount}
                          onChange={(e) =>
                            setNewExpense({
                              ...newExpense,
                              amount: e.target.value,
                            })
                          }
                        />
                      </Col>
                      <Col md={2}>
                        <Button
                          variant="danger"
                          className="w-100"
                          onClick={addExpense}
                        >
                          Add
                        </Button>
                      </Col>
                    </Row>
                  </div>
                </Tab>
              </Tabs>
            </Card.Body>
          </Card>
        </Col>
      </Row>

      {/* --- SPONSOR MAPPING MODAL --- */}
      <Modal show={showSponsorModal} onHide={() => setShowSponsorModal(false)}>
        <Modal.Header closeButton>
          <Modal.Title>Map a Sponsor</Modal.Title>
        </Modal.Header>
        <Modal.Body>
          <p className="text-muted">
            Select a donor from the list below to assign as a sponsor for{" "}
            <strong>{student.firstName}</strong>.
          </p>

          <Form.Group className="mb-3">
            <Form.Label>Select Donor</Form.Label>
            <Form.Select onChange={(e) => setSelectedSponsorId(e.target.value)}>
              <option value="">-- Choose Donor --</option>
              {donors.map((d) => (
                <option key={d._id} value={d._id}>
                  {d.donorName} - {d.amount} ({d.scheme})
                </option>
              ))}
            </Form.Select>
          </Form.Group>

          <Button variant="primary" className="w-100" onClick={mapSponsor}>
            Confirm Mapping
          </Button>
        </Modal.Body>
      </Modal>
    </div>
  );
};

export default StudentProfile;


--- FILE: client/src/pages/admin/SystemAudit.jsx ---
import React, { useEffect, useState } from "react";
import { Table, Badge, Card, Row, Col, Spinner, Form } from "react-bootstrap";
import { FaShieldAlt, FaSearch } from "react-icons/fa";
import axios from "axios";

const SystemAudit = () => {
  const [logs, setLogs] = useState([]);
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState("");

  useEffect(() => {
    // eslint-disable-next-line react-hooks/immutability
    fetchLogs();
  }, []);

  const fetchLogs = async () => {
    try {
      const userInfo = JSON.parse(localStorage.getItem("userInfo"));
      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };
      const { data } = await axios.get(
        "http://localhost:5000/api/audit/system",
        config
      );
      setLogs(data);
      setLoading(false);
    } catch (error) {
      console.error(error);
      setLoading(false);
    }
  };

  // Filter Logic
  const filteredLogs = logs.filter(
    (log) =>
      log.userName.toLowerCase().includes(filter.toLowerCase()) ||
      log.module.toLowerCase().includes(filter.toLowerCase()) ||
      log.action.toLowerCase().includes(filter.toLowerCase())
  );

  const getActionBadge = (action) => {
    switch (action) {
      case "CREATE":
        return <Badge bg="success">CREATE</Badge>;
      case "UPDATE":
        return (
          <Badge bg="warning" text="dark">
            UPDATE
          </Badge>
        );
      case "DELETE":
        return <Badge bg="danger">DELETE</Badge>;
      case "APPROVE":
        return <Badge bg="info">APPROVE</Badge>;
      default:
        return <Badge bg="secondary">{action}</Badge>;
    }
  };

  if (loading)
    return (
      <div className="text-center py-5">
        <Spinner animation="border" />
      </div>
    );

  return (
    <div>
      <Row className="mb-4 align-items-center">
        <Col>
          <h2
            className="text-maroon"
            style={{ fontFamily: "Playfair Display" }}
          >
            System Audit Trail
          </h2>
          <p className="text-muted">
            Track all user activities and data changes
          </p>
        </Col>
        <Col md={4}>
          <div className="input-group">
            <span className="input-group-text bg-white">
              <FaSearch />
            </span>
            <Form.Control
              placeholder="Search User, Module or Action..."
              value={filter}
              onChange={(e) => setFilter(e.target.value)}
            />
          </div>
        </Col>
      </Row>

      <Card className="shadow-sm border-0">
        <Card.Body className="p-0">
          <Table
            hover
            responsive
            className="align-middle mb-0"
            style={{ fontSize: "0.9rem" }}
          >
            <thead className="bg-light">
              <tr>
                <th className="ps-4">Time</th>
                <th>User</th>
                <th>Module</th>
                <th>Action</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody>
              {filteredLogs.map((log) => (
                <tr key={log._id}>
                  <td className="ps-4 text-muted" style={{ width: "180px" }}>
                    {new Date(log.createdAt).toLocaleString()}
                  </td>
                  <td className="fw-bold text-primary">{log.userName}</td>
                  <td>{log.module}</td>
                  <td>{getActionBadge(log.action)}</td>
                  <td className="text-muted">{log.details}</td>
                </tr>
              ))}
              {filteredLogs.length === 0 && (
                <tr>
                  <td colSpan="5" className="text-center py-5">
                    No logs found
                  </td>
                </tr>
              )}
            </tbody>
          </Table>
        </Card.Body>
      </Card>
    </div>
  );
};

export default SystemAudit;


--- FILE: client/src/pages/Contact.css ---
.contact-hero {
  background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)),
    url("https://images.unsplash.com/photo-1534536281715-e28d76689b4d?q=80&w=1920&auto=format&fit=crop");
  background-size: cover;
  background-position: center;
  height: 300px;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  color: white;
}

.contact-box-icon {
  width: 60px;
  height: 60px;
  background-color: #fffbf5;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #d35400; /* Saffron */
  font-size: 24px;
  margin-bottom: 15px;
  border: 1px solid #d35400;
}

.form-control-ashram {
  border: 1px solid #ccc;
  padding: 12px;
  border-radius: 5px;
}

.form-control-ashram:focus {
  border-color: #d35400;
  box-shadow: 0 0 0 0.2rem rgba(211, 84, 0, 0.25);
}


--- FILE: client/src/pages/Contact.jsx ---
import React, { useState } from "react";
import {
  Container,
  Row,
  Col,
  Form,
  Button,
  Card,
  Alert,
} from "react-bootstrap";
import { FaPhoneAlt, FaEnvelope, FaMapMarkerAlt } from "react-icons/fa";
import axios from "axios"; // Make sure you installed axios
import "./Contact.css";

const Contact = () => {
  // State for form fields
  const [formData, setFormData] = useState({
    name: "",
    phone: "",
    email: "",
    subject: "General Inquiry",
    message: "",
  });

  const [status, setStatus] = useState({ type: "", msg: "" });

  // Handle Input Change
  const handleChange = (e) => {
    setFormData({ ...formData, [e.target.name]: e.target.value });
  };

  // Handle Form Submit
  const handleSubmit = async (e) => {
    e.preventDefault();
    setStatus({ type: "", msg: "" });

    try {
      // Connect to your backend API
      const res = await axios.post(
        "http://localhost:5000/api/contact",
        formData
      );

      setStatus({ type: "success", msg: res.data.message });
      // Reset form
      setFormData({
        name: "",
        phone: "",
        email: "",
        subject: "General Inquiry",
        message: "",
      });
    } catch (err) {
      setStatus({
        type: "danger",
        msg:
          err.response?.data?.message ||
          "Something went wrong. Please try again.",
      });
    }
  };

  return (
    <>
      <div className="contact-hero">
        <div>
          <h1
            className="display-3 fw-bold"
            style={{ fontFamily: "Playfair Display" }}
          >
            Contact Us
          </h1>
          <p className="lead">We are here to help and serve</p>
        </div>
      </div>

      <Container className="py-5">
        <Row className="gy-5">
          {/* Left: Contact Info */}
          <Col lg={5}>
            <h2
              className="mb-4"
              style={{ fontFamily: "Playfair Display", color: "#581818" }}
            >
              Get In Touch
            </h2>
            <p className="text-muted mb-5">
              Have questions about our schemes or want to visit the Ashram?
              Reach out to us.
            </p>

            <div className="d-flex mb-4">
              <div className="contact-box-icon flex-shrink-0">
                <FaMapMarkerAlt />
              </div>
              <div className="ms-3">
                <h5 className="fw-bold">Our Location</h5>
                <p className="text-muted">
                  Plot No. 123, Temple Road, Saroornagar, Hyderabad, Telangana -
                  500035
                </p>
              </div>
            </div>

            <div className="d-flex mb-4">
              <div className="contact-box-icon flex-shrink-0">
                <FaPhoneAlt />
              </div>
              <div className="ms-3">
                <h5 className="fw-bold">Phone Number</h5>
                <p className="text-muted mb-0">+91 99220 03000</p>
                <p className="text-muted">+91 40 2456 7890</p>
              </div>
            </div>

            <div className="d-flex mb-4">
              <div className="contact-box-icon flex-shrink-0">
                <FaEnvelope />
              </div>
              <div className="ms-3">
                <h5 className="fw-bold">Email Address</h5>
                <p className="text-muted">info@karunasri.org</p>
              </div>
            </div>
          </Col>

          <Col lg={7}>
            <Card className="border-0 shadow-lg p-4">
              <h3 className="mb-4">Send a Message</h3>

              {/* Show Success/Error Alert */}
              {status.msg && <Alert variant={status.type}>{status.msg}</Alert>}

              <Form onSubmit={handleSubmit}>
                <Row>
                  <Col md={6} className="mb-3">
                    <Form.Label>Your Name</Form.Label>
                    <Form.Control
                      type="text"
                      name="name"
                      value={formData.name}
                      onChange={handleChange}
                      required
                      className="form-control-ashram"
                    />
                  </Col>
                  <Col md={6} className="mb-3">
                    <Form.Label>Phone Number</Form.Label>
                    <Form.Control
                      type="text"
                      name="phone"
                      value={formData.phone}
                      onChange={handleChange}
                      required
                      className="form-control-ashram"
                    />
                  </Col>
                </Row>
                <div className="mb-3">
                  <Form.Label>Email Address</Form.Label>
                  <Form.Control
                    type="email"
                    name="email"
                    value={formData.email}
                    onChange={handleChange}
                    required
                    className="form-control-ashram"
                  />
                </div>
                <div className="mb-3">
                  <Form.Label>Subject</Form.Label>
                  <Form.Select
                    name="subject"
                    value={formData.subject}
                    onChange={handleChange}
                    className="form-control-ashram"
                  >
                    <option>General Inquiry</option>
                    <option>Donation Related</option>
                    <option>Volunteering</option>
                    <option>Student Admission</option>
                  </Form.Select>
                </div>
                <div className="mb-4">
                  <Form.Label>Message</Form.Label>
                  <Form.Control
                    as="textarea"
                    rows={4}
                    name="message"
                    value={formData.message}
                    onChange={handleChange}
                    required
                    className="form-control-ashram"
                  />
                </div>
                <Button type="submit" className="btn-ashram w-100 py-2">
                  Send Message
                </Button>
              </Form>
            </Card>
          </Col>
        </Row>

        {/* Map Section */}
        <Row className="mt-5 pt-4">
          <Col>
            <div
              className="rounded overflow-hidden shadow-sm"
              style={{ height: "400px" }}
            >
              <iframe
                title="Google Map"
                src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3807.669661448982!2d78.53201431487616!3d17.37956498808331!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3bcb98a1f5f5f5f5%3A0x5f5f5f5f5f5f5f5f!2sSaroornagar%2C%20Hyderabad%2C%20Telangana!5e0!3m2!1sen!2sin!4v1620000000000!5m2!1sen!2sin"
                width="100%"
                height="100%"
                style={{ border: 0 }}
                allowFullScreen=""
                loading="lazy"
              ></iframe>
            </div>
          </Col>
        </Row>
      </Container>
    </>
  );
};

export default Contact;


--- FILE: client/src/pages/Donate.css ---
.donate-hero {
  background: linear-gradient(rgba(88, 24, 24, 0.8), rgba(88, 24, 24, 0.8)),
    url("https://images.unsplash.com/photo-1593113598332-cd288d649433?q=80&w=1920&auto=format&fit=crop");
  background-size: cover;
  background-position: center;
  padding: 60px 0;
  text-align: center;
  color: white;
  margin-bottom: 40px;
}

/* --- Section Titles --- */
.donate-section-title {
  font-family: "Playfair Display", serif;
  color: #581818;
  font-size: 1.5rem;
  margin-bottom: 20px;
  border-bottom: 2px solid #eee;
  padding-bottom: 10px;
}

/* --- Amount Presets --- */
.amount-btn-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 15px;
  margin-bottom: 20px;
}

.amount-btn {
  background-color: white;
  border: 2px solid #e0e0e0;
  padding: 15px;
  border-radius: 8px;
  font-weight: bold;
  color: #555;
  transition: all 0.2s;
}

.amount-btn:hover {
  border-color: #daa520; /* Gold */
  color: #daa520;
}

.amount-btn.active {
  background-color: #581818; /* Maroon */
  color: white;
  border-color: #581818;
  transform: scale(1.05);
  box-shadow: 0 5px 15px rgba(88, 24, 24, 0.2);
}

/* --- Scheme Selection --- */
.scheme-select-box {
  border: 2px solid #e0e0e0;
  padding: 10px;
  border-radius: 8px;
  width: 100%;
  font-size: 1.1rem;
  margin-bottom: 20px;
  background-color: #fffbf5; /* Light Cream */
}

/* --- Tax Benefit Badge --- */
.tax-badge {
  background-color: #d1e7dd;
  color: #0f5132;
  padding: 10px;
  border-radius: 5px;
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  gap: 10px;
  border: 1px solid #badbcc;
  margin-bottom: 20px;
}

/* --- Summary Box --- */
.donation-summary {
  background-color: #f8f9fa;
  padding: 20px;
  border-radius: 10px;
  border-top: 4px solid #daa520;
}

.total-amount-display {
  font-size: 2.5rem;
  font-weight: bold;
  color: #581818;
  font-family: "Playfair Display", serif;
}

/* --- Payment Methods --- */
.payment-method-card {
  border: 1px solid #ddd;
  padding: 15px;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
  transition: all 0.2s;
}

.payment-method-card.active {
  border-color: #25d366; /* Green for selected */
  background-color: #f0fff4;
}


--- FILE: client/src/pages/Donate.jsx ---
// import React, { useState } from "react";
// import {
//   Container,
//   Row,
//   Col,
//   Form,
//   Button,
//   Card,
//   InputGroup,
// } from "react-bootstrap";
// import {
//   FaHeart,
//   FaRupeeSign,
//   FaCheckCircle,
//   FaLock,
//   FaUniversity,
//   FaQrcode,
// } from "react-icons/fa";
// import "./Donate.css";

// const Donate = () => {
//   // State for form
//   const [amount, setAmount] = useState("");
//   const [scheme, setScheme] = useState("Nitya Annadhana");
//   const [paymentMethod, setPaymentMethod] = useState("online"); // online, bank, qr

//   // Preset amounts
//   const amounts = [500, 1000, 2500, 5000, 10000, 25000];

//   return (
//     <>
//       {/* 1. Hero */}
//       <div className="donate-hero">
//         <Container>
//           <h1
//             className="display-4 fw-bold"
//             style={{ fontFamily: "Playfair Display" }}
//           >
//             Make a Donation
//           </h1>
//           <p className="lead opacity-75">
//             Your contribution brings light to someone's life.
//           </p>
//         </Container>
//       </div>

//       <Container className="pb-5">
//         <Row className="gy-4">
//           {/* --- LEFT COLUMN: Donation Details --- */}
//           <Col lg={7}>
//             <Card className="border-0 shadow-sm p-4 h-100">
//               <h3 className="donate-section-title">
//                 1. Choose Donation Details
//               </h3>

//               {/* Scheme Dropdown */}
//               <Form.Label className="fw-bold text-muted">
//                 Select Cause (Scheme)
//               </Form.Label>
//               <select
//                 className="scheme-select-box form-select"
//                 value={scheme}
//                 onChange={(e) => setScheme(e.target.value)}
//               >
//                 {/* <option value="Nitya Annadhana">
//                   Nitya Annadhana (Food Distribution)
//                 </option>
//                 <option value="Vidyarthi Nidhi">
//                   Vidyarthi Nidhi (Education)
//                 </option>
//                 <option value="Go Seva">Go Seva (Cow Protection)</option>
//                 <option value="Ashram Development">Ashram Development</option>
//                 <option value="General Fund">General Fund</option> */}
//                 <option value="Nitya Annadhana Nidhi">
//                   Nitya Annadhana Nidhi
//                 </option>
//                 <option value="Shasvitha Annadhana Nidhi">
//                   Shasvitha Annadhana Nidhi
//                 </option>
//                 <option value="Smruthi Nidhi">Smruthi Nidhi</option>
//                 <option value="Vidyarthi Samraksha Nidhi">
//                   Vidyarthi Samraksha Nidhi
//                 </option>
//                 <option value="Vidyarthi PoshakaNidhi">
//                   Vidyarthi PoshakaNidhi
//                 </option>
//                 <option value="Vidyarthi Pathashala Rusumu Nidhi">
//                   Vidyarthi Pathashala Rusumu Nidhi
//                 </option>
//                 <option value="General Fund">General Fund</option>{" "}
//                 {/* Good to keep as a fallback */}
//               </select>

//               {/* Amount Selection */}
//               <Form.Label className="fw-bold text-muted mt-3">
//                 Select Amount ()
//               </Form.Label>
//               <div className="amount-btn-grid">
//                 {amounts.map((amt) => (
//                   <button
//                     key={amt}
//                     className={`amount-btn ${amount == amt ? "active" : ""}`}
//                     onClick={() => setAmount(amt)}
//                   >
//                     {amt.toLocaleString()}
//                   </button>
//                 ))}
//               </div>

//               {/* Custom Amount Input */}
//               <InputGroup className="mb-3">
//                 <InputGroup.Text>
//                   <FaRupeeSign />
//                 </InputGroup.Text>
//                 <Form.Control
//                   type="number"
//                   placeholder="Enter custom amount"
//                   value={amount}
//                   onChange={(e) => setAmount(e.target.value)}
//                   style={{ fontSize: "1.2rem", fontWeight: "bold" }}
//                 />
//               </InputGroup>

//               {/* Tax Benefit Badge */}
//               <div className="tax-badge">
//                 <FaCheckCircle />
//                 <div>
//                   <strong>Tax Benefit Available</strong>
//                   <br />
//                   <small>
//                     All donations are eligible for tax exemption under section
//                     80G.
//                   </small>
//                 </div>
//               </div>

//               {/* Payment Method Toggle */}
//               <h5 className="mt-4 mb-3 fw-bold text-secondary">
//                 Payment Method
//               </h5>

//               <div
//                 className={`payment-method-card ${
//                   paymentMethod === "online" ? "active" : ""
//                 }`}
//                 onClick={() => setPaymentMethod("online")}
//               >
//                 <div className="d-flex align-items-center gap-3">
//                   <div className="bg-light p-2 rounded">
//                     <FaLock />
//                   </div>
//                   <div>
//                     <strong>Online Payment</strong>
//                     <div className="small text-muted">
//                       Credit Card, Debit Card, UPI, NetBanking
//                     </div>
//                   </div>
//                 </div>
//                 <input
//                   type="radio"
//                   checked={paymentMethod === "online"}
//                   readOnly
//                 />
//               </div>

//               <div
//                 className={`payment-method-card ${
//                   paymentMethod === "bank" ? "active" : ""
//                 }`}
//                 onClick={() => setPaymentMethod("bank")}
//               >
//                 <div className="d-flex align-items-center gap-3">
//                   <div className="bg-light p-2 rounded">
//                     <FaUniversity />
//                   </div>
//                   <div>
//                     <strong>Bank Transfer (NEFT/RTGS)</strong>
//                     <div className="small text-muted">
//                       Direct transfer to Ashram account
//                     </div>
//                   </div>
//                 </div>
//                 <input
//                   type="radio"
//                   checked={paymentMethod === "bank"}
//                   readOnly
//                 />
//               </div>
//             </Card>
//           </Col>

//           {/* --- RIGHT COLUMN: Donor Details --- */}
//           <Col lg={5}>
//             <Card
//               className="border-0 shadow-lg p-4 h-100"
//               style={{ borderTop: "5px solid #581818" }}
//             >
//               <h3 className="donate-section-title">2. Donor Information</h3>

//               <Form>
//                 <Row>
//                   <Col md={12} className="mb-3">
//                     <Form.Label>
//                       Full Name <span className="text-danger">*</span>
//                     </Form.Label>
//                     <Form.Control
//                       type="text"
//                       placeholder="As per PAN Card"
//                       required
//                     />
//                   </Col>
//                   <Col md={12} className="mb-3">
//                     <Form.Label>
//                       Mobile Number <span className="text-danger">*</span>
//                     </Form.Label>
//                     <Form.Control type="tel" placeholder="+91" required />
//                   </Col>
//                   <Col md={12} className="mb-3">
//                     <Form.Label>
//                       Email Address <span className="text-danger">*</span>
//                     </Form.Label>
//                     <Form.Control
//                       type="email"
//                       placeholder="To receive receipt"
//                       required
//                     />
//                   </Col>

//                   {/* PAN Card - Optional but needed for 80G */}
//                   <Col md={12} className="mb-3">
//                     <Form.Label>PAN Number</Form.Label>
//                     <Form.Control
//                       type="text"
//                       placeholder="Required for 80G Receipt"
//                     />
//                     <Form.Text className="text-muted">
//                       Optional if you don't need tax exemption.
//                     </Form.Text>
//                   </Col>

//                   <Col md={12} className="mb-3">
//                     <Form.Label>Address</Form.Label>
//                     <Form.Control
//                       as="textarea"
//                       rows={2}
//                       placeholder="Your communication address"
//                     />
//                   </Col>
//                 </Row>

//                 {/* Summary Section */}
//                 <div className="donation-summary mt-3 text-center">
//                   <small className="text-muted text-uppercase ls-1">
//                     Total Donation
//                   </small>
//                   <div className="total-amount-display">
//                      {amount ? parseInt(amount).toLocaleString() : "0"}
//                   </div>
//                   <small className="text-muted">For: {scheme}</small>
//                 </div>

//                 <Button
//                   className="btn-ashram w-100 py-3 mt-4 text-uppercase fw-bold"
//                   style={{ fontSize: "1.1rem" }}
//                 >
//                   Proceed to Pay <FaHeart className="ms-2" />
//                 </Button>

//                 <div className="text-center mt-3">
//                   <small className="text-muted">
//                     <FaLock size={12} /> Secure 256-bit SSL encrypted payment
//                   </small>
//                 </div>
//               </Form>
//             </Card>
//           </Col>
//         </Row>

//         {/* --- BANK DETAILS (Only shows if 'bank' is selected) --- */}
//         {paymentMethod === "bank" && (
//           <Row className="mt-5 justify-content-center">
//             <Col md={8}>
//               <Card className="p-4 border-warning bg-light text-center">
//                 <h4 className="text-maroon mb-3">Bank Account Details</h4>
//                 <p className="mb-1">
//                   <strong>Account Name:</strong> Karunasri Seva Samithi
//                 </p>
//                 <p className="mb-1">
//                   <strong>Account Number:</strong> 992200300000312
//                 </p>
//                 <p className="mb-1">
//                   <strong>Bank:</strong> Telangana State Co-operative Apex Bank
//                 </p>
//                 <p className="mb-1">
//                   <strong>IFSC Code:</strong> TSAB0000122
//                 </p>
//                 <p className="mb-0">
//                   <strong>Branch:</strong> Champapet
//                 </p>
//                 <hr />
//                 <small className="text-danger">
//                   After transfer, please share screenshot to +91 99220 03000 on
//                   WhatsApp for receipt.
//                 </small>
//               </Card>
//             </Col>
//           </Row>
//         )}
//       </Container>
//     </>
//   );
// };

// export default Donate;
import React, { useState, useEffect } from "react";
import {
  Container,
  Row,
  Col,
  Form,
  Button,
  Card,
  InputGroup,
  Alert,
  Spinner,
} from "react-bootstrap";
import {
  FaHeart,
  FaRupeeSign,
  FaCheckCircle,
  FaLock,
  FaUniversity,
} from "react-icons/fa";
import axios from "axios";
import "./Donate.css";

const Donate = () => {
  // State for form
  const [amount, setAmount] = useState("");
  const [scheme, setScheme] = useState("Nitya Annadhana Nidhi");
  const [paymentMode, setPaymentMode] = useState("Online");

  // Donor Details State
  const [donorDetails, setDonorDetails] = useState({
    donorName: "",
    donorPhone: "",
    donorEmail: "",
    donorPan: "",
    address: "",
  });

  const [loading, setLoading] = useState(false);
  const [message, setMessage] = useState({ type: "", text: "" });
  const [schemesList, setSchemesList] = useState([]);
  useEffect(() => {
    const fetchSchemes = async () => {
      try {
        const { data } = await axios.get("http://localhost:5000/api/schemes");
        setSchemesList(data);
        if (data.length > 0) setScheme(data[0].name);
      } catch (err) {
        console.error(err);
      }
    };
    fetchSchemes();
  }, []);

  // Preset amounts
  const amounts = [500, 1000, 2500, 5000, 10000, 25000];

  const handleChange = (e) => {
    setDonorDetails({ ...donorDetails, [e.target.name]: e.target.value });
  };

  const handleDonate = async (e) => {
    e.preventDefault();
    setLoading(true);
    setMessage({ type: "", text: "" });

    // Basic Validation
    if (!amount || !donorDetails.donorName || !donorDetails.donorPhone) {
      setMessage({
        type: "danger",
        text: "Please fill in all required fields (Name, Phone, Amount).",
      });
      setLoading(false);
      return;
    }

    try {
      // Prepare Data
      const payload = {
        ...donorDetails,
        amount: Number(amount),
        scheme,
        paymentMode,
        paymentReference:
          paymentMode === "Online"
            ? "Razorpay_Simulated_ID"
            : "Bank_Transfer_Ref",
      };

      // Call Public API
      await axios.post("http://localhost:5000/api/donations/public", payload);

      setMessage({
        type: "success",
        text: "Thank you! Your donation has been recorded successfully. You will receive a receipt shortly.",
      });

      // Reset Form
      setAmount("");
      setDonorDetails({
        donorName: "",
        donorPhone: "",
        donorEmail: "",
        donorPan: "",
        address: "",
      });
    } catch (error) {
      setMessage({
        type: "danger",
        text:
          error.response?.data?.message || "Donation failed. Please try again.",
      });
    }
    setLoading(false);
  };

  return (
    <>
      {/* Hero */}
      <div className="donate-hero">
        <Container>
          <h1
            className="display-4 fw-bold"
            style={{ fontFamily: "Playfair Display" }}
          >
            Make a Donation
          </h1>
          <p className="lead opacity-75">
            Your contribution brings light to someone's life.
          </p>
        </Container>
      </div>

      <Container className="pb-5">
        {message.text && (
          <Alert variant={message.type} className="mb-4 text-center">
            {message.text}
          </Alert>
        )}

        <Form onSubmit={handleDonate}>
          <Row className="gy-4">
            {/* --- LEFT COLUMN: Donation Details --- */}
            <Col lg={7}>
              <Card className="border-0 shadow-sm p-4 h-100">
                <h3 className="donate-section-title">
                  1. Choose Donation Details
                </h3>

                {/* Scheme Dropdown */}
                <Form.Label className="fw-bold text-muted">
                  Select Cause (Scheme)
                </Form.Label>
                <select
                  className="scheme-select-box form-select"
                  value={scheme}
                  onChange={(e) => setScheme(e.target.value)}
                >
                  {schemesList.map((s) => (
                    <option key={s._id} value={s.name}>
                      {s.name}
                    </option>
                  ))}
                </select>

                {/* Amount Selection */}
                <Form.Label className="fw-bold text-muted mt-3">
                  Select Amount ()
                </Form.Label>
                <div className="amount-btn-grid">
                  {amounts.map((amt) => (
                    <button
                      type="button"
                      key={amt}
                      className={`amount-btn ${
                        Number(amount) === amt ? "active" : ""
                      }`}
                      onClick={() => setAmount(amt)}
                    >
                      {amt.toLocaleString()}
                    </button>
                  ))}
                </div>

                {/* Custom Amount Input */}
                <InputGroup className="mb-3">
                  <InputGroup.Text>
                    <FaRupeeSign />
                  </InputGroup.Text>
                  <Form.Control
                    type="number"
                    placeholder="Enter custom amount"
                    value={amount}
                    onChange={(e) => setAmount(e.target.value)}
                    style={{ fontSize: "1.2rem", fontWeight: "bold" }}
                  />
                </InputGroup>

                {/* Payment Method Toggle */}
                <h5 className="mt-4 mb-3 fw-bold text-secondary">
                  Payment Method
                </h5>

                <div
                  className={`payment-method-card ${
                    paymentMode === "Online" ? "active" : ""
                  }`}
                  onClick={() => setPaymentMode("Online")}
                >
                  <div className="d-flex align-items-center gap-3">
                    <div className="bg-light p-2 rounded">
                      <FaLock />
                    </div>
                    <div>
                      <strong>Online Payment</strong>
                      <div className="small text-muted">
                        Credit Card, Debit Card, UPI
                      </div>
                    </div>
                  </div>
                  <input
                    type="radio"
                    checked={paymentMode === "Online"}
                    readOnly
                  />
                </div>

                <div
                  className={`payment-method-card ${
                    paymentMode === "Bank Transfer" ? "active" : ""
                  }`}
                  onClick={() => setPaymentMode("Bank Transfer")}
                >
                  <div className="d-flex align-items-center gap-3">
                    <div className="bg-light p-2 rounded">
                      <FaUniversity />
                    </div>
                    <div>
                      <strong>Bank Transfer (NEFT/RTGS)</strong>
                      <div className="small text-muted">
                        Direct transfer to Ashram account
                      </div>
                    </div>
                  </div>
                  <input
                    type="radio"
                    checked={paymentMode === "Bank Transfer"}
                    readOnly
                  />
                </div>
              </Card>
            </Col>

            {/* --- RIGHT COLUMN: Donor Details --- */}
            <Col lg={5}>
              <Card
                className="border-0 shadow-lg p-4 h-100"
                style={{ borderTop: "5px solid #581818" }}
              >
                <h3 className="donate-section-title">2. Donor Information</h3>

                <Row>
                  <Col md={12} className="mb-3">
                    <Form.Label>
                      Full Name <span className="text-danger">*</span>
                    </Form.Label>
                    <Form.Control
                      type="text"
                      name="donorName"
                      value={donorDetails.donorName}
                      onChange={handleChange}
                      placeholder="As per PAN Card"
                      required
                    />
                  </Col>
                  <Col md={12} className="mb-3">
                    <Form.Label>
                      Mobile Number <span className="text-danger">*</span>
                    </Form.Label>
                    <Form.Control
                      type="tel"
                      name="donorPhone"
                      value={donorDetails.donorPhone}
                      onChange={handleChange}
                      placeholder="+91"
                      required
                    />
                  </Col>
                  {/* Add Aadhaar Input in the Form */}
                  <Col md={12} className="mb-3">
                    <Form.Label>Aadhaar Number</Form.Label>
                    <Form.Control
                      type="text"
                      name="donorAadhaar"
                      value={donorDetails.donorAadhaar}
                      onChange={handleChange}
                      placeholder="Optional"
                    />
                  </Col>
                  <Col md={12} className="mb-3">
                    <Form.Label>Email Address</Form.Label>
                    <Form.Control
                      type="email"
                      name="donorEmail"
                      value={donorDetails.donorEmail}
                      onChange={handleChange}
                      placeholder="To receive receipt"
                    />
                  </Col>

                  <Col md={12} className="mb-3">
                    <Form.Label>PAN Number</Form.Label>
                    <Form.Control
                      type="text"
                      name="donorPan"
                      value={donorDetails.donorPan}
                      onChange={handleChange}
                      placeholder="Required for 80G Receipt"
                    />
                  </Col>

                  <Col md={12} className="mb-3">
                    <Form.Label>Address</Form.Label>
                    <Form.Control
                      as="textarea"
                      rows={2}
                      name="address"
                      value={donorDetails.address}
                      onChange={handleChange}
                      placeholder="Your communication address"
                    />
                  </Col>
                </Row>

                {/* Summary Section */}
                <div className="donation-summary mt-3 text-center">
                  <small className="text-muted text-uppercase ls-1">
                    Total Donation
                  </small>
                  <div className="total-amount-display">
                     {amount ? parseInt(amount).toLocaleString() : "0"}
                  </div>
                  <small className="text-muted">For: {scheme}</small>
                </div>

                <Button
                  type="submit"
                  className="btn-ashram w-100 py-3 mt-4 text-uppercase fw-bold"
                  style={{ fontSize: "1.1rem" }}
                  disabled={loading}
                >
                  {loading ? (
                    <Spinner animation="border" size="sm" />
                  ) : (
                    <>
                      Proceed to Pay <FaHeart className="ms-2" />
                    </>
                  )}
                </Button>

                <div className="text-center mt-3">
                  <small className="text-muted">
                    <FaLock size={12} /> Secure 256-bit SSL encrypted payment
                  </small>
                </div>
              </Card>
            </Col>
          </Row>
        </Form>

        {/* --- BANK DETAILS (Only shows if 'Bank Transfer' is selected) --- */}
        {paymentMode === "Bank Transfer" && (
          <Row className="mt-5 justify-content-center">
            <Col md={8}>
              <Card className="p-4 border-warning bg-light text-center">
                <h4 className="text-maroon mb-3">Bank Account Details</h4>
                <p className="mb-1">
                  <strong>Account Name:</strong> Karunasri Seva Samithi
                </p>
                <p className="mb-1">
                  <strong>Account Number:</strong> 992200300000312
                </p>
                <p className="mb-1">
                  <strong>Bank:</strong> Telangana State Co-operative Apex Bank
                </p>
                <p className="mb-1">
                  <strong>IFSC Code:</strong> TSAB0000122
                </p>
                <p className="mb-0">
                  <strong>Branch:</strong> Champapet
                </p>
                <hr />
                <small className="text-danger">
                  After transfer, please click "Proceed to Pay" to record your
                  donation.
                </small>
              </Card>
            </Col>
          </Row>
        )}
      </Container>
    </>
  );
};

export default Donate;


--- FILE: client/src/pages/DonationHistory.jsx ---
/* eslint-disable no-unused-vars */
import React, { useState, useEffect } from "react";
import {
  Container,
  Table,
  Badge,
  Button,
  Card,
  Spinner,
} from "react-bootstrap";
import { FaFilePdf, FaHandHoldingHeart } from "react-icons/fa";
import axios from "axios";

const DonationHistory = () => {
  const [donations, setDonations] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchMyDonations = async () => {
      try {
        const userInfo = JSON.parse(localStorage.getItem("userInfo"));
        const config = {
          headers: { Authorization: `Bearer ${userInfo.token}` },
        };
        const { data } = await axios.get(
          "http://localhost:5000/api/donations/my",
          config
        );
        setDonations(data);
        setLoading(false);
      } catch (error) {
        console.error(error);
        setLoading(false);
      }
    };
    fetchMyDonations();
  }, []);

  const downloadReceipt = async (id, name) => {
    try {
      const userInfo = JSON.parse(localStorage.getItem("userInfo"));
      const response = await axios.get(
        `http://localhost:5000/api/donations/${id}/receipt`,
        {
          headers: { Authorization: `Bearer ${userInfo.token}` },
          responseType: "blob",
        }
      );
      const url = window.URL.createObjectURL(new Blob([response.data]));
      const link = document.createElement("a");
      link.href = url;
      link.setAttribute("download", `Receipt_${name}.pdf`);
      document.body.appendChild(link);
      link.click();
    } catch (err) {
      alert("Error downloading receipt");
    }
  };

  if (loading)
    return (
      <div className="text-center py-5">
        <Spinner animation="border" />
      </div>
    );

  return (
    <Container className="py-5">
      <div className="d-flex align-items-center gap-3 mb-4">
        <div className="bg-light p-3 rounded-circle">
          <FaHandHoldingHeart size={30} className="text-maroon" />
        </div>
        <div>
          <h2
            className="text-maroon m-0"
            style={{ fontFamily: "Playfair Display" }}
          >
            My Donation History
          </h2>
          <p className="text-muted m-0">Thank you for your generous support</p>
        </div>
      </div>

      <Card className="shadow-sm border-0">
        <Table hover responsive className="mb-0 align-middle">
          <thead className="bg-light">
            <tr>
              <th className="ps-4">Date</th>
              <th>Scheme</th>
              <th>Amount</th>
              <th>Payment Mode</th>
              <th>Status</th>
              <th className="text-center">Receipt</th>
            </tr>
          </thead>
          <tbody>
            {donations.map((d) => (
              <tr key={d._id}>
                <td className="ps-4">
                  {new Date(d.createdAt).toLocaleDateString()}
                </td>
                <td>
                  <Badge bg="info" text="dark">
                    {d.scheme}
                  </Badge>
                </td>
                <td className="fw-bold"> {d.amount.toLocaleString()}</td>
                <td>{d.paymentMode}</td>
                <td>
                  {d.receiptStatus === "Sent" ? (
                    <Badge bg="success">Completed</Badge>
                  ) : (
                    <Badge bg="warning" text="dark">
                      Processing
                    </Badge>
                  )}
                </td>
                <td className="text-center">
                  <Button
                    variant="outline-danger"
                    size="sm"
                    onClick={() => downloadReceipt(d._id, d.donorName)}
                    title="Download Receipt"
                  >
                    <FaFilePdf /> Download
                  </Button>
                </td>
              </tr>
            ))}
            {donations.length === 0 && (
              <tr>
                <td colSpan="6" className="text-center py-5 text-muted">
                  You haven't made any donations yet.
                </td>
              </tr>
            )}
          </tbody>
        </Table>
      </Card>
    </Container>
  );
};

export default DonationHistory;


--- FILE: client/src/pages/Events.css ---
/* --- Hero --- */
.events-hero {
  background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)),
    url("https://images.unsplash.com/photo-1561343754-0518747449a5?q=80&w=1920&auto=format&fit=crop");
  background-size: cover;
  background-position: center;
  height: 300px;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  color: white;
}

/* --- Tabs --- */
.event-tabs {
  display: flex;
  justify-content: center;
  margin-bottom: 40px;
  border-bottom: 2px solid #eee;
}

.event-tab-btn {
  background: none;
  border: none;
  padding: 15px 30px;
  font-size: 1.2rem;
  font-family: "Playfair Display", serif;
  color: #888;
  cursor: pointer;
  border-bottom: 4px solid transparent;
  transition: all 0.3s;
}

.event-tab-btn.active {
  color: #581818; /* Maroon */
  border-bottom: 4px solid #d35400; /* Saffron */
  font-weight: bold;
}

/* --- Event Card (Horizontal) --- */
.event-card-lg {
  background: white;
  border: 1px solid #eee;
  border-radius: 10px;
  overflow: hidden;
  transition: transform 0.3s, box-shadow 0.3s;
  margin-bottom: 30px;
}

.event-card-lg:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
  border-color: #daa520; /* Gold */
}

/* Date Block on Left */
.date-block {
  background-color: #581818;
  color: white;
  height: 100%;
  min-height: 150px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  padding: 20px;
}

.date-day {
  font-size: 2.5rem;
  font-weight: bold;
  line-height: 1;
}

.date-month {
  font-size: 1.2rem;
  text-transform: uppercase;
  letter-spacing: 2px;
}

.event-details {
  padding: 25px;
}

.event-title-lg {
  font-family: "Playfair Display", serif;
  font-size: 1.8rem;
  color: #333;
  margin-bottom: 10px;
}

.event-meta-row {
  display: flex;
  gap: 20px;
  color: #666;
  font-size: 0.95rem;
  margin-bottom: 15px;
}


--- FILE: client/src/pages/Events.jsx ---
// import React, { useState } from "react";
// import { Container, Row, Col, Button, Badge } from "react-bootstrap";
// import { FaClock, FaMapMarkerAlt } from "react-icons/fa";
// import "./Events.css";

// const Events = () => {
//   const [activeTab, setActiveTab] = useState("upcoming");

//   // Mock Data
//   const upcomingEvents = [
//     {
//       id: 1,
//       day: "15",
//       month: "AUG",
//       title: "Sri Krishna Janmashtami",
//       time: "6:00 PM - Midnight",
//       location: "Main Temple Hall",
//       desc: "Join us for the grand celebration of Lord Krishna's appearance day with Kirtan, Abhishekam, and Prasadam.",
//     },
//     {
//       id: 2,
//       day: "10",
//       month: "SEP",
//       title: "Ganesh Chaturthi",
//       time: "9:00 AM - 1:00 PM",
//       location: "Ashram Courtyard",
//       desc: "Special Puja and Ganapati Homa followed by cultural programs by our Bal Vihar students.",
//     },
//   ];

//   const pastEvents = [
//     {
//       id: 101,
//       day: "20",
//       month: "JUL",
//       title: "Guru Purnima",
//       time: "Completed",
//       location: "Main Temple Hall",
//       desc: "Over 500 devotees participated in the Paduka Puja honoring the Guru Parampara.",
//     },
//     {
//       id: 102,
//       day: "21",
//       month: "JUN",
//       title: "International Yoga Day",
//       time: "Completed",
//       location: "Garden Area",
//       desc: "A health and wellness session conducted for all ashram residents and visitors.",
//     },
//   ];

//   const displayData = activeTab === "upcoming" ? upcomingEvents : pastEvents;

//   return (
//     <>
//       <div className="events-hero">
//         <div>
//           <h1
//             className="display-3 fw-bold"
//             style={{ fontFamily: "Playfair Display" }}
//           >
//             Events & Calendar
//           </h1>
//           <p className="lead">Participate in our sacred gatherings</p>
//         </div>
//       </div>

//       <Container className="py-5">
//         {/* Tabs */}
//         <div className="event-tabs">
//           <button
//             className={`event-tab-btn ${
//               activeTab === "upcoming" ? "active" : ""
//             }`}
//             onClick={() => setActiveTab("upcoming")}
//           >
//             Upcoming Events
//           </button>
//           <button
//             className={`event-tab-btn ${activeTab === "past" ? "active" : ""}`}
//             onClick={() => setActiveTab("past")}
//           >
//             Past Celebrations
//           </button>
//         </div>

//         {/* Event List */}
//         <div className="event-list-container">
//           {displayData.map((evt) => (
//             <div key={evt.id} className="event-card-lg">
//               <Row className="g-0 align-items-center">
//                 {/* Date Column */}
//                 <Col md={2} sm={3} className="text-center">
//                   <div className="date-block">
//                     <span className="date-day">{evt.day}</span>
//                     <span className="date-month">{evt.month}</span>
//                   </div>
//                 </Col>

//                 {/* Details Column */}
//                 <Col md={7} sm={9}>
//                   <div className="event-details">
//                     <h3 className="event-title-lg">{evt.title}</h3>
//                     <div className="event-meta-row">
//                       <span>
//                         <FaClock className="text-warning me-1" /> {evt.time}
//                       </span>
//                       <span>
//                         <FaMapMarkerAlt className="text-danger me-1" />{" "}
//                         {evt.location}
//                       </span>
//                     </div>
//                     <p className="text-muted mb-0">{evt.desc}</p>
//                   </div>
//                 </Col>

//                 {/* Button Column */}
//                 <Col md={3} className="text-center p-3 border-start">
//                   {activeTab === "upcoming" ? (
//                     <Button className="btn-ashram w-100 mb-2">
//                       Register Now
//                     </Button>
//                   ) : (
//                     <Button
//                       variant="outline-secondary"
//                       className="w-100"
//                       disabled
//                     >
//                       View Gallery
//                     </Button>
//                   )}
//                   {activeTab === "upcoming" && (
//                     <small className="text-muted d-block mt-2">
//                       Free Entry
//                     </small>
//                   )}
//                 </Col>
//               </Row>
//             </div>
//           ))}

//           {displayData.length === 0 && (
//             <p className="text-center text-muted">
//               No events found for this category.
//             </p>
//           )}
//         </div>
//       </Container>
//     </>
//   );
// };

// export default Events;
import React, { useState, useEffect } from "react";
import { Container, Row, Col, Button, Modal, Form } from "react-bootstrap";
import { FaClock, FaMapMarkerAlt } from "react-icons/fa";
import axios from "axios";
import "./Events.css";

const Events = () => {
  const [activeTab, setActiveTab] = useState("upcoming");
  const [events, setEvents] = useState([]);

  // Registration Modal State
  const [showRegModal, setShowRegModal] = useState(false);
  const [selectedEvent, setSelectedEvent] = useState(null);
  const [regData, setRegData] = useState({ name: "", phone: "" });

  // Fetch Events from Backend
  useEffect(() => {
    const fetchEvents = async () => {
      try {
        const { data } = await axios.get("http://localhost:5000/api/events");
        setEvents(data);
      } catch (error) {
        console.error("Error fetching events", error);
      }
    };
    fetchEvents();
  }, []);

  // Filter Logic
  const now = new Date();
  const upcomingEvents = events.filter(
    (e) => new Date(e.date).setHours(0, 0, 0, 0) >= now.setHours(0, 0, 0, 0)
  );
  const pastEvents = events.filter(
    (e) => new Date(e.date) < new Date().setHours(0, 0, 0, 0)
  );

  const displayData = activeTab === "upcoming" ? upcomingEvents : pastEvents;

  // Handle Registration Click
  const handleRegisterClick = (evt) => {
    setSelectedEvent(evt);
    setShowRegModal(true);
  };

  // Submit Registration
  const handleRegSubmit = async (e) => {
    e.preventDefault();
    try {
      await axios.post(
        `http://localhost:5000/api/events/${selectedEvent._id}/register`,
        regData
      );
      alert("Registration Successful! We look forward to seeing you.");
      setShowRegModal(false);
      setRegData({ name: "", phone: "" });

      // Refresh events to update count
      const { data } = await axios.get("http://localhost:5000/api/events");
      setEvents(data);
    } catch (error) {
      alert(error.response?.data?.message || "Registration Failed");
    }
  };

  return (
    <>
      <div className="events-hero">
        <div>
          <h1
            className="display-3 fw-bold"
            style={{ fontFamily: "Playfair Display" }}
          >
            Events & Calendar
          </h1>
          <p className="lead">Participate in our sacred gatherings</p>
        </div>
      </div>

      <Container className="py-5">
        {/* Tabs */}
        <div className="event-tabs">
          <button
            className={`event-tab-btn ${
              activeTab === "upcoming" ? "active" : ""
            }`}
            onClick={() => setActiveTab("upcoming")}
          >
            Upcoming Events
          </button>
          <button
            className={`event-tab-btn ${activeTab === "past" ? "active" : ""}`}
            onClick={() => setActiveTab("past")}
          >
            Past Celebrations
          </button>
        </div>

        {/* Event List */}
        <div className="event-list-container">
          {displayData.map((evt) => {
            const dateObj = new Date(evt.date);
            const day = dateObj.getDate();
            const month = dateObj
              .toLocaleString("default", { month: "short" })
              .toUpperCase();

            return (
              <div key={evt._id} className="event-card-lg">
                <Row className="g-0 align-items-center">
                  <Col md={2} sm={3} className="text-center">
                    <div className="date-block">
                      <span className="date-day">{day}</span>
                      <span className="date-month">{month}</span>
                    </div>
                  </Col>
                  <Col md={7} sm={9}>
                    <div className="event-details">
                      <h3 className="event-title-lg">{evt.title}</h3>
                      <div className="event-meta-row">
                        <span>
                          <FaClock className="text-warning me-1" /> {evt.time}
                        </span>
                        <span>
                          <FaMapMarkerAlt className="text-danger me-1" />{" "}
                          {evt.location}
                        </span>
                      </div>
                      <p className="text-muted mb-0">{evt.description}</p>
                    </div>
                  </Col>
                  <Col md={3} className="text-center p-3 border-start">
                    {activeTab === "upcoming" ? (
                      <Button
                        className="btn-ashram w-100 mb-2"
                        onClick={() => handleRegisterClick(evt)}
                      >
                        Register Now
                      </Button>
                    ) : (
                      <Button
                        variant="outline-secondary"
                        className="w-100"
                        disabled
                      >
                        Completed
                      </Button>
                    )}
                    {activeTab === "upcoming" && (
                      <small className="text-muted d-block mt-2">
                        Free Entry
                      </small>
                    )}
                  </Col>
                </Row>
              </div>
            );
          })}
          {displayData.length === 0 && (
            <p className="text-center text-muted py-5">No events found.</p>
          )}
        </div>
      </Container>

      {/* Registration Modal */}
      <Modal show={showRegModal} onHide={() => setShowRegModal(false)}>
        <Modal.Header closeButton>
          <Modal.Title>Register for {selectedEvent?.title}</Modal.Title>
        </Modal.Header>
        <Modal.Body>
          <Form onSubmit={handleRegSubmit}>
            <Form.Group className="mb-3">
              <Form.Label>Your Name</Form.Label>
              <Form.Control
                type="text"
                value={regData.name}
                onChange={(e) =>
                  setRegData({ ...regData, name: e.target.value })
                }
                required
              />
            </Form.Group>
            <Form.Group className="mb-3">
              <Form.Label>Phone Number</Form.Label>
              <Form.Control
                type="text"
                value={regData.phone}
                onChange={(e) =>
                  setRegData({ ...regData, phone: e.target.value })
                }
                required
              />
            </Form.Group>
            <Button type="submit" className="w-100 btn-ashram">
              Confirm Registration
            </Button>
          </Form>
        </Modal.Body>
      </Modal>
    </>
  );
};

export default Events;


--- FILE: client/src/pages/Home.jsx ---
import React from "react";
import { Container, Row, Col, Card } from "react-bootstrap";
import { Link } from "react-router-dom";
import HeroSlider from "../components/HeroSlider";
import DonationSchemes from "../components/DonationSchemes";
import QuoteSection from "../components/QuoteSection";
import UpcomingEvents from "../components/UpcomingEvents";
import JoinCtaSection from "../components/JoinCtaSection";

const Home = () => {
  return (
    <>
      <Container fluid className="p-0">
        <HeroSlider />
        <DonationSchemes />
        <QuoteSection />
        <UpcomingEvents />
        <JoinCtaSection />
      </Container>
    </>
  );
};

export default Home;


--- FILE: client/src/pages/Login.css ---
/* --- Auth Page Background --- */
.auth-container {
  min-height: 80vh; /* Takes up most of the screen */
  background: linear-gradient(
      rgba(255, 251, 245, 0.9),
      rgba(255, 251, 245, 0.9)
    ),
    url("https://www.transparenttextures.com/patterns/black-scales.png"); /* Subtle texture */
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 40px 0;
}

/* --- The Card --- */
.auth-card {
  background: white;
  border: none;
  border-radius: 12px;
  box-shadow: 0 15px 35px rgba(88, 24, 24, 0.1); /* Maroon shadow */
  overflow: hidden;
  max-width: 450px;
  width: 100%;
  position: relative;
  border-top: 5px solid #d35400; /* Saffron Top Border */
}

.auth-header {
  text-align: center;
  padding: 30px 30px 10px 30px;
}

.auth-title {
  font-family: "Playfair Display", serif;
  color: #581818;
  font-weight: 700;
  margin-bottom: 5px;
}

.auth-subtitle {
  color: #888;
  font-size: 0.9rem;
}

/* --- Form Elements --- */
.auth-body {
  padding: 20px 30px 40px 30px;
}

.form-label-auth {
  font-weight: 600;
  color: #444;
  font-size: 0.9rem;
  margin-bottom: 5px;
}

.form-control-auth {
  padding: 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 1rem;
  margin-bottom: 20px;
  transition: all 0.3s;
}

.form-control-auth:focus {
  border-color: #d35400;
  box-shadow: 0 0 0 3px rgba(211, 84, 0, 0.1);
}

/* --- Button --- */
.btn-auth {
  background: linear-gradient(to right, #581818, #800000);
  color: white;
  width: 100%;
  padding: 12px;
  border: none;
  border-radius: 6px;
  font-weight: bold;
  font-size: 1rem;
  margin-top: 10px;
  transition: background 0.3s;
}

.btn-auth:hover {
  background: linear-gradient(to right, #d35400, #e67e22);
  color: white;
}

/* --- Links --- */
.auth-footer {
  text-align: center;
  margin-top: 20px;
  font-size: 0.9rem;
  color: #666;
}

.auth-link {
  color: #d35400;
  font-weight: bold;
  text-decoration: none;
}

.auth-link:hover {
  text-decoration: underline;
  color: #581818;
}

/* --- Divider --- */
.auth-divider {
  display: flex;
  align-items: center;
  text-align: center;
  margin: 20px 0;
  color: #ccc;
}
.auth-divider::before,
.auth-divider::after {
  content: "";
  flex: 1;
  border-bottom: 1px solid #eee;
}
.auth-divider span {
  padding: 0 10px;
  font-size: 0.8rem;
}


--- FILE: client/src/pages/Login.jsx ---
// import React, { useState } from "react";
// import { Link } from "react-router-dom";
// import { Form, Alert } from "react-bootstrap";
// import "./Login.css"; // Shared CSS

// const Login = () => {
//   const [email, setEmail] = useState("");
//   const [password, setPassword] = useState("");

//   // This is just for UI testing, real logic comes later
//   const handleLogin = (e) => {
//     e.preventDefault();
//     alert(`Attempting login with: ${email}`);
//   };

//   return (
//     <div className="auth-container">
//       <div className="auth-card">
//         {/* Header */}
//         <div className="auth-header">
//           <h2 className="auth-title">Welcome Back</h2>
//           <p className="auth-subtitle">Sign in to Karunasri Seva Samithi</p>
//         </div>

//         {/* Body */}
//         <div className="auth-body">
//           <Form onSubmit={handleLogin}>
//             {/* Email */}
//             <Form.Group className="mb-3">
//               <Form.Label className="form-label-auth">Email Address</Form.Label>
//               <Form.Control
//                 type="email"
//                 placeholder="name@example.com"
//                 className="form-control-auth"
//                 value={email}
//                 onChange={(e) => setEmail(e.target.value)}
//                 required
//               />
//             </Form.Group>

//             {/* Password */}
//             <Form.Group className="mb-3">
//               <div className="d-flex justify-content-between">
//                 <Form.Label className="form-label-auth">Password</Form.Label>
//                 <Link
//                   to="/forgot-password"
//                   style={{
//                     fontSize: "0.8rem",
//                     color: "#666",
//                     textDecoration: "none",
//                   }}
//                 >
//                   Forgot Password?
//                 </Link>
//               </div>
//               <Form.Control
//                 type="password"
//                 placeholder="Enter your password"
//                 className="form-control-auth"
//                 value={password}
//                 onChange={(e) => setPassword(e.target.value)}
//                 required
//               />
//             </Form.Group>

//             {/* Submit Button */}
//             <button type="submit" className="btn-auth">
//               Sign In
//             </button>
//           </Form>

//           {/* Footer / Register Link */}
//           <div className="auth-divider">
//             <span>OR</span>
//           </div>

//           <div className="auth-footer">
//             Don't have an account?{" "}
//             <Link to="/register" className="auth-link">
//               Create Account
//             </Link>
//           </div>
//         </div>
//       </div>
//     </div>
//   );
// };

// export default Login;
import React, { useState } from "react";
import { Link, useNavigate } from "react-router-dom";
import { Form, Alert, Spinner } from "react-bootstrap";
import axios from "axios";
import "./Login.css";

const Login = () => {
  const navigate = useNavigate();

  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");

  // UI States
  const [error, setError] = useState("");
  const [loading, setLoading] = useState(false);

  const handleLogin = async (e) => {
    e.preventDefault();
    setError("");
    setLoading(true);

    try {
      // 1. Send Data to Backend
      const config = {
        headers: {
          "Content-Type": "application/json",
        },
      };

      const { data } = await axios.post(
        "http://localhost:5000/api/users/login",
        { email, password },
        config
      );

      // 2. Save User Info (Token) to Browser Storage
      localStorage.setItem("userInfo", JSON.stringify(data));

      // 3. Redirect to Home
      setLoading(false);
      navigate("/");

      // Optional: Reload page to update Navbar immediately (simple fix before we add Redux)
      window.location.reload();
    } catch (err) {
      setLoading(false);
      // Show error message from backend (e.g., "Invalid password")
      setError(err.response?.data?.message || "Login Failed");
    }
  };

  return (
    <div className="auth-container">
      <div className="auth-card">
        <div className="auth-header">
          <h2 className="auth-title">Welcome Back</h2>
          <p className="auth-subtitle">Sign in to Karunasri Seva Samithi</p>
        </div>

        <div className="auth-body">
          {/* Error Alert */}
          {error && <Alert variant="danger">{error}</Alert>}

          <Form onSubmit={handleLogin}>
            <Form.Group className="mb-3">
              <Form.Label className="form-label-auth">Email Address</Form.Label>
              <Form.Control
                type="email"
                placeholder="name@example.com"
                className="form-control-auth"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                required
              />
            </Form.Group>

            <Form.Group className="mb-3">
              <div className="d-flex justify-content-between">
                <Form.Label className="form-label-auth">Password</Form.Label>
                {/* We will build Forgot Password logic later */}
                <Link
                  to="#"
                  style={{
                    fontSize: "0.8rem",
                    color: "#666",
                    textDecoration: "none",
                  }}
                >
                  Forgot Password?
                </Link>
              </div>
              <Form.Control
                type="password"
                placeholder="Enter your password"
                className="form-control-auth"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                required
              />
            </Form.Group>

            <button type="submit" className="btn-auth" disabled={loading}>
              {loading ? <Spinner animation="border" size="sm" /> : "Sign In"}
            </button>
          </Form>

          <div className="auth-divider">
            <span>OR</span>
          </div>

          <div className="auth-footer">
            Don't have an account?{" "}
            <Link to="/register" className="auth-link">
              Create Account
            </Link>
          </div>
        </div>
      </div>
    </div>
  );
};

export default Login;


--- FILE: client/src/pages/Register.jsx ---
// // import React, { useState } from "react";
// // import { Link } from "react-router-dom";
// // import { Form, Row, Col } from "react-bootstrap";
// // import "./Login.css"; // Reusing the same CSS

// // const Register = () => {
// //   const [formData, setFormData] = useState({
// //     fullName: "",
// //     email: "",
// //     phone: "",
// //     password: "",
// //     confirmPassword: "",
// //   });

// //   const handleChange = (e) => {
// //     setFormData({ ...formData, [e.target.name]: e.target.value });
// //   };

// //   const handleRegister = (e) => {
// //     e.preventDefault();
// //     if (formData.password !== formData.confirmPassword) {
// //       alert("Passwords do not match!");
// //       return;
// //     }
// //     alert("Registration UI works!");
// //   };

// //   return (
// //     <div className="auth-container">
// //       <div className="auth-card" style={{ maxWidth: "550px" }}>
// //         {" "}
// //         {/* Slightly wider */}
// //         <div className="auth-header">
// //           <h2 className="auth-title">Join Our Community</h2>
// //           <p className="auth-subtitle">
// //             Create an account to track donations & events
// //           </p>
// //         </div>
// //         <div className="auth-body">
// //           <Form onSubmit={handleRegister}>
// //             {/* Full Name */}
// //             <Form.Group className="mb-2">
// //               <Form.Label className="form-label-auth">Full Name</Form.Label>
// //               <Form.Control
// //                 type="text"
// //                 name="fullName"
// //                 placeholder="Enter your name"
// //                 className="form-control-auth"
// //                 onChange={handleChange}
// //                 required
// //               />
// //             </Form.Group>

// //             <Row>
// //               {/* Phone */}
// //               <Col md={6}>
// //                 <Form.Group className="mb-2">
// //                   <Form.Label className="form-label-auth">
// //                     Mobile Number
// //                   </Form.Label>
// //                   <Form.Control
// //                     type="tel"
// //                     name="phone"
// //                     placeholder="+91"
// //                     className="form-control-auth"
// //                     onChange={handleChange}
// //                     required
// //                   />
// //                 </Form.Group>
// //               </Col>

// //               {/* Email */}
// //               <Col md={6}>
// //                 <Form.Group className="mb-2">
// //                   <Form.Label className="form-label-auth">
// //                     Email Address
// //                   </Form.Label>
// //                   <Form.Control
// //                     type="email"
// //                     name="email"
// //                     placeholder="name@example.com"
// //                     className="form-control-auth"
// //                     onChange={handleChange}
// //                     required
// //                   />
// //                 </Form.Group>
// //               </Col>
// //             </Row>

// //             <Row>
// //               {/* Password */}
// //               <Col md={6}>
// //                 <Form.Group className="mb-2">
// //                   <Form.Label className="form-label-auth">Password</Form.Label>
// //                   <Form.Control
// //                     type="password"
// //                     name="password"
// //                     placeholder="Create password"
// //                     className="form-control-auth"
// //                     onChange={handleChange}
// //                     required
// //                   />
// //                 </Form.Group>
// //               </Col>

// //               {/* Confirm Password */}
// //               <Col md={6}>
// //                 <Form.Group className="mb-2">
// //                   <Form.Label className="form-label-auth">
// //                     Confirm Password
// //                   </Form.Label>
// //                   <Form.Control
// //                     type="password"
// //                     name="confirmPassword"
// //                     placeholder="Confirm password"
// //                     className="form-control-auth"
// //                     onChange={handleChange}
// //                     required
// //                   />
// //                 </Form.Group>
// //               </Col>
// //             </Row>

// //             <button type="submit" className="btn-auth mt-3">
// //               Register
// //             </button>
// //           </Form>

// //           <div className="auth-footer mt-4">
// //             Already have an account?{" "}
// //             <Link to="/login" className="auth-link">
// //               Sign In
// //             </Link>
// //           </div>
// //         </div>
// //       </div>
// //     </div>
// //   );
// // };

// // export default Register;
// import React, { useState } from "react";
// import { Link, useNavigate } from "react-router-dom";
// import { Form, Row, Col, Alert } from "react-bootstrap";
// import axios from "axios";
// import "./Login.css";

// const Register = () => {
//   const navigate = useNavigate(); // Hook to redirect after success
//   const [formData, setFormData] = useState({
//     name: "", // changed from fullName to match backend
//     email: "",
//     phone: "",
//     password: "",
//     confirmPassword: "",
//   });
//   const [error, setError] = useState("");

//   const handleChange = (e) => {
//     setFormData({ ...formData, [e.target.name]: e.target.value });
//   };

//   const handleRegister = async (e) => {
//     e.preventDefault();
//     setError("");

//     // Basic Validation
//     if (formData.password !== formData.confirmPassword) {
//       setError("Passwords do not match!");
//       return;
//     }

//     try {
//       // API Call
//       const res = await axios.post("http://localhost:5000/api/users/register", {
//         name: formData.name,
//         email: formData.email,
//         phone: formData.phone,
//         password: formData.password,
//       });

//       // If successful, save user data to LocalStorage (Browser memory)
//       localStorage.setItem("userInfo", JSON.stringify(res.data));

//       alert("Registration Successful!");
//       navigate("/"); // Redirect to Home Page
//     } catch (err) {
//       setError(err.response?.data?.message || "Registration Failed");
//     }
//   };

//   return (
//     <div className="auth-container">
//       <div className="auth-card" style={{ maxWidth: "550px" }}>
//         <div className="auth-header">
//           <h2 className="auth-title">Join Our Community</h2>
//           <p className="auth-subtitle">Create an account to track donations</p>
//         </div>

//         <div className="auth-body">
//           {error && <Alert variant="danger">{error}</Alert>}

//           <Form onSubmit={handleRegister}>
//             <Form.Group className="mb-2">
//               <Form.Label className="form-label-auth">Full Name</Form.Label>
//               <Form.Control
//                 type="text"
//                 name="name"
//                 placeholder="Enter full name"
//                 className="form-control-auth"
//                 onChange={handleChange}
//                 required
//               />
//             </Form.Group>

//             {/* ... Keep Phone, Email, Passwords exactly as before ... */}
//             {/* Just make sure input names match state: name="email", name="phone" etc */}
//             <Row>
//               <Col md={6}>
//                 <Form.Group className="mb-2">
//                   <Form.Label className="form-label-auth">
//                     Mobile Number
//                   </Form.Label>
//                   <Form.Control
//                     type="tel"
//                     name="phone"
//                     placeholder="+91"
//                     className="form-control-auth"
//                     onChange={handleChange}
//                     required
//                   />
//                 </Form.Group>
//               </Col>
//               <Col md={6}>
//                 <Form.Group className="mb-2">
//                   <Form.Label className="form-label-auth">
//                     Email Address
//                   </Form.Label>
//                   <Form.Control
//                     type="email"
//                     name="email"
//                     placeholder="name@example.com"
//                     className="form-control-auth"
//                     onChange={handleChange}
//                     required
//                   />
//                 </Form.Group>
//               </Col>
//             </Row>

//             <Row>
//               <Col md={6}>
//                 <Form.Group className="mb-2">
//                   <Form.Label className="form-label-auth">Password</Form.Label>
//                   <Form.Control
//                     type="password"
//                     name="password"
//                     placeholder="Create password"
//                     className="form-control-auth"
//                     onChange={handleChange}
//                     required
//                   />
//                 </Form.Group>
//               </Col>
//               <Col md={6}>
//                 <Form.Group className="mb-2">
//                   <Form.Label className="form-label-auth">
//                     Confirm Password
//                   </Form.Label>
//                   <Form.Control
//                     type="password"
//                     name="confirmPassword"
//                     placeholder="Confirm password"
//                     className="form-control-auth"
//                     onChange={handleChange}
//                     required
//                   />
//                 </Form.Group>
//               </Col>
//             </Row>

//             <button type="submit" className="btn-auth mt-3">
//               Register
//             </button>
//           </Form>

//           <div className="auth-footer mt-4">
//             Already have an account?{" "}
//             <Link to="/login" className="auth-link">
//               Sign In
//             </Link>
//           </div>
//         </div>
//       </div>
//     </div>
//   );
// };

// export default Register;
import React, { useState } from "react";
import { Link, useNavigate } from "react-router-dom";
import { Form, Row, Col, Alert } from "react-bootstrap"; // Ensure Alert is imported
import axios from "axios";
import "./Login.css";

const Register = () => {
  const navigate = useNavigate();

  const [formData, setFormData] = useState({
    name: "",
    email: "",
    phone: "",
    password: "",
    confirmPassword: "",
  });

  // State for messages
  const [error, setError] = useState("");
  const [success, setSuccess] = useState(""); // New success state

  const handleChange = (e) => {
    setFormData({ ...formData, [e.target.name]: e.target.value });
  };

  const handleRegister = async (e) => {
    e.preventDefault();
    setError("");
    setSuccess("");

    // Basic Validation
    if (formData.password !== formData.confirmPassword) {
      setError("Passwords do not match!");
      return;
    }

    try {
      const res = await axios.post("http://localhost:5000/api/users/register", {
        name: formData.name,
        email: formData.email,
        phone: formData.phone,
        password: formData.password,
      });

      // Save to LocalStorage
      localStorage.setItem("userInfo", JSON.stringify(res.data));

      // 1. Show Green Success Message
      setSuccess(
        "Registration Successful! Please check your email. Redirecting..."
      );

      // 2. Clear Form (Optional)
      setFormData({
        name: "",
        email: "",
        phone: "",
        password: "",
        confirmPassword: "",
      });

      // 3. Wait 3 seconds, then redirect
      setTimeout(() => {
        navigate("/");
      }, 3000);
    } catch (err) {
      setError(err.response?.data?.message || "Registration Failed");
    }
  };

  return (
    <div className="auth-container">
      <div className="auth-card" style={{ maxWidth: "550px" }}>
        <div className="auth-header">
          <h2 className="auth-title">Join Our Community</h2>
          <p className="auth-subtitle">Create an account to track donations</p>
        </div>

        <div className="auth-body">
          {/* Display Messages Here */}
          {error && <Alert variant="danger">{error}</Alert>}
          {success && <Alert variant="success">{success}</Alert>}

          <Form onSubmit={handleRegister}>
            <Form.Group className="mb-2">
              <Form.Label className="form-label-auth">Full Name</Form.Label>
              <Form.Control
                type="text"
                name="name"
                value={formData.name}
                placeholder="Enter full name"
                className="form-control-auth"
                onChange={handleChange}
                required
              />
            </Form.Group>

            <Row>
              <Col md={6}>
                <Form.Group className="mb-2">
                  <Form.Label className="form-label-auth">
                    Mobile Number
                  </Form.Label>
                  <Form.Control
                    type="tel"
                    name="phone"
                    value={formData.phone}
                    placeholder="+91"
                    className="form-control-auth"
                    onChange={handleChange}
                    required
                  />
                </Form.Group>
              </Col>
              <Col md={6}>
                <Form.Group className="mb-2">
                  <Form.Label className="form-label-auth">
                    Email Address
                  </Form.Label>
                  <Form.Control
                    type="email"
                    name="email"
                    value={formData.email}
                    placeholder="name@example.com"
                    className="form-control-auth"
                    onChange={handleChange}
                    required
                  />
                </Form.Group>
              </Col>
            </Row>

            <Row>
              <Col md={6}>
                <Form.Group className="mb-2">
                  <Form.Label className="form-label-auth">Password</Form.Label>
                  <Form.Control
                    type="password"
                    name="password"
                    value={formData.password}
                    placeholder="Create password"
                    className="form-control-auth"
                    onChange={handleChange}
                    required
                  />
                </Form.Group>
              </Col>
              <Col md={6}>
                <Form.Group className="mb-2">
                  <Form.Label className="form-label-auth">
                    Confirm Password
                  </Form.Label>
                  <Form.Control
                    type="password"
                    name="confirmPassword"
                    value={formData.confirmPassword}
                    placeholder="Confirm password"
                    className="form-control-auth"
                    onChange={handleChange}
                    required
                  />
                </Form.Group>
              </Col>
            </Row>

            <button type="submit" className="btn-auth mt-3">
              Register
            </button>
          </Form>

          <div className="auth-footer mt-4">
            Already have an account?{" "}
            <Link to="/login" className="auth-link">
              Sign In
            </Link>
          </div>
        </div>
      </div>
    </div>
  );
};

export default Register;


--- FILE: client/src/pages/UserProfile.jsx ---
import React, { useState, useEffect } from "react";
import {
  Container,
  Row,
  Col,
  Card,
  Form,
  Button,
  Alert,
} from "react-bootstrap";
import { FaUserCircle, FaSave, FaEdit } from "react-icons/fa";
import axios from "axios";

const UserProfile = () => {
  const [user, setUser] = useState({
    name: "",
    email: "",
    phone: "",
    password: "",
    confirmPassword: "",
  });
  const [isEditing, setIsEditing] = useState(false);
  const [message, setMessage] = useState(null);

  useEffect(() => {
    const fetchProfile = async () => {
      try {
        const userInfo = JSON.parse(localStorage.getItem("userInfo"));
        const config = {
          headers: { Authorization: `Bearer ${userInfo.token}` },
        };
        const { data } = await axios.get(
          "http://localhost:5000/api/users/profile",
          config
        );
        setUser({ ...data, password: "", confirmPassword: "" });
      } catch (error) {
        console.error(error);
      }
    };
    fetchProfile();
  }, []);

  const handleUpdate = async (e) => {
    e.preventDefault();
    if (user.password && user.password !== user.confirmPassword) {
      setMessage({ type: "danger", text: "Passwords do not match" });
      return;
    }

    try {
      const userInfo = JSON.parse(localStorage.getItem("userInfo"));
      const config = { headers: { Authorization: `Bearer ${userInfo.token}` } };

      const { data } = await axios.put(
        "http://localhost:5000/api/users/profile",
        {
          name: user.name,
          phone: user.phone,
          password: user.password,
        },
        config
      );

      // Update Local Storage
      localStorage.setItem(
        "userInfo",
        JSON.stringify({ ...userInfo, name: data.name })
      );

      setMessage({ type: "success", text: "Profile Updated Successfully" });
      setIsEditing(false);
    } catch (error) {
      setMessage({
        type: "danger",
        text: error.response?.data?.message || "Update Failed",
      });
    }
  };

  return (
    <Container className="py-5">
      <Row className="justify-content-center">
        <Col md={8} lg={6}>
          <Card className="shadow border-0">
            <Card.Header className="bg-white text-center py-4">
              <FaUserCircle size={60} className="text-secondary mb-2" />
              <h3 className="mb-0">My Profile</h3>
            </Card.Header>
            <Card.Body className="p-4">
              {message && <Alert variant={message.type}>{message.text}</Alert>}

              <Form onSubmit={handleUpdate}>
                <Form.Group className="mb-3">
                  <Form.Label>Full Name</Form.Label>
                  <Form.Control
                    type="text"
                    value={user.name}
                    onChange={(e) => setUser({ ...user, name: e.target.value })}
                    disabled={!isEditing}
                  />
                </Form.Group>

                <Form.Group className="mb-3">
                  <Form.Label>Email Address</Form.Label>
                  <Form.Control type="email" value={user.email} disabled />
                  <Form.Text className="text-muted">
                    Email cannot be changed.
                  </Form.Text>
                </Form.Group>

                <Form.Group className="mb-3">
                  <Form.Label>Phone Number</Form.Label>
                  <Form.Control
                    type="text"
                    value={user.phone}
                    onChange={(e) =>
                      setUser({ ...user, phone: e.target.value })
                    }
                    disabled={!isEditing}
                  />
                </Form.Group>

                {isEditing && (
                  <>
                    <hr />
                    <h6 className="mb-3 text-muted">
                      Change Password (Optional)
                    </h6>
                    <Form.Group className="mb-3">
                      <Form.Label>New Password</Form.Label>
                      <Form.Control
                        type="password"
                        value={user.password}
                        onChange={(e) =>
                          setUser({ ...user, password: e.target.value })
                        }
                      />
                    </Form.Group>
                    <Form.Group className="mb-3">
                      <Form.Label>Confirm Password</Form.Label>
                      <Form.Control
                        type="password"
                        value={user.confirmPassword}
                        onChange={(e) =>
                          setUser({ ...user, confirmPassword: e.target.value })
                        }
                      />
                    </Form.Group>
                  </>
                )}

                <div className="d-grid gap-2 mt-4">
                  {isEditing ? (
                    <Button type="submit" variant="success">
                      <FaSave className="me-2" /> Save Changes
                    </Button>
                  ) : (
                    <Button
                      variant="primary"
                      onClick={() => setIsEditing(true)}
                      style={{ backgroundColor: "#581818", border: "none" }}
                    >
                      <FaEdit className="me-2" /> Edit Profile
                    </Button>
                  )}
                </div>
              </Form>
            </Card.Body>
          </Card>
        </Col>
      </Row>
    </Container>
  );
};

export default UserProfile;


